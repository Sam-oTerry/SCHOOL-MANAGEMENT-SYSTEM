<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Cards - Director of Studies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/dos.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a4f8b;
            --secondary: #3a7cbd;
            --accent: #ff9e1b;
            --light: #f5f7fa;
            --dark: #2c3e50;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .role-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: var(--light);
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }
        
        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            border-color: var(--secondary);
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.5em 0.75em;
        }
        
        .status-generated { background-color: #28a745; }
        .status-printed { background-color: #17a2b8; }
        .status-pending { background-color: #ffc107; color: #212529; }
        .status-distributed { background-color: #6f42c1; }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 60px 15px 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="rounded-circle mb-2" style="width: 60px; height: 60px;">
                        <h5 class="text-white">Director of Studies</h5>
                        <small class="text-muted" id="sidebar-staff-id">Staff ID: Loading...</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="report-cards.html">
                                <i class="fas fa-file-alt"></i> Report Cards
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-ids.html">
                                <i class="fas fa-id-card"></i> Student IDs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar-alt"></i> Timetable
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-progress.html">
                                <i class="fas fa-chart-line"></i> Academic Progress
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-12 main-content">
                <div class="header">
                    <div>
                        <h4>Report Cards</h4>
                        <span class="role-badge">Academic Management</span>
                    </div>
                    <div>
                        <span id="current-user">Loading...</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Summary Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <h3 id="stat-total-students">0</h3>
                                <p class="mb-0">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body">
                                <h3 id="stat-generated">0</h3>
                                <p class="mb-0">Generated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body">
                                <h3 id="stat-printed">0</h3>
                                <p class="mb-0">Printed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body">
                                <h3 id="stat-pending">0</h3>
                                <p class="mb-0">Pending</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Card Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Report Card Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="classSelect">
                                    <option value="">Select Class</option>
                                    <option value="S.4 Science A">S.4 Science A</option>
                                    <option value="S.4 Science B">S.4 Science B</option>
                                    <option value="S.3 Science">S.3 Science</option>
                                    <option value="S.2 Science">S.2 Science</option>
                                    <option value="S.1 Science">S.1 Science</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Term</label>
                                <select class="form-select" id="termSelect">
                                    <option value="">Select Term</option>
                                    <option value="Term 1">Term 1</option>
                                    <option value="Term 2">Term 2</option>
                                    <option value="Term 3">Term 3</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Student</label>
                                <select class="form-select" id="studentSelect">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" id="generateReportBtn">
                                        <i class="fas fa-plus"></i> Generate Report
                                    </button>
                                    <button class="btn btn-success btn-sm" id="generateAllBtn">
                                        <i class="fas fa-layer-group"></i> Generate All
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Cards List -->
                <div class="card">
                    <div class="card-header">
                        <h5>Report Cards List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Term</th>
                                        <th>Avg Grade</th>
                                        <th>Position</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="reportListBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Loading report cards...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Generate Report Modal -->
    <div class="modal fade" id="generateReportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Report Card</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateReportForm">
                        <div class="mb-3">
                            <label class="form-label">Student</label>
                            <select class="form-select" id="modalStudentSelect" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class</label>
                            <select class="form-select" id="modalClassSelect" required>
                                <option value="">Select Class</option>
                                <option value="S.4 Science A">S.4 Science A</option>
                                <option value="S.4 Science B">S.4 Science B</option>
                                <option value="S.3 Science">S.3 Science</option>
                                <option value="S.2 Science">S.2 Science</option>
                                <option value="S.1 Science">S.1 Science</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Term</label>
                            <select class="form-select" id="modalTermSelect" required>
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="emailCheckbox">
                                <label class="form-check-label" for="emailCheckbox">
                                    Send via Email
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="oneDriveCheckbox">
                                <label class="form-check-label" for="oneDriveCheckbox">
                                    Save to OneDrive
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmGenerateBtn">
                        <i class="fas fa-file-word"></i> Generate Report Card
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Preview Modal -->
    <div class="modal fade" id="reportPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reportPreviewContent">
                        <!-- Preview content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="loadSampleData()">
                        <i class="fas fa-flask"></i> Load Sample Data
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printReportCard()">
                        <i class="fas fa-print"></i> Print Report Card
                    </button>
                    <button type="button" class="btn btn-success" onclick="generatePDF()">
                        <i class="fas fa-file-pdf"></i> Generate PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <br>
            <span id="loadingText">Processing...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // Configuration
        const API_BASE_URL = 'https://your-api.onrender.com';
        const FIREBASE_CONFIG = {
            apiKey: "your-api-key",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let students = [];
        let reportCards = [];
        let currentUser = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
            loadInitialData();
            setupEventListeners();
        });

        // Authentication
        async function initializeAuth() {
            try {
                currentUser = await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        resolve(user);
                    });
                });

                if (currentUser) {
                    document.getElementById('current-user').textContent = currentUser.displayName || currentUser.email;
                    document.getElementById('sidebar-staff-id').textContent = `Staff ID: ${currentUser.uid.substring(0, 8)}`;
                } else {
                    // Redirect to login if not authenticated
                    window.location.href = '../../index.html';
                }
            } catch (error) {
                console.error('Auth initialization error:', error);
                alert('Authentication failed. Please refresh the page.');
            }
        }

        // Load initial data
        async function loadInitialData() {
            showLoading('Loading data...');
            try {
                await Promise.all([
                    loadStudents(),
                    loadReportCards(),
                    updateSummaryStats()
                ]);
                populateDropdowns();
                populateReportList();
            } catch (error) {
                console.error('Error loading initial data:', error);
                alert('Failed to load data. Please refresh the page.');
            } finally {
                hideLoading();
            }
        }

        // Load students from Firestore
        async function loadStudents() {
            try {
                const snapshot = await db.collection('students').get();
                students = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Loaded students:', students.length);
            } catch (error) {
                console.error('Error loading students:', error);
                throw error;
            }
        }

        // Load report cards from Firestore
        async function loadReportCards() {
            try {
                const snapshot = await db.collection('report_cards').get();
                reportCards = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Loaded report cards:', reportCards.length);
            } catch (error) {
                console.error('Error loading report cards:', error);
                throw error;
            }
        }

        // Update summary statistics
        async function updateSummaryStats() {
            const totalStudents = students.length;
            
            const generated = reportCards.filter(rc => rc.status === 'Generated').length;
            const printed = reportCards.filter(rc => rc.status === 'Printed').length;
            const pending = totalStudents - generated;

            document.getElementById('stat-total-students').textContent = totalStudents;
            document.getElementById('stat-generated').textContent = generated;
            document.getElementById('stat-printed').textContent = printed;
            document.getElementById('stat-pending').textContent = pending;
        }

        // Populate dropdowns
        function populateDropdowns() {
            const studentSelect = document.getElementById('studentSelect');
            const modalStudentSelect = document.getElementById('modalStudentSelect');
            
            // Clear existing options
            [studentSelect, modalStudentSelect].forEach(select => {
                select.innerHTML = '<option value="">Select Student</option>';
            });

            // Add student options
            students.forEach(student => {
                const optionText = `${student.name} (${student.lin})`;
                [studentSelect, modalStudentSelect].forEach(select => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = optionText;
                    select.appendChild(option);
                });
            });
        }

        // Populate report list table
        function populateReportList() {
            const tbody = document.getElementById('reportListBody');
            tbody.innerHTML = '';

            if (reportCards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No report cards available</td></tr>';
                return;
            }

            reportCards.forEach(card => {
                const student = students.find(s => s.id === card.student_id);
                if (!student) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.lin}</td>
                    <td>${student.name}</td>
                    <td>${card.class || 'N/A'}</td>
                    <td>${card.term || 'N/A'}</td>
                    <td>${card.avg_grade || 'N/A'}</td>
                    <td>${card.position || 'N/A'}</td>
                    <td><span class="badge status-${card.status?.toLowerCase() || 'pending'}">${card.status || 'Pending'}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="previewReport('${card.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="printReport('${card.id}')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="downloadReport('${card.id}')">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Generate Report button
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                const studentId = document.getElementById('studentSelect').value;
                const classValue = document.getElementById('classSelect').value;
                const termValue = document.getElementById('termSelect').value;

                if (!studentId || !classValue || !termValue) {
                    alert('Please select student, class, and term first.');
                    return;
                }

                // Populate modal
                document.getElementById('modalStudentSelect').value = studentId;
                document.getElementById('modalClassSelect').value = classValue;
                document.getElementById('modalTermSelect').value = termValue;

                // Show modal
                new bootstrap.Modal(document.getElementById('generateReportModal')).show();
            });

            // Generate All button
            document.getElementById('generateAllBtn').addEventListener('click', function() {
                const classValue = document.getElementById('classSelect').value;
                const termValue = document.getElementById('termSelect').value;

                if (!classValue || !termValue) {
                    alert('Please select class and term first.');
                    return;
                }

                if (confirm(`Generate report cards for all students in ${classValue} - ${termValue}?`)) {
                    generateAllReports(classValue, termValue);
                }
            });

            // Confirm Generate button
            document.getElementById('confirmGenerateBtn').addEventListener('click', function() {
                generateSingleReport();
            });

            // Class/Term change handlers
            document.getElementById('classSelect').addEventListener('change', function() {
                filterStudentsByClass();
            });

            document.getElementById('termSelect').addEventListener('change', function() {
                filterStudentsByClass();
            });
        }

        // Filter students by class
        function filterStudentsByClass() {
            const classValue = document.getElementById('classSelect').value;
            const studentSelect = document.getElementById('studentSelect');
            
            // Reset to show all students
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            
            const filteredStudents = classValue ? 
                students.filter(s => s.class === classValue) : 
                students;

            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.lin})`;
                studentSelect.appendChild(option);
            });
        }

        // Generate single report
        async function generateSingleReport() {
            const studentId = document.getElementById('modalStudentSelect').value;
            const classValue = document.getElementById('modalClassSelect').value;
            const termValue = document.getElementById('modalTermSelect').value;
            const emailCheckbox = document.getElementById('emailCheckbox').checked;
            const oneDriveCheckbox = document.getElementById('oneDriveCheckbox').checked;

            if (!studentId || !classValue || !termValue) {
                alert('Please fill in all required fields.');
                return;
            }

            showLoading('Generating report card...');

            try {
                // Get auth token
                const token = await currentUser.getIdToken();
                
                // Call FastAPI
                const response = await fetch(`${API_BASE_URL}/generate_report/${studentId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: termValue,
                        class: classValue
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                // Download the DOCX file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Report_Card_${studentId}_${termValue}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Update Firestore
                await updateReportCardStatus(studentId, 'Generated', {
                    class: classValue,
                    term: termValue,
                    generated_at: firebase.firestore.FieldValue.serverTimestamp(),
                    email_sent: emailCheckbox,
                    onedrive_saved: oneDriveCheckbox
                });

                // Log email/OneDrive options
                if (emailCheckbox) {
                    console.log('Email option selected for student:', studentId);
                }
                if (oneDriveCheckbox) {
                    console.log('OneDrive option selected for student:', studentId);
                }

                // Refresh data
                await loadReportCards();
                await updateSummaryStats();
                populateReportList();

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('generateReportModal')).hide();

                alert('Report card generated successfully!');

            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report card: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Generate all reports
        async function generateAllReports(classValue, termValue) {
            const classStudents = students.filter(s => s.class === classValue);
            
            if (classStudents.length === 0) {
                alert('No students found for the selected class.');
                return;
            }

            showLoading(`Generating ${classStudents.length} report cards...`);

            try {
                const token = await currentUser.getIdToken();
                let successCount = 0;
                let errorCount = 0;

                for (const student of classStudents) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/generate_report/${student.id}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                term: termValue,
                                class: classValue
                            })
                        });

                        if (response.ok) {
                            await updateReportCardStatus(student.id, 'Generated', {
                                class: classValue,
                                term: termValue,
                                generated_at: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error generating report for ${student.id}:`, error);
                        errorCount++;
                    }
                }

                // Refresh data
                await loadReportCards();
                await updateSummaryStats();
                populateReportList();

                alert(`Batch generation completed!\nSuccess: ${successCount}\nErrors: ${errorCount}`);

            } catch (error) {
                console.error('Error in batch generation:', error);
                alert('Batch generation failed: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update report card status in Firestore
        async function updateReportCardStatus(studentId, status, additionalData = {}) {
            try {
                const reportCardData = {
                    student_id: studentId,
                    status: status,
                    ...additionalData
                };

                await db.collection('report_cards').doc(studentId).set(reportCardData, { merge: true });
                console.log(`Updated report card status for ${studentId}: ${status}`);
            } catch (error) {
                console.error('Error updating report card status:', error);
                throw error;
            }
        }

        // Preview report
        function previewReport(reportId) {
            const report = reportCards.find(rc => rc.id === reportId);
            if (!report) {
                alert('Report not found.');
                return;
            }

            // Load sample data for preview
            loadSampleData();
            new bootstrap.Modal(document.getElementById('reportPreviewModal')).show();
        }

        // Print report
        function printReport(reportId) {
            const report = reportCards.find(rc => rc.id === reportId);
            if (!report) {
                alert('Report not found.');
                return;
            }

            // Update status to printed
            updateReportCardStatus(reportId, 'Printed');
            
            // Trigger print
            window.print();
        }

        // Download report
        async function downloadReport(reportId) {
            const report = reportCards.find(rc => rc.id === reportId);
            if (!report) {
                alert('Report not found.');
                return;
            }

            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${API_BASE_URL}/generate_report/${report.student_id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        term: report.term,
                        class: report.class
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Report_Card_${report.student_id}_${report.term}.docx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Failed to download report.');
                }
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Failed to download report: ' + error.message);
            }
        }

        // Load sample data for preview
        function loadSampleData() {
            const previewContent = document.getElementById('reportPreviewContent');
            previewContent.innerHTML = `
                <div class="report-card-preview">
                    <div class="text-center mb-4">
                        <h3>ADILANG SECONDARY SCHOOL</h3>
                        <p>P.O.BOX 13, PADER-AGAGO DISTRICT</p>
                        <p>TEL: 0773221580/0782634466/0782446279/0770685882</p>
                        <h4>END OF TERM THREE ASSESSMENT REPORT CARD 2025</h4>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Student Name:</strong> John Doe</p>
                            <p><strong>Class:</strong> S.4 Science A</p>
                            <p><strong>LIN:</strong> ADM256174</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Sex:</strong> Male</p>
                            <p><strong>Term:</strong> Term 3</p>
                            <p><strong>Payment Code:</strong> 1003</p>
                        </div>
                    </div>
                    
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>S/N</th>
                                <th>Subject</th>
                                <th>AOI AV</th>
                                <th>EOT Score</th>
                                <th>Total Score</th>
                                <th>Grade</th>
                                <th>Position</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>MATHS</td>
                                <td>39</td>
                                <td>10</td>
                                <td>70%</td>
                                <td>C</td>
                                <td>5th</td>
                                <td>Good</td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>ENGLISH</td>
                                <td>39</td>
                                <td>9</td>
                                <td>78%</td>
                                <td>B</td>
                                <td>3rd</td>
                                <td>Well done</td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>LIT IN ENGLISH</td>
                                <td>40</td>
                                <td>10</td>
                                <td>70%</td>
                                <td>C</td>
                                <td>4th</td>
                                <td>Good effort</td>
                            </tr>
                            <tr>
                                <td>4</td>
                                <td>CRE</td>
                                <td>38</td>
                                <td>8</td>
                                <td>65%</td>
                                <td>B</td>
                                <td>6th</td>
                                <td>Good</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="mt-4">
                        <h5>REMARKS</h5>
                        <p><strong>Class Teacher:</strong> _________________ Sign: _________________</p>
                        <p><strong>Bursar:</strong> Fees Balance: _________________ Sign: _________________</p>
                        <p><strong>Head Teacher:</strong> _________________ Sign: _________________</p>
                    </div>
                </div>
            `;
        }

        // Print report card
        function printReportCard() {
            window.print();
        }

        // Generate PDF
        function generatePDF() {
            const element = document.getElementById('reportPreviewContent');
            const opt = {
                margin: 1,
                filename: 'report-card.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        // Utility functions
        function showLoading(text = 'Loading...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>
