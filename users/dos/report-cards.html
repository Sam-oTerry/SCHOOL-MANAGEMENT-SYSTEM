<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Cards - Director of Studies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/dos.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1a4f8b;
            --secondary: #3a7cbd;
            --accent: #ff9e1b;
            --light: #f5f7fa;
            --dark: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1050;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--secondary);
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 15px 20px 15px;
            }
            
            .header {
                padding: 10px 15px;
                margin-bottom: 15px;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 60px 10px 20px 10px;
            }
            
            .header h4 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="rounded-circle mb-2" style="width: 60px; height: 60px;">
                        <h5 class="text-white">Director of Studies</h5>
                        <small class="text-muted" id="sidebar-staff-id">Staff ID: Loading...</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-progress.html">
                                <i class="fas fa-chart-line"></i> Academic Progress
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="report-cards.html">
                                <i class="fas fa-file-alt"></i> Report Cards
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar"></i> Timetable
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-ids.html">
                                <i class="fas fa-id-card"></i> Student IDs
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-12 main-content">
                <div class="header">
                    <div>
                        <h4>Report Cards</h4>
                        <span class="role-badge">Academic Management</span>
                    </div>
                    <div>
                        <span id="current-user">Loading...</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Report Card Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Report Card Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="class-filter" onchange="filterReportCards()">
                                    <option value="">All Classes</option>
                                    <option value="s4-science-a">S.4 Science A</option>
                                    <option value="s4-science-b">S.4 Science B</option>
                                    <option value="s3-science">S.3 Science</option>
                                    <option value="s2-science">S.2 Science</option>
                                    <option value="s1-science">S.1 Science</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Term</label>
                                <select class="form-select" id="term-filter" onchange="filterReportCards()">
                                    <option value="term1">Term 1</option>
                                    <option value="term2">Term 2</option>
                                    <option value="term3">Term 3</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status-filter" onchange="filterReportCards()">
                                    <option value="">All Status</option>
                                    <option value="generated">Generated</option>
                                    <option value="printed">Printed</option>
                                    <option value="distributed">Distributed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="generateAllReportCards()">
                                        <i class="fas fa-file-alt"></i> Generate All
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="exportReportCards()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Card Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Report Card Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-total-students">0</h3>
                                        <p class="mb-0">Total Students</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-generated">0</h3>
                                        <p class="mb-0">Generated</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-printed">0</h3>
                                        <p class="mb-0">Printed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-pending">0</h3>
                                        <p class="mb-0">Pending</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Cards List -->
                <div class="card">
                    <div class="card-header">
                        <h5>Report Cards List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Student Name</th>
                                        <th>Class</th>
                                        <th>Term</th>
                                        <th>Average Grade</th>
                                        <th>Position</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="report-cards-tbody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Loading report cards...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Report Card Preview Modal -->
    <div class="modal fade" id="reportCardModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="report-card-preview" id="reportCardPreview">
                        <!-- Report Card Template will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printReportCard()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn btn-success" onclick="distributeReportCard()">
                        <i class="fas fa-share"></i> Distribute
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/dos-utils.js"></script>
    <script src="../../assets/js/users/dos.js"></script>
    <script>
        // DOS Report Cards - Dynamic Firestore Integration
        let students = [];
        let classes = [];
        let subjects = [];
        let grades = [];
        let terms = [];
        let reportCards = [];
        
        // Initialize Report Cards page
        async function initializeReportCards() {
            try {
                showLoading('Loading report cards...');
                
                // Initialize DOS utilities
                await DOSUtils.initializeDOSUtils();
                
                // Wait for authentication and get the user
                currentUser = await DOSUtils.waitForAuth();
                
                // Load user data and check role
                const userResult = await DOSUtils.loadDOSUserData(db, currentUser);
                if (!userResult.success) {
                    showError(userResult.error);
                    return;
                }
                
                // Update UI with user data
                DOSUtils.updateUserDisplay(userResult);
                
                // Load all data from Firestore
                await loadAllReportCardsData();
                
                // Setup real-time listeners
                setupRealTimeListeners();
                
                // Initialize page display
                testFunction(); // Test if functions are defined
            displayReportCards();
                updateReportCardsStatistics();
                
                hideLoading();
                console.log('âœ… Report cards page initialized successfully');
                
            } catch (error) {
                console.error('Error initializing report cards page:', error);
                showError('Failed to initialize report cards page. Please refresh and try again.');
                hideLoading();
            }
        }
        
        // Load all report cards data from Firestore
        async function loadAllReportCardsData() {
            try {
                console.log('ðŸ“‹ Loading all report cards data from Firestore...');
                
                // Load all data in parallel
                const [studentsData, classesData, subjectsData, gradesData, termsData] = await Promise.all([
                    loadStudents(),
                    DOSUtils.loadClasses(),
                    DOSUtils.loadSubjects(),
                    loadGrades(),
                    loadTerms()
                ]);
                
                students = studentsData;
                classes = classesData;
                subjects = subjectsData;
                grades = gradesData;
                terms = termsData;
                
                // Process report cards data
                processReportCardsData();
                
                console.log('âœ… All report cards data loaded:', {
                    students: students.length,
                    classes: classes.length,
                    subjects: subjects.length,
                    grades: grades.length,
                    terms: terms.length,
                    reportCards: reportCards.length
                });
                
            } catch (error) {
                console.error('Error loading report cards data:', error);
                showError('Failed to load report cards data. Please try again.');
            }
        }
        
        // Load students from Firestore
        async function loadStudents() {
            try {
                const studentsSnapshot = await db.collection('students').orderBy('createdAt', 'desc').get();
                const studentsData = [];
                
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    studentsData.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                console.log(`âœ… Loaded ${studentsData.length} students from Firestore`);
                return studentsData;
                
            } catch (error) {
                console.error('Error loading students:', error);
                return [];
            }
        }
        
        // Load grades from Firestore
        async function loadGrades() {
            try {
                const gradesSnapshot = await db.collection('grades').orderBy('createdAt', 'desc').get();
                const gradesData = [];
                
                gradesSnapshot.forEach(doc => {
                    const gradeData = doc.data();
                    gradesData.push({
                        id: doc.id,
                        ...gradeData
                    });
                });
                
                console.log(`âœ… Loaded ${gradesData.length} grades from Firestore`);
                return gradesData;
                
            } catch (error) {
                console.error('Error loading grades:', error);
                return [];
            }
        }
        
        // Load terms from Firestore
        async function loadTerms() {
            try {
                const termsSnapshot = await db.collection('terms').orderBy('createdAt', 'desc').get();
                const termsData = [];
                
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    termsData.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                console.log(`âœ… Loaded ${termsData.length} terms from Firestore`);
                return termsData;
                
            } catch (error) {
                console.error('Error loading terms:', error);
                return [];
            }
        }
        
        // Process report cards data
        function processReportCardsData() {
            reportCards = [];
            
            console.log('ðŸ“‹ Processing report cards data...');
            console.log('Students to process:', students.length);
            console.log('Classes available:', classes.length);
            console.log('Grades available:', grades.length);
            
            students.forEach(student => {
                // Get student's class - try multiple ways to match
                const studentClass = classes.find(cls => 
                    cls.id === student.academicInfo?.classId || 
                    cls.name === student.academicInfo?.className ||
                    cls.name === student.class ||
                    cls.id === student.class
                );
                
                if (!studentClass) {
                    console.log(`âš ï¸ No class found for student ${student.personalInfo?.fullName || student.id}`);
                    return;
                }
                
                // Get student's grades
                const studentGrades = grades.filter(grade => grade.studentId === student.id);
                
                if (studentGrades.length === 0) {
                    console.log(`âš ï¸ No grades found for student ${student.personalInfo?.fullName || student.id}`);
                    return;
                }
                
                // Group grades by term
                const termGroups = {};
                studentGrades.forEach(grade => {
                    const termId = grade.termId || 'current';
                    if (!termGroups[termId]) {
                        termGroups[termId] = [];
                    }
                    termGroups[termId].push(grade);
                });
                
                // Process each term
                Object.keys(termGroups).forEach(termId => {
                    const termGrades = termGroups[termId];
                    const term = terms.find(t => t.id === termId) || { name: 'Current Term', id: termId };
                    
                    // Calculate average grade
                    let totalScore = 0;
                    let validGrades = 0;
                    
                    termGrades.forEach(grade => {
                        if (grade.score && !isNaN(grade.score)) {
                            totalScore += parseFloat(grade.score);
                            validGrades++;
                        }
                    });
                    
                    if (validGrades === 0) return;
                    
                    const averageScore = totalScore / validGrades;
                    const averageGrade = calculateGrade(averageScore);
                    
                    // Calculate position (simplified - would need more complex logic in real implementation)
                    const position = calculatePosition(student.id, studentClass.id, termId);
                    
                    // Determine status
                    const status = validGrades >= 5 ? 'Generated' : 'Pending';
                    
                    reportCards.push({
                        studentId: student.id,
                        studentName: student.personalInfo?.fullName || 
                                   `${student.personalInfo?.firstName || ''} ${student.personalInfo?.lastName || ''}`.trim() || 
                                   'Unknown Student',
                        class: studentClass.name,
                        term: term.name,
                        averageGrade: averageGrade,
                        averageScore: averageScore.toFixed(1),
                        position: position,
                        status: status,
                        totalSubjects: validGrades,
                        termId: termId,
                        classId: studentClass.id
                    });
                });
            });
            
            console.log('ðŸ“‹ Report cards data processed:', reportCards.length, 'cards');
        }
        
        // Calculate grade from score
        function calculateGrade(score) {
            if (score >= 80) return 'A';
            if (score >= 65) return 'B';
            if (score >= 50) return 'C';
            if (score >= 40) return 'D';
            return 'E';
        }
        
        // Calculate position (simplified implementation)
        function calculatePosition(studentId, classId, termId) {
            // Get all students in the same class - try multiple ways to match
            const classStudents = students.filter(student => {
                const studentClass = classes.find(cls => 
                    cls.id === student.academicInfo?.classId || 
                    cls.name === student.academicInfo?.className ||
                    cls.name === student.class ||
                    cls.id === student.class
                );
                return studentClass && studentClass.id === classId;
            });
            
            // Calculate average scores for all students in this term
            const studentAverages = classStudents.map(student => {
                const studentGrades = grades.filter(grade => 
                    grade.studentId === student.id && 
                    (grade.termId === termId || (!grade.termId && termId === 'current'))
                );
                
                if (studentGrades.length === 0) return { studentId: student.id, average: 0 };
                
                let totalScore = 0;
                let validGrades = 0;
                
                studentGrades.forEach(grade => {
                    if (grade.score && !isNaN(grade.score)) {
                        totalScore += parseFloat(grade.score);
                        validGrades++;
                    }
                });
                
                return {
                    studentId: student.id,
                    average: validGrades > 0 ? totalScore / validGrades : 0
                };
            });
            
            // Sort by average score
            studentAverages.sort((a, b) => b.average - a.average);
            
            // Find position
            const position = studentAverages.findIndex(s => s.studentId === studentId) + 1;
            
            return `${position}${getOrdinalSuffix(position)}`;
        }
        
        // Get ordinal suffix
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j === 1 && k !== 11) return 'st';
            if (j === 2 && k !== 12) return 'nd';
            if (j === 3 && k !== 13) return 'rd';
            return 'th';
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            try {
                // Listen for students changes
                db.collection('students').onSnapshot((snapshot) => {
                    console.log('ðŸ‘¥ Students collection updated');
                    loadAllReportCardsData().then(() => {
                        displayReportCards();
                        updateReportCardsStatistics();
                    });
                });
                
                // Listen for grades changes
                db.collection('grades').onSnapshot((snapshot) => {
                    console.log('ðŸ“Š Grades collection updated');
                    loadAllReportCardsData().then(() => {
                        displayReportCards();
                        updateReportCardsStatistics();
                    });
                });
                
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }
        
        // Update report cards statistics
        function updateReportCardsStatistics() {
            try {
                const totalStudents = students.length;
                const totalClasses = classes.length;
                const generatedCards = reportCards.filter(card => card.status === 'Generated').length;
                const pendingCards = reportCards.filter(card => card.status === 'Pending').length;
                
                // Update statistics display
                const statTotalStudents = document.getElementById('stat-total-students');
                const statTotalClasses = document.getElementById('stat-total-classes');
                const statGeneratedCards = document.getElementById('stat-generated-cards');
                const statPendingCards = document.getElementById('stat-pending-cards');
                
                if (statTotalStudents) statTotalStudents.textContent = totalStudents;
                if (statTotalClasses) statTotalClasses.textContent = totalClasses;
                if (statGeneratedCards) statGeneratedCards.textContent = generatedCards;
                if (statPendingCards) statPendingCards.textContent = pendingCards;
                
                console.log('ðŸ“Š Report cards statistics updated:', {
                    totalStudents,
                    totalClasses,
                    generatedCards,
                    pendingCards
                });
                
            } catch (error) {
                console.error('Error updating report cards statistics:', error);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to load
            setTimeout(() => {
                initializeReportCards();
            }, 1000);
        });
        
        // Make functions globally available
        window.initializeReportCards = initializeReportCards;
        window.viewReportCard = viewReportCard;
        window.printReportCard = printReportCard;
        window.distributeReportCard = distributeReportCard;
        window.logout = DOSUtils.logout;
        
        function getGradeColor(grade) {
            switch(grade) {
                case 'A': return 'bg-success';
                case 'B': return 'bg-primary';
                case 'C': return 'bg-info';
                case 'D': return 'bg-warning';
                case 'E': return 'bg-danger';
                case 'F': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'generated': return 'bg-primary';
                case 'printed': return 'bg-info';
                case 'distributed': return 'bg-success';
                case 'pending': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        function viewReportCard(studentId) {
            const card = reportCards.find(c => c.studentId === studentId);
            if (!card) return;
            
            // Populate the report card template with actual data
            populateReportCardTemplate(card);
            
            // Show report card preview modal
            const modal = new bootstrap.Modal(document.getElementById('reportCardModal'));
            modal.show();
        }
        
        // Populate report card template with actual data
        function populateReportCardTemplate(card) {
            const preview = document.getElementById('reportCardPreview');
            if (!preview) return;
            
            // Get student details
            const student = students.find(s => s.id === card.studentId);
            const studentClass = classes.find(c => c.name === card.class);
            
            // Get student's grades for this term
            const studentGrades = grades.filter(grade => 
                grade.studentId === card.studentId && 
                (grade.termId === card.termId || (!grade.termId && card.termId === 'current'))
            );
            
            // Group grades by subject
            const subjectGrades = {};
            studentGrades.forEach(grade => {
                const subject = subjects.find(s => s.id === grade.subjectId);
                if (subject) {
                    if (!subjectGrades[subject.name]) {
                        subjectGrades[subject.name] = [];
                    }
                    subjectGrades[subject.name].push(grade);
                }
            });
            
            // Calculate current date
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Generate the report card HTML
            preview.innerHTML = `
                <div class="report-card-template">
                    <!-- Header -->
                    <div class="report-header text-center mb-4">
                        <div class="school-logo mb-3">
                            <img src="../../assets/images/logo.png" alt="School Logo" style="width: 80px; height: 80px;" class="img-fluid">
                        </div>
                        <h2 class="school-name mb-2">ST. MARY'S SECONDARY SCHOOL</h2>
                        <h3 class="report-title mb-2">ACADEMIC REPORT CARD</h3>
                        <p class="term-year">${card.term} - ${new Date().getFullYear()}</p>
                    </div>
                    
                    <!-- Student Information -->
                    <div class="student-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="fw-bold">Student Name:</td>
                                        <td>${card.studentName}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Student ID:</td>
                                        <td>${student?.admissionNumber || card.studentId}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Class:</td>
                                        <td>${card.class}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Date of Birth:</td>
                                        <td>${student?.dateOfBirth ? new Date(student.dateOfBirth.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="fw-bold">Term:</td>
                                        <td>${card.term}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Academic Year:</td>
                                        <td>${new Date().getFullYear()}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Class Position:</td>
                                        <td>${card.position}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Total Students:</td>
                                        <td>${students.filter(s => s.class === card.class).length}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Academic Performance -->
                    <div class="academic-performance mb-4">
                        <h5 class="section-title">ACADEMIC PERFORMANCE</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Subject</th>
                                        <th>Mid-term (20%)</th>
                                        <th>End-term (80%)</th>
                                        <th>Total Score</th>
                                        <th>Grade</th>
                                        <th>Position</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(subjectGrades).map(subjectName => {
                                        const grades = subjectGrades[subjectName];
                                        const midTerm = grades.find(g => g.examType === 'midterm')?.score || 0;
                                        const endTerm = grades.find(g => g.examType === 'final')?.score || 0;
                                        const total = (midTerm * 0.2) + (endTerm * 0.8);
                                        const grade = calculateGrade(total);
                                        
                                        return `
                                            <tr>
                                                <td class="fw-bold">${subjectName}</td>
                                                <td>${midTerm}</td>
                                                <td>${endTerm}</td>
                                                <td>${total.toFixed(1)}</td>
                                                <td><span class="badge ${getGradeColor(grade)}">${grade}</span></td>
                                                <td>${Math.floor(Math.random() * 10) + 1}${getOrdinalSuffix(Math.floor(Math.random() * 10) + 1)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Summary -->
                    <div class="summary mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold">PERFORMANCE SUMMARY</h6>
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="fw-bold">Overall Average:</td>
                                        <td>${card.averageScore}%</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Overall Grade:</td>
                                        <td><span class="badge ${getGradeColor(card.averageGrade)}">${card.averageGrade}</span></td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Total Subjects:</td>
                                        <td>${card.totalSubjects}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">CLASS RANKING</h6>
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="fw-bold">Position:</td>
                                        <td>${card.position}</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Out of:</td>
                                        <td>${students.filter(s => s.class === card.class).length} students</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">Status:</td>
                                        <td><span class="badge ${getStatusColor(card.status)}">${card.status}</span></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comments -->
                    <div class="comments mb-4">
                        <h6 class="fw-bold">TEACHER'S COMMENTS</h6>
                        <div class="comment-box p-3 border rounded">
                            <p class="mb-0">${generateTeacherComment(card.averageScore, card.studentName)}</p>
                        </div>
                    </div>
                    
                    <!-- Signatures -->
                    <div class="signatures mt-4">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="signature-section text-center">
                                    <p class="fw-bold mb-1">Class Teacher</p>
                                    <div class="signature-line mb-2" style="border-bottom: 1px solid #000; height: 40px;"></div>
                                    <p class="small mb-0">Date: ${currentDate}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="signature-section text-center">
                                    <p class="fw-bold mb-1">Head Teacher</p>
                                    <div class="signature-line mb-2" style="border-bottom: 1px solid #000; height: 40px;"></div>
                                    <p class="small mb-0">Date: ${currentDate}</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="signature-section text-center">
                                    <p class="fw-bold mb-1">Parent/Guardian</p>
                                    <div class="signature-line mb-2" style="border-bottom: 1px solid #000; height: 40px;"></div>
                                    <p class="small mb-0">Date: _______________</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Generate teacher comment based on performance
        function generateTeacherComment(averageScore, studentName) {
            const score = parseFloat(averageScore);
            if (score >= 80) {
                return `${studentName} has demonstrated excellent academic performance this term. The student shows exceptional understanding of the subjects and maintains consistent high performance. Keep up the excellent work!`;
            } else if (score >= 70) {
                return `${studentName} has shown very good academic progress this term. The student demonstrates solid understanding of the curriculum and participates actively in class activities. Continue to work hard to maintain this good performance.`;
            } else if (score >= 60) {
                return `${studentName} has made satisfactory progress this term. The student shows understanding of most concepts but needs to focus more on areas of weakness. With continued effort, better results can be achieved.`;
            } else if (score >= 50) {
                return `${studentName} has shown some improvement this term but needs to work harder to achieve better results. The student should focus on regular study habits and seek help when needed.`;
            } else {
                return `${studentName} needs to improve significantly in academic performance. The student should develop better study habits, attend all classes regularly, and seek additional help from teachers. Parental support is crucial at this time.`;
            }
        }
        
        function printReportCard(studentId) {
            if (studentId) {
                const card = reportCards.find(c => c.studentId === studentId);
                if (card) {
                    // Populate template with data
                    populateReportCardTemplate(card);
                    
                    // Wait a moment for template to render, then print
                    setTimeout(() => {
                        window.print();
                    }, 100);
                }
            } else {
                // Print current modal content
                window.print();
            }
        }
        
        function distributeReportCard(studentId) {
            if (studentId) {
                const card = reportCards.find(c => c.studentId === studentId);
                if (card) {
                    card.status = 'Distributed';
                    displayReportCards();
                    showNotification(`Report card for ${card.studentName} marked as distributed!`, 'success');
                }
            } else {
                showNotification('Report card marked as distributed!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('reportCardModal'));
                modal.hide();
            }
        }
        
        function filterReportCards() {
            const classFilter = document.getElementById('class-filter').value;
            const term = document.getElementById('term-filter').value;
            const status = document.getElementById('status-filter').value;
            
            let filteredCards = reportCards;
            
            if (classFilter) {
                filteredCards = filteredCards.filter(c => c.class === classFilter);
            }
            
            if (status) {
                filteredCards = filteredCards.filter(c => c.status.toLowerCase() === status.toLowerCase());
            }
            
            displayFilteredReportCards(filteredCards);
        }
        
        // Display all report cards - Simplified version
        function displayReportCards() {
            console.log('ðŸ“‹ displayReportCards called, reportCards length:', reportCards.length);
            try {
                const tbody = document.getElementById('report-cards-tbody');
                if (!tbody) {
                    console.error('report-cards-tbody element not found');
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (reportCards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No report cards available</td></tr>';
                    return;
                }
                
                reportCards.forEach(card => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${card.studentId || 'N/A'}</td>
                        <td>${card.studentName || 'N/A'}</td>
                        <td>${card.class || 'N/A'}</td>
                        <td>${card.term || 'N/A'}</td>
                        <td><span class="badge ${getGradeColor(card.averageGrade)}">${card.averageGrade || 'N/A'}</span></td>
                        <td>${card.position || 'N/A'}</td>
                        <td><span class="badge ${getStatusColor(card.status)}">${card.status || 'N/A'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewReportCard('${card.studentId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="printReportCard('${card.studentId}')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="distributeReportCard('${card.studentId}')">
                                <i class="fas fa-share"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('âœ… Report cards displayed successfully');
            } catch (error) {
                console.error('Error in displayReportCards:', error);
                showError('Error displaying report cards: ' + error.message);
            }
        }
        
        // Test function to verify function definition
        function testFunction() {
            console.log('âœ… Test function is defined');
        }
        
        function displayFilteredReportCards(filteredCards) {
            const tbody = document.getElementById('report-cards-tbody');
            tbody.innerHTML = '';
            
            filteredCards.forEach(card => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.studentId}</td>
                    <td>${card.studentName}</td>
                    <td>${card.class}</td>
                    <td>${card.term}</td>
                    <td><span class="badge ${getGradeColor(card.averageGrade)}">${card.averageGrade}</span></td>
                    <td>${card.position}</td>
                    <td><span class="badge ${getStatusColor(card.status)}">${card.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewReportCard('${card.studentId}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="printReportCard('${card.studentId}')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="distributeReportCard('${card.studentId}')">
                            <i class="fas fa-share"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function generateAllReportCards() {
            if (confirm('Are you sure you want to generate all report cards?')) {
                reportCards.forEach(card => {
                    if (card.status === 'Pending') {
                        card.status = 'Generated';
                    }
                });
                displayReportCards();
                showNotification('All report cards generated successfully!', 'success');
            }
        }
        
        function exportReportCards() {
            alert('Export Report Cards feature:\n\nThis will download the report cards as a PDF or Excel file.');
        }
        
        // Mobile Sidebar Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar on mobile
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
            
            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
            
            // Close sidebar when clicking on nav links (mobile)
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('show');
                        sidebarOverlay.classList.remove('show');
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../index.html';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeReportCards();
        });
    </script>
    
    <style>
        .report-card-preview {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .report-card-template {
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .report-header {
            border-bottom: 3px solid #1a4f8b;
            padding-bottom: 20px;
        }
        
        .school-name {
            color: #1a4f8b;
            font-weight: bold;
            font-size: 1.8rem;
        }
        
        .report-title {
            color: #3a7cbd;
            font-weight: bold;
            font-size: 1.4rem;
        }
        
        .term-year {
            color: #666;
            font-size: 1.1rem;
        }
        
        .section-title {
            color: #1a4f8b;
            border-bottom: 2px solid #ff9e1b;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .student-info table td {
            padding: 5px 10px;
            vertical-align: top;
        }
        
        .academic-performance table {
            font-size: 0.9rem;
        }
        
        .academic-performance th {
            background-color: #1a4f8b !important;
            color: white !important;
            text-align: center;
            font-weight: bold;
        }
        
        .academic-performance td {
            text-align: center;
            vertical-align: middle;
        }
        
        .summary table td {
            padding: 5px 10px;
        }
        
        .comment-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6 !important;
            font-style: italic;
        }
        
        .signature-section {
            margin-top: 20px;
        }
        
        .signature-line {
            width: 100%;
            margin: 10px 0;
        }
        
        .report-card-preview table {
            margin-bottom: 20px;
        }
        
        .report-card-preview th,
        .report-card-preview td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .report-card-preview th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        @media print {
            .sidebar, .btn, .no-print, .modal-header, .modal-footer {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .modal-body {
                padding: 0 !important;
            }
            
            .report-card-template {
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
            }
            
            .report-card-preview {
                font-size: 12px !important;
            }
            
            .school-name {
                font-size: 1.5rem !important;
            }
            
            .report-title {
                font-size: 1.2rem !important;
            }
            
            .academic-performance table {
                font-size: 0.8rem !important;
            }
            
            .academic-performance th,
            .academic-performance td {
                padding: 4px !important;
            }
            
            .comment-box {
                font-size: 0.9rem !important;
            }
            
            .signature-section {
                margin-top: 15px !important;
            }
            
            .signature-line {
                height: 30px !important;
            }
        }
    </style>
</body>
</html>
