<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Cards - Director of Studies</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/dos.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1a4f8b;
            --secondary: #3a7cbd;
            --accent: #ff9e1b;
            --light: #f5f7fa;
            --dark: #2c3e50;
        }
        
        /* Report Card Specific Styles */
        .report-card-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .report-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px;
        }
        
        .school-logo {
            width: 150px;
            height: 80px;
            object-fit: contain;
        }
        
        .student-photo {
            width: 120px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid white;
        }
        
        /* Circular Logo Styling */
        .school-logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .circular-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid white;
            background: linear-gradient(135deg, #1a4f8b 0%, #3a7cbd 100%);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        
        .logo-text-outer {
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 8px;
        }
        
        .logo-text-top {
            font-size: 8px;
            text-align: center;
            transform: rotate(180deg);
        }
        
        .logo-text-bottom {
            font-size: 8px;
            text-align: center;
        }
        
        .logo-inner {
            text-align: center;
            z-index: 2;
        }
        
        .book-sun-icon {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .logo-code {
            font-size: 10px;
            font-weight: bold;
        }
        
        .student-photo-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Student Information Styling */
        .student-details-section {
            margin: 20px 0;
        }
        
        .student-info-line {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .student-info-line .fw-bold {
            margin-right: 5px;
            white-space: nowrap;
        }
        
        .dotted-line {
            border-bottom: 1px dotted #000;
            flex: 1;
            margin: 0 10px;
            height: 20px;
            display: inline-block;
        }
        
        .report-table {
            margin: 0;
        }
        
        .report-table th {
            background-color: var(--dark) !important;
            color: white !important;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
        }
        
        .report-table td {
            text-align: center;
            vertical-align: middle;
            padding: 12px 8px;
        }
        
        /* Grade Color Classes */
        .grade-excellent {
            background-color: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }
        
        .grade-very-good {
            background-color: #cce5ff !important;
            color: #004085;
            font-weight: bold;
        }
        
        .grade-good {
            background-color: #fff3cd !important;
            color: #856404;
            font-weight: bold;
        }
        
        .grade-fair {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }
        
        .grade-poor {
            background-color: #f5c6cb !important;
            color: #721c24;
            font-weight: bold;
        }
        
        /* Blank row styling */
        .text-muted {
            color: #6c757d !important;
            font-style: italic;
        }
        
        .report-table tr td.text-muted {
            background-color: #f8f9fa;
            border-color: #dee2e6;
        }
        
        /* A4 Paper Optimization - Perfect Fit */
        .report-card-container {
            max-width: 210mm; /* A4 width */
            margin: 0 auto;
            padding: 0;
        }
        
        /* Header Optimization */
        .report-header {
            padding: 6px 8px !important;
            min-height: 60px;
            max-height: 60px;
        }
        
        .school-logo, .student-photo {
            max-height: 50px !important;
            max-width: 50px !important;
        }
        
        .school-name {
            font-size: 14px !important;
            line-height: 1.2;
            font-weight: bold;
        }
        
        .school-details {
            font-size: 10px !important;
            line-height: 1.1;
        }
        
        .report-title {
            font-size: 12px !important;
            font-weight: bold;
        }
        
        /* Student Info Optimization */
        .student-details-section {
            padding: 8px 12px;
            font-size: 11px;
        }
        
        .student-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .student-info-item {
            display: flex;
            align-items: center;
            font-size: 10px;
        }
        
        .student-info-label {
            font-weight: bold;
            margin-right: 4px;
            min-width: 60px;
        }
        
        .student-info-value {
            border-bottom: 1px dotted #333;
            flex: 1;
            padding: 2px 4px;
        }
        
        /* Table Optimization for A4 */
        .report-table {
            table-layout: fixed;
            width: 100%;
            font-size: 9px;
            margin-bottom: 8px;
        }
        
        .report-table th {
            font-size: 8px;
            padding: 4px 2px;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }
        
        .report-table td {
            font-size: 8px;
            padding: 3px 2px;
            text-align: center;
            vertical-align: middle;
        }
        
        /* Fixed column widths for A4 */
        .report-table th:nth-child(1), .report-table td:nth-child(1) { width: 5%; } /* S/N */
        .report-table th:nth-child(2), .report-table td:nth-child(2) { width: 20%; } /* Subject */
        .report-table th:nth-child(3), .report-table td:nth-child(3) { width: 10%; } /* AOI AV */
        .report-table th:nth-child(4), .report-table td:nth-child(4) { width: 10%; } /* EOT Score */
        .report-table th:nth-child(5), .report-table td:nth-child(5) { width: 10%; } /* Total Score */
        .report-table th:nth-child(6), .report-table td:nth-child(6) { width: 8%; } /* Grade */
        .report-table th:nth-child(7), .report-table td:nth-child(7) { width: 8%; } /* Position */
        .report-table th:nth-child(8), .report-table td:nth-child(8) { width: 19%; } /* Remarks */
        .report-table th:nth-child(9), .report-table td:nth-child(9) { width: 10%; } /* Teacher Initials */
        
        /* Footer/Sidebar Optimization */
        .report-footer {
            padding: 6px 12px;
            font-size: 9px;
            page-break-inside: avoid;
        }
        
        .summary-section {
            margin-bottom: 6px;
        }
        
        .comments-section {
            max-height: 40%;
            overflow: hidden;
        }
        
        .signatures-section {
            font-size: 8px;
            margin-top: 8px;
        }
        
        /* Print Styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
                font-size: 12px;
                line-height: 1.3;
            }
            
            .sidebar, .mobile-menu-toggle, .btn, .card-header, .modal-header, .modal-footer {
                display: none !important;
            }
            
            .main-content {
                margin: 0;
                padding: 0;
            }
            
            .report-card-container {
                box-shadow: none;
                border-radius: 0;
                max-width: none;
                width: 100%;
            }
            
            .report-header {
                background: var(--primary) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
                padding: 15px !important;
            }
            
            .report-header h2 {
                font-size: 18px !important;
                margin-bottom: 5px !important;
            }
            
            .report-header h4 {
                font-size: 14px !important;
                margin-bottom: 3px !important;
            }
            
            .report-header p {
                font-size: 12px !important;
                margin-bottom: 0 !important;
            }
            
            .school-logo {
                width: 100px !important;
                height: 60px !important;
            }
            
            .student-photo {
                width: 80px !important;
                height: 100px !important;
            }
            
            .report-table {
                font-size: 11px !important;
            }
            
            .report-table th {
                background-color: var(--dark) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
                padding: 6px 4px !important;
                font-size: 10px !important;
            }
            
            .report-table td {
                padding: 4px 3px !important;
                font-size: 10px !important;
            }
            
            .grade-excellent, .grade-very-good, .grade-good, .grade-fair, .grade-poor {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .text-muted {
                color: #6c757d !important;
                font-style: italic;
            }
            
            .report-table tr td.text-muted {
                background-color: #f8f9fa !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .table-sm td, .table-sm th {
                padding: 3px !important;
                font-size: 10px !important;
            }
            
            h6 {
                font-size: 11px !important;
                margin-bottom: 5px !important;
            }
            
            .p-4 {
                padding: 10px !important;
            }
            
            .mt-4 {
                margin-top: 10px !important;
            }
            
            .mb-4 {
                margin-bottom: 10px !important;
            }
            
            .mt-3 {
                margin-top: 8px !important;
            }
            
            .mb-3 {
                margin-bottom: 8px !important;
            }
            
            @page {
                size: A4 portrait;
                margin: 0.4in;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .report-header .row {
                flex-direction: column;
                text-align: center;
            }
            
            .school-logo, .student-photo {
                margin: 10px auto;
            }
            
            .report-table {
                font-size: 0.9rem;
            }
            
            .report-table th,
            .report-table td {
                padding: 8px 4px;
            }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1050;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--secondary);
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 15px 20px 15px;
            }
            
            .header {
                padding: 10px 15px;
                margin-bottom: 15px;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 60px 10px 20px 10px;
            }
            
            .header h4 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="rounded-circle mb-2" style="width: 60px; height: 60px;">
                        <h5 class="text-white">Director of Studies</h5>
                        <small class="text-muted" id="sidebar-staff-id">Staff ID: Loading...</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-progress.html">
                                <i class="fas fa-chart-line"></i> Academic Progress
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="report-cards.html">
                                <i class="fas fa-file-alt"></i> Report Cards
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar"></i> Timetable
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-ids.html">
                                <i class="fas fa-id-card"></i> Student IDs
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-12 main-content">
                <div class="header">
                    <div>
                        <h4>Report Cards</h4>
                        <span class="role-badge">Academic Management</span>
                    </div>
                    <div>
                        <span id="current-user">Loading...</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Report Card Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Report Card Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="class-filter" onchange="filterReportCards()">
                                    <option value="">All Classes</option>
                                    <option value="s4-science-a">S.4 Science A</option>
                                    <option value="s4-science-b">S.4 Science B</option>
                                    <option value="s3-science">S.3 Science</option>
                                    <option value="s2-science">S.2 Science</option>
                                    <option value="s1-science">S.1 Science</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Term</label>
                                <select class="form-select" id="term-filter" onchange="filterReportCards()">
                                    <option value="term1">Term 1</option>
                                    <option value="term2">Term 2</option>
                                    <option value="term3">Term 3</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status-filter" onchange="filterReportCards()">
                                    <option value="">All Status</option>
                                    <option value="generated">Generated</option>
                                    <option value="printed">Printed</option>
                                    <option value="distributed">Distributed</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="generateAllReportCards()">
                                        <i class="fas fa-file-alt"></i> Generate All
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="testReportCard()">
                                        <i class="fas fa-file-pdf"></i> Test PDF
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="exportReportCards()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Card Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Report Card Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-total-students">0</h3>
                                        <p class="mb-0">Total Students</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-generated">0</h3>
                                        <p class="mb-0">Generated</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-printed">0</h3>
                                        <p class="mb-0">Printed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h3 id="stat-pending">0</h3>
                                        <p class="mb-0">Pending</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Report Cards List -->
                <div class="card">
                    <div class="card-header">
                        <h5>Report Cards List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Student Name</th>
                                        <th>Class</th>
                                        <th>Term</th>
                                        <th>Average Grade</th>
                                        <th>Position</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="report-cards-tbody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            Loading report cards...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Report Card Preview Modal -->
    <div class="modal fade" id="reportCardModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Report Card Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="report-card-preview" id="reportCardPreview">
                        <!-- Professional Report Card Template -->
                        <div class="report-card-container" id="reportCardTemplate">
                            <!-- Header Section -->
                            <div class="report-header">
                                <div class="row align-items-center">
                                    <div class="col-md-3 text-center">
                                        <div class="school-logo-container">
                                            <div class="circular-logo">
                                                <div class="logo-text-outer">
                                                    <div class="logo-text-top">ADILANG INSTITUTION</div>
                                                    <div class="logo-text-bottom">WE OF HEBE</div>
                                                </div>
                                                <div class="logo-inner">
                                                    <div class="book-sun-icon">📚☀️⭐</div>
                                                    <div class="logo-code">E2ID:3000</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-center">
                                        <h2 class="mb-1" id="schoolName">ADILANG SECONDARY SCHOOL</h2>
                                        <p class="mb-1" id="schoolAddress">P.O.BOX 13, PADER-AGAGO DISTRICT</p>
                                        <p class="mb-1" id="schoolPhone">TEL: 0773221580/0782634466/0782446279/0770685882</p>
                                        <h4 class="mb-1" id="reportTitle">END OF TERM THREE ASSESSMENT REPORT CARD 2025</h4>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="student-photo-container">
                                            <img src="https://via.placeholder.com/120x150/cccccc/666666?text=Photo" alt="Student Photo" class="student-photo" id="studentPhoto">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Student Information -->
                            <div class="p-4">
                                <div class="student-details-section mb-4">
                                    <div class="student-info-line">
                                        <span class="fw-bold">STUDENT'S NAME:</span>
                                        <span class="dotted-line" id="studentNameLine">................................................</span>
                                        <span class="fw-bold">SEX:</span>
                                        <span class="dotted-line" id="studentSexLine">................................</span>
                                        <span class="fw-bold">CLASS:</span>
                                        <span class="dotted-line" id="studentClassLine">................................</span>
                                    </div>
                                    <div class="student-info-line">
                                        <span class="fw-bold">STREAM:</span>
                                        <span class="dotted-line" id="studentStreamLine">................................</span>
                                        <span class="fw-bold">LIN:</span>
                                        <span class="dotted-line" id="studentLinLine">................................</span>
                                        <span class="fw-bold">PAYMENT CODE:</span>
                                        <span class="dotted-line" id="paymentCodeLine">................................</span>
                                    </div>
                                </div>
                                
                                <!-- Academic Performance Table -->
                                <div class="table-responsive">
                                    <table class="table table-bordered report-table" id="academicTable">
                                        <thead>
                                            <tr>
                                                <th>S/N</th>
                                                <th>SUBJECT</th>
                                                <th>AOI/AV (20%)</th>
                                                <th>EOT (80%)</th>
                                                <th>TOTAL (100%)</th>
                                                <th>GRADE</th>
                                                <th>POS</th>
                                                <th>REMARKS</th>
                                                <th>TR INIT</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subjectsTableBody">
                                            <!-- Subjects will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Grading Keys Section -->
                                <div class="row mt-3 mb-3">
                                    <div class="col-12">
                                        <h6 class="fw-bold mb-2">GRADING SYSTEM</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-dark">
                                                        <tr><th colspan="3">Grade Scale</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr class="grade-excellent"><td>A</td><td>80-100%</td><td>Excellent</td></tr>
                                                        <tr class="grade-very-good"><td>B</td><td>65-79%</td><td>Very Good</td></tr>
                                                        <tr class="grade-good"><td>C</td><td>50-64%</td><td>Good</td></tr>
                                                        <tr class="grade-fair"><td>D</td><td>40-49%</td><td>Fair</td></tr>
                                                        <tr class="grade-poor"><td>E</td><td>Below 40%</td><td>Poor</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="col-md-6">
                                                <table class="table table-sm table-bordered">
                                                    <thead class="table-dark">
                                                        <tr><th colspan="2">Assessment Weight</th></tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr><td class="fw-bold">Mid-term</td><td>20%</td></tr>
                                                        <tr><td class="fw-bold">End-term</td><td>80%</td></tr>
                                                        <tr><td class="fw-bold">Total</td><td>100%</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Section -->
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">PERFORMANCE SUMMARY</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr><td class="fw-bold">Overall Average:</td><td id="overallAverage">-</td></tr>
                                            <tr><td class="fw-bold">Overall Grade:</td><td id="overallGrade">-</td></tr>
                                            <tr><td class="fw-bold">Total Subjects:</td><td id="totalSubjects">-</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="fw-bold">CLASS RANKING</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr><td class="fw-bold">Position:</td><td id="rankingPosition">-</td></tr>
                                            <tr><td class="fw-bold">Out of:</td><td id="rankingOutOf">-</td></tr>
                                            <tr><td class="fw-bold">Status:</td><td id="academicStatus">-</td></tr>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Comments Section -->
                                <div class="mt-4">
                                    <h6 class="fw-bold">TEACHER'S COMMENTS</h6>
                                    <div class="border rounded p-3" id="teacherComments">
                                        <!-- Comments will be populated here -->
                                    </div>
                                </div>
                                
                                <!-- Signatures Section -->
                                <div class="row mt-4">
                                    <div class="col-md-4 text-center">
                                        <p class="fw-bold mb-1">Class Teacher</p>
                                        <div class="border-bottom mb-2" style="height: 40px;"></div>
                                        <p class="small mb-0">Date: <span id="teacherDate">-</span></p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <p class="fw-bold mb-1">Head Teacher</p>
                                        <div class="border-bottom mb-2" style="height: 40px;"></div>
                                        <p class="small mb-0">Date: <span id="headTeacherDate">-</span></p>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <p class="fw-bold mb-1">Bursar</p>
                                        <div class="border-bottom mb-2" style="height: 40px;"></div>
                                        <p class="small mb-0">Fees Balance: <span id="feesBalance">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success btn-lg" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Generate PDF Report Card
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printReportCard()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button type="button" class="btn btn-success" onclick="distributeReportCard()">
                        <i class="fas fa-share"></i> Distribute
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- html2pdf.js for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- A4 Test Script -->
    <script src="a4-test-script.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/dos-utils.js"></script>
    <script src="../../assets/js/users/dos.js"></script>
    <script>
        // DOS Report Cards - Dynamic Firestore Integration
        let students = [];
        let classes = [];
        let subjects = [];
        let grades = [];
        let terms = [];
        let reportCards = [];
        
        // Initialize Report Cards page
        async function initializeReportCards() {
            try {
                showLoading('Loading report cards...');
                
                // Initialize DOS utilities
                await DOSUtils.initializeDOSUtils();
                
                // Wait for authentication and get the user
                currentUser = await DOSUtils.waitForAuth();
                
                // Load user data and check role
                const userResult = await DOSUtils.loadDOSUserData(db, currentUser);
                if (!userResult.success) {
                    showError(userResult.error);
                    return;
                }
                
                // Update UI with user data
                DOSUtils.updateUserDisplay(userResult);
                
                // Load all data from Firestore
                await loadAllReportCardsData();
                
                // Setup real-time listeners
                setupRealTimeListeners();
                
                // Initialize page display
                testFunction(); // Test if functions are defined
            displayReportCards();
                updateReportCardsStatistics();
                
                hideLoading();
                console.log('✅ Report cards page initialized successfully');
                
            } catch (error) {
                console.error('Error initializing report cards page:', error);
                showError('Failed to initialize report cards page. Please refresh and try again.');
                hideLoading();
            }
        }
        
        // Load all report cards data from Firestore
        async function loadAllReportCardsData() {
            try {
                console.log('📋 Loading all report cards data from Firestore...');
                
                // Load all data in parallel
                const [studentsData, classesData, subjectsData, gradesData, termsData] = await Promise.all([
                    loadStudents(),
                    DOSUtils.loadClasses(),
                    DOSUtils.loadSubjects(),
                    loadGrades(),
                    loadTerms()
                ]);
                
                students = studentsData;
                classes = classesData;
                subjects = subjectsData;
                grades = gradesData;
                terms = termsData;
                
                // Process report cards data
                processReportCardsData();
                
                console.log('✅ All report cards data loaded:', {
                    students: students.length,
                    classes: classes.length,
                    subjects: subjects.length,
                    grades: grades.length,
                    terms: terms.length,
                    reportCards: reportCards.length
                });
                
            } catch (error) {
                console.error('Error loading report cards data:', error);
                showError('Failed to load report cards data. Please try again.');
            }
        }
        
        // Load students from Firestore
        async function loadStudents() {
            try {
                console.log('👥 Loading students from Firestore...');
                const studentsSnapshot = await db.collection('students').orderBy('createdAt', 'desc').get();
                const studentsData = [];
                
                console.log('👥 Students snapshot size:', studentsSnapshot.size);
                
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    console.log('👥 Student document:', doc.id, studentData);
                    studentsData.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                console.log(`✅ Loaded ${studentsData.length} students from Firestore`);
                return studentsData;
                
            } catch (error) {
                console.error('Error loading students:', error);
                return [];
            }
        }
        
        // Load grades from Firestore
        async function loadGrades() {
            try {
                console.log('📊 Loading grades from Firestore...');
                const gradesSnapshot = await db.collection('grades').orderBy('createdAt', 'desc').get();
                const gradesData = [];
                
                console.log('📊 Grades snapshot size:', gradesSnapshot.size);
                
                gradesSnapshot.forEach(doc => {
                    const gradeData = doc.data();
                    console.log('📊 Grade document:', doc.id, gradeData);
                    gradesData.push({
                        id: doc.id,
                        ...gradeData
                    });
                });
                
                console.log(`✅ Loaded ${gradesData.length} grades from Firestore`);
                return gradesData;
                
            } catch (error) {
                console.error('Error loading grades:', error);
                return [];
            }
        }
        
        // Load terms from Firestore
        async function loadTerms() {
            try {
                console.log('📅 Loading terms from Firestore...');
                const termsSnapshot = await db.collection('terms').orderBy('createdAt', 'desc').get();
                const termsData = [];
                
                console.log('📅 Terms snapshot size:', termsSnapshot.size);
                
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    console.log('📅 Term document:', doc.id, termData);
                    termsData.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                console.log(`✅ Loaded ${termsData.length} terms from Firestore`);
                return termsData;
                
            } catch (error) {
                console.error('Error loading terms:', error);
                return [];
            }
        }
        
        // Process report cards data
        function processReportCardsData() {
            reportCards = [];
            
            console.log('📋 Processing report cards data...');
            console.log('Students to process:', students.length);
            console.log('Classes available:', classes.length);
            console.log('Grades available:', grades.length);
            
            students.forEach(student => {
                // Get student's class - try multiple ways to match
                const studentClass = classes.find(cls => 
                    cls.id === student.academicInfo?.classId || 
                    cls.name === student.academicInfo?.className ||
                    cls.name === student.class ||
                    cls.id === student.class
                );
                
                if (!studentClass) {
                    console.log(`⚠️ No class found for student ${student.personalInfo?.fullName || student.id}`);
                    return;
                }
                
                // Get student's grades - match the structure from grade-entry.html
                const studentGrades = grades.filter(grade => grade.studentId === student.id);
                
                console.log(`🔍 Checking grades for student ${student.id}:`, {
                    studentId: student.id,
                    totalGrades: grades.length,
                    studentGrades: studentGrades.length,
                    gradeIds: grades.map(g => g.studentId).slice(0, 5), // Show first 5 grade student IDs
                    sampleGrade: grades.length > 0 ? grades[0] : null // Show structure of first grade
                });
                
                if (studentGrades.length === 0) {
                    console.log(`⚠️ No grades found for student ${student.personalInfo?.fullName || student.id}`);
                    return;
                }
                
                // Group grades by term - use the correct field name from grade-entry.html
                const termGroups = {};
                studentGrades.forEach(grade => {
                    const termId = grade.term || grade.termId || 'current';
                    if (!termGroups[termId]) {
                        termGroups[termId] = [];
                    }
                    termGroups[termId].push(grade);
                });
                
                // Process each term
                Object.keys(termGroups).forEach(termId => {
                    const termGrades = termGroups[termId];
                    // If no terms exist in database, create a default term
                    const term = terms.find(t => t.id === termId) || { 
                        name: termId === 'current' ? 'Current Term' : `Term ${termId}`, 
                        id: termId 
                    };
                    
                    // Calculate average grade - use the structure from grade-entry.html
                    let totalScore = 0;
                    let validGrades = 0;
                    
                    termGrades.forEach(grade => {
                        // Check for finalGrade.percentage first (from grade-entry.html)
                        if (grade.finalGrade && grade.finalGrade.percentage && !isNaN(grade.finalGrade.percentage)) {
                            totalScore += parseFloat(grade.finalGrade.percentage);
                            validGrades++;
                        }
                        // Fallback to old structure
                        else if (grade.score && !isNaN(grade.score)) {
                            totalScore += parseFloat(grade.score);
                            validGrades++;
                        }
                    });
                    
                    if (validGrades === 0) return;
                    
                    const averageScore = totalScore / validGrades;
                    const averageGrade = calculateGrade(averageScore);
                    
                    // Calculate position (simplified - would need more complex logic in real implementation)
                    const position = calculatePosition(student.id, studentClass.id, termId);
                    
                    // Determine status
                    const status = validGrades >= 5 ? 'Generated' : 'Pending';
                    
                    reportCards.push({
                        studentId: student.id,
                        studentName: student.personalInfo?.fullName || 
                                   `${student.personalInfo?.firstName || ''} ${student.personalInfo?.lastName || ''}`.trim() || 
                                   'Unknown Student',
                        class: studentClass.name,
                        term: term.name,
                        averageGrade: averageGrade,
                        averageScore: averageScore.toFixed(1),
                        position: position,
                        status: status,
                        totalSubjects: validGrades,
                        termId: termId,
                        classId: studentClass.id
                    });
                });
            });
            
            console.log('📋 Report cards data processed:', reportCards.length, 'cards');
        }
        
        // Calculate grade from score
        function calculateGrade(score) {
            if (score >= 80) return 'A';
            if (score >= 65) return 'B';
            if (score >= 50) return 'C';
            if (score >= 40) return 'D';
            return 'E';
        }
        
        // Calculate position (simplified implementation)
        function calculatePosition(studentId, classId, termId) {
            // Get all students in the same class - try multiple ways to match
            const classStudents = students.filter(student => {
                const studentClass = classes.find(cls => 
                    cls.id === student.academicInfo?.classId || 
                    cls.name === student.academicInfo?.className ||
                    cls.name === student.class ||
                    cls.id === student.class
                );
                return studentClass && studentClass.id === classId;
            });
            
            // Calculate average scores for all students in this term
            const studentAverages = classStudents.map(student => {
                const studentGrades = grades.filter(grade => 
                    grade.studentId === student.id && 
                    (grade.term === termId || grade.termId === termId || (!grade.term && !grade.termId && termId === 'current'))
                );
                
                if (studentGrades.length === 0) return { studentId: student.id, average: 0 };
                
                let totalScore = 0;
                let validGrades = 0;
                
                studentGrades.forEach(grade => {
                    // Check for finalGrade.percentage first (from grade-entry.html)
                    if (grade.finalGrade && grade.finalGrade.percentage && !isNaN(grade.finalGrade.percentage)) {
                        totalScore += parseFloat(grade.finalGrade.percentage);
                        validGrades++;
                    }
                    // Fallback to old structure
                    else if (grade.score && !isNaN(grade.score)) {
                        totalScore += parseFloat(grade.score);
                        validGrades++;
                    }
                });
                
                return {
                    studentId: student.id,
                    average: validGrades > 0 ? totalScore / validGrades : 0
                };
            });
            
            // Sort by average score
            studentAverages.sort((a, b) => b.average - a.average);
            
            // Find position
            const position = studentAverages.findIndex(s => s.studentId === studentId) + 1;
            
            return `${position}${getOrdinalSuffix(position)}`;
        }
        
        // Get ordinal suffix
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j === 1 && k !== 11) return 'st';
            if (j === 2 && k !== 12) return 'nd';
            if (j === 3 && k !== 13) return 'rd';
            return 'th';
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            try {
                // Listen for students changes
                db.collection('students').onSnapshot((snapshot) => {
                    console.log('👥 Students collection updated');
                    loadAllReportCardsData().then(() => {
                        displayReportCards();
                        updateReportCardsStatistics();
                    });
                });
                
                // Listen for grades changes
                db.collection('grades').onSnapshot((snapshot) => {
                    console.log('📊 Grades collection updated');
                    loadAllReportCardsData().then(() => {
                        displayReportCards();
                        updateReportCardsStatistics();
                    });
                });
                
            } catch (error) {
                console.error('Error setting up real-time listeners:', error);
            }
        }
        
        // Update report cards statistics
        function updateReportCardsStatistics() {
            try {
                const totalStudents = students.length;
                const totalClasses = classes.length;
                const generatedCards = reportCards.filter(card => card.status === 'Generated').length;
                const pendingCards = reportCards.filter(card => card.status === 'Pending').length;
                
                // Update statistics display
                const statTotalStudents = document.getElementById('stat-total-students');
                const statTotalClasses = document.getElementById('stat-total-classes');
                const statGeneratedCards = document.getElementById('stat-generated-cards');
                const statPendingCards = document.getElementById('stat-pending-cards');
                
                if (statTotalStudents) statTotalStudents.textContent = totalStudents;
                if (statTotalClasses) statTotalClasses.textContent = totalClasses;
                if (statGeneratedCards) statGeneratedCards.textContent = generatedCards;
                if (statPendingCards) statPendingCards.textContent = pendingCards;
                
                console.log('📊 Report cards statistics updated:', {
                    totalStudents,
                    totalClasses,
                    generatedCards,
                    pendingCards
                });
                
            } catch (error) {
                console.error('Error updating report cards statistics:', error);
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for Firebase to load
            setTimeout(() => {
                initializeReportCards();
            }, 1000);
        });
        
        // Make functions globally available
        window.initializeReportCards = initializeReportCards;
        window.viewReportCard = viewReportCard;
        window.printReportCard = printReportCard;
        window.distributeReportCard = distributeReportCard;
        window.logout = DOSUtils.logout;
        
        function getGradeColor(grade) {
            switch(grade) {
                case 'A': return 'bg-success';
                case 'B': return 'bg-primary';
                case 'C': return 'bg-info';
                case 'D': return 'bg-warning';
                case 'E': return 'bg-danger';
                case 'F': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'generated': return 'bg-primary';
                case 'printed': return 'bg-info';
                case 'distributed': return 'bg-success';
                case 'pending': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }
        
        function viewReportCard(studentId) {
            const card = reportCards.find(c => c.studentId === studentId);
            if (!card) return;
            
            // Populate the report card template with actual data
            populateReportCardTemplate(card);
            
            // Generate PDF directly instead of showing modal
            setTimeout(() => {
                exportToPDF();
            }, 500); // Small delay to ensure template is populated
        }
        
        // Populate report card template with actual data - Updated for new template structure
        function populateReportCardTemplate(card) {
            // Get student details
            const student = students.find(s => s.id === card.studentId);
            const studentClass = classes.find(c => c.name === card.class);
            
            // Get student's grades for this term - use correct field names
            const studentGrades = grades.filter(grade => 
                grade.studentId === card.studentId && 
                (grade.term === card.termId || grade.termId === card.termId || (!grade.term && !grade.termId && card.termId === 'current'))
            );
            
            // Group grades by subject
            const subjectGrades = {};
            studentGrades.forEach(grade => {
                const subject = subjects.find(s => s.id === grade.subjectId);
                if (subject) {
                    if (!subjectGrades[subject.name]) {
                        subjectGrades[subject.name] = [];
                    }
                    subjectGrades[subject.name].push(grade);
                }
            });
            
            // Calculate current date
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Populate header information
            document.getElementById('schoolName').textContent = 'ADILANG SECONDARY SCHOOL';
            document.getElementById('schoolAddress').textContent = 'P.O.BOX 13, PADER-AGAGO DISTRICT';
            document.getElementById('schoolPhone').textContent = 'TEL: 0773221580/0782634466/0782446279/0770685882';
            document.getElementById('reportTitle').textContent = 'END OF TERM THREE ASSESSMENT REPORT CARD 2025';
            
            // Populate student information - improved name loading with debugging
            console.log('Student data:', student);
            console.log('Card data:', card);
            
            const studentName = student?.personalInfo?.fullName || 
                               `${student?.personalInfo?.firstName || ''} ${student?.personalInfo?.lastName || ''}`.trim() ||
                               student?.name ||
                               card.studentName ||
                               'Unknown Student';
            
            console.log('Resolved student name:', studentName);
            
            // Populate student information in dotted line format
            document.getElementById('studentNameLine').textContent = studentName;
            document.getElementById('studentSexLine').textContent = student?.sex || student?.gender || 'M';
            document.getElementById('studentClassLine').textContent = card.class;
            document.getElementById('studentStreamLine').textContent = card.class; // Using class as stream
            document.getElementById('studentLinLine').textContent = student?.admissionNumber || student?.studentId || card.studentId;
            document.getElementById('paymentCodeLine').textContent = student?.paymentCode || 'PC001';
            
            // Calculate and populate fees balance (sample calculation)
            const feesBalance = student?.feesBalance || Math.floor(Math.random() * 500000) + 100000; // Random amount between 100,000-600,000
            document.getElementById('feesBalance').textContent = `UGX ${feesBalance.toLocaleString()}`;
            
            // Populate subjects table with 14 rows (filled + blank)
            const subjectsTableBody = document.getElementById('subjectsTableBody');
            subjectsTableBody.innerHTML = '';
            
            let totalScore = 0;
            let subjectCount = 0;
            
            // First, add rows for subjects with grades
            Object.keys(subjectGrades).forEach(subjectName => {
                const grades = subjectGrades[subjectName];
                const grade = grades[0]; // Take the first grade for this subject
                
                // Use the structure from grade-entry.html
                const midTerm = grade?.scores?.midterm || 0;
                const endTerm = grade?.scores?.endterm || 0;
                const total = grade?.finalGrade?.percentage || ((midTerm * 0.2) + (endTerm * 0.8));
                const letterGrade = grade?.finalGrade?.letterGrade || calculateGrade(total);
                
                // Calculate totals
                totalScore += total;
                subjectCount++;
                
                // Create table row with S/N
                const rowNumber = subjectCount;
                const subjectPosition = calculateSubjectPosition(card.studentId, grade.subjectId, card.termId);
                const teacherInitials = getTeacherInitials(subjectName, card.class);
                const subjectRemark = generateSubjectRemark(letterGrade, total, subjectName);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rowNumber}</td>
                    <td class="fw-bold">${subjectName}</td>
                    <td>${midTerm}</td>
                    <td>${endTerm}</td>
                    <td>${total.toFixed(1)}</td>
                    <td class="${getGradeClass(letterGrade)}">${letterGrade}</td>
                    <td>${subjectPosition}</td>
                    <td>${subjectRemark}</td>
                    <td>${teacherInitials}</td>
                `;
                subjectsTableBody.appendChild(row);
            });
            
            // Add blank rows to make total of 14 subjects
            const filledSubjects = Object.keys(subjectGrades).length;
            const blankRowsNeeded = Math.max(0, 14 - filledSubjects);
            
            for (let i = 0; i < blankRowsNeeded; i++) {
                const blankRowNumber = filledSubjects + i + 1;
                const blankRemark = generateBlankSubjectRemark();
                const blankRow = document.createElement('tr');
                blankRow.innerHTML = `
                    <td class="text-muted">${blankRowNumber}</td>
                    <td class="fw-bold text-muted">-</td>
                    <td class="text-muted">-</td>
                    <td class="text-muted">-</td>
                    <td class="text-muted">-</td>
                    <td class="text-muted">-</td>
                    <td class="text-muted">-</td>
                    <td class="text-muted">${blankRemark}</td>
                    <td class="text-muted">-</td>
                `;
                subjectsTableBody.appendChild(blankRow);
            }
            
            // Calculate and populate summary
            const overallAverage = subjectCount > 0 ? (totalScore / subjectCount).toFixed(1) : '0.0';
            const overallGrade = calculateGrade(overallAverage);
            
            document.getElementById('overallAverage').textContent = `${overallAverage}%`;
            document.getElementById('overallGrade').textContent = overallGrade;
            document.getElementById('totalSubjects').textContent = subjectCount;
            
            // Populate ranking information
            document.getElementById('rankingPosition').textContent = card.position;
            document.getElementById('rankingOutOf').textContent = students.filter(s => s.class === card.class).length;
            document.getElementById('academicStatus').textContent = card.status;
            
            // Populate teacher comments with automatic generation
            const automaticComments = generateClassTeacherComments(card);
            document.getElementById('teacherComments').textContent = automaticComments;
            
            // Populate dates
            document.getElementById('teacherDate').textContent = currentDate;
            document.getElementById('headTeacherDate').textContent = currentDate;
            
            // Update student photo if available
            const studentPhoto = document.getElementById('studentPhoto');
            if (student?.photoUrl) {
                studentPhoto.src = student.photoUrl;
                studentPhoto.alt = `${studentName} Photo`;
            } else {
                studentPhoto.src = 'https://via.placeholder.com/120x150/cccccc/666666?text=Photo';
                studentPhoto.alt = 'Student Photo Placeholder';
            }
        }
        
        // Generate teacher comment based on performance
        // Helper function to get grade CSS class for professional styling
        function getGradeClass(grade) {
            switch(grade) {
                case 'A': return 'grade-excellent';
                case 'B': return 'grade-very-good';
                case 'C': return 'grade-good';
                case 'D': return 'grade-fair';
                case 'E': return 'grade-poor';
                default: return '';
            }
        }
        
        // Helper function to get grade remark
        function getGradeRemark(grade) {
            switch(grade) {
                case 'A': return 'Excellent';
                case 'B': return 'Very Good';
                case 'C': return 'Good';
                case 'D': return 'Fair';
                case 'E': return 'Poor';
                default: return 'N/A';
            }
        }
        
        // Helper function to generate automatic remarks based on performance
        function generateAutomaticRemarks(card) {
            const grades = card.grades || [];
            const totalSubjects = grades.length;
            
            if (totalSubjects === 0) {
                return "No grades available for this term.";
            }
            
            // Calculate grade distribution
            const gradeCounts = { A: 0, B: 0, C: 0, D: 0, E: 0 };
            let totalScore = 0;
            let subjectCount = 0;
            
            grades.forEach(grade => {
                const letterGrade = grade.finalGrade?.letterGrade;
                if (letterGrade && gradeCounts.hasOwnProperty(letterGrade)) {
                    gradeCounts[letterGrade]++;
                }
                
                const percentage = grade.finalGrade?.percentage;
                if (percentage) {
                    totalScore += percentage;
                    subjectCount++;
                }
            });
            
            const averageScore = subjectCount > 0 ? totalScore / subjectCount : 0;
            const overallGrade = calculateOverallGrade(averageScore);
            
            // Generate remarks based on performance
            let remarks = [];
            
            // Overall performance remark
            if (overallGrade === 'A') {
                remarks.push("Outstanding performance across all subjects. Demonstrates exceptional mastery and consistent excellence.");
            } else if (overallGrade === 'B') {
                remarks.push("Very good performance with strong understanding in most subjects. Shows consistent effort and dedication.");
            } else if (overallGrade === 'C') {
                remarks.push("Good performance with satisfactory understanding. Shows potential for improvement with continued effort.");
            } else if (overallGrade === 'D') {
                remarks.push("Fair performance with some areas needing attention. Requires more focused study and consistent effort.");
            } else if (overallGrade === 'E') {
                remarks.push("Performance below expectations. Immediate intervention and additional support required.");
            }
            
            // Subject-specific remarks
            if (gradeCounts.A > 0) {
                remarks.push(`Excellent work in ${gradeCounts.A} subject${gradeCounts.A > 1 ? 's' : ''}.`);
            }
            
            if (gradeCounts.E > 0) {
                remarks.push(`${gradeCounts.E} subject${gradeCounts.E > 1 ? 's' : ''} require${gradeCounts.E === 1 ? 's' : ''} immediate attention and remedial support.`);
            }
            
            // Improvement suggestions
            if (averageScore < 50) {
                remarks.push("Recommend additional tutoring and regular study schedule to improve performance.");
            } else if (averageScore < 65) {
                remarks.push("Continue working hard and seek help in challenging subjects to reach full potential.");
            } else if (averageScore >= 80) {
                remarks.push("Maintain this excellent standard and consider taking on additional challenges.");
            }
            
            // Attendance and behavior (if available)
            if (card.attendance && card.attendance < 80) {
                remarks.push("Regular attendance is crucial for academic success. Please ensure consistent school attendance.");
            }
            
            return remarks.join(' ');
        }
        
        // Helper function to calculate overall grade from average
        function calculateOverallGrade(average) {
            if (average >= 80) return 'A';
            if (average >= 65) return 'B';
            if (average >= 50) return 'C';
            if (average >= 40) return 'D';
            return 'E';
        }
        
        // Helper function to generate remarks for blank subjects
        function generateBlankSubjectRemark() {
            const blankRemarks = [
                'Not assessed this term',
                'Subject not offered',
                'Assessment pending',
                'No data available',
                'To be determined',
                'Not evaluated',
                'Assessment incomplete',
                'Subject not taken'
            ];
            
            return blankRemarks[Math.floor(Math.random() * blankRemarks.length)];
        }
        
        // Helper function to generate subject-specific remarks
        function generateSubjectRemark(grade, score, subjectName) {
            const remarks = {
                'A': [
                    'Outstanding performance! Excellent understanding and application.',
                    'Exceptional work! Demonstrates mastery of concepts.',
                    'Excellent! Shows deep understanding and critical thinking.',
                    'Outstanding! Consistent excellence in this subject.'
                ],
                'B': [
                    'Very good work! Strong understanding demonstrated.',
                    'Good performance! Shows solid grasp of concepts.',
                    'Well done! Consistent effort and understanding.',
                    'Very good! Continue this excellent progress.'
                ],
                'C': [
                    'Good work! Shows understanding with room for improvement.',
                    'Satisfactory performance! Keep working hard.',
                    'Good effort! Focus on challenging areas.',
                    'Decent work! Continue practicing regularly.'
                ],
                'D': [
                    'Needs improvement. Focus on understanding basic concepts.',
                    'Below average. Requires more study time and effort.',
                    'Needs attention. Seek help from teacher or peers.',
                    'Requires improvement. Practice more regularly.'
                ],
                'E': [
                    'Poor performance. Immediate remedial support needed.',
                    'Below expectations. Intensive study required.',
                    'Needs urgent attention. Consider extra tutoring.',
                    'Requires immediate intervention and support.'
                ]
            };
            
            // Get random remark for the grade
            const gradeRemarks = remarks[grade] || ['N/A'];
            const randomRemark = gradeRemarks[Math.floor(Math.random() * gradeRemarks.length)];
            
            // Add subject-specific context
            if (grade === 'A' || grade === 'B') {
                return `${randomRemark} Strong foundation in ${subjectName}.`;
            } else if (grade === 'C') {
                return `${randomRemark} Focus on ${subjectName} fundamentals.`;
            } else {
                return `${randomRemark} Priority subject: ${subjectName}.`;
            }
        }
        
        // Helper function to generate class teacher comments
        function generateClassTeacherComments(card) {
            const grades = card.grades || [];
            const totalSubjects = grades.length;
            
            if (totalSubjects === 0) {
                return "Student needs to engage more actively in academic activities.";
            }
            
            // Calculate performance metrics
            let totalScore = 0;
            let subjectCount = 0;
            let excellentSubjects = 0;
            let poorSubjects = 0;
            
            grades.forEach(grade => {
                const percentage = grade.finalGrade?.percentage;
                if (percentage) {
                    totalScore += percentage;
                    subjectCount++;
                    
                    if (percentage >= 80) excellentSubjects++;
                    if (percentage < 40) poorSubjects++;
                }
            });
            
            const averageScore = subjectCount > 0 ? totalScore / subjectCount : 0;
            
            // Generate contextual comments
            let comments = [];
            
            if (averageScore >= 80) {
                comments.push(`${card.studentName || 'This student'} has demonstrated exceptional academic performance this term.`);
                comments.push("The student shows strong leadership qualities and is a positive influence on peers.");
                comments.push("Continue to maintain this high standard and consider mentoring other students.");
            } else if (averageScore >= 65) {
                comments.push(`${card.studentName || 'This student'} has shown consistent improvement and dedication to studies.`);
                comments.push("The student participates actively in class and shows good understanding of concepts.");
                comments.push("With continued effort, the student can achieve even better results.");
            } else if (averageScore >= 50) {
                comments.push(`${card.studentName || 'This student'} has made satisfactory progress this term.`);
                comments.push("The student shows potential but needs to focus more on challenging subjects.");
                comments.push("Regular study habits and seeking help when needed will improve performance.");
            } else if (averageScore >= 40) {
                comments.push(`${card.studentName || 'This student'} needs to improve academic performance significantly.`);
                comments.push("The student requires additional support and more focused study time.");
                comments.push("Parents/guardians should be involved in monitoring study habits at home.");
            } else {
                comments.push(`${card.studentName || 'This student'} requires immediate academic intervention.`);
                comments.push("The student needs intensive remedial support and regular monitoring.");
                comments.push("A meeting with parents/guardians is recommended to discuss improvement strategies.");
            }
            
            // Add specific subject comments
            if (excellentSubjects > 0) {
                comments.push(`Particularly strong performance in ${excellentSubjects} subject${excellentSubjects > 1 ? 's' : ''}.`);
            }
            
            if (poorSubjects > 0) {
                comments.push(`${poorSubjects} subject${poorSubjects > 1 ? 's' : ''} need${poorSubjects === 1 ? 's' : ''} immediate attention and remedial support.`);
            }
            
            // Add behavioral comments
            comments.push("The student is encouraged to maintain good conduct and participate actively in school activities.");
            
            return comments.join(' ');
        }
        
        // Helper function to get teacher initials from actual teacher name
        function getTeacherInitials(subjectName, studentClass) {
            // Find the teacher assigned to this subject and class
            const teacherAssignment = findTeacherForSubject(subjectName, studentClass);
            
            if (teacherAssignment && teacherAssignment.teacherName) {
                return generateInitialsFromName(teacherAssignment.teacherName);
            }
            
            // Fallback to sample initials if no teacher found
            const sampleTeacherMap = {
                'Mathematics': 'JM',
                'English Language': 'BK',
                'Integrated Science': 'AS',
                'History': 'MN',
                'Geography': 'LP',
                'Art & Design': 'RT',
                'Physics': 'OS',
                'Chemistry': 'MW',
                'Biology': 'FK',
                'Economics': 'DN',
                'Literature': 'GT',
                'Computer Studies': 'HC',
                'Agriculture': 'VM',
                'Business Studies': 'QZ'
            };
            return sampleTeacherMap[subjectName] || 'XX';
        }
        
        // Helper function to find teacher assigned to a subject and class
        function findTeacherForSubject(subjectName, studentClass) {
            // First, try to find in teacherAssignments collection data
            if (window.teacherAssignments && window.teacherAssignments.length > 0) {
                const assignment = window.teacherAssignments.find(ta => 
                    ta.subjectName === subjectName && 
                    ta.assignedClasses && 
                    ta.assignedClasses.includes(studentClass)
                );
                if (assignment) {
                    return {
                        teacherName: assignment.teacherName,
                        teacherId: assignment.teacherId
                    };
                }
            }
            
            // Second, try to find in users collection (teachers)
            if (window.teachers && window.teachers.length > 0) {
                const teacher = window.teachers.find(t => {
                    // Check if teacher is assigned to this subject and class
                    return t.academicInfo && 
                           t.academicInfo.assignedSubjects && 
                           t.academicInfo.assignedSubjects.some(subject => 
                               subject.name === subjectName || subject.id === subjectName
                           ) &&
                           t.academicInfo.assignedClasses && 
                           t.academicInfo.assignedClasses.includes(studentClass);
                });
                
                if (teacher) {
                    return {
                        teacherName: teacher.personalInfo?.fullName || 
                                   `${teacher.personalInfo?.firstName || ''} ${teacher.personalInfo?.lastName || ''}`.trim() ||
                                   teacher.name,
                        teacherId: teacher.id
                    };
                }
            }
            
            return null;
        }
        
        // Helper function to generate initials from full name
        function generateInitialsFromName(fullName) {
            if (!fullName || typeof fullName !== 'string') {
                return 'XX';
            }
            
            // Split name into words and filter out empty strings
            const nameParts = fullName.trim().split(/\s+/).filter(part => part.length > 0);
            
            if (nameParts.length === 0) {
                return 'XX';
            }
            
            if (nameParts.length === 1) {
                // If only one name, take first two characters
                return nameParts[0].substring(0, 2).toUpperCase();
            }
            
            // Take first letter of first name and first letter of last name
            const firstName = nameParts[0];
            const lastName = nameParts[nameParts.length - 1];
            
            return (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
        }
        
        // Helper function to calculate student position in a subject
        function calculateSubjectPosition(studentId, subjectId, termId) {
            // Get all students in the same class
            const student = students.find(s => s.id === studentId);
            if (!student) return 'N/A';
            
            const classStudents = students.filter(s => s.class === student.class);
            
            // Get grades for this subject and term for all students in the class
            const subjectGrades = [];
            
            classStudents.forEach(classStudent => {
                const studentGrades = grades.filter(grade => 
                    grade.studentId === classStudent.id && 
                    grade.subjectId === subjectId &&
                    (grade.term === termId || grade.termId === termId || (!grade.term && !grade.termId && termId === 'current'))
                );
                
                if (studentGrades.length > 0) {
                    const grade = studentGrades[0];
                    const total = grade?.finalGrade?.percentage || ((grade?.scores?.midterm || 0) * 0.2) + ((grade?.scores?.endterm || 0) * 0.8);
                    subjectGrades.push({
                        studentId: classStudent.id,
                        total: total
                    });
                }
            });
            
            // Sort by total score (descending)
            subjectGrades.sort((a, b) => b.total - a.total);
            
            // Find the position of the current student
            const position = subjectGrades.findIndex(grade => grade.studentId === studentId) + 1;
            
            if (position === 0) return 'N/A';
            
            // Return position with ordinal suffix
            return `${position}${getOrdinalSuffix(position)}`;
        }
        
        // Helper function to get ordinal suffix (1st, 2nd, 3rd, etc.)
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) {
                return "st";
            }
            if (j == 2 && k != 12) {
                return "nd";
            }
            if (j == 3 && k != 13) {
                return "rd";
            }
            return "th";
        }
        
        // Export to PDF using html2pdf.js - Optimized for single page
        function exportToPDF() {
            const element = document.getElementById('reportCardTemplate');
            if (!element) {
                alert('No report card to export. Please view a report card first.');
                return;
            }
            
            // Configure PDF options for A4 single page with 0.5in margins
            console.log('Generating PDF with A4 optimization...');
            console.log('Element dimensions:', element.offsetWidth, 'x', element.offsetHeight);
            
            const opt = {
                margin: [0.5, 0.5, 0.5, 0.5], // 0.5in margins as specified
                filename: `report_card_${document.getElementById('studentNameLine')?.textContent || 'student'}_${new Date().getFullYear()}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 1.5, // Reduced scale to prevent distortion
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#ffffff',
                    letterSpacing: 0, // Prevent text distortion
                    logging: false
                },
                jsPDF: { 
                    unit: 'in', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true,
                    precision: 2
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Add debug logging
            console.log('PDF options:', opt);
            
            // Show loading state (only if called from button click)
            let exportBtn = null;
            let originalText = '';
            if (event && event.target) {
                exportBtn = event.target;
                originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
                exportBtn.disabled = true;
            }
            
            // Generate PDF
            html2pdf().set(opt).from(element).save().then(() => {
                console.log('PDF generated successfully');
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. Please try again.');
            }).finally(() => {
                // Restore button state (only if button was found)
                if (exportBtn) {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                }
            });
        }
        
        function generateTeacherComment(averageScore, studentName) {
            const score = parseFloat(averageScore);
            if (score >= 80) {
                return `${studentName} has demonstrated excellent academic performance this term. The student shows exceptional understanding of the subjects and maintains consistent high performance. Keep up the excellent work!`;
            } else if (score >= 70) {
                return `${studentName} has shown very good academic progress this term. The student demonstrates solid understanding of the curriculum and participates actively in class activities. Continue to work hard to maintain this good performance.`;
            } else if (score >= 60) {
                return `${studentName} has made satisfactory progress this term. The student shows understanding of most concepts but needs to focus more on areas of weakness. With continued effort, better results can be achieved.`;
            } else if (score >= 50) {
                return `${studentName} has shown some improvement this term but needs to work harder to achieve better results. The student should focus on regular study habits and seek help when needed.`;
            } else {
                return `${studentName} needs to improve significantly in academic performance. The student should develop better study habits, attend all classes regularly, and seek additional help from teachers. Parental support is crucial at this time.`;
            }
        }
        
        function printReportCard(studentId) {
            if (studentId) {
                const card = reportCards.find(c => c.studentId === studentId);
                if (card) {
                    // Populate template with data
                    populateReportCardTemplate(card);
                    
                    // Wait a moment for template to render, then print
                    setTimeout(() => {
                        window.print();
                    }, 100);
                }
            } else {
                // Print current modal content
                window.print();
            }
        }
        
        function distributeReportCard(studentId) {
            if (studentId) {
                const card = reportCards.find(c => c.studentId === studentId);
                if (card) {
                    card.status = 'Distributed';
                    displayReportCards();
                    showNotification(`Report card for ${card.studentName} marked as distributed!`, 'success');
                }
            } else {
                showNotification('Report card marked as distributed!', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('reportCardModal'));
                modal.hide();
            }
        }
        
        function filterReportCards() {
            const classFilter = document.getElementById('class-filter').value;
            const term = document.getElementById('term-filter').value;
            const status = document.getElementById('status-filter').value;
            
            let filteredCards = reportCards;
            
            if (classFilter) {
                filteredCards = filteredCards.filter(c => c.class === classFilter);
            }
            
            if (status) {
                filteredCards = filteredCards.filter(c => c.status.toLowerCase() === status.toLowerCase());
            }
            
            displayFilteredReportCards(filteredCards);
        }
        
        // Display all report cards - Simplified version
        function displayReportCards() {
            console.log('📋 displayReportCards called, reportCards length:', reportCards.length);
            try {
                const tbody = document.getElementById('report-cards-tbody');
                if (!tbody) {
                    console.error('report-cards-tbody element not found');
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (reportCards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No report cards available</td></tr>';
                    return;
                }
                
                reportCards.forEach(card => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${card.studentId || 'N/A'}</td>
                        <td>${card.studentName || 'N/A'}</td>
                        <td>${card.class || 'N/A'}</td>
                        <td>${card.term || 'N/A'}</td>
                        <td><span class="badge ${getGradeColor(card.averageGrade)}">${card.averageGrade || 'N/A'}</span></td>
                        <td>${card.position || 'N/A'}</td>
                        <td><span class="badge ${getStatusColor(card.status)}">${card.status || 'N/A'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="viewReportCard('${card.studentId}')">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="printReportCard('${card.studentId}')">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="distributeReportCard('${card.studentId}')">
                                <i class="fas fa-share"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                console.log('✅ Report cards displayed successfully');
            } catch (error) {
                console.error('Error in displayReportCards:', error);
                showError('Error displaying report cards: ' + error.message);
            }
        }
        
        // Test function to verify function definition
        function testFunction() {
            console.log('✅ Test function is defined');
        }
        
        function displayFilteredReportCards(filteredCards) {
            const tbody = document.getElementById('report-cards-tbody');
            tbody.innerHTML = '';
            
            filteredCards.forEach(card => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.studentId}</td>
                    <td>${card.studentName}</td>
                    <td>${card.class}</td>
                    <td>${card.term}</td>
                    <td><span class="badge ${getGradeColor(card.averageGrade)}">${card.averageGrade}</span></td>
                    <td>${card.position}</td>
                    <td><span class="badge ${getStatusColor(card.status)}">${card.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="viewReportCard('${card.studentId}')">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="printReportCard('${card.studentId}')">
                            <i class="fas fa-print"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="distributeReportCard('${card.studentId}')">
                            <i class="fas fa-share"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function generateAllReportCards() {
            if (confirm('Are you sure you want to generate all report cards?')) {
                reportCards.forEach(card => {
                    if (card.status === 'Pending') {
                        card.status = 'Generated';
                    }
                });
                displayReportCards();
                showNotification('All report cards generated successfully!', 'success');
            }
        }
        
        function exportReportCards() {
            alert('Export Report Cards feature:\n\nThis will download the report cards as a PDF or Excel file.');
        }
        
        // Mobile Sidebar Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            // Toggle sidebar on mobile
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
                sidebarOverlay.classList.toggle('show');
            });
            
            // Close sidebar when clicking overlay
            sidebarOverlay.addEventListener('click', function() {
                sidebar.classList.remove('show');
                sidebarOverlay.classList.remove('show');
            });
            
            // Close sidebar when clicking on nav links (mobile)
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('show');
                        sidebarOverlay.classList.remove('show');
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }
            });
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../index.html';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeReportCards();
        });
        
        // Sample data for testing - can be removed in production
        function loadSampleData() {
            console.log('Loading sample data for testing...');
            
            // Sample student data
            const sampleStudent = {
                id: 'sample-student-001',
                personalInfo: {
                    fullName: 'John Doe',
                    firstName: 'John',
                    lastName: 'Doe'
                },
                admissionNumber: 'ADM001',
                class: 'S1',
                sex: 'M',
                dateOfBirth: { seconds: 946684800 }, // Jan 1, 2000
                photoUrl: 'https://via.placeholder.com/120x150/4a90e2/ffffff?text=JD',
                feesBalance: 250000, // Sample fees balance
                paymentCode: 'PC001'
            };
            
            // Sample grades data
            const sampleGrades = [
                {
                    id: 'grade-001',
                    studentId: 'sample-student-001',
                    subjectId: 'math-subject',
                    term: 'first-term',
                    scores: { midterm: 85, endterm: 90 },
                    finalGrade: { percentage: 89, letterGrade: 'A' }
                },
                {
                    id: 'grade-002',
                    studentId: 'sample-student-001',
                    subjectId: 'english-subject',
                    term: 'first-term',
                    scores: { midterm: 75, endterm: 80 },
                    finalGrade: { percentage: 79, letterGrade: 'B' }
                },
                {
                    id: 'grade-003',
                    studentId: 'sample-student-001',
                    subjectId: 'science-subject',
                    term: 'first-term',
                    scores: { midterm: 70, endterm: 75 },
                    finalGrade: { percentage: 74, letterGrade: 'B' }
                },
                {
                    id: 'grade-004',
                    studentId: 'sample-student-001',
                    subjectId: 'history-subject',
                    term: 'first-term',
                    scores: { midterm: 60, endterm: 65 },
                    finalGrade: { percentage: 64, letterGrade: 'C' }
                },
                {
                    id: 'grade-005',
                    studentId: 'sample-student-001',
                    subjectId: 'geography-subject',
                    term: 'first-term',
                    scores: { midterm: 55, endterm: 60 },
                    finalGrade: { percentage: 59, letterGrade: 'C' }
                },
                {
                    id: 'grade-006',
                    studentId: 'sample-student-001',
                    subjectId: 'art-subject',
                    term: 'first-term',
                    scores: { midterm: 45, endterm: 50 },
                    finalGrade: { percentage: 49, letterGrade: 'D' }
                }
            ];
            
            // Sample subjects data - 6 subjects with grades, 8 will be blank
            const sampleSubjects = [
                { id: 'math-subject', name: 'Mathematics' },
                { id: 'english-subject', name: 'English Language' },
                { id: 'science-subject', name: 'Integrated Science' },
                { id: 'history-subject', name: 'History' },
                { id: 'geography-subject', name: 'Geography' },
                { id: 'art-subject', name: 'Art & Design' },
                { id: 'physics-subject', name: 'Physics' },
                { id: 'chemistry-subject', name: 'Chemistry' },
                { id: 'biology-subject', name: 'Biology' },
                { id: 'economics-subject', name: 'Economics' },
                { id: 'literature-subject', name: 'Literature' },
                { id: 'computer-subject', name: 'Computer Studies' },
                { id: 'agriculture-subject', name: 'Agriculture' },
                { id: 'business-subject', name: 'Business Studies' }
            ];
            
            // Add sample data to global arrays
            students.push(sampleStudent);
            
            // Add more sample students for position calculation
            const additionalStudents = [
                {
                    id: 'sample-student-002',
                    personalInfo: { fullName: 'Jane Smith' },
                    admissionNumber: 'ADM002',
                    class: 'S1',
                    sex: 'F'
                },
                {
                    id: 'sample-student-003',
                    personalInfo: { fullName: 'Mike Johnson' },
                    admissionNumber: 'ADM003',
                    class: 'S1',
                    sex: 'M'
                },
                {
                    id: 'sample-student-004',
                    personalInfo: { fullName: 'Sarah Wilson' },
                    admissionNumber: 'ADM004',
                    class: 'S1',
                    sex: 'F'
                }
            ];
            
            students.push(...additionalStudents);
            
            // Add grades for additional students to demonstrate position calculation
            const additionalGrades = [
                // Jane Smith grades (better than John Doe)
                {
                    id: 'grade-007',
                    studentId: 'sample-student-002',
                    subjectId: 'math-subject',
                    term: 'first-term',
                    scores: { midterm: 90, endterm: 95 },
                    finalGrade: { percentage: 94, letterGrade: 'A' }
                },
                {
                    id: 'grade-008',
                    studentId: 'sample-student-002',
                    subjectId: 'english-subject',
                    term: 'first-term',
                    scores: { midterm: 85, endterm: 90 },
                    finalGrade: { percentage: 89, letterGrade: 'A' }
                },
                // Mike Johnson grades (worse than John Doe)
                {
                    id: 'grade-009',
                    studentId: 'sample-student-003',
                    subjectId: 'math-subject',
                    term: 'first-term',
                    scores: { midterm: 60, endterm: 65 },
                    finalGrade: { percentage: 64, letterGrade: 'C' }
                },
                {
                    id: 'grade-010',
                    studentId: 'sample-student-003',
                    subjectId: 'english-subject',
                    term: 'first-term',
                    scores: { midterm: 55, endterm: 60 },
                    finalGrade: { percentage: 59, letterGrade: 'C' }
                },
                // Sarah Wilson grades (middle performance)
                {
                    id: 'grade-011',
                    studentId: 'sample-student-004',
                    subjectId: 'math-subject',
                    term: 'first-term',
                    scores: { midterm: 75, endterm: 80 },
                    finalGrade: { percentage: 79, letterGrade: 'B' }
                },
                {
                    id: 'grade-012',
                    studentId: 'sample-student-004',
                    subjectId: 'english-subject',
                    term: 'first-term',
                    scores: { midterm: 70, endterm: 75 },
                    finalGrade: { percentage: 74, letterGrade: 'B' }
                }
            ];
            
            grades.push(...sampleGrades, ...additionalGrades);
            subjects.push(...sampleSubjects);
            
            // Add sample teacher data for initials demonstration
            const sampleTeachers = [
                {
                    id: 'teacher-001',
                    personalInfo: {
                        fullName: 'John Mwangi',
                        firstName: 'John',
                        lastName: 'Mwangi'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'Mathematics', id: 'math-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                },
                {
                    id: 'teacher-002',
                    personalInfo: {
                        fullName: 'Betty Kiprop',
                        firstName: 'Betty',
                        lastName: 'Kiprop'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'English Language', id: 'english-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                },
                {
                    id: 'teacher-003',
                    personalInfo: {
                        fullName: 'Andrew Ssemwogerere',
                        firstName: 'Andrew',
                        lastName: 'Ssemwogerere'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'Integrated Science', id: 'science-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                },
                {
                    id: 'teacher-004',
                    personalInfo: {
                        fullName: 'Mary Nakato',
                        firstName: 'Mary',
                        lastName: 'Nakato'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'History', id: 'history-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                },
                {
                    id: 'teacher-005',
                    personalInfo: {
                        fullName: 'Peter Lwanga',
                        firstName: 'Peter',
                        lastName: 'Lwanga'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'Geography', id: 'geography-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                },
                {
                    id: 'teacher-006',
                    personalInfo: {
                        fullName: 'Rose Tumusiime',
                        firstName: 'Rose',
                        lastName: 'Tumusiime'
                    },
                    academicInfo: {
                        assignedSubjects: [
                            { name: 'Art & Design', id: 'art-subject' }
                        ],
                        assignedClasses: ['S1']
                    }
                }
            ];
            
            // Make teachers globally available
            window.teachers = sampleTeachers;
            
            // Add sample teacher assignments
            const sampleTeacherAssignments = [
                {
                    teacherId: 'teacher-001',
                    teacherName: 'John Mwangi',
                    subjectName: 'Mathematics',
                    assignedClasses: ['S1']
                },
                {
                    teacherId: 'teacher-002',
                    teacherName: 'Betty Kiprop',
                    subjectName: 'English Language',
                    assignedClasses: ['S1']
                },
                {
                    teacherId: 'teacher-003',
                    teacherName: 'Andrew Ssemwogerere',
                    subjectName: 'Integrated Science',
                    assignedClasses: ['S1']
                },
                {
                    teacherId: 'teacher-004',
                    teacherName: 'Mary Nakato',
                    subjectName: 'History',
                    assignedClasses: ['S1']
                },
                {
                    teacherId: 'teacher-005',
                    teacherName: 'Peter Lwanga',
                    subjectName: 'Geography',
                    assignedClasses: ['S1']
                },
                {
                    teacherId: 'teacher-006',
                    teacherName: 'Rose Tumusiime',
                    subjectName: 'Art & Design',
                    assignedClasses: ['S1']
                }
            ];
            
            // Make teacher assignments globally available
            window.teacherAssignments = sampleTeacherAssignments;
            
            // Create sample report card
            const sampleCard = {
                studentId: 'sample-student-001',
                studentName: 'John Doe',
                class: 'S1',
                term: 'First Term',
                averageGrade: 'B',
                averageScore: '69.0',
                position: '5th',
                status: 'Generated',
                totalSubjects: 6,
                termId: 'first-term',
                classId: 's1'
            };
            
            reportCards.push(sampleCard);
            
            console.log('Sample data loaded successfully');
            console.log('Students:', students.length);
            console.log('Grades:', grades.length);
            console.log('Subjects:', subjects.length);
            console.log('Report Cards:', reportCards.length);
            
            // Refresh the display
            displayReportCards();
        }
        
        // Test function to demonstrate the report card - now generates PDF directly
        function testReportCard() {
            console.log('Testing report card PDF generation...');
            
            // Load sample data if not already loaded
            if (reportCards.length === 0) {
                loadSampleData();
            }
            
            // Find the sample report card
            const sampleCard = reportCards.find(card => card.studentId === 'sample-student-001');
            if (sampleCard) {
                populateReportCardTemplate(sampleCard);
                
                // Generate PDF directly instead of showing modal
                setTimeout(() => {
                    exportToPDF();
                }, 500);
                
                console.log('Sample report card PDF generated');
            } else {
                console.error('Sample report card not found');
            }
        }
        
        // Make test functions globally available
        window.testReportCard = testReportCard;
        window.loadSampleData = loadSampleData;
    </script>
    
    <style>
        .report-card-preview {
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        
        .report-card-template {
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .report-header {
            border-bottom: 3px solid #1a4f8b;
            padding-bottom: 20px;
        }
        
        .school-name {
            color: #1a4f8b;
            font-weight: bold;
            font-size: 1.8rem;
        }
        
        .report-title {
            color: #3a7cbd;
            font-weight: bold;
            font-size: 1.4rem;
        }
        
        .term-year {
            color: #666;
            font-size: 1.1rem;
        }
        
        .section-title {
            color: #1a4f8b;
            border-bottom: 2px solid #ff9e1b;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .student-info table td {
            padding: 5px 10px;
            vertical-align: top;
        }
        
        .academic-performance table {
            font-size: 0.9rem;
        }
        
        .academic-performance th {
            background-color: #1a4f8b !important;
            color: white !important;
            text-align: center;
            font-weight: bold;
        }
        
        .academic-performance td {
            text-align: center;
            vertical-align: middle;
        }
        
        .summary table td {
            padding: 5px 10px;
        }
        
        .comment-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6 !important;
            font-style: italic;
        }
        
        .signature-section {
            margin-top: 20px;
        }
        
        .signature-line {
            width: 100%;
            margin: 10px 0;
        }
        
        .report-card-preview table {
            margin-bottom: 20px;
        }
        
        .report-card-preview th,
        .report-card-preview td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        
        .report-card-preview th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        @media print {
            .sidebar, .btn, .no-print, .modal-header, .modal-footer {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
            
            .modal-body {
                padding: 0 !important;
            }
            
            .report-card-template {
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
            }
            
            .report-card-preview {
                font-size: 12px !important;
            }
            
            .school-name {
                font-size: 1.5rem !important;
            }
            
            .report-title {
                font-size: 1.2rem !important;
            }
            
            .academic-performance table {
                font-size: 0.8rem !important;
            }
            
            .academic-performance th,
            .academic-performance td {
                padding: 4px !important;
            }
            
            .comment-box {
                font-size: 0.9rem !important;
            }
            
            .signature-section {
                margin-top: 15px !important;
            }
            
            .signature-line {
                height: 30px !important;
            }
        }
    </style>
</body>
</html>
