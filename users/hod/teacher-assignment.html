<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Assignment - Head of Department</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/hod.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1a4f8b;
            --secondary: #3a7cbd;
            --accent: #ff9e1b;
            --light: #f5f7fa;
            --dark: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        
        /* Mobile Menu Toggle Button */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1050;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--secondary);
        }
        
        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }
        
        /* Sidebar Overlay for Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .sidebar-overlay.show {
            display: block;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 15px 20px 15px;
            }
            
            .header {
                padding: 10px 15px;
                margin-bottom: 15px;
            }
            
            .card {
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 60px 10px 20px 10px;
            }
            
            .header h4 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle Button -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">Head of Department</h6>
                        <small class="text-muted">Staff ID: HOD1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-teachers.html">
                                <i class="fas fa-users"></i> My Teachers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="teacher-assignment.html">
                                <i class="fas fa-user-plus"></i> Teacher Assignment
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="results-approval.html">
                                <i class="fas fa-check-circle"></i> Results Approval
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="department-performance.html">
                                <i class="fas fa-chart-bar"></i> Department Performance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="department-analytics.html">
                                <i class="fas fa-chart-line"></i> Department Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grade-entry.html">
                                <i class="fas fa-edit"></i> Grade Entry
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-lists.html">
                                <i class="fas fa-user-graduate"></i> Student Lists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar-alt"></i> Timetable
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-12 main-content">
                <div class="header">
                    <div>
                        <h4>Teacher Assignment</h4>
                        <span class="role-badge" id="department-badge">Department Management</span>
                    </div>
                    <div>
                        <span id="current-user">John Doe</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Department Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Department Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Detected Department:</strong>
                                <span class="badge bg-primary ms-2" id="detected-department">Loading...</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Available Data:</strong>
                                <span class="ms-2">
                                    <span class="badge bg-success" id="subjects-count">0</span> Subjects |
                                    <span class="badge bg-info" id="teachers-count">0</span> Teachers |
                                    <span class="badge bg-warning" id="classes-count">0</span> Classes
                                </span>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="debugDepartmentDetection()" title="Debug department detection">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assignment Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Assignment Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Subject</label>
                                <select class="form-select" id="subject-select" onchange="loadTeachers()">
                                    <option value="">Select Subject</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="class-select" onchange="loadTeachers()">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Term</label>
                                <select class="form-select" id="term-select" onchange="loadTeachers()">
                                    <option value="">Select Term</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assignTeacherModal">
                                        <i class="fas fa-plus"></i> Assign Teacher
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="exportAssignments()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="refreshAllDropdowns()" title="Refresh dropdowns for current department">
                                        <i class="fas fa-sync"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Search Assignments</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="search-input" placeholder="Search by teacher, subject, class, or ID..." onkeyup="searchAssignments(this.value)">
                                    <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('search-input').value=''; searchAssignments('')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Filter by Status</label>
                                <select class="form-select" id="status-filter" onchange="filterAssignments()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Quick Stats</label>
                                <div class="d-flex gap-2">
                                    <span class="badge bg-primary" id="total-assignments">Total: 0</span>
                                    <span class="badge bg-success" id="active-assignments">Active: 0</span>
                                    <span class="badge bg-warning" id="pending-assignments">Pending: 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Department Overview -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Department Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h3 id="total-teachers-count">0</h3>
                                        <p class="mb-0">Total Teachers</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h3 id="assigned-teachers-count">0</h3>
                                        <p class="mb-0">Assigned</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h3 id="unassigned-teachers-count">0</h3>
                                        <p class="mb-0">Unassigned</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h3 id="total-classes-count">0</h3>
                                        <p class="mb-0">Total Classes</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teacher Assignments -->
                <div class="card">
                    <div class="card-header">
                        <h5>Teacher Assignments</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Teacher</th>
                                        <th>Subject</th>
                                        <th>Class</th>
                                        <th>Term</th>
                                        <th>Workload</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="assignments-tbody">
                                    <!-- Assignments will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Assign Teacher Modal -->
    <div class="modal fade" id="assignTeacherModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Teacher</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assign-teacher-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Teacher</label>
                                    <select class="form-select" id="teacher-select" required>
                                        <option value="">Select Teacher</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" id="assign-subject" required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Class</label>
                                    <select class="form-select" id="assign-class" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Term</label>
                                    <select class="form-select" id="assign-term" required>
                                        <option value="">Select Term</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Workload (Hours/Week)</label>
                                    <input type="number" class="form-control" id="workload" min="1" max="40" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="priority">
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3" placeholder="Additional notes about this assignment..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignTeacher()">Assign Teacher</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Assignment Modal -->
    <div class="modal fade" id="editAssignmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Assignment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-assignment-form">
                        <input type="hidden" id="edit-assignment-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Teacher</label>
                                    <select class="form-select" id="edit-teacher-select" required>
                                        <option value="">Select Teacher</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" id="edit-assign-subject" required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Class</label>
                                    <select class="form-select" id="edit-assign-class" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Term</label>
                                    <select class="form-select" id="edit-assign-term" required>
                                        <option value="">Select Term</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Workload (Hours/Week)</label>
                                    <input type="number" class="form-control" id="edit-workload" min="1" max="40" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="edit-priority">
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="edit-notes" rows="3" placeholder="Additional notes about this assignment..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateAssignment()">Update Assignment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/hod-utils.js"></script>
    <script src="../../assets/js/users/hod.js"></script>
    <script>
        // Dynamic Data Management
        let departments = [];
        let subjects = [];
        let classes = [];
        let teachers = [];
        let terms = [];
        let currentDepartment = '';
        let assignments = []; // Initialize assignments array
        let currentAssignmentId = 1; // Initialize assignment ID counter
        
        // Load dynamic data from Firebase
        async function loadDynamicData() {
            // Prevent multiple data loading
            if (isDataLoaded) {
                console.log('Data already loaded, skipping...');
                return;
            }
            
            isDataLoaded = true;
            console.log('Loading dynamic data...');
            
            try {
                showNotification('Loading system data...', 'info');
                
                // Ensure database is available
                if (!window.db) {
                    throw new Error('Database not initialized');
                }
                
                // Load departments
                const departmentsSnapshot = await window.db.collection('departments').get();
                departments = [];
                departmentsSnapshot.forEach(doc => {
                    departments.push({ id: doc.id, ...doc.data() });
                });
                
                // Load subjects
                const subjectsSnapshot = await window.db.collection('subjects').get();
                subjects = [];
                subjectsSnapshot.forEach(doc => {
                    subjects.push({ id: doc.id, ...doc.data() });
                });
                
                // Load classes
                const classesSnapshot = await window.db.collection('classes').get();
                classes = [];
                classesSnapshot.forEach(doc => {
                    classes.push({ id: doc.id, ...doc.data() });
                });
                
                // Load teachers from users collection with teacher role
                const teachersSnapshot = await window.db.collection('users')
                    .where('role', 'in', ['teacher', 'subject_teacher', 'hod'])
                    .get();
                teachers = [];
                teachersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    teachers.push({ 
                        id: doc.id, 
                        ...userData,
                        name: userData.personalInfo?.fullName || userData.displayName || userData.email,
                        department: userData.academicInfo?.department || userData.department,
                        subjects: userData.academicInfo?.subjects || userData.subjects || []
                    });
                });
                
                // Load terms - using hardcoded terms instead of Firestore
                terms = [
                    { id: 'term1', name: 'Term 1', active: true },
                    { id: 'term2', name: 'Term 2', active: false },
                    { id: 'term3', name: 'Term 3', active: false }
                ];
                
                // Set current department from user profile
                await loadUserProfile();
                
                // Populate dropdowns
                populateDropdowns();
                
                // Update UI with dynamic data
                updateUIWithDynamicData();
                
                showNotification('System data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading dynamic data:', error);
                showNotification('Error loading system data. Using fallback data.', 'warning');
                loadFallbackData();
            }
        }
        
        async function loadUserProfile() {
            try {
                // Check if we already have the department name from loadHODUserData
                if (window.currentUserData && window.currentUserData.departmentName) {
                    currentDepartment = window.currentUserData.departmentName;
                    console.log('Using department name from loadHODUserData:', currentDepartment);
                    return;
                }
                
                // Get user data from users collection (more reliable than userProfiles)
                const userDoc = await window.db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Get department ID from academic info
                    const departmentId = userData.academicInfo?.department || userData.department;
                    
                    if (departmentId) {
                        // Find department name by ID
                        const deptDoc = await window.db.collection('departments').doc(departmentId).get();
                        if (deptDoc.exists) {
                            const deptData = deptDoc.data();
                            currentDepartment = deptData.name || deptData.departmentName || 'Mathematics';
                            console.log('Department document found:', deptData);
                        } else {
                            console.log('Department document not found for ID:', departmentId);
                            // Try to get all departments to debug
                            const allDepts = await window.db.collection('departments').get();
                            console.log('Available departments:', allDepts.docs.map(doc => ({ id: doc.id, data: doc.data() })));
                            currentDepartment = 'Mathematics'; // Default fallback
                        }
                    } else {
                        currentDepartment = 'Mathematics'; // Default fallback
                    }
                    
                    console.log('Department from user document:', currentDepartment);
                    console.log('Department ID:', departmentId);
                } else {
                    // Fallback to userProfiles collection
                    const userProfileSnapshot = await window.db.collection('userProfiles')
                        .where('email', '==', currentUser.email)
                        .get();
                    
                    if (!userProfileSnapshot.empty) {
                        const userProfile = userProfileSnapshot.docs[0].data();
                        currentDepartment = userProfile.department || userProfile.subject || 'Mathematics';
                        console.log('User department detected:', currentDepartment);
                    } else {
                        currentDepartment = 'Mathematics'; // Default fallback
                        console.log('Using default department:', currentDepartment);
                    }
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                currentDepartment = 'Mathematics'; // Default fallback
            }
        }
        
        function loadFallbackData() {
            // Fallback data when Firebase is unavailable
            departments = [
                { id: 'math', name: 'Mathematics', code: 'MATH' },
                { id: 'science', name: 'Science', code: 'SCI' },
                { id: 'english', name: 'English', code: 'ENG' }
            ];
            
            subjects = [
                { id: 'math', name: 'Mathematics', department: 'math' },
                { id: 'physics', name: 'Physics', department: 'science' },
                { id: 'chemistry', name: 'Chemistry', department: 'science' },
                { id: 'biology', name: 'Biology', department: 'science' }
            ];
            
            classes = [
                { id: 's4a', name: 'S.4 Science A', level: 'S4' },
                { id: 's4b', name: 'S.4 Science B', level: 'S4' },
                { id: 's3', name: 'S.3 Science', level: 'S3' }
            ];
            
            teachers = [
                { id: 't001', name: 'John Smith', subject: 'Mathematics', department: 'math' },
                { id: 't002', name: 'Mary Johnson', subject: 'Physics', department: 'science' },
                { id: 't003', name: 'Peter Brown', subject: 'Chemistry', department: 'science' },
                { id: 't004', name: 'Sarah Wilson', subject: 'Biology', department: 'science' }
            ];
            
            terms = [
                { id: 'term1', name: 'Term 1', year: '2024', active: true },
                { id: 'term2', name: 'Term 2', year: '2024', active: false },
                { id: 'term3', name: 'Term 3', year: '2024', active: false }
            ];
            
            currentDepartment = 'Mathematics';
            populateDropdowns();
            updateUIWithDynamicData();
        }
        
        function updateUIWithDynamicData() {
            // Update department badge
            const departmentBadge = document.getElementById('department-badge');
            if (departmentBadge) {
                departmentBadge.textContent = `${currentDepartment} Department Head`;
            }
            
            // Update sidebar department info
            const sidebarDepartment = document.querySelector('.sidebar h6');
            if (sidebarDepartment) {
                sidebarDepartment.textContent = `Head of ${currentDepartment}`;
            }
            
            // Update current user info
            const currentUserElement = document.getElementById('current-user');
            if (currentUserElement && currentUser) {
                currentUserElement.textContent = currentUser.displayName || currentUser.email.split('@')[0];
            }
            
            // Add department info to the page header
            const pageTitle = document.querySelector('.header h4');
            if (pageTitle) {
                pageTitle.textContent = `Teacher Assignment - ${currentDepartment} Department`;
            }
            
            // Update department information display
            const detectedDeptElement = document.getElementById('detected-department');
            if (detectedDeptElement) {
                detectedDeptElement.textContent = currentDepartment;
            }
            
            // Update data counts
            const subjectsCountElement = document.getElementById('subjects-count');
            const teachersCountElement = document.getElementById('teachers-count');
            const classesCountElement = document.getElementById('classes-count');
            
            if (subjectsCountElement) {
                const departmentSubjects = subjects.filter(subject => {
                    const subjectDept = (subject.department || '').toLowerCase();
                    const currentDept = currentDepartment.toLowerCase();
                    return subjectDept === currentDept || 
                           subjectDept.includes(currentDept) || 
                           currentDept.includes(subjectDept) ||
                           subject.name.toLowerCase().includes(currentDept);
                });
                subjectsCountElement.textContent = departmentSubjects.length;
            }
            
            if (teachersCountElement) {
                const departmentTeachers = teachers.filter(teacher => {
                    const teacherDept = (teacher.department || '').toLowerCase();
                    const teacherSubject = (teacher.subject || '').toLowerCase();
                    const currentDept = currentDepartment.toLowerCase();
                    return teacherDept === currentDept || 
                           teacherDept.includes(currentDept) || 
                           currentDept.includes(teacherDept) ||
                           teacherSubject.includes(currentDept) ||
                           teacher.name.toLowerCase().includes(currentDept);
                });
                teachersCountElement.textContent = departmentTeachers.length;
            }
            
            if (classesCountElement) {
                // Count senior level classes (S1-S6 with streams)
                const seniorClasses = ['s1', 's2', 's3', 's4', 's5', 's6'];
                const totalSeniorClasses = seniorClasses.length * 5; // 5 options per level (main + 4 streams)
                classesCountElement.textContent = totalSeniorClasses;
            }
            
            // Log department information for debugging
            console.log(`UI updated for department: ${currentDepartment}`);
            console.log(`Available subjects: ${subjects.length}`);
            console.log(`Available teachers: ${teachers.length}`);
            console.log(`Available classes: ${classes.length}`);
            
            // Update department statistics
            updateDepartmentStats();
        }

        function populateDropdowns() {
            console.log(`Populating dropdowns for department: ${currentDepartment}`);
            
            // Populate subject dropdowns
            populateSubjectDropdown('subject-select');
            populateSubjectDropdown('assign-subject');
            populateSubjectDropdown('edit-assign-subject');
            
            // Populate class dropdowns
            populateClassDropdown('class-select');
            populateClassDropdown('assign-class');
            populateClassDropdown('edit-assign-class');
            
            // Populate teacher dropdowns
            populateTeacherDropdown('teacher-select');
            populateTeacherDropdown('edit-teacher-select');
            
            // Populate term dropdowns
            populateTermDropdown('term-select');
            populateTermDropdown('assign-term');
            populateTermDropdown('edit-assign-term');
        }
        
        // Debug function to show department detection details
        function debugDepartmentDetection() {
            console.log('=== DEPARTMENT DETECTION DEBUG ===');
            console.log('Current User:', currentUser);
            console.log('Detected Department:', currentDepartment);
            console.log('All Departments:', departments);
            console.log('All Subjects:', subjects);
            console.log('All Teachers:', teachers);
            console.log('All Classes:', classes);
            
            // Show filtered data
            const filteredSubjects = subjects.filter(subject => {
                const subjectDept = (subject.department || '').toLowerCase();
                const currentDept = currentDepartment.toLowerCase();
                return subjectDept === currentDept || 
                       subjectDept.includes(currentDept) || 
                       currentDept.includes(subjectDept) ||
                       subject.name.toLowerCase().includes(currentDept);
            });
            
            const filteredTeachers = teachers.filter(teacher => {
                const teacherDept = (teacher.department || '').toLowerCase();
                const teacherSubject = (teacher.subject || '').toLowerCase();
                const currentDept = currentDepartment.toLowerCase();
                return teacherDept === currentDept || 
                       teacherDept.includes(currentDept) || 
                       currentDept.includes(teacherDept) ||
                       teacherSubject.includes(currentDept) ||
                       teacher.name.toLowerCase().includes(currentDept);
            });
            
            console.log('Filtered Subjects for Department:', filteredSubjects);
            console.log('Filtered Teachers for Department:', filteredTeachers);
            console.log('=====================================');
            
            showNotification(`Debug info logged to console. Department: ${currentDepartment}`, 'info');
        }
        
        function populateSubjectDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select Subject</option>';
            
            // Filter subjects by current department using improved logic
            // First, find the department ID for the current department name
            const currentDeptObj = departments.find(dept => 
                dept.name && dept.name.toLowerCase() === currentDepartment.toLowerCase()
            );
            
            const currentDeptId = currentDeptObj ? currentDeptObj.id : null;
            
            const departmentSubjects = subjects.filter(subject => {
                // Check by department ID first (most reliable)
                if (currentDeptId && (subject.departmentId === currentDeptId || subject.department === currentDeptId)) {
                    return true;
                }
                
                // Check by department name (fallback)
                const subjectDept = (subject.department || subject.departmentName || '').toLowerCase();
                const currentDept = currentDepartment.toLowerCase();
                
                // Use exact match instead of includes to avoid false positives
                return subjectDept === currentDept;
            });
            
            console.log(`Filtering subjects for department: ${currentDepartment}`);
            console.log(`Found ${departmentSubjects.length} subjects:`, departmentSubjects);
            
            departmentSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                select.appendChild(option);
            });
            
            // If no subjects found, show all subjects as fallback
            if (departmentSubjects.length === 0) {
                console.log('No department-specific subjects found, showing all subjects');
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    select.appendChild(option);
                });
            }
        }
        
        function populateClassDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Class</option>';
            
            // Generate S1-S6 classes with optional streams
            const classLevels = ['S1', 'S2', 'S3', 'S4', 'S5', 'S6'];
            const streams = ['A', 'B', 'C', 'D']; // Optional streams
            
            classLevels.forEach(level => {
                // Add main class option (without stream)
                const mainOption = document.createElement('option');
                mainOption.value = level.toLowerCase();
                mainOption.textContent = level;
                select.appendChild(mainOption);
                
                // Add stream options for each level
                streams.forEach(stream => {
                    const streamOption = document.createElement('option');
                    streamOption.value = `${level.toLowerCase()}_${stream.toLowerCase()}`;
                    streamOption.textContent = `${level} ${stream}`;
                    select.appendChild(streamOption);
                });
            });
            
            console.log(`Populated class dropdown with S1-S6 classes and streams`);
        }
        
        function populateTeacherDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) {
                console.log(`Teacher dropdown element not found: ${selectId}`);
                return;
            }
            
            console.log(`Populating teacher dropdown: ${selectId}`);
            console.log(`Current department: ${currentDepartment}`);
            console.log(`Total teachers loaded: ${teachers.length}`);
            
            select.innerHTML = '<option value="">Select Teacher</option>';
            
            // Add HOD themselves as an option
            if (window.currentUser && window.currentUser.email) {
                const hodOption = document.createElement('option');
                hodOption.value = window.currentUser.uid;
                hodOption.textContent = `${window.currentUser.displayName || 'HOD'} - Head of Department (Me)`;
                hodOption.style.fontWeight = 'bold';
                select.appendChild(hodOption);
                console.log('Added HOD option to dropdown');
            }
            
            // Get subjects that belong to the current department
            // First, find the department ID for the current department name
            const currentDeptObj = departments.find(dept => 
                dept.name && dept.name.toLowerCase() === currentDepartment.toLowerCase()
            );
            
            const currentDeptId = currentDeptObj ? currentDeptObj.id : null;
            
            const departmentSubjects = subjects.filter(subject => {
                // Check by department ID first (most reliable)
                if (currentDeptId && (subject.departmentId === currentDeptId || subject.department === currentDeptId)) {
                    return true;
                }
                
                // Check by department name (fallback)
                const subjectDept = (subject.department || subject.departmentName || '').toLowerCase();
                const currentDept = currentDepartment.toLowerCase();
                
                // Use exact match instead of includes to avoid false positives
                return subjectDept === currentDept;
            });
            
            const departmentSubjectIds = departmentSubjects.map(subject => subject.id);
            const departmentSubjectNames = departmentSubjects.map(subject => subject.name || subject.subjectName);
            
            console.log(`Department subjects for ${currentDepartment}:`, departmentSubjectNames);
            console.log(`Department subject IDs:`, departmentSubjectIds);
            
            // Filter teachers who teach subjects under the current department
            const departmentTeachers = teachers.filter(teacher => {
                console.log(`Checking teacher: ${teacher.name}, subjects:`, teacher.subjects);
                const teacherSubjects = teacher.subjects || teacher.academicInfo?.subjects || [];
                
                // Check if teacher teaches any subject that belongs to the current department
                const teachesDepartmentSubject = teacherSubjects.some(teacherSubject => {
                    // Check by subject ID
                    if (typeof teacherSubject === 'string' && departmentSubjectIds.includes(teacherSubject)) {
                        return true;
                    }
                    
                    // Check by subject name
                    if (typeof teacherSubject === 'string') {
                        return departmentSubjectNames.some(deptSubjectName => 
                            deptSubjectName.toLowerCase().includes(teacherSubject.toLowerCase()) ||
                            teacherSubject.toLowerCase().includes(deptSubjectName.toLowerCase())
                        );
                    }
                    
                    // If teacherSubject is an object with id or name
                    if (typeof teacherSubject === 'object') {
                        const subjectId = teacherSubject.id || teacherSubject.subjectId;
                        const subjectName = teacherSubject.name || teacherSubject.subjectName;
                        
                        return departmentSubjectIds.includes(subjectId) ||
                               departmentSubjectNames.some(deptSubjectName => 
                                   deptSubjectName.toLowerCase().includes(subjectName.toLowerCase()) ||
                                   subjectName.toLowerCase().includes(deptSubjectName.toLowerCase())
                               );
                    }
                    
                    return false;
                });
                
                // Also include HOD of the current department
                const isHODOfDepartment = teacher.role === 'hod' && 
                    (teacher.department === currentDepartment || 
                     teacher.academicInfo?.department === currentDepartment);
                
                return teachesDepartmentSubject || isHODOfDepartment;
            });
            
            console.log(`Filtering teachers for department: ${currentDepartment}`);
            console.log(`Found ${departmentTeachers.length} teachers:`, departmentTeachers);
            
            departmentTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                
                // Get teacher's subjects
                const teacherSubjects = teacher.subjects || [];
                const subjectsText = teacherSubjects.length > 0 
                    ? teacherSubjects.join(', ') 
                    : (teacher.academicInfo?.subjects?.join(', ') || 'General');
                
                // Get staff ID
                const staffId = teacher.staffId || teacher.academicInfo?.staffId || 'N/A';
                
                option.textContent = `${teacher.name} (${staffId}) - ${subjectsText}`;
                select.appendChild(option);
            });
            
            // If no teachers found, show a message
            if (departmentTeachers.length === 0) {
                console.log('No teachers found who teach subjects in this department');
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No teachers available for this department';
                option.disabled = true;
                select.appendChild(option);
            }
        }
        
        function populateTermDropdown(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Term</option>';
            
            // Generate Term 1, Term 2, Term 3 options
            const terms = [
                { value: 'term1', name: 'Term 1' },
                { value: 'term2', name: 'Term 2' },
                { value: 'term3', name: 'Term 3' }
            ];
            
            terms.forEach(term => {
                const option = document.createElement('option');
                option.value = term.value;
                option.textContent = term.name;
                select.appendChild(option);
            });
            
            console.log(`Populated term dropdown with Term 1, Term 2, Term 3`);
        }

        // Firebase Integration
        let currentUser;
        let isInitialized = false; // Flag to prevent multiple initializations
        let isDataLoaded = false; // Flag to prevent multiple data loading
        let isTeacherAssignmentInitialized = false; // Flag to prevent multiple teacher assignment initialization
        
        // Enhanced Firebase Functions
        function enableOfflineSupport() {
            // Enable offline persistence
            window.db.enablePersistence({
                synchronizeTabs: true
            }).catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code == 'unimplemented') {
                    console.log('The current browser does not support all of the features required to enable persistence');
                }
            });
        }
        
        function setupConnectionStatus() {
            // Connection status monitoring removed - not needed for Firestore-only functionality
            console.log('Connection status monitoring disabled - using Firestore only');
        }
        
        function addAssignmentAuditLog(assignmentId, action, details) {
            const auditRef = window.db.collection('assignmentAuditLog').doc();
            auditRef.set({
                assignmentId: assignmentId,
                action: action,
                details: details,
                user: currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
                console.error('Error logging audit:', error);
            });
        }
        
        function getDepartmentFromUser() {
            return currentDepartment;
        }

        // Initialize Firebase
        function initializeFirebase() {
            // Prevent multiple initializations
            if (isInitialized) {
                console.log('Firebase already initialized, skipping...');
                return;
            }
            
            isInitialized = true;
            console.log('Initializing Firebase...');
            
            // Use the global db instance instead of creating a new one
            // db = firebase.firestore(); // Remove this line to avoid conflicts
            
            // Skip offline support as it's already initialized elsewhere
            // enableOfflineSupport(); // Remove this to avoid persistence error
            
            // Setup connection status
            setupConnectionStatus();
            
            // Check authentication
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.email);
                    await loadDynamicData();
                    // Don't call initializeTeacherAssignment here to avoid loop
                } else {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = '../../index.html';
                }
            });
        }
        
        // Firebase Teacher Assignment Functions
        async function loadAssignmentsFromFirebase() {
            try {
                showNotification('Loading assignments...', 'info');
                
                const department = getDepartmentFromUser();
                const assignmentsRef = window.db.collection('teacherAssignments');
                const snapshot = await assignmentsRef
                    .where('department', '==', department)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                // Initialize assignments array
                assignments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    assignments.push({
                        id: doc.id,
                        ...data,
                        firebaseId: doc.id
                    });
                });
                
                displayAssignments();
                updateDepartmentStats();
                updateQuickStats();
                
                showNotification('Assignments loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading assignments:', error);
                showNotification('Error loading assignments. Using sample data.', 'warning');
                // Fallback to sample data
                assignments = sampleAssignments || [];
                displayAssignments();
                updateDepartmentStats();
                updateQuickStats();
            }
        }
        
        async function saveAssignmentToFirebase(assignmentData) {
            try {
                const assignmentRef = window.db.collection('teacherAssignments').doc();
                const department = getDepartmentFromUser();
                
                const assignment = {
                    teacher: assignmentData.teacher,
                    teacherId: assignmentData.teacherId,
                    subject: assignmentData.subject,
                    class: assignmentData.class,
                    term: assignmentData.term,
                    workload: assignmentData.workload,
                    status: assignmentData.status,
                    priority: assignmentData.priority,
                    notes: assignmentData.notes,
                    department: department,
                    createdBy: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await assignmentRef.set(assignment);
                
                // Add Firebase ID to local assignment
                assignmentData.firebaseId = assignmentRef.id;
                assignmentData.id = assignmentRef.id;
                
                // Log audit trail
                addAssignmentAuditLog(assignmentRef.id, 'CREATE', {
                    teacher: assignmentData.teacher,
                    subject: assignmentData.subject,
                    class: assignmentData.class
                });
                
                return assignmentData;
            } catch (error) {
                console.error('Error saving assignment:', error);
                throw error;
            }
        }
        
        async function updateAssignmentInFirebase(assignmentId, updateData) {
            try {
                const assignmentRef = window.db.collection('teacherAssignments').doc(assignmentId);
                
                const updateFields = {
                    teacher: updateData.teacher,
                    subject: updateData.subject,
                    class: updateData.class,
                    term: updateData.term,
                    workload: updateData.workload,
                    priority: updateData.priority,
                    notes: updateData.notes,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.email
                };
                
                await assignmentRef.update(updateFields);
                
                // Log audit trail
                addAssignmentAuditLog(assignmentId, 'UPDATE', updateData);
                
                return true;
            } catch (error) {
                console.error('Error updating assignment:', error);
                throw error;
            }
        }
        
        async function deleteAssignmentFromFirebase(assignmentId) {
            try {
                // Get assignment details before deletion for audit log
                const assignment = assignments.find(a => a.id === assignmentId);
                
                await window.db.collection('teacherAssignments').doc(assignmentId).delete();
                
                // Log audit trail
                if (assignment) {
                    addAssignmentAuditLog(assignmentId, 'DELETE', {
                        teacher: assignment.teacher,
                        subject: assignment.subject,
                        class: assignment.class
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Error deleting assignment:', error);
                throw error;
            }
        }
        
        // Real-time listener for assignments
        function setupRealtimeListener() {
            const department = getDepartmentFromUser();
            const assignmentsRef = window.db.collection('teacherAssignments')
                .where('department', '==', department)
                .orderBy('createdAt', 'desc');
            
            assignmentsRef.onSnapshot((snapshot) => {
                assignments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    assignments.push({
                        id: doc.id,
                        ...data,
                        firebaseId: doc.id
                    });
                });
                
                displayAssignments();
                updateDepartmentStats();
                updateQuickStats();
                
                console.log('Assignments updated in real-time');
            }, (error) => {
                console.error('Error in real-time listener:', error);
                showNotification('Real-time updates unavailable. Data may not be current.', 'warning');
            });
        }


        // Notification System
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Enhanced Teacher Assignment Functions
        
        // Sample assignments data (fallback only)
        const sampleAssignments = [];
        
        async function initializeTeacherAssignment() {
            // Prevent multiple initializations
            if (isTeacherAssignmentInitialized) {
                console.log('Teacher assignment already initialized, skipping...');
                return;
            }
            
            isTeacherAssignmentInitialized = true;
            console.log('Initializing teacher assignment...');
            
            try {
                // Wait for authentication
                await waitForAuth(); // From hod-utils.js
                
                // Load user data using utility function
                const userResult = await window.loadHODUserData(window.db, window.currentUser); // From hod-utils.js
                if (!userResult.success) {
                    showError(userResult.error); // From hod-utils.js
                    return;
                }
                
                // Update UI with user data
                updateHODUserDisplay(userResult);
                
                // Load from Firebase instead of sample data
                await loadAssignmentsFromFirebase();
                setupRealtimeListener();
                
            } catch (error) {
                console.error('Error initializing teacher assignment:', error);
                showError('Failed to initialize teacher assignment. Please refresh and try again.'); // From hod-utils.js
            }
        }
        
        function updateDepartmentStats() {
            try {
                // Get subjects that belong to the current department
                const currentDeptObj = departments.find(dept => 
                    dept.name && dept.name.toLowerCase() === currentDepartment.toLowerCase()
                );
                const currentDeptId = currentDeptObj ? currentDeptObj.id : null;
                
                const departmentSubjects = subjects.filter(subject => {
                    // Check by department ID first (most reliable)
                    if (currentDeptId && (subject.departmentId === currentDeptId || subject.department === currentDeptId)) {
                        return true;
                    }
                    
                    // Check by department name (fallback)
                    const subjectDept = (subject.department || subject.departmentName || '').toLowerCase();
                    const currentDept = currentDepartment.toLowerCase();
                    
                    // Use exact match instead of includes to avoid false positives
                    return subjectDept === currentDept;
                });
                
                const departmentSubjectIds = departmentSubjects.map(subject => subject.id);
                const departmentSubjectNames = departmentSubjects.map(subject => subject.name || subject.subjectName);
                
                // Calculate stats from current data - only count teachers who teach subjects in current department
                const departmentTeachers = teachers.filter(teacher => {
                    const teacherSubjects = teacher.subjects || teacher.academicInfo?.subjects || [];
                    
                    // Check if teacher teaches any subject that belongs to the current department
                    const teachesDepartmentSubject = teacherSubjects.some(teacherSubject => {
                        // Check by subject ID
                        if (typeof teacherSubject === 'string' && departmentSubjectIds.includes(teacherSubject)) {
                            return true;
                        }
                        // Check by subject name
                        if (typeof teacherSubject === 'string') {
                            return departmentSubjectNames.some(deptSubjectName => 
                                deptSubjectName.toLowerCase().includes(teacherSubject.toLowerCase()) ||
                                teacherSubject.toLowerCase().includes(deptSubjectName.toLowerCase())
                            );
                        }
                        // Check by subject object
                        if (typeof teacherSubject === 'object') {
                            const subjectId = teacherSubject.id || teacherSubject.subjectId;
                            const subjectName = teacherSubject.name || teacherSubject.subjectName;
                            
                            return departmentSubjectIds.includes(subjectId) ||
                                   departmentSubjectNames.some(deptSubjectName => 
                                       deptSubjectName.toLowerCase().includes(subjectName.toLowerCase()) ||
                                       subjectName.toLowerCase().includes(deptSubjectName.toLowerCase())
                                   );
                        }
                        return false;
                    });
                    
                    // Also include HOD of the department
                    const isHODOfDepartment = teacher.role === 'hod' && 
                        (teacher.department === currentDepartment || 
                         teacher.academicInfo?.department === currentDepartment);
                    
                    return teachesDepartmentSubject || isHODOfDepartment;
                });
                
                const totalTeachers = departmentTeachers.length;
                const assignedTeachers = new Set(assignments.map(a => a.teacherId)).size;
                const unassignedTeachers = totalTeachers - assignedTeachers;
                
                // Count senior level classes (S1-S6)
                const seniorClasses = ['s1', 's2', 's3', 's4', 's5', 's6'];
                const totalClasses = seniorClasses.length * 5; // 5 options per level (main + 4 streams)
                
                // Update department overview cards
                document.getElementById('total-teachers-count').textContent = totalTeachers;
                document.getElementById('assigned-teachers-count').textContent = assignedTeachers;
                document.getElementById('unassigned-teachers-count').textContent = unassignedTeachers;
                document.getElementById('total-classes-count').textContent = totalClasses;
                
                // Update quick stats badges
                const totalAssignments = assignments.length;
                const activeAssignments = assignments.filter(a => a.status === 'active').length;
                const pendingAssignments = assignments.filter(a => a.status === 'pending').length;
                
                document.getElementById('total-assignments').textContent = `Total: ${totalAssignments}`;
                document.getElementById('active-assignments').textContent = `Active: ${activeAssignments}`;
                document.getElementById('pending-assignments').textContent = `Pending: ${pendingAssignments}`;
                
            } catch (error) {
                console.error('Error updating department stats:', error);
            }
        }

        function displayAssignments() {
            const tbody = document.getElementById('assignments-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Ensure assignments array exists
            if (!assignments) {
                assignments = [];
            }
            
            if (assignments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-info-circle"></i> No assignments found for ${currentDepartment} department
                        </td>
                    </tr>
                `;
                return;
            }
            
            assignments.forEach(assignment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <strong>${assignment.teacher}</strong><br>
                            <small class="text-muted">ID: ${assignment.teacherId}</small>
                        </div>
                    </td>
                    <td>${assignment.subject}</td>
                    <td>${assignment.class}</td>
                    <td>${assignment.term}</td>
                    <td>${assignment.workload} hrs/week</td>
                    <td><span class="badge ${getStatusColor(assignment.status)}">${assignment.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAssignment(${assignment.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editAssignment(${assignment.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${assignment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update department statistics
            updateDepartmentStats();
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'active': return 'bg-success';
                case 'pending': return 'bg-warning';
                case 'inactive': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        // Enhanced Assignment Functions
        function validateAssignment(teacher, subject, classSelect, workload) {
            if (!teacher || !subject || !classSelect || !workload) {
                showNotification('Please fill in all required fields.', 'warning');
                return false;
            }
            
            if (workload < 1 || workload > 40) {
                showNotification('Workload must be between 1 and 40 hours per week.', 'warning');
                return false;
            }
            
            // Check for duplicate assignments
            const duplicate = assignments.find(a => 
                a.teacher === teacher.split(' - ')[0] && 
                a.subject === subject && 
                a.class === classSelect
            );
            
            if (duplicate) {
                showNotification('This teacher is already assigned to this subject and class.', 'warning');
                return false;
            }
            
            return true;
        }
        
        function calculateWorkloadStats() {
            const totalWorkload = assignments.reduce((sum, assignment) => sum + assignment.workload, 0);
            const averageWorkload = assignments.length > 0 ? totalWorkload / assignments.length : 0;
            const maxWorkload = Math.max(...assignments.map(a => a.workload), 0);
            
            return {
                total: totalWorkload,
                average: Math.round(averageWorkload * 10) / 10,
                max: maxWorkload
            };
        }
        
        function updateQuickStats() {
            const total = assignments.length;
            const active = assignments.filter(a => a.status === 'Active').length;
            const pending = assignments.filter(a => a.status === 'Pending').length;
            
            document.getElementById('total-assignments').textContent = `Total: ${total}`;
            document.getElementById('active-assignments').textContent = `Active: ${active}`;
            document.getElementById('pending-assignments').textContent = `Pending: ${pending}`;
        }

        
        function exportAssignmentsToCSV() {
            if (assignments.length === 0) {
                showNotification('No assignments to export.', 'warning');
                return;
            }
            
            const headers = ['Teacher', 'Teacher ID', 'Subject', 'Class', 'Term', 'Workload', 'Status', 'Priority', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...assignments.map(assignment => [
                    `"${assignment.teacher}"`,
                    `"${assignment.teacherId}"`,
                    `"${assignment.subject}"`,
                    `"${assignment.class}"`,
                    `"${assignment.term}"`,
                    assignment.workload,
                    `"${assignment.status}"`,
                    `"${assignment.priority}"`,
                    `"${assignment.notes}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `teacher-assignments-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Assignments exported successfully!', 'success');
        }
        
        function searchAssignments(searchTerm) {
            if (!searchTerm.trim()) {
                displayAssignments();
                return;
            }
            
            const filteredAssignments = assignments.filter(assignment => 
                assignment.teacher.toLowerCase().includes(searchTerm.toLowerCase()) ||
                assignment.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||
                assignment.class.toLowerCase().includes(searchTerm.toLowerCase()) ||
                assignment.teacherId.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            displayFilteredAssignments(filteredAssignments);
        }

        function filterAssignments() {
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value;
            
            let filteredAssignments = assignments;
            
            // Apply status filter
            if (statusFilter) {
                filteredAssignments = filteredAssignments.filter(assignment => 
                    assignment.status.toLowerCase() === statusFilter.toLowerCase()
                );
            }
            
            // Apply search filter
            if (searchTerm.trim()) {
                filteredAssignments = filteredAssignments.filter(assignment => 
                    assignment.teacher.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    assignment.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    assignment.class.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    assignment.teacherId.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            
            displayFilteredAssignments(filteredAssignments);
        }

        async function assignTeacher() {
            const teacherId = document.getElementById('teacher-select').value;
            const subjectId = document.getElementById('assign-subject').value;
            const classId = document.getElementById('assign-class').value;
            const termId = document.getElementById('assign-term').value;
            const workload = document.getElementById('workload').value;
            const priority = document.getElementById('priority').value;
            const notes = document.getElementById('notes').value;
            
            // Get dynamic data from arrays
            const teacher = teachers.find(t => t.id === teacherId);
            const subject = subjects.find(s => s.id === subjectId);
            const classData = classes.find(c => c.id === classId);
            const term = terms.find(t => t.id === termId);
            
            if (!teacher || !subject || !classData || !term) {
                showNotification('Please select valid options from all dropdowns.', 'warning');
                return;
            }
            
            // Use enhanced validation
            if (!validateAssignment(teacher.name, subject.name, classData.name, workload)) {
                return;
            }
            
            const newAssignment = {
                id: currentAssignmentId++,
                teacher: teacher.name,
                teacherId: teacher.id,
                subject: subject.name,
                class: classData.name,
                term: term.name,
                workload: parseInt(workload),
                status: 'Active',
                priority: priority,
                notes: notes
            };
            
            try {
                showNotification('Saving assignment...', 'info');
                
                // Save to Firebase
                const savedAssignment = await saveAssignmentToFirebase(newAssignment);
                
                // Add to local array (real-time listener will also update this)
                assignments.push(savedAssignment);
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('assignTeacherModal'));
            modal.hide();
            document.getElementById('assign-teacher-form').reset();
            
            showNotification('Teacher assigned successfully!', 'success');
            } catch (error) {
                console.error('Error assigning teacher:', error);
                showNotification('Error saving assignment. Please try again.', 'error');
            }
        }
        
        function editAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            // Find the corresponding IDs from dynamic data
            const teacher = teachers.find(t => t.name === assignment.teacher);
            const subject = subjects.find(s => s.name === assignment.subject);
            const classData = classes.find(c => c.name === assignment.class);
            const term = terms.find(t => t.name === assignment.term);
            
            // Populate edit form
            document.getElementById('edit-assignment-id').value = assignment.id;
            document.getElementById('edit-teacher-select').value = teacher ? teacher.id : '';
            document.getElementById('edit-assign-subject').value = subject ? subject.id : '';
            document.getElementById('edit-assign-class').value = classData ? classData.id : '';
            document.getElementById('edit-assign-term').value = term ? term.id : '';
            document.getElementById('edit-workload').value = assignment.workload;
            document.getElementById('edit-priority').value = assignment.priority;
            document.getElementById('edit-notes').value = assignment.notes;
            
            // Show edit modal
            const modal = new bootstrap.Modal(document.getElementById('editAssignmentModal'));
            modal.show();
        }
        
        async function updateAssignment() {
            const assignmentId = document.getElementById('edit-assignment-id').value;
            const assignmentIndex = assignments.findIndex(a => a.id == assignmentId);
            
            if (assignmentIndex === -1) return;
            
            const teacherId = document.getElementById('edit-teacher-select').value;
            const subjectId = document.getElementById('edit-assign-subject').value;
            const classId = document.getElementById('edit-assign-class').value;
            const termId = document.getElementById('edit-assign-term').value;
            const workload = document.getElementById('edit-workload').value;
            const priority = document.getElementById('edit-priority').value;
            const notes = document.getElementById('edit-notes').value;
            
            // Get dynamic data from arrays
            const teacher = teachers.find(t => t.id === teacherId);
            const subject = subjects.find(s => s.id === subjectId);
            const classData = classes.find(c => c.id === classId);
            const term = terms.find(t => t.id === termId);
            
            if (!teacher || !subject || !classData || !term) {
                showNotification('Please select valid options from all dropdowns.', 'warning');
                return;
            }
            
            const updateData = {
                teacher: teacher.name,
                subject: subject.name,
                class: classData.name,
                term: term.name,
                workload: parseInt(workload),
                priority: priority,
                notes: notes
            };
            
            try {
                showNotification('Updating assignment...', 'info');
                
                // Update in Firebase
                await updateAssignmentInFirebase(assignmentId, updateData);
                
                // Update local array (real-time listener will also update this)
            assignments[assignmentIndex] = {
                ...assignments[assignmentIndex],
                    ...updateData
                };
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editAssignmentModal'));
            modal.hide();
            
            showNotification('Assignment updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating assignment:', error);
                showNotification('Error updating assignment. Please try again.', 'error');
            }
        }
        
        async function removeAssignment(assignmentId) {
            if (confirm('Are you sure you want to remove this assignment?')) {
                try {
                    showNotification('Deleting assignment...', 'info');
                    
                    // Delete from Firebase
                    await deleteAssignmentFromFirebase(assignmentId);
                    
                    // Remove from local array (real-time listener will also update this)
                assignments = assignments.filter(a => a.id !== assignmentId);
                    
                showNotification('Assignment removed successfully!', 'success');
                } catch (error) {
                    console.error('Error removing assignment:', error);
                    showNotification('Error removing assignment. Please try again.', 'error');
                }
            }
        }
        
        function viewAssignment(assignmentId) {
            const assignment = assignments.find(a => a.id === assignmentId);
            if (!assignment) return;
            
            alert(`Assignment Details:\n\nTeacher: ${assignment.teacher} (${assignment.teacherId})\nSubject: ${assignment.subject}\nClass: ${assignment.class}\nTerm: ${assignment.term}\nWorkload: ${assignment.workload} hrs/week\nStatus: ${assignment.status}\nPriority: ${assignment.priority}\nNotes: ${assignment.notes}`);
        }
        
        function loadTeachers() {
            const subject = document.getElementById('subject-select').value;
            const classSelect = document.getElementById('class-select').value;
            const term = document.getElementById('term-select').value;
            
            // Filter assignments based on selections
            let filteredAssignments = assignments;
            
            if (subject) {
                filteredAssignments = filteredAssignments.filter(a => a.subject === subject);
            }
            
            if (classSelect) {
                filteredAssignments = filteredAssignments.filter(a => a.class === classSelect);
            }
            
            displayFilteredAssignments(filteredAssignments);
        }
        
        function displayFilteredAssignments(filteredAssignments) {
            const tbody = document.getElementById('assignments-tbody');
            tbody.innerHTML = '';
            
            filteredAssignments.forEach(assignment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div>
                            <strong>${assignment.teacher}</strong><br>
                            <small class="text-muted">ID: ${assignment.teacherId}</small>
                        </div>
                    </td>
                    <td>${assignment.subject}</td>
                    <td>${assignment.class}</td>
                    <td>${assignment.term}</td>
                    <td>${assignment.workload} hrs/week</td>
                    <td><span class="badge ${getStatusColor(assignment.status)}">${assignment.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewAssignment(${assignment.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editAssignment(${assignment.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${assignment.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function exportAssignments() {
            exportAssignmentsToCSV();
        }
        
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase to set up auth state listener
            initializeFirebase();
            setupMobileSidebar(); // From hod-utils.js
        });


        function updateHODUserDisplay(userResult) {
            // Use the standardized updateUserDisplay function from hod-utils.js
            window.updateUserDisplay(userResult);
            
            // Additional HOD-specific updates
            try {
                // Update department badge
                const departmentBadge = document.getElementById('detected-department');
                if (departmentBadge) {
                    departmentBadge.textContent = userResult.departmentName || 'Unknown Department';
                }
                
                // Update role badge
                const roleBadge = document.getElementById('department-badge');
                if (roleBadge) {
                    roleBadge.textContent = `${userResult.departmentName || 'Department'} Management`;
                }
                
                console.log('Teacher Assignment user loaded:', {
                    name: userResult.userName,
                    department: userResult.departmentId,
                    departmentName: userResult.departmentName,
                    staffId: userResult.staffId
                });
            } catch (error) {
                console.error('Error updating HOD-specific display:', error);
            }
        }

        // Make functions globally accessible
        window.searchAssignments = searchAssignments;
        window.filterAssignments = filterAssignments;
        window.assignTeacher = assignTeacher;
        window.editAssignment = editAssignment;
        window.removeAssignment = removeAssignment;
        window.updateAssignment = updateAssignment;
        window.exportAssignments = exportAssignments;
        window.viewAssignment = viewAssignment;
    </script>
</body>
</html>
