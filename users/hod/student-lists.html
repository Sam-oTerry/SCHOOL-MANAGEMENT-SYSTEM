<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Lists - Subject Teacher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/subject-teacher.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">Subject Teacher</h6>
                        <small class="text-muted">Staff ID: <span id="sidebar-staff-id">â€”</span></small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-teachers.html">
                                <i class="fas fa-users"></i> My Teachers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="teacher-assignment.html">
                                <i class="fas fa-user-plus"></i> Teacher Assignment
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="results-approval.html">
                                <i class="fas fa-check-circle"></i> Results Approval
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="department-performance.html">
                                <i class="fas fa-chart-bar"></i> Department Performance
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="department-analytics.html">
                                <i class="fas fa-chart-line"></i> Department Analytics
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grade-entry.html">
                                <i class="fas fa-edit"></i> Grade Entry
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="student-lists.html">
                                <i class="fas fa-user-graduate"></i> Student Lists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar-alt"></i> Timetable
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>Student Lists</h4>
                        <span class="role-badge" id="department-badge">Loading Department...</span>
                    </div>
                    <div>
                        <span id="current-user">Loading...</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Filter Options -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Filter Students</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Subject</label>
                                <select class="form-select" id="subject-filter" onchange="filterStudents()">
                                    <option value="">All Subjects</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="class-filter" onchange="filterStudents()">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Performance</label>
                                <select class="form-select" id="performance-filter" onchange="filterStudents()">
                                    <option value="">All Students</option>
                                    <option value="excellent">Excellent (A)</option>
                                    <option value="very-good">Very Good (B)</option>
                                    <option value="good">Good (C)</option>
                                    <option value="satisfactory">Satisfactory (D)</option>
                                    <option value="pass">Pass (E)</option>
                                    <option value="fail">Fail (F)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="search-input" placeholder="Search by name or ID" onkeyup="filterStudents()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Students List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Student Lists</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportStudents()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="refreshStudents()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="students-table">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Class</th>
                                        <th>Subject</th>
                                        <th>Mid-term</th>
                                        <th>End-term</th>
                                        <th>Final Grade</th>
                                        <th>Grade</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="students-tbody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">
                                            <i class="fas fa-circle-notch fa-spin"></i> Loading students...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <nav aria-label="Students pagination" class="mt-4">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated here -->
                            </ul>
                        </nav>
                    </div>
                </div>
                
                <!-- Student Performance Summary -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Performance Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-light text-center">
                                    <div class="card-body">
                                        <h3 class="text-success" id="excellent-count">0</h3>
                                        <p class="mb-0">Excellent (A)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light text-center">
                                    <div class="card-body">
                                        <h3 class="text-primary" id="very-good-count">0</h3>
                                        <p class="mb-0">Very Good (B)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light text-center">
                                    <div class="card-body">
                                        <h3 class="text-info" id="good-count">0</h3>
                                        <p class="mb-0">Good (C)</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light text-center">
                                    <div class="card-body">
                                        <h3 class="text-warning" id="satisfactory-count">0</h3>
                                        <p class="mb-0">Satisfactory (D)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/hod-utils.js"></script>
    <script src="../../assets/js/users/subject-teacher.js"></script>
    <script>
        // Firebase-powered Student Lists
        let allStudents = [];
        let filteredStudents = [];
        let currentPage = 1;
        const studentsPerPage = 10;
        let subjectsIndex = {}; // id -> { id, name, classes }
        let assignedSubjectIds = [];
        
        function initials(name) {
            return (name || '').split(' ').filter(Boolean).map(n => n[0]).join('').toUpperCase() || 'ST';
        }
        
        function normalizeFinalFromDoc(gradeDoc) {
            if (!gradeDoc) return { mid: null, end: null, final: null, letter: null };
            const scores = gradeDoc.scores || {};
            const mid = typeof scores.midterm === 'number' ? scores.midterm : (typeof gradeDoc.midTerm === 'number' ? gradeDoc.midTerm : null);
            const end = typeof scores.endterm === 'number' ? scores.endterm : (typeof gradeDoc.endTerm === 'number' ? gradeDoc.endTerm : null);
            const fg = gradeDoc.finalGrade || {};
            const final = typeof fg.percentage === 'number' ? fg.percentage : (typeof gradeDoc.finalGrade === 'number' ? gradeDoc.finalGrade : null);
            const letter = fg.letterGrade || gradeDoc.grade || null;
            return { mid, end, final, letter };
        }
        
        function gradeToBand(letter) {
            if (letter === 'A') return 'excellent';
            if (letter === 'B') return 'very-good';
            if (letter === 'C') return 'good';
            if (letter === 'D') return 'satisfactory';
            if (letter === 'E') return 'pass';
            if (letter === 'F') return 'fail';
            return '';
        }
        
        function filterStudents() {
            const subjectFilter = document.getElementById('subject-filter').value;
            const classFilter = document.getElementById('class-filter').value;
            const performanceFilter = document.getElementById('performance-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            
            filteredStudents = allStudents.filter(student => {
                const matchesSubject = !subjectFilter || (student.subjectId === subjectFilter);
                const matchesClass = !classFilter || (student.classSlug === classFilter);
                const matchesPerformance = !performanceFilter || gradeToBand(student.letter) === performanceFilter;
                const matchesSearch = !searchInput || 
                    (student.name || '').toLowerCase().includes(searchInput) || 
                    (student.id || '').toLowerCase().includes(searchInput);
                
                return matchesSubject && matchesClass && matchesPerformance && matchesSearch;
            });
            
            currentPage = 1;
            displayStudents();
            updatePerformanceSummary();
        }
        
        function displayStudents() {
            const tbody = document.getElementById('students-tbody');
            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const pageStudents = filteredStudents.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            pageStudents.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-2">${initials(student.name)}</div>
                            <div>
                                <strong>${student.name}</strong>
                            </div>
                        </div>
                    </td>
                    <td>${student.className || 'â€”'}</td>
                    <td>${subjectsIndex[student.subjectId]?.name || 'â€”'}</td>
                    <td>${typeof student.midTerm === 'number' ? student.midTerm + '%' : 'â€”'}</td>
                    <td>${typeof student.endTerm === 'number' ? student.endTerm + '%' : 'â€”'}</td>
                    <td>${typeof student.finalGrade === 'number' ? student.finalGrade + '%' : 'â€”'}</td>
                    <td><span class="badge ${getGradeColor(student.letter)}">${student.letter || 'â€”'}</span></td>
                    <td><span class="badge bg-success">${student.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails('${student.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editStudentGrade('${student.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updatePagination();
        }
        
        function getGradeColor(grade) {
            const colors = {
                'A': 'bg-success',
                'B': 'bg-primary',
                'C': 'bg-info',
                'D': 'bg-warning',
                'E': 'bg-secondary',
                'F': 'bg-danger'
            };
            return colors[grade] || 'bg-secondary';
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }
        
        function changePage(page) {
            const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayStudents();
            }
        }
        
        function updatePerformanceSummary() {
            const excellent = filteredStudents.filter(s => s.letter === 'A').length;
            const veryGood = filteredStudents.filter(s => s.letter === 'B').length;
            const good = filteredStudents.filter(s => s.letter === 'C').length;
            const satisfactory = filteredStudents.filter(s => s.letter === 'D').length;
            
            document.getElementById('excellent-count').textContent = excellent;
            document.getElementById('very-good-count').textContent = veryGood;
            document.getElementById('good-count').textContent = good;
            document.getElementById('satisfactory-count').textContent = satisfactory;
        }
        
        function viewStudentDetails(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                alert(`Student Details:\n\nID: ${student.id}\nName: ${student.name}\nClass: ${student.class}\nSubject: ${student.subject}\nFinal Grade: ${student.finalGrade}% (${student.grade})`);
            }
        }
        
        function editStudentGrade(studentId) {
            alert(`Edit grade for student: ${studentId}`);
        }
        
        function exportStudents() {
            alert('Exporting student list...');
        }
        
        function refreshStudents() {
            initializeStudents();
        }
        
        function logout() {
            if (!window.auth) { window.location.href='../../index.html'; return; }
            auth.signOut().then(() => window.location.href='../../index.html');
        }
        
        async function loadAssignedSubjects(uid) {
            const userDoc = await db.collection('users').doc(uid).get();
            const data = userDoc.exists ? userDoc.data() : {};
            const employmentSubjects = (data.employmentInfo && Array.isArray(data.employmentInfo.subjects)) ? data.employmentInfo.subjects : [];
            const academicSubjects = (data.academicInfo && Array.isArray(data.academicInfo.subjects)) ? data.academicInfo.subjects : [];
            
            // Extract IDs from subjects (handle both string IDs and object subjects)
            const extractIds = (subjects) => {
                return subjects.map(subject => {
                    if (typeof subject === 'string') {
                        return subject;
                    } else if (typeof subject === 'object' && subject.id) {
                        return subject.id;
                    } else if (typeof subject === 'object' && subject.subjectId) {
                        return subject.subjectId;
                    }
                    return null;
                }).filter(Boolean);
            };
            
            const employmentIds = extractIds(employmentSubjects);
            const academicIds = extractIds(academicSubjects);
            const ids = Array.from(new Set([...employmentIds, ...academicIds]));
            
            console.log('Extracted subject IDs for student lists:', ids);
            assignedSubjectIds = ids;
            
            if (ids.length === 0) return [];
            const chunks = [];
            for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i+10));
            const snaps = await Promise.all(chunks.map(ch => db.collection('subjects').where(firebase.firestore.FieldPath.documentId(), 'in', ch).get()));
            const list = [];
            snaps.forEach(snap => snap.forEach(doc => list.push({ id: doc.id, ...doc.data() })));
            subjectsIndex = {};
            list.forEach(s => { subjectsIndex[s.id] = { id: s.id, name: s.name || s.subjectName || 'Subject', classes: Array.isArray(s.classes) ? s.classes : [] }; });
            return list;
        }
        
        async function loadStudentsAndGrades() {
            // Load students
            const studentsSnap = await db.collection('students').limit(1000).get();
            const studentsMap = {};
            studentsSnap.forEach(doc => {
                const s = doc.data();
                const name = (s.personalInfo && (s.personalInfo.fullName || `${s.personalInfo.firstName || ''} ${s.personalInfo.lastName || ''}`.trim())) || s.name || 'Unnamed Student';
                const className = (s.academicInfo && s.academicInfo.currentClass) || s.class || 'â€”';
                const classSlug = className.toLowerCase().replace(/\s+/g, '-');
                studentsMap[doc.id] = { id: doc.id, name, className, classSlug };
            });
            
            // Load grades for assigned subjects
            let grades = [];
            if (assignedSubjectIds.length > 0) {
                const chunks = [];
                for (let i = 0; i < assignedSubjectIds.length; i += 10) chunks.push(assignedSubjectIds.slice(i, i+10));
                const snaps = await Promise.all(chunks.map(ch => db.collection('grades').where('subjectId', 'in', ch).limit(1000).get()));
                snaps.forEach(snap => snap.forEach(doc => grades.push({ id: doc.id, ...doc.data() })));
            } else {
                // Fallback: teacherâ€™s own grades
                const snap = await db.collection('grades').where('teacherId', '==', window.currentUser.uid).limit(1000).get();
                snap.forEach(doc => grades.push({ id: doc.id, ...doc.data() }));
            }
            
            // Build rows: one per student-subject with latest term by timestamp if available
            const rows = [];
            grades.forEach(g => {
                const studentId = g.studentId || (g.student && g.student.id);
                const subjId = g.subjectId || (g.subject && g.subject.id);
                if (!studentId || !subjId) return;
                if (!(studentId in studentsMap)) return;
                const { mid, end, final, letter } = normalizeFinalFromDoc(g);
                rows.push({
                    id: studentId,
                    name: studentsMap[studentId].name,
                    className: studentsMap[studentId].className,
                    classSlug: studentsMap[studentId].classSlug,
                    subjectId: subjId,
                    midTerm: mid,
                    endTerm: end,
                    finalGrade: final,
                    letter: letter || (typeof final === 'number' ? (final >= 90 ? 'A' : final >= 80 ? 'B' : final >= 70 ? 'C' : final >= 60 ? 'D' : final >= 50 ? 'E' : 'F') : null),
                    status: 'Active'
                });
            });
            
            // If no grades, still show students in classes of assigned subjects (without scores)
            if (rows.length === 0 && Object.keys(subjectsIndex).length > 0) {
                const allowedClasses = new Set(Object.values(subjectsIndex).flatMap(s => s.classes || []));
                Object.values(studentsMap).forEach(s => {
                    if (allowedClasses.has(s.className)) {
                        assignedSubjectIds.forEach(subjId => {
                            rows.push({ id: s.id, name: s.name, className: s.className, classSlug: s.classSlug, subjectId: subjId, midTerm: null, endTerm: null, finalGrade: null, letter: null, status: 'Active' });
                        });
                    }
                });
            }
            
            allStudents = rows;
            filteredStudents = [...allStudents];
        }
        
        function populateFilters() {
            const subjSel = document.getElementById('subject-filter');
            const classSel = document.getElementById('class-filter');
            // Subjects
            subjSel.innerHTML = '<option value="">All Subjects</option>' + Object.values(subjectsIndex).map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            // Classes
            const classes = new Set();
            filteredStudents.forEach(s => { if (s.className) classes.add(s.className); });
            classSel.innerHTML = '<option value="">All Classes</option>' + Array.from(classes).map(c => `<option value="${c.toLowerCase().replace(/\s+/g,'-')}">${c}</option>`).join('');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeStudentLists();
            setupMobileSidebar(); // From hod-utils.js
        });

        async function initializeStudentLists() {
            try {
                // Wait for authentication
                await waitForAuth(); // From hod-utils.js
                
                // Load user data using utility function
                const userResult = await window.loadHODUserData(window.db, window.currentUser); // From hod-utils.js
                if (!userResult.success) {
                    showError(userResult.error); // From hod-utils.js
                    return;
                }
                
                // Update UI with user data
                updateStudentListsUserDisplay(userResult);
                
                // Load student data
                await loadAssignedSubjects(window.currentUser.uid);
                await loadStudentsAndGrades();
                populateFilters();
                displayStudents();
                updatePerformanceSummary();
                
            } catch (error) {
                console.error('Error initializing student lists:', error);
                showError('Failed to initialize student lists. Please refresh and try again.'); // From hod-utils.js
            }
        }

        function updateStudentListsUserDisplay(userResult) {
            // Use the standardized updateUserDisplay function from hod-utils.js
            window.updateUserDisplay(userResult);
            
            // Update department badge specifically for student lists
            const departmentBadge = document.getElementById('department-badge');
            if (departmentBadge && userResult.departmentName) {
                departmentBadge.textContent = `${userResult.departmentName} Department`;
            }
                
            console.log('Student Lists user loaded:', {
                name: userResult.userName,
                department: userResult.departmentId,
                departmentName: userResult.departmentName,
                staffId: userResult.staffId
            });
        }
    </script>
</body>
</html>
