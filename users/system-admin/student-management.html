<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="staff-management.html">
                                <i class="fas fa-user-tie"></i> Staff Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Student Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportStudents()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printStudents()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search students..." onkeyup="searchStudents()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="classFilter" onchange="filterStudents()">
                            <option value="all">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter" onchange="filterStudents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="graduated">Graduated</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="yearFilter" onchange="filterStudents()">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Student Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-user-graduate text-primary mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle text-success mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-graduation-cap text-info mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Graduated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-times-circle text-danger mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Inactive</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Students</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Payment Code</th>
                                        <th>Class & Year</th>
                                        <th>Parent/Guardian</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="studentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="studentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="studentEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="studentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentClass" class="form-label">Class</label>
                                    <select class="form-select" id="studentClass" required onchange="updateStreamOptions()">
                                        <option value="">Select Class</option>
                                        <option value="S.1">Senior 1 (S.1)</option>
                                        <option value="S.2">Senior 2 (S.2)</option>
                                        <option value="S.3">Senior 3 (S.3)</option>
                                        <option value="S.4">Senior 4 (S.4)</option>
                                        <option value="S.5">Senior 5 (S.5)</option>
                                        <option value="S.6">Senior 6 (S.6)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentStream" class="form-label">Stream (Optional)</label>
                                    <select class="form-select" id="studentStream">
                                        <option value="">No Stream</option>
                                        <option value="Science">Science</option>
                                        <option value="Arts">Arts</option>
                                        <option value="Commercial">Commercial</option>
                                        <option value="Technical">Technical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentYear" class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="studentYear" value="2024" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="studentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="studentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="studentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="studentAddress" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentPaymentCode" class="form-label">Student Payment Code</label>
                                    <input type="text" class="form-control" id="studentPaymentCode" required placeholder="Enter payment code">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentAdmissionNumber" class="form-label">Admission Number</label>
                                    <input type="text" class="form-control" id="studentAdmissionNumber" placeholder="Auto-generated if empty">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parent/Guardian Information -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">Parent/Guardian Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentName" class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="parentName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentRelationship" class="form-label">Relationship</label>
                                            <select class="form-select" id="parentRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="Father">Father</option>
                                                <option value="Mother">Mother</option>
                                                <option value="Guardian">Guardian</option>
                                                <option value="Uncle">Uncle</option>
                                                <option value="Aunt">Aunt</option>
                                                <option value="Grandfather">Grandfather</option>
                                                <option value="Grandmother">Grandmother</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentPhone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="parentPhone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="parentEmail">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentOccupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="parentOccupation">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentWorkplace" class="form-label">Workplace</label>
                                            <input type="text" class="form-control" id="parentWorkplace">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="parentAddress" class="form-label">Parent/Guardian Address</label>
                                    <textarea class="form-control" id="parentAddress" rows="2"></textarea>
                                </div>
                                
                                <!-- Emergency Contact -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emergencyContactName" class="form-label">Emergency Contact Name</label>
                                            <input type="text" class="form-control" id="emergencyContactName">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emergencyContactPhone" class="form-label">Emergency Contact Phone</label>
                                            <input type="tel" class="form-control" id="emergencyContactPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addStudent()">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editStudentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editStudentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="editStudentEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="editStudentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentClass" class="form-label">Class</label>
                                    <select class="form-select" id="editStudentClass" required onchange="updateEditStreamOptions()">
                                        <option value="">Select Class</option>
                                        <option value="S.1">Senior 1 (S.1)</option>
                                        <option value="S.2">Senior 2 (S.2)</option>
                                        <option value="S.3">Senior 3 (S.3)</option>
                                        <option value="S.4">Senior 4 (S.4)</option>
                                        <option value="S.5">Senior 5 (S.5)</option>
                                        <option value="S.6">Senior 6 (S.6)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentStream" class="form-label">Stream (Optional)</label>
                                    <select class="form-select" id="editStudentStream">
                                        <option value="">No Stream</option>
                                        <option value="Science">Science</option>
                                        <option value="Arts">Arts</option>
                                        <option value="Commercial">Commercial</option>
                                        <option value="Technical">Technical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentYear" class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="editStudentYear" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="editStudentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="editStudentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editStudentAddress" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentPaymentCode" class="form-label">Student Payment Code</label>
                                    <input type="text" class="form-control" id="editStudentPaymentCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentAdmissionNumber" class="form-label">Admission Number</label>
                                    <input type="text" class="form-control" id="editStudentAdmissionNumber">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parent/Guardian Information -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">Parent/Guardian Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentName" class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="editParentName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentRelationship" class="form-label">Relationship</label>
                                            <select class="form-select" id="editParentRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="Father">Father</option>
                                                <option value="Mother">Mother</option>
                                                <option value="Guardian">Guardian</option>
                                                <option value="Uncle">Uncle</option>
                                                <option value="Aunt">Aunt</option>
                                                <option value="Grandfather">Grandfather</option>
                                                <option value="Grandmother">Grandmother</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentPhone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="editParentPhone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="editParentEmail">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentOccupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="editParentOccupation">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentWorkplace" class="form-label">Workplace</label>
                                            <input type="text" class="form-control" id="editParentWorkplace">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editParentAddress" class="form-label">Parent/Guardian Address</label>
                                    <textarea class="form-control" id="editParentAddress" rows="2"></textarea>
                                </div>
                                
                                <!-- Emergency Contact -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editEmergencyContactName" class="form-label">Emergency Contact Name</label>
                                            <input type="text" class="form-control" id="editEmergencyContactName">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editEmergencyContactPhone" class="form-label">Emergency Contact Phone</label>
                                            <input type="tel" class="form-control" id="editEmergencyContactPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStudentStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="graduated">Graduated</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">Update Student</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStudent()">Delete Student</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "ass-sms.firebaseapp.com",
            projectId: "ass-sms",
            storageBucket: "ass-sms.firebasestorage.app",
            messagingSenderId: "515388722489",
            appId: "1:515388722489:web:21169f130303f48aaa2ce8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let students = [];
        let filteredStudents = [];
        let classes = [];
        let academicYears = [];
        
        // Check authentication and role
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userRole = userData.role;
                        
                        if (userRole === 'system_admin') {
                            console.log('‚úÖ System Administrator authenticated:', user.email);
                            currentUser = user;
                            loadStudents();
                            loadClasses();
                            loadAcademicYears();
                            setupRealTimeListeners();
                        } else {
                            console.log('‚ùå Access denied. Required role: system_admin');
                            alert('Access denied. You do not have system administrator privileges.');
                            auth.signOut().then(() => {
                                window.location.href = '../../index.html';
                            });
                        }
                    } else {
                        console.log('‚ùå User document not found');
                        auth.signOut().then(() => {
                            window.location.href = '../../index.html';
                        });
                    }
                });
            } else {
                console.log('‚ùå No authenticated user, redirecting to login');
                window.location.href = '../../index.html';
            }
        });
        
        // Load students from Firebase
        async function loadStudents() {
            try {
                const studentsSnapshot = await db.collection('students')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                students = [];
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    students.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                filteredStudents = [...students];
                displayStudents();
                updateStudentStats();
                
                console.log(`‚úÖ Loaded ${students.length} students from Firestore`);
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Failed to load students. Please try again.');
            }
        }
        
        // Load classes
        async function loadClasses() {
            try {
                const classesSnapshot = await db.collection('classes').get();
                classes = [];
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    classes.push({
                        id: doc.id,
                        ...classData
                    });
                });
                
                populateClassSelects();
                
            } catch (error) {
                console.error('Error loading classes:', error);
                // Set default classes if none exist
                classes = [
                    { id: '1', name: 'S.1', level: 'Senior 1' },
                    { id: '2', name: 'S.2', level: 'Senior 2' },
                    { id: '3', name: 'S.3', level: 'Senior 3' },
                    { id: '4', name: 'S.4', level: 'Senior 4' },
                    { id: '5', name: 'S.5', level: 'Senior 5' },
                    { id: '6', name: 'S.6', level: 'Senior 6' }
                ];
                populateClassSelects();
            }
        }
        
        // Load academic years
        async function loadAcademicYears() {
            try {
                const yearsSnapshot = await db.collection('academic_years').get();
                academicYears = [];
                yearsSnapshot.forEach(doc => {
                    const yearData = doc.data();
                    academicYears.push({
                        id: doc.id,
                        ...yearData
                    });
                });
                
                populateYearSelects();
                
            } catch (error) {
                console.error('Error loading academic years:', error);
                // Set default years
                academicYears = [
                    { id: '1', year: '2024' },
                    { id: '2', year: '2023' },
                    { id: '3', year: '2022' }
                ];
                populateYearSelects();
            }
        }
        
        // Populate class selects
        function populateClassSelects() {
            const classSelects = ['studentClass', 'editStudentClass', 'classFilter'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = selectId === 'classFilter' ? '<option value="all">All Classes</option>' : '<option value="">Select Class</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.name;
                        option.textContent = cls.name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Populate year selects
        function populateYearSelects() {
            const yearSelects = ['yearFilter'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="all">All Years</option>';
                    academicYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year.year;
                        option.textContent = year.year;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Display students in the table
        function displayStudents() {
            const tbody = document.querySelector('#studentsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-user-graduate fa-2x mb-2"></i><br>
                            No students found
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(student => {
                const row = createStudentRow(student);
                tbody.appendChild(row);
            });
            
            console.log(`üìä Displayed ${filteredStudents.length} students`);
        }
        
        // Create student row
        function createStudentRow(student) {
            const row = document.createElement('tr');
            const fullName = `${student.firstName || ''} ${student.lastName || ''}`.trim();
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            const statusColors = {
                'active': 'success',
                'inactive': 'danger',
                'graduated': 'info'
            };
            const statusColor = statusColors[student.status] || 'secondary';
            
            // Format class with stream if available
            const classDisplay = student.stream ? `${student.class} (${student.stream})` : student.class;
            
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">${initials}</div>
                        <div>
                            <strong>${fullName}</strong><br>
                            <small class="text-muted">${student.email || 'No email'}</small><br>
                            <small class="text-muted">ID: ${student.studentId || 'N/A'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${student.paymentCode || 'N/A'}</strong><br>
                        <small class="text-muted">Payment Code</small>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${classDisplay || 'N/A'}</strong><br>
                        <small class="text-muted">${student.academicYear || 'N/A'}</small>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${student.parent?.name || 'N/A'}</strong><br>
                        <small class="text-muted">${student.parent?.relationship || ''}</small>
                    </div>
                </td>
                <td><span class="badge bg-${statusColor}">${student.status || 'Unknown'}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewStudentDetails('${student.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="viewStudentGrades('${student.id}')" title="View Grades">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteStudent('${student.id}')" title="Delete Student">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Update student statistics
        function updateStudentStats() {
            const totalStudents = students.length;
            const activeStudents = students.filter(student => student.status === 'active').length;
            const graduatedStudents = students.filter(student => student.status === 'graduated').length;
            const inactiveStudents = students.filter(student => student.status === 'inactive').length;
            
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalStudents;
                statsCards[1].textContent = activeStudents;
                statsCards[2].textContent = graduatedStudents;
                statsCards[3].textContent = inactiveStudents;
            }
            
            console.log(`üìä Student Stats - Total: ${totalStudents}, Active: ${activeStudents}, Graduated: ${graduatedStudents}, Inactive: ${inactiveStudents}`);
        }
        
        // Update stream options based on class selection
        function updateStreamOptions() {
            const classSelect = document.getElementById('studentClass');
            const streamSelect = document.getElementById('studentStream');
            
            if (classSelect.value === 'S.5' || classSelect.value === 'S.6') {
                // A-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else if (classSelect.value === 'S.3' || classSelect.value === 'S.4') {
                // O-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else {
                // S.1 and S.2 - no streams typically
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                `;
            }
        }
        
        // Generate unique student ID (ASS + Level + YY + 4 digits)
        async function generateStudentId(studentClass) {
            try {
                const currentYear = new Date().getFullYear();
                const yearPrefix = currentYear.toString().slice(-2); // Last 2 digits of year
                
                // Determine level based on class
                let levelPrefix = 'ST'; // Default for O-Level
                if (studentClass === 'S.5' || studentClass === 'S.6') {
                    levelPrefix = 'AL'; // A-Level
                } else if (studentClass === 'S.1' || studentClass === 'S.2' || studentClass === 'S.3' || studentClass === 'S.4') {
                    levelPrefix = 'OL'; // O-Level
                }
                
                const prefix = 'ASS' + levelPrefix + yearPrefix; // e.g., ASSOL24, ASSAL24
                
                // Get the latest student ID for this level and year
                const querySnapshot = await db.collection('students')
                    .where('studentId', '>=', prefix + '0001')
                    .where('studentId', '<', prefix + '9999')
                    .orderBy('studentId', 'desc')
                    .limit(1)
                    .get();
                
                let nextNumber = 1;
                if (!querySnapshot.empty) {
                    const latestStudentId = querySnapshot.docs[0].data().studentId;
                    const currentNumber = parseInt(latestStudentId.substring(6)); // Remove 'ASSXXYY' prefix (6 chars)
                    nextNumber = currentNumber + 1;
                }
                
                return prefix + String(nextNumber).padStart(4, '0');
            } catch (error) {
                console.error('Error generating student ID:', error);
                // Fallback to timestamp-based ID
                const currentYear = new Date().getFullYear();
                const yearPrefix = currentYear.toString().slice(-2);
                const levelPrefix = (studentClass === 'S.5' || studentClass === 'S.6') ? 'AL' : 'OL';
                return 'ASS' + levelPrefix + yearPrefix + String(Date.now()).slice(-4);
            }
        }
        
        // Add new student
        async function addStudent() {
            const firstName = document.getElementById('studentFirstName').value;
            const lastName = document.getElementById('studentLastName').value;
            const email = document.getElementById('studentEmail').value;
            const phone = document.getElementById('studentPhone').value;
            const studentClass = document.getElementById('studentClass').value;
            const studentStream = document.getElementById('studentStream').value;
            const academicYear = document.getElementById('studentYear').value;
            const dateOfBirth = document.getElementById('studentDateOfBirth').value;
            const gender = document.getElementById('studentGender').value;
            const address = document.getElementById('studentAddress').value;
            const paymentCode = document.getElementById('studentPaymentCode').value;
            const admissionNumber = document.getElementById('studentAdmissionNumber').value;
            
            // Parent/Guardian information
            const parentName = document.getElementById('parentName').value;
            const parentRelationship = document.getElementById('parentRelationship').value;
            const parentPhone = document.getElementById('parentPhone').value;
            const parentEmail = document.getElementById('parentEmail').value;
            const parentOccupation = document.getElementById('parentOccupation').value;
            const parentWorkplace = document.getElementById('parentWorkplace').value;
            const parentAddress = document.getElementById('parentAddress').value;
            const emergencyContactName = document.getElementById('emergencyContactName').value;
            const emergencyContactPhone = document.getElementById('emergencyContactPhone').value;
            
            if (!firstName || !lastName || !studentClass || !academicYear || !dateOfBirth || !gender || !paymentCode || !parentName || !parentRelationship || !parentPhone) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                // Generate student ID with level and year prefix and sequential numbering
                const studentId = await generateStudentId(studentClass);
                const finalAdmissionNumber = admissionNumber || `ADM${Date.now().toString().slice(-6)}`;
                
                const studentData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email || '',
                    phone: phone || '',
                    studentId: studentId,
                    admissionNumber: finalAdmissionNumber,
                    paymentCode: paymentCode,
                    class: studentClass,
                    stream: studentStream || null,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                    parent: {
                        name: parentName,
                        relationship: parentRelationship,
                        phone: parentPhone,
                        email: parentEmail || '',
                        occupation: parentOccupation || '',
                        workplace: parentWorkplace || '',
                        address: parentAddress || ''
                    },
                    emergencyContact: {
                        name: emergencyContactName || '',
                        phone: emergencyContactPhone || ''
                    },
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('students').add(studentData);
                
                showSuccess(`Student added successfully! Student ID: ${studentId}`);
                document.getElementById('addStudentForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('Error adding student:', error);
                showError('Error adding student: ' + error.message);
            }
        }
        
        // Update edit stream options based on class selection
        function updateEditStreamOptions() {
            const classSelect = document.getElementById('editStudentClass');
            const streamSelect = document.getElementById('editStudentStream');
            
            if (classSelect.value === 'S.5' || classSelect.value === 'S.6') {
                // A-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else if (classSelect.value === 'S.3' || classSelect.value === 'S.4') {
                // O-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else {
                // S.1 and S.2 - no streams typically
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                `;
            }
        }
        
        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentFirstName').value = student.firstName || '';
            document.getElementById('editStudentLastName').value = student.lastName || '';
            document.getElementById('editStudentEmail').value = student.email || '';
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentClass').value = student.class || '';
            document.getElementById('editStudentStream').value = student.stream || '';
            document.getElementById('editStudentYear').value = student.academicYear || '';
            document.getElementById('editStudentDateOfBirth').value = student.dateOfBirth ? 
                new Date(student.dateOfBirth.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editStudentAddress').value = student.address || '';
            document.getElementById('editStudentPaymentCode').value = student.paymentCode || '';
            document.getElementById('editStudentAdmissionNumber').value = student.admissionNumber || '';
            
            // Parent/Guardian information
            document.getElementById('editParentName').value = student.parent?.name || '';
            document.getElementById('editParentRelationship').value = student.parent?.relationship || '';
            document.getElementById('editParentPhone').value = student.parent?.phone || '';
            document.getElementById('editParentEmail').value = student.parent?.email || '';
            document.getElementById('editParentOccupation').value = student.parent?.occupation || '';
            document.getElementById('editParentWorkplace').value = student.parent?.workplace || '';
            document.getElementById('editParentAddress').value = student.parent?.address || '';
            document.getElementById('editEmergencyContactName').value = student.emergencyContact?.name || '';
            document.getElementById('editEmergencyContactPhone').value = student.emergencyContact?.phone || '';
            
            document.getElementById('editStudentStatus').value = student.status || 'active';
            
            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }
        
        // Update student
        async function updateStudent() {
            const studentId = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const email = document.getElementById('editStudentEmail').value;
            const phone = document.getElementById('editStudentPhone').value;
            const studentClass = document.getElementById('editStudentClass').value;
            const studentStream = document.getElementById('editStudentStream').value;
            const academicYear = document.getElementById('editStudentYear').value;
            const dateOfBirth = document.getElementById('editStudentDateOfBirth').value;
            const gender = document.getElementById('editStudentGender').value;
            const address = document.getElementById('editStudentAddress').value;
            const paymentCode = document.getElementById('editStudentPaymentCode').value;
            const admissionNumber = document.getElementById('editStudentAdmissionNumber').value;
            
            // Parent/Guardian information
            const parentName = document.getElementById('editParentName').value;
            const parentRelationship = document.getElementById('editParentRelationship').value;
            const parentPhone = document.getElementById('editParentPhone').value;
            const parentEmail = document.getElementById('editParentEmail').value;
            const parentOccupation = document.getElementById('editParentOccupation').value;
            const parentWorkplace = document.getElementById('editParentWorkplace').value;
            const parentAddress = document.getElementById('editParentAddress').value;
            const emergencyContactName = document.getElementById('editEmergencyContactName').value;
            const emergencyContactPhone = document.getElementById('editEmergencyContactPhone').value;
            const status = document.getElementById('editStudentStatus').value;
            
            if (!firstName || !lastName || !studentClass || !academicYear || !dateOfBirth || !gender || !paymentCode || !parentName || !parentRelationship || !parentPhone) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                await db.collection('students').doc(studentId).update({
                    firstName: firstName,
                    lastName: lastName,
                    email: email || '',
                    phone: phone || '',
                    class: studentClass,
                    stream: studentStream || null,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                    paymentCode: paymentCode,
                    admissionNumber: admissionNumber || '',
                    parent: {
                        name: parentName,
                        relationship: parentRelationship,
                        phone: parentPhone,
                        email: parentEmail || '',
                        occupation: parentOccupation || '',
                        workplace: parentWorkplace || '',
                        address: parentAddress || ''
                    },
                    emergencyContact: {
                        name: emergencyContactName || '',
                        phone: emergencyContactPhone || ''
                    },
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                });
                
                showSuccess('Student updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('Error updating student:', error);
                showError('Error updating student: ' + error.message);
            }
        }
        
        // Delete student
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                try {
                    await db.collection('students').doc(studentId).delete();
                    showSuccess('Student deleted successfully!');
                    loadStudents();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showError('Error deleting student: ' + error.message);
                }
            }
        }
        
        // View student details
        function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const dateOfBirth = student.dateOfBirth ? new Date(student.dateOfBirth.seconds * 1000).toLocaleDateString() : 'Not set';
            const createdDate = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            const classDisplay = student.stream ? `${student.class} (${student.stream})` : student.class;
            
            const details = `
                <div style="text-align: left; max-width: 500px;">
                    <h4>Student Details</h4>
                    <hr>
                    
                    <h5>Personal Information</h5>
                    <strong>Name:</strong> ${student.firstName} ${student.lastName}<br>
                    <strong>Student ID:</strong> ${student.studentId || 'N/A'}<br>
                    <strong>Admission Number:</strong> ${student.admissionNumber || 'N/A'}<br>
                    <strong>Payment Code:</strong> ${student.paymentCode || 'N/A'}<br>
                    <strong>Email:</strong> ${student.email || 'Not provided'}<br>
                    <strong>Phone:</strong> ${student.phone || 'Not provided'}<br>
                    <strong>Date of Birth:</strong> ${dateOfBirth}<br>
                    <strong>Gender:</strong> ${student.gender || 'Not specified'}<br>
                    <strong>Address:</strong> ${student.address || 'Not provided'}<br>
                    <strong>Status:</strong> ${student.status || 'Unknown'}<br><br>
                    
                    <h5>Academic Information</h5>
                    <strong>Class:</strong> ${classDisplay || 'N/A'}<br>
                    <strong>Academic Year:</strong> ${student.academicYear || 'N/A'}<br><br>
                    
                    <h5>Parent/Guardian Information</h5>
                    <strong>Name:</strong> ${student.parent?.name || 'Not provided'}<br>
                    <strong>Relationship:</strong> ${student.parent?.relationship || 'Not specified'}<br>
                    <strong>Phone:</strong> ${student.parent?.phone || 'Not provided'}<br>
                    <strong>Email:</strong> ${student.parent?.email || 'Not provided'}<br>
                    <strong>Occupation:</strong> ${student.parent?.occupation || 'Not provided'}<br>
                    <strong>Workplace:</strong> ${student.parent?.workplace || 'Not provided'}<br>
                    <strong>Address:</strong> ${student.parent?.address || 'Not provided'}<br><br>
                    
                    <h5>Emergency Contact</h5>
                    <strong>Name:</strong> ${student.emergencyContact?.name || 'Not provided'}<br>
                    <strong>Phone:</strong> ${student.emergencyContact?.phone || 'Not provided'}<br><br>
                    
                    <strong>Created:</strong> ${createdDate}
                </div>
            `;
            
            // Create a modal for better display
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'studentDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Student Details - ${student.firstName} ${student.lastName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // View student grades (placeholder)
        function viewStudentGrades(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            alert(`View grades for ${student.firstName} ${student.lastName} - This feature will be implemented in the grades module.`);
        }
        
        // Search students
        function searchStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredStudents = students.filter(student => 
                (student.firstName || '').toLowerCase().includes(searchTerm) ||
                (student.lastName || '').toLowerCase().includes(searchTerm) ||
                (student.email || '').toLowerCase().includes(searchTerm) ||
                (student.studentId || '').toLowerCase().includes(searchTerm) ||
                (student.paymentCode || '').toLowerCase().includes(searchTerm) ||
                (student.admissionNumber || '').toLowerCase().includes(searchTerm) ||
                (student.parent?.name || '').toLowerCase().includes(searchTerm) ||
                (student.parent?.phone || '').includes(searchTerm) ||
                (student.class || '').toLowerCase().includes(searchTerm) ||
                (student.stream || '').toLowerCase().includes(searchTerm)
            );
            displayStudents();
        }
        
        // Filter students
        function filterStudents() {
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            filteredStudents = students.filter(student => {
                const classMatch = classFilter === 'all' || student.class === classFilter;
                const statusMatch = statusFilter === 'all' || student.status === statusFilter;
                const yearMatch = yearFilter === 'all' || student.academicYear === yearFilter;
                return classMatch && statusMatch && yearMatch;
            });
            
            displayStudents();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('classFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            filteredStudents = [...students];
            displayStudents();
        }
        
        // Export students
        function exportStudents() {
            const studentsData = students.map(student => ({
                firstName: student.firstName,
                lastName: student.lastName,
                email: student.email,
                phone: student.phone,
                studentId: student.studentId,
                class: student.class,
                academicYear: student.academicYear,
                gender: student.gender,
                status: student.status,
                guardianName: student.guardian?.name,
                guardianPhone: student.guardian?.phone,
                guardianEmail: student.guardian?.email
            }));
            
            const dataStr = JSON.stringify(studentsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Students exported successfully!');
        }
        
        // Print students
        function printStudents() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for student changes
            db.collection('students').onSnapshot((snapshot) => {
                console.log('üìä Students collection updated');
                loadStudents();
                updateStudentStats();
            });
            
            // Listen for class changes
            db.collection('classes').onSnapshot((snapshot) => {
                console.log('üìö Classes collection updated');
                loadClasses();
            });
            
            // Listen for academic year changes
            db.collection('academicYears').onSnapshot((snapshot) => {
                console.log('üìÖ Academic years collection updated');
                loadAcademicYears();
            });
        }
        
        
        // Enhanced class loading with real-time updates
        async function loadClasses() {
            try {
                const classesSnapshot = await db.collection('classes').get();
                classes = [];
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    classes.push({
                        id: doc.id,
                        ...classData
                    });
                });
                
                updateClassSelector();
                
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }
        
        // Enhanced academic year loading with real-time updates
        async function loadAcademicYears() {
            try {
                const academicYearsSnapshot = await db.collection('academicYears')
                    .orderBy('year', 'desc')
                    .get();
                
                academicYears = [];
                academicYearsSnapshot.forEach(doc => {
                    const yearData = doc.data();
                    academicYears.push({
                        id: doc.id,
                        ...yearData
                    });
                });
                
                updateAcademicYearSelector();
                
            } catch (error) {
                console.error('Error loading academic years:', error);
            }
        }
        
        // Update student statistics
        function updateStudentStats() {
            const totalStudents = students.length;
            const activeStudents = students.filter(student => student.isActive !== false).length;
            const maleStudents = students.filter(student => student.personalInfo?.gender === 'male').length;
            const femaleStudents = students.filter(student => student.personalInfo?.gender === 'female').length;
            
            // Update stats cards if they exist
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalStudents;
                statsCards[1].textContent = activeStudents;
                statsCards[2].textContent = maleStudents;
                statsCards[3].textContent = femaleStudents;
            }
        }
        
        // Update class selector dropdown
        function updateClassSelector() {
            const classSelector = document.getElementById('class-filter');
            if (classSelector) {
                classSelector.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.name;
                    classSelector.appendChild(option);
                });
            }
        }
        
        // Update academic year selector dropdown
        function updateAcademicYearSelector() {
            const yearSelector = document.getElementById('academic-year-filter');
            if (yearSelector) {
                yearSelector.innerHTML = '<option value="">All Years</option>';
                academicYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.id;
                    option.textContent = year.year;
                    yearSelector.appendChild(option);
                });
            }
        }
        
        // Enhanced search with real-time filtering
        function searchStudents() {
            const searchTerm = document.getElementById('search-students').value.toLowerCase();
            const filteredStudents = students.filter(student => 
                student.personalInfo?.fullName?.toLowerCase().includes(searchTerm) ||
                student.personalInfo?.studentId?.toLowerCase().includes(searchTerm) ||
                student.personalInfo?.phone?.includes(searchTerm) ||
                student.personalInfo?.email?.toLowerCase().includes(searchTerm)
            );
            displayStudents(filteredStudents);
        }
        
        // Enhanced filter with real-time updates
        function filterStudents() {
            const classFilter = document.getElementById('class-filter').value;
            const yearFilter = document.getElementById('academic-year-filter').value;
            const genderFilter = document.getElementById('gender-filter').value;
            
            let filteredStudents = students;
            
            if (classFilter) {
                filteredStudents = filteredStudents.filter(student => student.academicInfo?.currentClass === classFilter);
            }
            
            if (yearFilter) {
                filteredStudents = filteredStudents.filter(student => student.academicInfo?.academicYear === yearFilter);
            }
            
            if (genderFilter) {
                filteredStudents = filteredStudents.filter(student => student.personalInfo?.gender === genderFilter);
            }
            
            displayStudents(filteredStudents);
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.addStudent = addStudent;
        window.editStudent = editStudent;
        window.updateStudent = updateStudent;
        window.deleteStudent = deleteStudent;
        window.viewStudentDetails = viewStudentDetails;
        window.viewStudentGrades = viewStudentGrades;
        window.searchStudents = searchStudents;
        window.filterStudents = filterStudents;
        window.clearFilters = clearFilters;
        window.exportStudents = exportStudents;
        window.printStudents = printStudents;
        window.updateStreamOptions = updateStreamOptions;
        window.updateEditStreamOptions = updateEditStreamOptions;
        window.logout = logout;
    </script>
</body>
</html>
