<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Student Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportStudents()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printStudents()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search students..." onkeyup="searchStudents()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="classFilter" onchange="filterStudents()">
                            <option value="all">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter" onchange="filterStudents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="graduated">Graduated</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="yearFilter" onchange="filterStudents()">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Student Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-user-graduate text-primary mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle text-success mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-graduation-cap text-info mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Graduated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-times-circle text-danger mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Inactive</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Students</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Student ID</th>
                                        <th>Class</th>
                                        <th>Year</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="studentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="studentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="studentEmail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="studentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentClass" class="form-label">Class</label>
                                    <select class="form-select" id="studentClass" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentYear" class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="studentYear" value="2024" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="studentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="studentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="studentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="studentAddress" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="studentGuardianName" class="form-label">Guardian Name</label>
                            <input type="text" class="form-control" id="studentGuardianName">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentGuardianPhone" class="form-label">Guardian Phone</label>
                                    <input type="tel" class="form-control" id="studentGuardianPhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentGuardianEmail" class="form-label">Guardian Email</label>
                                    <input type="email" class="form-control" id="studentGuardianEmail">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addStudent()">Add Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editStudentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editStudentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editStudentEmail" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="editStudentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentClass" class="form-label">Class</label>
                                    <select class="form-select" id="editStudentClass" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentYear" class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="editStudentYear" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="editStudentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="editStudentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editStudentAddress" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentGuardianName" class="form-label">Guardian Name</label>
                            <input type="text" class="form-control" id="editStudentGuardianName">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentGuardianPhone" class="form-label">Guardian Phone</label>
                                    <input type="tel" class="form-control" id="editStudentGuardianPhone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentGuardianEmail" class="form-label">Guardian Email</label>
                                    <input type="email" class="form-control" id="editStudentGuardianEmail">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStudentStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="graduated">Graduated</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">Update Student</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStudent()">Delete Student</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "ass-sms.firebaseapp.com",
            projectId: "ass-sms",
            storageBucket: "ass-sms.firebasestorage.app",
            messagingSenderId: "515388722489",
            appId: "1:515388722489:web:21169f130303f48aaa2ce8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let students = [];
        let filteredStudents = [];
        let classes = [];
        let academicYears = [];
        
        // Check authentication and role
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userRole = userData.role;
                        
                        if (userRole === 'system_admin') {
                            console.log('‚úÖ System Administrator authenticated:', user.email);
                            currentUser = user;
                            loadStudents();
                            loadClasses();
                            loadAcademicYears();
                        } else {
                            console.log('‚ùå Access denied. Required role: system_admin');
                            alert('Access denied. You do not have system administrator privileges.');
                            auth.signOut().then(() => {
                                window.location.href = '../../index.html';
                            });
                        }
                    } else {
                        console.log('‚ùå User document not found');
                        auth.signOut().then(() => {
                            window.location.href = '../../index.html';
                        });
                    }
                });
            } else {
                console.log('‚ùå No authenticated user, redirecting to login');
                window.location.href = '../../index.html';
            }
        });
        
        // Load students from Firebase
        async function loadStudents() {
            try {
                const studentsSnapshot = await db.collection('students')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                students = [];
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    students.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                filteredStudents = [...students];
                displayStudents();
                updateStudentStats();
                
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Failed to load students. Please try again.');
            }
        }
        
        // Load classes
        async function loadClasses() {
            try {
                const classesSnapshot = await db.collection('classes').get();
                classes = [];
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    classes.push({
                        id: doc.id,
                        ...classData
                    });
                });
                
                populateClassSelects();
                
            } catch (error) {
                console.error('Error loading classes:', error);
                // Set default classes if none exist
                classes = [
                    { id: '1', name: 'S.1', level: 'Senior 1' },
                    { id: '2', name: 'S.2', level: 'Senior 2' },
                    { id: '3', name: 'S.3', level: 'Senior 3' },
                    { id: '4', name: 'S.4', level: 'Senior 4' },
                    { id: '5', name: 'S.5', level: 'Senior 5' },
                    { id: '6', name: 'S.6', level: 'Senior 6' }
                ];
                populateClassSelects();
            }
        }
        
        // Load academic years
        async function loadAcademicYears() {
            try {
                const yearsSnapshot = await db.collection('academic_years').get();
                academicYears = [];
                yearsSnapshot.forEach(doc => {
                    const yearData = doc.data();
                    academicYears.push({
                        id: doc.id,
                        ...yearData
                    });
                });
                
                populateYearSelects();
                
            } catch (error) {
                console.error('Error loading academic years:', error);
                // Set default years
                academicYears = [
                    { id: '1', year: '2024' },
                    { id: '2', year: '2023' },
                    { id: '3', year: '2022' }
                ];
                populateYearSelects();
            }
        }
        
        // Populate class selects
        function populateClassSelects() {
            const classSelects = ['studentClass', 'editStudentClass', 'classFilter'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = selectId === 'classFilter' ? '<option value="all">All Classes</option>' : '<option value="">Select Class</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.name;
                        option.textContent = cls.name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Populate year selects
        function populateYearSelects() {
            const yearSelects = ['yearFilter'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="all">All Years</option>';
                    academicYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year.year;
                        option.textContent = year.year;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Display students in the table
        function displayStudents() {
            const tbody = document.querySelector('#studentsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            filteredStudents.forEach(student => {
                const row = createStudentRow(student);
                tbody.appendChild(row);
            });
        }
        
        // Create student row
        function createStudentRow(student) {
            const row = document.createElement('tr');
            const fullName = `${student.firstName || ''} ${student.lastName || ''}`.trim();
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            const statusColors = {
                'active': 'success',
                'inactive': 'danger',
                'graduated': 'info'
            };
            const statusColor = statusColors[student.status] || 'secondary';
            
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">${initials}</div>
                        <div>
                            <strong>${fullName}</strong><br>
                            <small class="text-muted">${student.email || 'No email'}</small>
                        </div>
                    </div>
                </td>
                <td>${student.studentId || 'N/A'}</td>
                <td>${student.class || 'N/A'}</td>
                <td>${student.academicYear || 'N/A'}</td>
                <td><span class="badge bg-${statusColor}">${student.status || 'Unknown'}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewStudentDetails('${student.id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="viewStudentGrades('${student.id}')" title="View Grades">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${student.id}')" title="Delete Student">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            return row;
        }
        
        // Update student statistics
        function updateStudentStats() {
            const totalStudents = students.length;
            const activeStudents = students.filter(student => student.status === 'active').length;
            const graduatedStudents = students.filter(student => student.status === 'graduated').length;
            const inactiveStudents = students.filter(student => student.status === 'inactive').length;
            
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalStudents;
                statsCards[1].textContent = activeStudents;
                statsCards[2].textContent = graduatedStudents;
                statsCards[3].textContent = inactiveStudents;
            }
        }
        
        // Add new student
        async function addStudent() {
            const firstName = document.getElementById('studentFirstName').value;
            const lastName = document.getElementById('studentLastName').value;
            const email = document.getElementById('studentEmail').value;
            const phone = document.getElementById('studentPhone').value;
            const studentClass = document.getElementById('studentClass').value;
            const academicYear = document.getElementById('studentYear').value;
            const dateOfBirth = document.getElementById('studentDateOfBirth').value;
            const gender = document.getElementById('studentGender').value;
            const address = document.getElementById('studentAddress').value;
            const guardianName = document.getElementById('studentGuardianName').value;
            const guardianPhone = document.getElementById('studentGuardianPhone').value;
            const guardianEmail = document.getElementById('studentGuardianEmail').value;
            
            if (!firstName || !lastName || !email || !studentClass || !academicYear || !dateOfBirth || !gender) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                // Generate student ID
                const studentId = `STU${Date.now().toString().slice(-6)}`;
                
                const studentData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone || '',
                    studentId: studentId,
                    class: studentClass,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                    guardian: {
                        name: guardianName || '',
                        phone: guardianPhone || '',
                        email: guardianEmail || ''
                    },
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('students').add(studentData);
                
                showSuccess('Student added successfully!');
                document.getElementById('addStudentForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('Error adding student:', error);
                showError('Error adding student: ' + error.message);
            }
        }
        
        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentFirstName').value = student.firstName || '';
            document.getElementById('editStudentLastName').value = student.lastName || '';
            document.getElementById('editStudentEmail').value = student.email || '';
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentClass').value = student.class || '';
            document.getElementById('editStudentYear').value = student.academicYear || '';
            document.getElementById('editStudentDateOfBirth').value = student.dateOfBirth ? 
                new Date(student.dateOfBirth.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editStudentAddress').value = student.address || '';
            document.getElementById('editStudentGuardianName').value = student.guardian?.name || '';
            document.getElementById('editStudentGuardianPhone').value = student.guardian?.phone || '';
            document.getElementById('editStudentGuardianEmail').value = student.guardian?.email || '';
            document.getElementById('editStudentStatus').value = student.status || 'active';
            
            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }
        
        // Update student
        async function updateStudent() {
            const studentId = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const email = document.getElementById('editStudentEmail').value;
            const phone = document.getElementById('editStudentPhone').value;
            const studentClass = document.getElementById('editStudentClass').value;
            const academicYear = document.getElementById('editStudentYear').value;
            const dateOfBirth = document.getElementById('editStudentDateOfBirth').value;
            const gender = document.getElementById('editStudentGender').value;
            const address = document.getElementById('editStudentAddress').value;
            const guardianName = document.getElementById('editStudentGuardianName').value;
            const guardianPhone = document.getElementById('editStudentGuardianPhone').value;
            const guardianEmail = document.getElementById('editStudentGuardianEmail').value;
            const status = document.getElementById('editStudentStatus').value;
            
            if (!firstName || !lastName || !email || !studentClass || !academicYear || !dateOfBirth || !gender) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                await db.collection('students').doc(studentId).update({
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone || '',
                    class: studentClass,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                    guardian: {
                        name: guardianName || '',
                        phone: guardianPhone || '',
                        email: guardianEmail || ''
                    },
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                });
                
                showSuccess('Student updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('Error updating student:', error);
                showError('Error updating student: ' + error.message);
            }
        }
        
        // Delete student
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                try {
                    await db.collection('students').doc(studentId).delete();
                    showSuccess('Student deleted successfully!');
                    loadStudents();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    showError('Error deleting student: ' + error.message);
                }
            }
        }
        
        // View student details
        function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const dateOfBirth = student.dateOfBirth ? new Date(student.dateOfBirth.seconds * 1000).toLocaleDateString() : 'Not set';
            const createdDate = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            
            const details = `
                <strong>Student Details:</strong><br><br>
                <strong>Name:</strong> ${student.firstName} ${student.lastName}<br>
                <strong>Student ID:</strong> ${student.studentId || 'N/A'}<br>
                <strong>Email:</strong> ${student.email}<br>
                <strong>Phone:</strong> ${student.phone || 'Not provided'}<br>
                <strong>Class:</strong> ${student.class || 'N/A'}<br>
                <strong>Academic Year:</strong> ${student.academicYear || 'N/A'}<br>
                <strong>Date of Birth:</strong> ${dateOfBirth}<br>
                <strong>Gender:</strong> ${student.gender || 'Not specified'}<br>
                <strong>Address:</strong> ${student.address || 'Not provided'}<br>
                <strong>Status:</strong> ${student.status || 'Unknown'}<br><br>
                <strong>Guardian Information:</strong><br>
                <strong>Name:</strong> ${student.guardian?.name || 'Not provided'}<br>
                <strong>Phone:</strong> ${student.guardian?.phone || 'Not provided'}<br>
                <strong>Email:</strong> ${student.guardian?.email || 'Not provided'}<br><br>
                <strong>Created:</strong> ${createdDate}
            `;
            
            alert(details);
        }
        
        // View student grades (placeholder)
        function viewStudentGrades(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            alert(`View grades for ${student.firstName} ${student.lastName} - This feature will be implemented in the grades module.`);
        }
        
        // Search students
        function searchStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredStudents = students.filter(student => 
                (student.firstName || '').toLowerCase().includes(searchTerm) ||
                (student.lastName || '').toLowerCase().includes(searchTerm) ||
                (student.email || '').toLowerCase().includes(searchTerm) ||
                (student.studentId || '').toLowerCase().includes(searchTerm)
            );
            displayStudents();
        }
        
        // Filter students
        function filterStudents() {
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            filteredStudents = students.filter(student => {
                const classMatch = classFilter === 'all' || student.class === classFilter;
                const statusMatch = statusFilter === 'all' || student.status === statusFilter;
                const yearMatch = yearFilter === 'all' || student.academicYear === yearFilter;
                return classMatch && statusMatch && yearMatch;
            });
            
            displayStudents();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('classFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            filteredStudents = [...students];
            displayStudents();
        }
        
        // Export students
        function exportStudents() {
            const studentsData = students.map(student => ({
                firstName: student.firstName,
                lastName: student.lastName,
                email: student.email,
                phone: student.phone,
                studentId: student.studentId,
                class: student.class,
                academicYear: student.academicYear,
                gender: student.gender,
                status: student.status,
                guardianName: student.guardian?.name,
                guardianPhone: student.guardian?.phone,
                guardianEmail: student.guardian?.email
            }));
            
            const dataStr = JSON.stringify(studentsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Students exported successfully!');
        }
        
        // Print students
        function printStudents() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.addStudent = addStudent;
        window.editStudent = editStudent;
        window.updateStudent = updateStudent;
        window.deleteStudent = deleteStudent;
        window.viewStudentDetails = viewStudentDetails;
        window.viewStudentGrades = viewStudentGrades;
        window.searchStudents = searchStudents;
        window.filterStudents = filterStudents;
        window.clearFilters = clearFilters;
        window.exportStudents = exportStudents;
        window.printStudents = printStudents;
        window.logout = logout;
    </script>
</body>
</html>
