<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
    <style>
        .filter-status {
            transition: all 0.3s ease;
        }
        .filter-status.text-info {
            background-color: rgba(13, 202, 240, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #0dcaf0;
        }
        .search-input:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }
        .filter-select:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }
        .btn-clear-filters:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Student Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportStudents()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printStudents()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="fixMalformedStudentIds()" title="Fix malformed student IDs">
                                <i class="fas fa-wrench"></i> Fix IDs
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="cleanupDuplicateStudents()" title="Remove duplicate students from database">
                                <i class="fas fa-trash-alt"></i> Clean Duplicates
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-plus"></i> Add Student
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control search-input" id="searchInput" placeholder="Search students..." onkeyup="searchStudents()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-select" id="classFilter" onchange="filterStudents()">
                            <option value="all">All Classes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-select" id="statusFilter" onchange="filterStudents()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="graduated">Graduated</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-select" id="yearFilter" onchange="filterStudents()">
                            <option value="all">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100 btn-clear-filters" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Student Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-user-graduate text-primary mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle text-success mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Active</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-graduation-cap text-info mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Graduated</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-times-circle text-danger mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Inactive</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Students</h5>
                        <div class="filter-status">
                            <small class="text-muted" id="filterStatus">Showing all students</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="studentsTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Payment Code</th>
                                        <th>Class & Year</th>
                                        <th>Parent/Guardian</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="card-footer bg-light">
                            <div id="pageInfoContainer" class="mb-3">
                                <!-- Page info will be inserted here -->
                            </div>
                            <div id="paginationContainer">
                                <!-- Pagination controls will be inserted here -->
                            </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="studentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="studentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="studentEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="studentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentClass" class="form-label">Class</label>
                                    <div class="input-group">
                                    <select class="form-select" id="studentClass" required onchange="updateStreamOptions()">
                                        <option value="">Select Class</option>
                                        <!-- Classes will be loaded dynamically -->
                                    </select>
                                        <button class="btn btn-outline-secondary" type="button" id="add-class-btn" title="Add New Class" data-bs-toggle="modal" data-bs-target="#createClassModal">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentStream" class="form-label">Stream (Optional)</label>
                                    <select class="form-select" id="studentStream">
                                        <option value="">No Stream</option>
                                        <option value="Science">Science</option>
                                        <option value="Arts">Arts</option>
                                        <option value="Commercial">Commercial</option>
                                        <option value="Technical">Technical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="studentYear" class="form-label">Academic Year</label>
                                    <select class="form-select" id="studentYear" required>
                                        <option value="">Select Year</option>
                                        <!-- Academic years will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="studentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="studentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="studentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="studentAddress" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentPaymentCode" class="form-label">Student Payment Code</label>
                                    <input type="text" class="form-control" id="studentPaymentCode" required placeholder="Enter payment code">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentAdmissionNumber" class="form-label">Admission Number</label>
                                    <input type="text" class="form-control" id="studentAdmissionNumber" placeholder="Auto-generated if empty">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parent/Guardian Information -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">Parent/Guardian Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentName" class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="parentName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentRelationship" class="form-label">Relationship</label>
                                            <select class="form-select" id="parentRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="Father">Father</option>
                                                <option value="Mother">Mother</option>
                                                <option value="Guardian">Guardian</option>
                                                <option value="Uncle">Uncle</option>
                                                <option value="Aunt">Aunt</option>
                                                <option value="Grandfather">Grandfather</option>
                                                <option value="Grandmother">Grandmother</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentPhone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="parentPhone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="parentEmail">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentOccupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="parentOccupation">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="parentWorkplace" class="form-label">Workplace</label>
                                            <input type="text" class="form-control" id="parentWorkplace">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="parentAddress" class="form-label">Parent/Guardian Address</label>
                                    <textarea class="form-control" id="parentAddress" rows="2"></textarea>
                                </div>
                                
                                <!-- Emergency Contact -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emergencyContactName" class="form-label">Emergency Contact Name</label>
                                            <input type="text" class="form-control" id="emergencyContactName">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="emergencyContactPhone" class="form-label">Emergency Contact Phone</label>
                                            <input type="tel" class="form-control" id="emergencyContactPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addStudentBtn" onclick="addStudent()">
                        <i class="fas fa-plus me-1"></i>Add Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentFirstName" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="editStudentFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentLastName" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="editStudentLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="editStudentEmail">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentPhone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="editStudentPhone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentClass" class="form-label">Class</label>
                                    <select class="form-select" id="editStudentClass" required onchange="updateEditStreamOptions()">
                                        <option value="">Select Class</option>
                                        <!-- Classes will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentStream" class="form-label">Stream (Optional)</label>
                                    <select class="form-select" id="editStudentStream">
                                        <option value="">No Stream</option>
                                        <option value="Science">Science</option>
                                        <option value="Arts">Arts</option>
                                        <option value="Commercial">Commercial</option>
                                        <option value="Technical">Technical</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="editStudentYear" class="form-label">Academic Year</label>
                                    <select class="form-select" id="editStudentYear" required>
                                        <option value="">Select Year</option>
                                        <!-- Academic years will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentDateOfBirth" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="editStudentDateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentGender" class="form-label">Gender</label>
                                    <select class="form-select" id="editStudentGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editStudentAddress" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentPaymentCode" class="form-label">Student Payment Code</label>
                                    <input type="text" class="form-control" id="editStudentPaymentCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editStudentAdmissionNumber" class="form-label">Admission Number</label>
                                    <input type="text" class="form-control" id="editStudentAdmissionNumber">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parent/Guardian Information -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">Parent/Guardian Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentName" class="form-label">Parent/Guardian Name</label>
                                            <input type="text" class="form-control" id="editParentName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentRelationship" class="form-label">Relationship</label>
                                            <select class="form-select" id="editParentRelationship" required>
                                                <option value="">Select Relationship</option>
                                                <option value="Father">Father</option>
                                                <option value="Mother">Mother</option>
                                                <option value="Guardian">Guardian</option>
                                                <option value="Uncle">Uncle</option>
                                                <option value="Aunt">Aunt</option>
                                                <option value="Grandfather">Grandfather</option>
                                                <option value="Grandmother">Grandmother</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentPhone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="editParentPhone" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentEmail" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="editParentEmail">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentOccupation" class="form-label">Occupation</label>
                                            <input type="text" class="form-control" id="editParentOccupation">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editParentWorkplace" class="form-label">Workplace</label>
                                            <input type="text" class="form-control" id="editParentWorkplace">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editParentAddress" class="form-label">Parent/Guardian Address</label>
                                    <textarea class="form-control" id="editParentAddress" rows="2"></textarea>
                                </div>
                                
                                <!-- Emergency Contact -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editEmergencyContactName" class="form-label">Emergency Contact Name</label>
                                            <input type="text" class="form-control" id="editEmergencyContactName">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editEmergencyContactPhone" class="form-label">Emergency Contact Phone</label>
                                            <input type="tel" class="form-control" id="editEmergencyContactPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentStatus" class="form-label">Status</label>
                            <select class="form-select" id="editStudentStatus" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="graduated">Graduated</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateStudent()">Update Student</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStudent()">Delete Student</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div class="modal fade" id="createClassModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Class</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-class-form">
                        <div class="mb-3">
                            <label for="new-class-name" class="form-label">Class Name</label>
                            <input type="text" class="form-control" id="new-class-name" placeholder="e.g., S1, S2, S3" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-class-level" class="form-label">Level</label>
                            <select class="form-select" id="new-class-level" required>
                                <option value="">Select Level</option>
                                <option value="O Level">O Level</option>
                                <option value="A Level">A Level</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="new-class-stream" class="form-label">Stream (Optional)</label>
                            <select class="form-select" id="new-class-stream">
                                <option value="">No Stream</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="new-class-description" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="new-class-description" rows="3" placeholder="Additional information about this class"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createNewClass()">Create Class</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/users/system-admin-utils.js"></script>
    
    <script>
        // System Admin Student Management Functionality
        let students = [];
        let filteredStudents = [];
        let classes = [];
        let academicYears = [];
        
        // Pagination variables
        let currentPage = 1;
        let studentsPerPage = 10;
        let totalPages = 1;
        let totalStudents = 0;
        
        // Button state management to prevent rapid clicking
        let isAddingStudent = false;
        
        // Helper function to create unique key for student deduplication
        function createStudentUniqueKey(studentData) {
            // Create a unique key based on multiple identifiers
            // Priority order: studentId > admissionNumber > paymentCode > name+dob
            if (studentData.studentId) {
                return `id_${studentData.studentId}`;
            }
            
            if (studentData.admissionNumber) {
                return `adm_${studentData.admissionNumber}`;
            }
            
            if (studentData.paymentCode) {
                return `pay_${studentData.paymentCode}`;
            }
            
            // Fallback to name + date of birth
            const firstName = (studentData.firstName || '').toLowerCase().trim();
            const lastName = (studentData.lastName || '').toLowerCase().trim();
            const dob = studentData.dateOfBirth ? 
                (studentData.dateOfBirth.toDate ? 
                    studentData.dateOfBirth.toDate().toISOString().split('T')[0] : 
                    new Date(studentData.dateOfBirth.seconds * 1000).toISOString().split('T')[0]
                ) : '';
            
            return `name_${firstName}_${lastName}_${dob}`;
        }
        
        // Helper functions for button state management
        function setAddStudentButtonState(isProcessing) {
            const addButton = document.getElementById('addStudentBtn');
            if (addButton) {
                if (isProcessing) {
                    addButton.disabled = true;
                    addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding Student...';
                    addButton.classList.add('btn-secondary');
                    addButton.classList.remove('btn-primary');
                } else {
                    addButton.disabled = false;
                    addButton.innerHTML = '<i class="fas fa-plus me-1"></i>Add Student';
                    addButton.classList.add('btn-primary');
                    addButton.classList.remove('btn-secondary');
                }
            }
        }
        
        function resetAddStudentButton() {
            isAddingStudent = false;
            setAddStudentButtonState(false);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                try {
                    if (typeof setupMobileSidebar === 'function') {
                        setupMobileSidebar();
                    } else {
                        console.warn('setupMobileSidebar function not available');
                    }
                    
                    // Add event listeners for modal state management
                    const addStudentModal = document.getElementById('addStudentModal');
                    if (addStudentModal) {
                        addStudentModal.addEventListener('hidden.bs.modal', function() {
                            console.log('üîÑ Add Student modal closed, resetting button state');
                            resetAddStudentButton();
                        });
                        
                        addStudentModal.addEventListener('show.bs.modal', function() {
                            console.log('üîÑ Add Student modal opened, ensuring button is ready');
                            resetAddStudentButton();
                        });
                    }
                    
            initializeStudentManagement();
                } catch (error) {
                    console.error('Error initializing student management:', error);
                }
            }, 100);
        });

        async function initializeStudentManagement() {
            console.log('üöÄ Starting student management initialization...');
            try {
                // Check Firebase availability
                console.log('üîç Checking Firebase availability...');
                console.log('Firebase auth available:', typeof window.auth !== 'undefined');
                console.log('Firebase db available:', typeof window.db !== 'undefined');
                
                // Wait for authentication and get the user
                console.log('üîê Waiting for authentication...');
                if (typeof waitForAuth === 'function') {
                    window.currentUser = await waitForAuth();
                    console.log('‚úÖ Authentication successful:', window.currentUser?.uid);
                } else {
                    console.error('‚ùå waitForAuth function not available');
                    throw new Error('waitForAuth function not available');
                }
                
                // Load user data using utility function
                console.log('üë§ Loading user data...');
                if (typeof loadSystemAdminUserData === 'function') {
                    const userResult = await loadSystemAdminUserData(db, window.currentUser);
                    console.log('User data result:', userResult);
                    if (!userResult.success) {
                        console.error('‚ùå Failed to load user data:', userResult.error);
                        if (typeof showError === 'function') {
                            showError(userResult.error);
                        } else {
                            console.error('Error loading user data:', userResult.error);
                        }
                        return;
                    }
                    
                    // Update UI with user data
                    updateUserDisplay(userResult);
                    console.log('‚úÖ User display updated');
                } else {
                    console.error('‚ùå loadSystemAdminUserData function not available');
                    throw new Error('loadSystemAdminUserData function not available');
                }
                
                // Load student data
                console.log('üìö Loading student data...');
                await loadStudents();
                console.log('üìö Loading classes...');
                await loadClasses();
                console.log('üìÖ Loading academic years...');
                await loadAcademicYears();
                console.log('üîÑ Setting up real-time listeners...');
                setupRealTimeListeners();
                console.log('‚úÖ Student management initialization complete!');
                
            } catch (error) {
                console.error('‚ùå Error initializing student management:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                if (typeof showError === 'function') {
                    showError('Failed to initialize student management. Please refresh and try again.');
                } else {
                    console.error('Failed to initialize student management. Please refresh and try again.');
                }
            }
        }

        function updateUserDisplay(userResult) {
            try {
                // Update current user display
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = userResult.userName;
                }
                
                // Update sidebar staff ID
                const staffIdEl = document.querySelector('.sidebar small');
                if (staffIdEl) {
                    staffIdEl.textContent = `Staff ID: ${userResult.staffId}`;
                }
                
                console.log('System Admin Student Management user loaded:', {
                    name: userResult.userName,
                    department: userResult.departmentId,
                    departmentName: userResult.departmentName,
                    staffId: userResult.staffId
                });
            } catch (error) {
                console.error('Error updating user display:', error);
            }
        }
        
        // Load students from Firebase
        async function loadStudents() {
            console.log('üìö Starting to load students from Firestore...');
            try {
                console.log('üîç Querying students collection...');
                const studentsSnapshot = await db.collection('students')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                console.log('üìä Students snapshot received:', studentsSnapshot.size, 'documents');
                
                students = [];
                const seenStudents = new Set(); // Track unique students
                let duplicateCount = 0;
                
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    const studentRecord = {
                        id: doc.id,
                        ...studentData
                    };
                    
                    // Create a unique identifier for deduplication
                    const uniqueKey = createStudentUniqueKey(studentData);
                    
                    if (seenStudents.has(uniqueKey)) {
                        console.log('‚ö†Ô∏è Duplicate student detected:', {
                            name: `${studentData.firstName} ${studentData.lastName}`,
                            studentId: studentData.studentId,
                            admissionNumber: studentData.admissionNumber,
                            paymentCode: studentData.paymentCode,
                            documentId: doc.id
                        });
                        duplicateCount++;
                        return; // Skip this duplicate
                    }
                    
                    seenStudents.add(uniqueKey);
                    students.push(studentRecord);
                });
                
                console.log('‚úÖ Processed', students.length, 'unique students');
                if (duplicateCount > 0) {
                    console.log(`‚ö†Ô∏è Skipped ${duplicateCount} duplicate student records`);
                }
                
                filteredStudents = [...students];
                displayStudents();
                updateStudentStats();
                updateFilterStatus(students.length, students.length);
                populateFilterDropdowns();
                
                console.log(`‚úÖ Loaded ${students.length} students from Firestore`);
                
            } catch (error) {
                console.error('‚ùå Error loading students:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                if (typeof showError === 'function') {
                    showError('Failed to load students. Please try again.');
                } else {
                    console.error('Failed to load students. Please try again.');
                }
            }
        }
        
        // Load classes dynamically from Firestore
        async function loadClasses() {
            console.log('üìö Starting to load classes from Firestore...');
            try {
                console.log('üîç Querying classes collection...');
                const classesSnapshot = await db.collection('classes')
                    .where('status', '==', 'active')
                    .orderBy('name')
                    .get();
                
                console.log('üìä Classes snapshot received:', classesSnapshot.size, 'documents');
                
                classes = [];
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    classes.push({
                        id: doc.id,
                        ...classData
                    });
                });
                
                console.log('‚úÖ Processed', classes.length, 'classes');
                
                // If no classes found, use sample data
                if (classes.length === 0) {
                    console.log('‚ö†Ô∏è No classes found in Firestore, using sample data');
                    classes = [
                        { id: 's1', name: 'S1', level: 'O Level', stream: null },
                        { id: 's2', name: 'S2', level: 'O Level', stream: null },
                        { id: 's3', name: 'S3', level: 'O Level', stream: null },
                        { id: 's4', name: 'S4', level: 'O Level', stream: null },
                        { id: 's5', name: 'S5', level: 'A Level', stream: null },
                        { id: 's6', name: 'S6', level: 'A Level', stream: null }
                    ];
                }
                
                populateClassDropdowns();
                console.log(`‚úÖ Loaded ${classes.length} classes from Firestore`);
                
            } catch (error) {
                console.error('‚ùå Error loading classes:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                // Fallback to sample data
                console.log('üîÑ Using fallback sample data for classes');
                classes = [
                    { id: 's1', name: 'S1', level: 'O Level', stream: null },
                    { id: 's2', name: 'S2', level: 'O Level', stream: null },
                    { id: 's3', name: 'S3', level: 'O Level', stream: null },
                    { id: 's4', name: 'S4', level: 'O Level', stream: null },
                    { id: 's5', name: 'S5', level: 'A Level', stream: null },
                    { id: 's6', name: 'S6', level: 'A Level', stream: null }
                ];
                populateClassSelects();
            }
        }
        
        // Load academic years dynamically from Firestore
        async function loadAcademicYears() {
            try {
                const yearsSnapshot = await db.collection('academic_years')
                    .orderBy('year', 'desc')
                    .get();
                
                academicYears = [];
                yearsSnapshot.forEach(doc => {
                    const yearData = doc.data();
                    academicYears.push({
                        id: doc.id,
                        ...yearData
                    });
                });
                
                // If no academic years found, create current year
                if (academicYears.length === 0) {
                    console.log('No academic years found in Firestore, creating current year');
                    const currentYear = new Date().getFullYear();
                    academicYears = [
                        { id: 'current', year: currentYear.toString(), isActive: true },
                        { id: 'previous', year: (currentYear - 1).toString(), isActive: false }
                    ];
                }
                
                populateYearSelects();
                console.log(`‚úÖ Loaded ${academicYears.length} academic years from Firestore`);
                
            } catch (error) {
                console.error('Error loading academic years:', error);
                // Fallback to current year
                const currentYear = new Date().getFullYear();
                academicYears = [
                    { id: 'current', year: currentYear.toString(), isActive: true },
                    { id: 'previous', year: (currentYear - 1).toString(), isActive: false }
                ];
                populateYearSelects();
            }
        }
        
        // Populate class selects with dynamic data
         // Populate class dropdowns with loaded classes (consistent with user-management.html)
         function populateClassDropdowns() {
            const classSelects = ['studentClass', 'editStudentClass', 'classFilter'];
            classSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = selectId === 'classFilter' ? '<option value="all">All Classes</option>' : '<option value="">Select Class</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                         option.value = cls.name.toUpperCase(); // Use uppercase for consistency
                        option.textContent = `${cls.name} (${cls.level})`;
                        select.appendChild(option);
                    });
                }
            });
         }

        // Create new class function (consistent with user-management.html)
        async function createNewClass() {
            const className = document.getElementById('new-class-name').value.trim();
            const classLevel = document.getElementById('new-class-level').value;
            const classStream = document.getElementById('new-class-stream').value;
            const classDescription = document.getElementById('new-class-description').value.trim();
            
            // Validation
            if (!className || !classLevel) {
                showError('Please fill in class name and select level.');
                return;
            }
            
            try {
                showLoading('Creating new class...');
                
                 // Generate class ID and normalize name
                 const classId = className.toLowerCase().replace(/\s+/g, '_');
                 const normalizedClassName = className.toUpperCase();
                 
                 // Create class document in Firestore
                 const classData = {
                     id: classId,
                     name: normalizedClassName,
                     displayName: className, // Keep original case for display
                     level: classLevel,
                     stream: classStream || null,
                     description: classDescription || '',
                     status: 'active',
                     createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                     createdBy: window.currentUser?.uid || 'system'
                 };
                
                await db.collection('classes').doc(classId).set(classData);
                
                // Add to local classes array
                classes.push(classData);
                
                // Update the class dropdowns
                populateClassDropdowns();
                
                 // Select the newly created class
                 const classSelect = document.getElementById('studentClass');
                 if (classSelect) {
                     classSelect.value = normalizedClassName;
                 }
                
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('createClassModal')).hide();
                
                // Clear the form
                document.getElementById('create-class-form').reset();
                
                showSuccess(`Class "${className}" created successfully!`);
                
            } catch (error) {
                console.error('Error creating class:', error);
                showError('Failed to create class. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        // Populate filter dropdowns with actual student data
        function populateFilterDropdowns() {
            // Get unique classes from students
            const uniqueClasses = [...new Set(students.map(student => student.class).filter(Boolean))];
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.innerHTML = '<option value="all">All Classes</option>';
                uniqueClasses.sort().forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classFilter.appendChild(option);
                });
            }
            
            // Get unique academic years from students
            const uniqueYears = [...new Set(students.map(student => student.academicYear).filter(Boolean))];
            const yearFilter = document.getElementById('yearFilter');
            if (yearFilter) {
                yearFilter.innerHTML = '<option value="all">All Years</option>';
                uniqueYears.sort((a, b) => b - a).forEach(year => { // Sort descending (newest first)
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            }
        }
        
        // Populate year selects with dynamic data
        function populateYearSelects() {
            const yearSelects = ['studentYear', 'editStudentYear', 'yearFilter'];
            yearSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    if (selectId === 'yearFilter') {
                    select.innerHTML = '<option value="all">All Years</option>';
                    } else {
                        select.innerHTML = '<option value="">Select Year</option>';
                    }
                    academicYears.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year.year;
                        option.textContent = year.year;
                        if (year.isActive) {
                            option.selected = true; // Select active year by default
                        }
                        select.appendChild(option);
                    });
                }
            });
        }
        
        // Display students in table with pagination
        function displayStudents() {
            const tbody = document.querySelector('#studentsTable tbody');
            if (!tbody) return;
            
            // Update pagination variables
            totalStudents = filteredStudents.length;
            totalPages = Math.ceil(totalStudents / studentsPerPage);
            
            // Ensure current page is valid
            if (currentPage > totalPages) {
                currentPage = Math.max(1, totalPages);
            }
            
            // Additional deduplication check for display (safety measure)
            const uniquePageStudents = [];
            const seenInPage = new Set();
            
            filteredStudents.forEach(student => {
                const uniqueKey = createStudentUniqueKey(student);
                if (!seenInPage.has(uniqueKey)) {
                    seenInPage.add(uniqueKey);
                    uniquePageStudents.push(student);
                }
            });
            
            // Update filteredStudents with deduplicated data
            if (uniquePageStudents.length !== filteredStudents.length) {
                console.log(`üîß Display deduplication: Removed ${filteredStudents.length - uniquePageStudents.length} duplicates`);
                filteredStudents = uniquePageStudents;
                // Recalculate pagination
                totalStudents = filteredStudents.length;
                totalPages = Math.ceil(totalStudents / studentsPerPage);
                if (currentPage > totalPages) {
                    currentPage = Math.max(1, totalPages);
                }
            }
            
            // Get students for current page
            const startIndex = (currentPage - 1) * studentsPerPage;
            const endIndex = startIndex + studentsPerPage;
            const pageStudents = filteredStudents.slice(startIndex, endIndex);
            
            tbody.innerHTML = '';
            
            if (pageStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-user-graduate fa-2x mb-2"></i><br>
                            No students found
                        </td>
                    </tr>
                `;
            } else {
                pageStudents.forEach(student => {
                const row = createStudentRow(student);
                tbody.appendChild(row);
            });
            }
            
            // Update pagination controls
            updatePaginationControls();
            
            console.log(`üìä Displayed ${pageStudents.length} students (Page ${currentPage} of ${totalPages})`);
        }
        
        // Update pagination controls
        function updatePaginationControls() {
            const paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) return;
            
            if (totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }
            
            let paginationHTML = `
                <nav aria-label="Students pagination">
                    <ul class="pagination justify-content-center mb-0">
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <button class="page-link" onclick="goToPage(1)" title="First Page">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                        </li>
                        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                            <button class="page-link" onclick="goToPage(${currentPage - 1})" title="Previous Page">
                                <i class="fas fa-angle-left"></i>
                            </button>
                        </li>
            `;
            
            // Calculate page range to show
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add page numbers
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <button class="page-link" onclick="goToPage(${i})">${i}</button>
                    </li>
                `;
            }
            
            paginationHTML += `
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <button class="page-link" onclick="goToPage(${currentPage + 1})" title="Next Page">
                                <i class="fas fa-angle-right"></i>
                            </button>
                        </li>
                        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                            <button class="page-link" onclick="goToPage(${totalPages})" title="Last Page">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </li>
                    </ul>
                </nav>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
            
            // Update page info
            updatePageInfo();
        }
        
        // Update page information display
        function updatePageInfo() {
            const pageInfoContainer = document.getElementById('pageInfoContainer');
            if (!pageInfoContainer) return;
            
            const startIndex = (currentPage - 1) * studentsPerPage + 1;
            const endIndex = Math.min(currentPage * studentsPerPage, totalStudents);
            
            pageInfoContainer.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted">
                        Showing ${startIndex} to ${endIndex} of ${totalStudents} students
                    </div>
                    <div class="d-flex align-items-center">
                        <label class="form-label me-2 mb-0">Students per page:</label>
                        <select class="form-select form-select-sm" style="width: auto;" onchange="changeStudentsPerPage(this.value)">
                            <option value="5" ${studentsPerPage === 5 ? 'selected' : ''}>5</option>
                            <option value="10" ${studentsPerPage === 10 ? 'selected' : ''}>10</option>
                            <option value="25" ${studentsPerPage === 25 ? 'selected' : ''}>25</option>
                            <option value="50" ${studentsPerPage === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${studentsPerPage === 100 ? 'selected' : ''}>100</option>
                        </select>
                    </div>
                </div>
            `;
        }
        
        // Go to specific page
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            
            currentPage = page;
            displayStudents();
            
            // Scroll to top of table
            const tableContainer = document.getElementById('studentsTableContainer');
            if (tableContainer) {
                tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Change students per page
        function changeStudentsPerPage(newPerPage) {
            studentsPerPage = parseInt(newPerPage);
            currentPage = 1; // Reset to first page
            displayStudents();
        }
        
        // Create student row
        function createStudentRow(student) {
            const row = document.createElement('tr');
            const fullName = `${student.firstName || ''} ${student.lastName || ''}`.trim();
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            const statusColors = {
                'active': 'success',
                'inactive': 'danger',
                'graduated': 'info'
            };
            const statusColor = statusColors[student.status] || 'secondary';
            
            // Format class with stream if available
            const classDisplay = student.stream ? `${student.class} (${student.stream})` : student.class;
            
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">${initials}</div>
                        <div>
                            <strong>${fullName}</strong><br>
                            <small class="text-muted">${student.email || 'No email'}</small><br>
                            <small class="text-muted">ID: ${formatStudentId(student.studentId) || 'N/A'}</small>
                        </div>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${student.paymentCode || 'N/A'}</strong><br>
                        <small class="text-muted">Payment Code</small>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${classDisplay || 'N/A'}</strong><br>
                        <small class="text-muted">${student.academicYear || 'N/A'}</small>
                    </div>
                </td>
                <td>
                    <div>
                        <strong>${student.parent?.name || 'N/A'}</strong><br>
                        <small class="text-muted">${student.parent?.relationship || ''}</small>
                    </div>
                </td>
                <td><span class="badge bg-${statusColor}">${student.status || 'Unknown'}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editStudent('${student.id}')" title="Edit Student">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewStudentDetails('${student.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="viewStudentGrades('${student.id}')" title="View Grades">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteStudent('${student.id}')" title="Delete Student">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Update student statistics
        function updateStudentStats() {
            const totalStudents = students.length;
            const activeStudents = students.filter(student => student.status === 'active').length;
            const graduatedStudents = students.filter(student => student.status === 'graduated').length;
            const inactiveStudents = students.filter(student => student.status === 'inactive').length;
            
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalStudents;
                statsCards[1].textContent = activeStudents;
                statsCards[2].textContent = graduatedStudents;
                statsCards[3].textContent = inactiveStudents;
            }
            
            console.log(`üìä Student Stats - Total: ${totalStudents}, Active: ${activeStudents}, Graduated: ${graduatedStudents}, Inactive: ${inactiveStudents}`);
        }
        
        // Update stream options based on class selection
        function updateStreamOptions() {
            const classSelect = document.getElementById('studentClass');
            const streamSelect = document.getElementById('studentStream');
            
            if (classSelect.value === 'S5' || classSelect.value === 'S6') {
                // A-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else if (classSelect.value === 'S3' || classSelect.value === 'S4') {
                // O-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else {
                // S1 and S2 - no streams typically
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                `;
            }
        }
        
        // Fix malformed student IDs in the database
        async function fixMalformedStudentIds() {
            try {
                console.log('üîß Starting to fix malformed student IDs...');
                showLoading('Fixing malformed student IDs...');
                
                const studentsSnapshot = await db.collection('students').get();
                let fixedCount = 0;
                let skippedCount = 0;
                
                const updates = [];
                
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    const studentId = studentData.studentId;
                    
                    console.log('üîç Checking student:', studentData.firstName, studentData.lastName, 'ID:', studentId);
                    
                    // Check if ID is malformed
                    let needsFix = false;
                    let reason = '';
                    
                    if (!studentId) {
                        needsFix = true;
                        reason = 'Missing student ID';
                    } else if (typeof studentId === 'number') {
                        needsFix = true;
                        reason = 'ID is a number instead of string';
                    } else if (typeof studentId === 'string') {
                        if (studentId === 'NaN' || studentId === 'null' || studentId === 'undefined') {
                            needsFix = true;
                            reason = 'ID is invalid string value';
                        } else if (studentId.includes('e+')) {
                            needsFix = true;
                            reason = 'ID contains scientific notation';
                        } else if (studentId.length > 15) {
                            needsFix = true;
                            reason = 'ID is too long';
                        } else if (!studentId.match(/^ASS[A-Z]{2}\d{2}\d{4}$/) && !/^\d+$/.test(studentId)) {
                            needsFix = true;
                            reason = 'ID format is invalid';
                        }
                    }
                    
                    if (needsFix) {
                        console.log(`üîß Fixing student: ${studentData.firstName} ${studentData.lastName}`);
                        console.log(`   Reason: ${reason}`);
                        console.log(`   Old ID: ${studentId}`);
                        
                        // Generate a new proper ID
                        const newId = generateNewStudentId(studentData.class, fixedCount + 1);
                        console.log(`   New ID: ${newId}`);
                        
                        updates.push({ docRef: doc.ref, newId: newId });
                        fixedCount++;
                    } else {
                        skippedCount++;
                        console.log(`‚úÖ Student ID is valid: ${studentId}`);
                    }
                });
                
                // Process updates in batches
                const batchSize = 500; // Firestore batch limit
                for (let i = 0; i < updates.length; i += batchSize) {
                    const batch = db.batch();
                    const batchUpdates = updates.slice(i, i + batchSize);
                    
                    console.log(`üì¶ Processing batch ${Math.floor(i / batchSize) + 1} with ${batchUpdates.length} updates`);
                    
                    batchUpdates.forEach(update => {
                        batch.update(update.docRef, { studentId: update.newId });
                    });
                    
                    await batch.commit();
                    console.log(`‚úÖ Committed batch ${Math.floor(i / batchSize) + 1}`);
                }
                
                console.log(`‚úÖ Fixed ${fixedCount} malformed student IDs`);
                console.log(`‚è≠Ô∏è Skipped ${skippedCount} valid student IDs`);
                
                if (fixedCount > 0) {
                    showSuccess(`Fixed ${fixedCount} malformed student IDs! Skipped ${skippedCount} valid IDs.`);
                    loadStudents(); // Reload to show updated IDs
                } else {
                    showSuccess('All student IDs are properly formatted!');
                }
                
            } catch (error) {
                console.error('‚ùå Error fixing malformed student IDs:', error);
                showError('Failed to fix malformed student IDs: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Generate a new student ID for fixing malformed ones (shorter format)
        function generateNewStudentId(studentClass, sequenceNumber) {
            const currentYear = new Date().getFullYear();
            const yearPrefix = currentYear.toString().slice(-2);
            
            let levelPrefix = 'O'; // Default for O-Level
            if (studentClass === 'S5' || studentClass === 'S6') {
                levelPrefix = 'A'; // A-Level
            }
            
            const prefix = 'S' + levelPrefix + yearPrefix;
            const finalId = prefix + String(sequenceNumber).padStart(4, '0');
            
            // Ensure ID is not longer than 10 characters
            return finalId.length > 10 ? finalId.substring(0, 10) : finalId;
        }
        
        // Format student ID to handle malformed IDs
        function formatStudentId(studentId) {
            if (!studentId) return 'N/A';
            
            console.log('üîß Formatting student ID:', studentId, 'Type:', typeof studentId);
            
            // If it's already a proper string format, return as is
            if (typeof studentId === 'string' && studentId.match(/^S[A-Z]\d{2}\d{4}$/)) {
                console.log('‚úÖ Student ID is already properly formatted');
                return studentId;
            }
            
            // Handle NaN or null values
            if (studentId === null || studentId === undefined || studentId === 'NaN' || studentId === 'null') {
                console.log('‚ö†Ô∏è Student ID is null/undefined/NaN, returning N/A');
                return 'N/A';
            }
            
            // If it's a number or scientific notation, convert to string
            if (typeof studentId === 'number' || (typeof studentId === 'string' && studentId.includes('e+'))) {
                console.log('üîß Converting number/scientific notation to string');
                const numStr = studentId.toString();
                
                // If it's in scientific notation, convert it
                if (numStr.includes('e+')) {
                    const num = parseFloat(numStr);
                    if (isNaN(num)) {
                        console.log('‚ö†Ô∏è Scientific notation conversion resulted in NaN');
                        return 'N/A';
                    }
                    const str = num.toFixed(0); // Convert to integer string
                    console.log('üîß Converted scientific notation:', numStr, 'to:', str);
                    return str;
                }
                
                // If it's a very long number, truncate it
                if (numStr.length > 15) {
                    console.log('‚ö†Ô∏è Number too long, truncating:', numStr);
                    return numStr.substring(0, 15);
                }
                
                return numStr;
            }
            
            // If it's a string but doesn't match the pattern, check if it's malformed
            if (typeof studentId === 'string') {
                // Check if it contains only numbers (malformed ID)
                if (/^\d+$/.test(studentId)) {
                    console.log('üîß String contains only numbers, might be malformed');
                    // If it's too long, truncate it
                    if (studentId.length > 15) {
                        return studentId.substring(0, 15);
                    }
                    return studentId;
                }
                
                // Check if it's a malformed ASS ID
                if (studentId.startsWith('ASS') && studentId.length > 15) {
                    console.log('üîß Malformed ASS ID detected, truncating:', studentId);
                    return studentId.substring(0, 15);
                }
                
                return studentId;
            }
            
            // Fallback: convert to string
            console.log('üîß Fallback: converting to string');
            return studentId.toString();
        }
        
        // Generate unique student ID (maximum 10 characters)
        async function generateStudentId(studentClass) {
            try {
                console.log('üÜî Generating student ID for class:', studentClass);
                
                const currentYear = new Date().getFullYear();
                const yearPrefix = currentYear.toString().slice(-2); // Last 2 digits of year
                
                // Determine level based on class - shorter prefixes
                let levelPrefix = 'O'; // O-Level
                if (studentClass === 'S5' || studentClass === 'S6') {
                    levelPrefix = 'A'; // A-Level
                }
                
                // Create shorter prefix: S + Level + Year = 3 characters
                const prefix = 'S' + levelPrefix + yearPrefix; // e.g., SO24, SA24
                console.log('üÜî Generated prefix:', prefix);
                
                // Get all students with this prefix to find the highest number
                const querySnapshot = await db.collection('students')
                    .where('studentId', '>=', prefix + '0001')
                    .where('studentId', '<=', prefix + '9999')
                    .get();
                
                let nextNumber = 1;
                let maxNumber = 0;
                
                if (!querySnapshot.empty) {
                    console.log('üîç Found', querySnapshot.size, 'existing students with prefix', prefix);
                    
                    querySnapshot.forEach(doc => {
                        const studentId = doc.data().studentId;
                        console.log('üîç Checking student ID:', studentId);
                        
                        if (studentId && typeof studentId === 'string' && studentId.startsWith(prefix)) {
                            // Extract the number part (everything after the prefix)
                            const numberPart = studentId.substring(prefix.length);
                            const number = parseInt(numberPart);
                            
                            console.log('üîç Extracted number:', number, 'from:', numberPart);
                            
                            if (!isNaN(number) && number > maxNumber) {
                                maxNumber = number;
                            }
                        }
                    });
                    
                    nextNumber = maxNumber + 1;
                    console.log('üîç Max number found:', maxNumber, 'Next number:', nextNumber);
                } else {
                    console.log('üîç No existing students found with prefix', prefix);
                }
                
                // Ensure the number doesn't exceed 4 digits (total length = 3 + 4 = 7 characters)
                if (nextNumber > 9999) {
                    console.warn('‚ö†Ô∏è Student ID sequence exceeded 9999, using fallback');
                    throw new Error('Student ID sequence exceeded maximum');
                }
                
                const finalId = prefix + String(nextNumber).padStart(4, '0');
                console.log('‚úÖ Generated final student ID:', finalId, '(Length:', finalId.length, ')');
                
                // Ensure ID is not longer than 10 characters
                if (finalId.length > 10) {
                    console.warn('‚ö†Ô∏è Generated ID too long, truncating:', finalId);
                    return finalId.substring(0, 10);
                }
                
                return finalId;
                
            } catch (error) {
                console.error('‚ùå Error generating student ID:', error);
                
                // Improved fallback with shorter format
                const currentYear = new Date().getFullYear();
                const yearPrefix = currentYear.toString().slice(-2);
                const levelPrefix = (studentClass === 'S5' || studentClass === 'S6') ? 'A' : 'O';
                
                // Generate a shorter fallback ID: S + Level + Year + 3 random digits = 6 characters
                const randomSuffix = Math.floor(Math.random() * 900) + 100; // 100-999
                const fallbackId = 'S' + levelPrefix + yearPrefix + String(randomSuffix);
                
                console.log('üîÑ Using fallback ID:', fallbackId, '(Length:', fallbackId.length, ')');
                return fallbackId;
            }
        }
        
        // Show duplicate error with detailed information
        function showDuplicateError(duplicateInfo) {
            const existingStudent = duplicateInfo.existingStudent;
            const reason = duplicateInfo.reason;
            const message = duplicateInfo.message;
            
            // Create a detailed error message
            const errorMessage = `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle"></i> Duplicate Student Detected</h6>
                    <p><strong>Reason:</strong> ${reason}</p>
                    <p><strong>Message:</strong> ${message}</p>
                    <hr>
                    <h6>Existing Student Details:</h6>
                    <ul class="mb-0">
                        <li><strong>Name:</strong> ${existingStudent.firstName} ${existingStudent.lastName}</li>
                        <li><strong>Student ID:</strong> ${formatStudentId(existingStudent.studentId) || 'N/A'}</li>
                        <li><strong>Admission Number:</strong> ${existingStudent.admissionNumber || 'N/A'}</li>
                        <li><strong>Payment Code:</strong> ${existingStudent.paymentCode || 'N/A'}</li>
                        <li><strong>Class:</strong> ${existingStudent.class || 'N/A'}</li>
                        <li><strong>Status:</strong> ${existingStudent.status || 'N/A'}</li>
                    </ul>
                </div>
            `;
            
            // Create modal for better display
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'duplicateStudentModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle"></i> Duplicate Student Detected
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${errorMessage}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> 
                                <strong>Please check:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Is this the same student?</li>
                                    <li>Are you trying to re-enroll an existing student?</li>
                                    <li>Did you enter incorrect information?</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="viewExistingStudent('${existingStudent.studentId || existingStudent.admissionNumber}')">
                                <i class="fas fa-eye"></i> View Existing Student
                            </button>
                            <button type="button" class="btn btn-danger" onclick="forceAddStudent()">
                                <i class="fas fa-plus"></i> Add Anyway (Not Recommended)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // View existing student details
        function viewExistingStudent(identifier) {
            // Close the duplicate modal first
            const duplicateModal = bootstrap.Modal.getInstance(document.getElementById('duplicateStudentModal'));
            if (duplicateModal) {
                duplicateModal.hide();
            }
            
            // Find and show the existing student
            const student = students.find(s => 
                s.studentId === identifier || 
                s.admissionNumber === identifier || 
                s.paymentCode === identifier
            );
            
            if (student) {
                viewStudentDetails(student.id);
            } else {
                showError('Could not find the existing student details.');
            }
        }
        
        // Force add student (not recommended)
        function forceAddStudent() {
            if (confirm('Are you sure you want to add this student anyway? This may create duplicate records and cause data inconsistencies.')) {
                // Close the duplicate modal
                const duplicateModal = bootstrap.Modal.getInstance(document.getElementById('duplicateStudentModal'));
                if (duplicateModal) {
                    duplicateModal.hide();
                }
                
                // Proceed with adding the student
                addStudentWithoutDuplicateCheck();
            }
        }
        
        // Add student without duplicate check (for force add)
        async function addStudentWithoutDuplicateCheck() {
            // This is the same as the original addStudent function but without duplicate checking
            // Implementation would be the same as addStudent but skipping the duplicate check
            showError('Force add functionality not implemented. Please review the duplicate and try again.');
        }
        
        // Check for duplicate students before adding
        async function checkForDuplicateStudent(studentData) {
            try {
                console.log('üîç Checking for duplicate students...');
                
                // Check by student ID (if provided)
                if (studentData.studentId) {
                    const existingById = await db.collection('students')
                        .where('studentId', '==', studentData.studentId)
                        .get();
                    
                    if (!existingById.empty) {
                        const existing = existingById.docs[0].data();
                        return {
                            isDuplicate: true,
                            reason: 'Student ID',
                            existingStudent: existing,
                            message: `A student with ID "${studentData.studentId}" already exists: ${existing.firstName} ${existing.lastName}`
                        };
                    }
                }
                
                // Check by admission number (if provided)
                if (studentData.admissionNumber) {
                    const existingByAdmission = await db.collection('students')
                        .where('admissionNumber', '==', studentData.admissionNumber)
                        .get();
                    
                    if (!existingByAdmission.empty) {
                        const existing = existingByAdmission.docs[0].data();
                        return {
                            isDuplicate: true,
                            reason: 'Admission Number',
                            existingStudent: existing,
                            message: `A student with admission number "${studentData.admissionNumber}" already exists: ${existing.firstName} ${existing.lastName}`
                        };
                    }
                }
                
                // Check by payment code (if provided)
                if (studentData.paymentCode) {
                    const existingByPayment = await db.collection('students')
                        .where('paymentCode', '==', studentData.paymentCode)
                        .get();
                    
                    if (!existingByPayment.empty) {
                        const existing = existingByPayment.docs[0].data();
                        return {
                            isDuplicate: true,
                            reason: 'Payment Code',
                            existingStudent: existing,
                            message: `A student with payment code "${studentData.paymentCode}" already exists: ${existing.firstName} ${existing.lastName}`
                        };
                    }
                }
                
                // Check by name and date of birth (more flexible check)
                const existingByName = await db.collection('students')
                    .where('firstName', '==', studentData.firstName)
                    .where('lastName', '==', studentData.lastName)
                    .get();
                
                if (!existingByName.empty) {
                    // Check if any of the results have the same date of birth
                    for (const doc of existingByName.docs) {
                        const existing = doc.data();
                        if (existing.dateOfBirth && studentData.dateOfBirth) {
                            const existingDate = existing.dateOfBirth.toDate ? existing.dateOfBirth.toDate() : new Date(existing.dateOfBirth.seconds * 1000);
                            const newDate = studentData.dateOfBirth.toDate ? studentData.dateOfBirth.toDate() : new Date(studentData.dateOfBirth.seconds * 1000);
                            
                            if (existingDate.getTime() === newDate.getTime()) {
                                return {
                                    isDuplicate: true,
                                    reason: 'Name and Date of Birth',
                                    existingStudent: existing,
                                    message: `A student with the same name "${studentData.firstName} ${studentData.lastName}" and date of birth already exists`
                                };
                            }
                        }
                    }
                }
                
                console.log('‚úÖ No duplicate students found');
                return { isDuplicate: false };
                
            } catch (error) {
                console.error('‚ùå Error checking for duplicates:', error);
                // If there's an error checking, allow the addition but log the error
                return { isDuplicate: false, error: error.message };
            }
        }
        
        // Add new student
        async function addStudent() {
            // Prevent multiple simultaneous submissions
            if (isAddingStudent) {
                console.log('‚ö†Ô∏è Student addition already in progress, ignoring duplicate click');
                return;
            }
            
            console.log('üöÄ Starting student addition process...');
            isAddingStudent = true;
            setAddStudentButtonState(true);
            
            const firstName = document.getElementById('studentFirstName').value;
            const lastName = document.getElementById('studentLastName').value;
            const email = document.getElementById('studentEmail').value;
            const phone = document.getElementById('studentPhone').value;
            const studentClass = document.getElementById('studentClass').value;
            const studentStream = document.getElementById('studentStream').value;
            const academicYear = document.getElementById('studentYear').value;
            const dateOfBirth = document.getElementById('studentDateOfBirth').value;
            const gender = document.getElementById('studentGender').value;
            const address = document.getElementById('studentAddress').value;
            const paymentCode = document.getElementById('studentPaymentCode').value;
            const admissionNumber = document.getElementById('studentAdmissionNumber').value;
            
            // Parent/Guardian information
            const parentName = document.getElementById('parentName').value;
            const parentRelationship = document.getElementById('parentRelationship').value;
            const parentPhone = document.getElementById('parentPhone').value;
            const parentEmail = document.getElementById('parentEmail').value;
            const parentOccupation = document.getElementById('parentOccupation').value;
            const parentWorkplace = document.getElementById('parentWorkplace').value;
            const parentAddress = document.getElementById('parentAddress').value;
            const emergencyContactName = document.getElementById('emergencyContactName').value;
            const emergencyContactPhone = document.getElementById('emergencyContactPhone').value;
            
            if (!firstName || !lastName || !studentClass || !academicYear || !dateOfBirth || !gender || !paymentCode || !parentName || !parentRelationship || !parentPhone) {
                console.log('‚ùå Validation failed: Missing required fields');
                resetAddStudentButton();
                if (typeof showError === 'function') {
                showError('Please fill in all required fields.');
                } else {
                    console.error('Please fill in all required fields.');
                }
                return;
            }
            
            try {
                console.log('üìù Validating student data...');
                showLoading('Adding student...');
                
                // Generate student ID with level and year prefix and sequential numbering
                const studentId = await generateStudentId(studentClass);
                
                // Generate admission number if not provided - shorter format
                let finalAdmissionNumber = admissionNumber;
                if (!finalAdmissionNumber) {
                    const currentYear = new Date().getFullYear();
                    const yearPrefix = currentYear.toString().slice(-2);
                    const randomSuffix = Math.floor(Math.random() * 9000) + 1000; // 1000-9999
                    finalAdmissionNumber = `ADM${yearPrefix}${randomSuffix}`;
                }
                
                console.log('üìù Generated IDs:', { studentId, admissionNumber: finalAdmissionNumber });
                
                 // Normalize class name to uppercase for consistency
                 const normalizedClass = studentClass.toUpperCase();
                
                const studentData = {
                    firstName: firstName,
                    lastName: lastName,
                    email: email || '',
                    phone: phone || '',
                    studentId: studentId,
                    admissionNumber: finalAdmissionNumber,
                    paymentCode: paymentCode,
                     class: normalizedClass,
                    stream: studentStream || null,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                     // Add academicInfo structure for consistency with teachers
                     academicInfo: {
                         currentClass: normalizedClass,
                         assignedClass: normalizedClass,
                         stream: studentStream || null,
                         academicYear: academicYear,
                         level: classes.find(c => c.name.toUpperCase() === normalizedClass)?.level || 'O Level'
                     },
                    parent: {
                        name: parentName,
                        relationship: parentRelationship,
                        phone: parentPhone,
                        email: parentEmail || '',
                        occupation: parentOccupation || '',
                        workplace: parentWorkplace || '',
                        address: parentAddress || ''
                    },
                    emergencyContact: {
                        name: emergencyContactName || '',
                        phone: emergencyContactPhone || ''
                    },
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: window.currentUser.uid
                };
                
                // Check for duplicates before adding
                console.log('üîç Checking for duplicate students...');
                const duplicateCheck = await checkForDuplicateStudent(studentData);
                if (duplicateCheck.isDuplicate) {
                    console.log('‚ùå Duplicate student detected:', duplicateCheck.reason);
                    hideLoading();
                    resetAddStudentButton();
                    showDuplicateError(duplicateCheck);
                    return;
                }
                
                console.log('‚úÖ No duplicates found, adding student to database...');
                await db.collection('students').add(studentData);
                
                console.log('‚úÖ Student added successfully!');
                hideLoading();
                resetAddStudentButton();
                showSuccess(`Student added successfully! Student ID: ${studentId}`);
                document.getElementById('addStudentForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('‚ùå Error adding student:', error);
                hideLoading();
                resetAddStudentButton();
                if (typeof showError === 'function') {
                showError('Error adding student: ' + error.message);
                } else {
                    console.error('Error adding student: ' + error.message);
                }
            }
        }
        
        // Update edit stream options based on class selection
        function updateEditStreamOptions() {
            const classSelect = document.getElementById('editStudentClass');
            const streamSelect = document.getElementById('editStudentStream');
            
            if (classSelect.value === 'S5' || classSelect.value === 'S6') {
                // A-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else if (classSelect.value === 'S3' || classSelect.value === 'S4') {
                // O-Level streams
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                    <option value="Science">Science</option>
                    <option value="Arts">Arts</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Technical">Technical</option>
                `;
            } else {
                // S1 and S2 - no streams typically
                streamSelect.innerHTML = `
                    <option value="">No Stream</option>
                `;
            }
        }
        
        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = student.id;
            document.getElementById('editStudentFirstName').value = student.firstName || '';
            document.getElementById('editStudentLastName').value = student.lastName || '';
            document.getElementById('editStudentEmail').value = student.email || '';
            document.getElementById('editStudentPhone').value = student.phone || '';
            document.getElementById('editStudentClass').value = student.class || '';
            document.getElementById('editStudentStream').value = student.stream || '';
            document.getElementById('editStudentYear').value = student.academicYear || '';
            document.getElementById('editStudentDateOfBirth').value = student.dateOfBirth ? 
                new Date(student.dateOfBirth.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editStudentGender').value = student.gender || '';
            document.getElementById('editStudentAddress').value = student.address || '';
            document.getElementById('editStudentPaymentCode').value = student.paymentCode || '';
            document.getElementById('editStudentAdmissionNumber').value = student.admissionNumber || '';
            
            // Parent/Guardian information
            document.getElementById('editParentName').value = student.parent?.name || '';
            document.getElementById('editParentRelationship').value = student.parent?.relationship || '';
            document.getElementById('editParentPhone').value = student.parent?.phone || '';
            document.getElementById('editParentEmail').value = student.parent?.email || '';
            document.getElementById('editParentOccupation').value = student.parent?.occupation || '';
            document.getElementById('editParentWorkplace').value = student.parent?.workplace || '';
            document.getElementById('editParentAddress').value = student.parent?.address || '';
            document.getElementById('editEmergencyContactName').value = student.emergencyContact?.name || '';
            document.getElementById('editEmergencyContactPhone').value = student.emergencyContact?.phone || '';
            
            document.getElementById('editStudentStatus').value = student.status || 'active';
            
            new bootstrap.Modal(document.getElementById('editStudentModal')).show();
        }
        
        // Update student
        async function updateStudent() {
            const studentId = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editStudentFirstName').value;
            const lastName = document.getElementById('editStudentLastName').value;
            const email = document.getElementById('editStudentEmail').value;
            const phone = document.getElementById('editStudentPhone').value;
            const studentClass = document.getElementById('editStudentClass').value;
            const studentStream = document.getElementById('editStudentStream').value;
            const academicYear = document.getElementById('editStudentYear').value;
            const dateOfBirth = document.getElementById('editStudentDateOfBirth').value;
            const gender = document.getElementById('editStudentGender').value;
            const address = document.getElementById('editStudentAddress').value;
            const paymentCode = document.getElementById('editStudentPaymentCode').value;
            const admissionNumber = document.getElementById('editStudentAdmissionNumber').value;
            
            // Parent/Guardian information
            const parentName = document.getElementById('editParentName').value;
            const parentRelationship = document.getElementById('editParentRelationship').value;
            const parentPhone = document.getElementById('editParentPhone').value;
            const parentEmail = document.getElementById('editParentEmail').value;
            const parentOccupation = document.getElementById('editParentOccupation').value;
            const parentWorkplace = document.getElementById('editParentWorkplace').value;
            const parentAddress = document.getElementById('editParentAddress').value;
            const emergencyContactName = document.getElementById('editEmergencyContactName').value;
            const emergencyContactPhone = document.getElementById('editEmergencyContactPhone').value;
            const status = document.getElementById('editStudentStatus').value;
            
            if (!firstName || !lastName || !studentClass || !academicYear || !dateOfBirth || !gender || !paymentCode || !parentName || !parentRelationship || !parentPhone) {
                if (typeof showError === 'function') {
                showError('Please fill in all required fields.');
                } else {
                    console.error('Please fill in all required fields.');
                }
                return;
            }
            
            try {
                showLoading('Updating student...');
                 
                 // Normalize class name to uppercase for consistency
                 const normalizedClass = studentClass.toUpperCase();
                
                await db.collection('students').doc(studentId).update({
                    firstName: firstName,
                    lastName: lastName,
                    email: email || '',
                    phone: phone || '',
                     class: normalizedClass,
                    stream: studentStream || null,
                    academicYear: academicYear,
                    dateOfBirth: firebase.firestore.Timestamp.fromDate(new Date(dateOfBirth)),
                    gender: gender,
                    address: address || '',
                    paymentCode: paymentCode,
                    admissionNumber: admissionNumber || '',
                     // Update academicInfo structure for consistency with teachers
                     academicInfo: {
                         currentClass: normalizedClass,
                         assignedClass: normalizedClass,
                         stream: studentStream || null,
                         academicYear: academicYear,
                         level: classes.find(c => c.name.toUpperCase() === normalizedClass)?.level || 'O Level'
                     },
                    parent: {
                        name: parentName,
                        relationship: parentRelationship,
                        phone: parentPhone,
                        email: parentEmail || '',
                        occupation: parentOccupation || '',
                        workplace: parentWorkplace || '',
                        address: parentAddress || ''
                    },
                    emergencyContact: {
                        name: emergencyContactName || '',
                        phone: emergencyContactPhone || ''
                    },
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: window.currentUser.uid
                });
                
                hideLoading();
                showSuccess('Student updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                loadStudents();
                
            } catch (error) {
                console.error('Error updating student:', error);
                hideLoading();
                if (typeof showError === 'function') {
                showError('Error updating student: ' + error.message);
                } else {
                    console.error('Error updating student: ' + error.message);
                }
            }
        }
        
        // Delete student
        async function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student? This action cannot be undone.')) {
                try {
                    showLoading('Deleting student...');
                    await db.collection('students').doc(studentId).delete();
                    hideLoading();
                    showSuccess('Student deleted successfully!');
                    loadStudents();
                } catch (error) {
                    console.error('Error deleting student:', error);
                    hideLoading();
                    if (typeof showError === 'function') {
                    showError('Error deleting student: ' + error.message);
                    } else {
                        console.error('Error deleting student: ' + error.message);
                    }
                }
            }
        }
        
        // View student details
        function viewStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const dateOfBirth = student.dateOfBirth ? new Date(student.dateOfBirth.seconds * 1000).toLocaleDateString() : 'Not set';
            const createdDate = student.createdAt ? new Date(student.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            const classDisplay = student.stream ? `${student.class} (${student.stream})` : student.class;
            
            const details = `
                <div style="text-align: left; max-width: 500px;">
                    <h4>Student Details</h4>
                    <hr>
                    
                    <h5>Personal Information</h5>
                    <strong>Name:</strong> ${student.firstName} ${student.lastName}<br>
                    <strong>Student ID:</strong> ${formatStudentId(student.studentId) || 'N/A'}<br>
                    <strong>Admission Number:</strong> ${student.admissionNumber || 'N/A'}<br>
                    <strong>Payment Code:</strong> ${student.paymentCode || 'N/A'}<br>
                    <strong>Email:</strong> ${student.email || 'Not provided'}<br>
                    <strong>Phone:</strong> ${student.phone || 'Not provided'}<br>
                    <strong>Date of Birth:</strong> ${dateOfBirth}<br>
                    <strong>Gender:</strong> ${student.gender || 'Not specified'}<br>
                    <strong>Address:</strong> ${student.address || 'Not provided'}<br>
                    <strong>Status:</strong> ${student.status || 'Unknown'}<br><br>
                    
                    <h5>Academic Information</h5>
                    <strong>Class:</strong> ${classDisplay || 'N/A'}<br>
                    <strong>Academic Year:</strong> ${student.academicYear || 'N/A'}<br><br>
                    
                    <h5>Parent/Guardian Information</h5>
                    <strong>Name:</strong> ${student.parent?.name || 'Not provided'}<br>
                    <strong>Relationship:</strong> ${student.parent?.relationship || 'Not specified'}<br>
                    <strong>Phone:</strong> ${student.parent?.phone || 'Not provided'}<br>
                    <strong>Email:</strong> ${student.parent?.email || 'Not provided'}<br>
                    <strong>Occupation:</strong> ${student.parent?.occupation || 'Not provided'}<br>
                    <strong>Workplace:</strong> ${student.parent?.workplace || 'Not provided'}<br>
                    <strong>Address:</strong> ${student.parent?.address || 'Not provided'}<br><br>
                    
                    <h5>Emergency Contact</h5>
                    <strong>Name:</strong> ${student.emergencyContact?.name || 'Not provided'}<br>
                    <strong>Phone:</strong> ${student.emergencyContact?.phone || 'Not provided'}<br><br>
                    
                    <strong>Created:</strong> ${createdDate}
                </div>
            `;
            
            // Create a modal for better display
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'studentDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Student Details - ${student.firstName} ${student.lastName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // View student grades (placeholder)
        function viewStudentGrades(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            alert(`View grades for ${student.firstName} ${student.lastName} - This feature will be implemented in the grades module.`);
        }
        
        
        // Clear filters
        function clearFilters() {
            console.log('üßπ Clearing all filters');
            document.getElementById('searchInput').value = '';
            document.getElementById('classFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            filteredStudents = [...students];
            displayStudents();
            updateFilterStatus(students.length, students.length);
            console.log(`üìä Reset to show all ${students.length} students`);
        }
        
        // Export students
        function exportStudents() {
            const studentsData = students.map(student => ({
                firstName: student.firstName,
                lastName: student.lastName,
                email: student.email,
                phone: student.phone,
                studentId: student.studentId,
                class: student.class,
                academicYear: student.academicYear,
                gender: student.gender,
                status: student.status,
                guardianName: student.guardian?.name,
                guardianPhone: student.guardian?.phone,
                guardianEmail: student.guardian?.email
            }));
            
            const dataStr = JSON.stringify(studentsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Students exported successfully!');
        }
        
        // Print students
        function printStudents() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show loading message
        function showLoading(message = 'Loading...') {
            // Remove any existing loading messages
            hideLoading();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-message';
            loadingDiv.className = 'alert alert-info alert-dismissible fade show';
            loadingDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    ${message}
                </div>
            `;
            document.body.insertBefore(loadingDiv, document.body.firstChild);
        }
        
        // Hide loading message
        function hideLoading() {
            const loadingDiv = document.getElementById('loading-message');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for student changes
            db.collection('students').onSnapshot((snapshot) => {
                console.log('üìä Students collection updated');
                loadStudents();
                updateStudentStats();
            });
            
            // Listen for class changes
            db.collection('classes').onSnapshot((snapshot) => {
                console.log('üìö Classes collection updated');
                loadClasses();
            });
            
            // Listen for academic year changes
            db.collection('academic_years').onSnapshot((snapshot) => {
                console.log('üìÖ Academic years collection updated');
                loadAcademicYears();
            });
        }
        
        // Update student statistics
        function updateStudentStats() {
            const totalStudents = students.length;
            const activeStudents = students.filter(student => student.isActive !== false).length;
            const maleStudents = students.filter(student => student.personalInfo?.gender === 'male').length;
            const femaleStudents = students.filter(student => student.personalInfo?.gender === 'female').length;
            
            // Update stats cards if they exist
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalStudents;
                statsCards[1].textContent = activeStudents;
                statsCards[2].textContent = maleStudents;
                statsCards[3].textContent = femaleStudents;
            }
        }
        
        // Update class selector dropdown
        function updateClassSelector() {
            const classSelector = document.getElementById('class-filter');
            if (classSelector) {
                classSelector.innerHTML = '<option value="">All Classes</option>';
                classes.forEach(classItem => {
                    const option = document.createElement('option');
                    option.value = classItem.id;
                    option.textContent = classItem.name;
                    classSelector.appendChild(option);
                });
            }
        }
        
        // Update academic year selector dropdown
        function updateAcademicYearSelector() {
            const yearSelector = document.getElementById('academic-year-filter');
            if (yearSelector) {
                yearSelector.innerHTML = '<option value="">All Years</option>';
                academicYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.id;
                    option.textContent = year.year;
                    yearSelector.appendChild(option);
                });
            }
        }
        
        // Enhanced search with real-time filtering
        function searchStudents() {
            const searchTerm = document.getElementById('search-students').value.toLowerCase();
            const filteredStudents = students.filter(student => 
                student.personalInfo?.fullName?.toLowerCase().includes(searchTerm) ||
                student.personalInfo?.studentId?.toLowerCase().includes(searchTerm) ||
                student.personalInfo?.phone?.includes(searchTerm) ||
                student.personalInfo?.email?.toLowerCase().includes(searchTerm)
            );
            displayStudents(filteredStudents);
        }
        
        // Enhanced filter with real-time updates
        function filterStudents() {
            const classFilter = document.getElementById('class-filter').value;
            const yearFilter = document.getElementById('academic-year-filter').value;
            const genderFilter = document.getElementById('gender-filter').value;
            
            let filteredStudents = students;
            
            if (classFilter) {
                filteredStudents = filteredStudents.filter(student => student.academicInfo?.currentClass === classFilter);
            }
            
            if (yearFilter) {
                filteredStudents = filteredStudents.filter(student => student.academicInfo?.academicYear === yearFilter);
            }
            
            if (genderFilter) {
                filteredStudents = filteredStudents.filter(student => student.personalInfo?.gender === genderFilter);
            }
            
            displayStudents(filteredStudents);
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Combined search and filter function
        function applyFiltersAndSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            console.log('üîç Applying filters and search:', { searchTerm, classFilter, statusFilter, yearFilter });
            
            // Start with all students
            let results = [...students];
            
            // Apply filters first
            if (classFilter !== 'all') {
                results = results.filter(student => student.class === classFilter);
            }
            
            if (statusFilter !== 'all') {
                results = results.filter(student => student.status === statusFilter);
            }
            
            if (yearFilter !== 'all') {
                results = results.filter(student => student.academicYear === yearFilter);
            }
            
            // Apply search filter
            if (searchTerm !== '') {
                results = results.filter(student => 
                    (student.firstName || '').toLowerCase().includes(searchTerm) ||
                    (student.lastName || '').toLowerCase().includes(searchTerm) ||
                    (student.email || '').toLowerCase().includes(searchTerm) ||
                    (student.studentId || '').toLowerCase().includes(searchTerm) ||
                    (student.paymentCode || '').toLowerCase().includes(searchTerm) ||
                    (student.admissionNumber || '').toLowerCase().includes(searchTerm) ||
                    (student.parent?.name || '').toLowerCase().includes(searchTerm) ||
                    (student.parent?.phone || '').includes(searchTerm) ||
                    (student.class || '').toLowerCase().includes(searchTerm) ||
                    (student.stream || '').toLowerCase().includes(searchTerm)
                );
            }
            
            // Update filtered students and display
            filteredStudents = results;
            displayStudents();
            updateFilterStatus(results.length, students.length);
            showActiveFilters();
            
            console.log(`üìä Applied filters: ${results.length} students from ${students.length} total`);
        }
        
        // Update search function to use combined approach
        function searchStudents() {
            currentPage = 1; // Reset to first page when searching
            applyFiltersAndSearch();
        }
        
        // Update filter function to use combined approach
        function filterStudents() {
            currentPage = 1; // Reset to first page when filtering
            applyFiltersAndSearch();
        }
        
        // Update filter status indicator
        function updateFilterStatus(filteredCount, totalCount) {
            const statusElement = document.getElementById('filterStatus');
            if (statusElement) {
                if (filteredCount === totalCount) {
                    statusElement.textContent = `Showing all ${totalCount} students`;
                    statusElement.className = 'text-muted';
                } else {
                    statusElement.textContent = `Showing ${filteredCount} of ${totalCount} students`;
                    statusElement.className = 'text-info fw-bold';
                }
            }
        }
        
        // Show active filter indicators
        function showActiveFilters() {
            const searchTerm = document.getElementById('searchInput').value;
            const classFilter = document.getElementById('classFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            const activeFilters = [];
            if (searchTerm) activeFilters.push(`Search: "${searchTerm}"`);
            if (classFilter !== 'all') activeFilters.push(`Class: ${classFilter}`);
            if (statusFilter !== 'all') activeFilters.push(`Status: ${statusFilter}`);
            if (yearFilter !== 'all') activeFilters.push(`Year: ${yearFilter}`);
            
            console.log('üîç Active filters:', activeFilters);
            return activeFilters;
        }

        // Optional: Clean up duplicate students from database
        async function cleanupDuplicateStudents() {
            try {
                console.log('üßπ Starting duplicate student cleanup...');
                showLoading('Cleaning up duplicate students...');
                
                const studentsSnapshot = await db.collection('students').get();
                const seenStudents = new Map(); // Use Map to store first occurrence
                const duplicatesToDelete = [];
                
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    const uniqueKey = createStudentUniqueKey(studentData);
                    
                    if (seenStudents.has(uniqueKey)) {
                        // This is a duplicate
                        const originalDoc = seenStudents.get(uniqueKey);
                        console.log('üóëÔ∏è Marking duplicate for deletion:', {
                            duplicate: `${studentData.firstName} ${studentData.lastName}`,
                            duplicateId: doc.id,
                            originalId: originalDoc.id,
                            uniqueKey: uniqueKey
                        });
                        duplicatesToDelete.push(doc.ref);
                    } else {
                        // First occurrence, keep it
                        seenStudents.set(uniqueKey, { id: doc.id, data: studentData });
                    }
                });
                
                if (duplicatesToDelete.length > 0) {
                    console.log(`üóëÔ∏è Deleting ${duplicatesToDelete.length} duplicate student records...`);
                    
                    // Delete duplicates in batches
                    const batchSize = 500;
                    for (let i = 0; i < duplicatesToDelete.length; i += batchSize) {
                        const batch = db.batch();
                        const batchDeletes = duplicatesToDelete.slice(i, i + batchSize);
                        
                        batchDeletes.forEach(docRef => {
                            batch.delete(docRef);
                        });
                        
                        await batch.commit();
                        console.log(`‚úÖ Deleted batch ${Math.floor(i / batchSize) + 1}`);
                    }
                    
                    showSuccess(`Cleaned up ${duplicatesToDelete.length} duplicate student records!`);
                    loadStudents(); // Reload to show updated list
                } else {
                    showSuccess('No duplicate students found in the database!');
                }
                
            } catch (error) {
                console.error('‚ùå Error cleaning up duplicates:', error);
                showError('Failed to clean up duplicate students: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Make functions globally available
        window.addStudent = addStudent;
        window.editStudent = editStudent;
        window.updateStudent = updateStudent;
        window.deleteStudent = deleteStudent;
        window.viewStudentDetails = viewStudentDetails;
        window.viewStudentGrades = viewStudentGrades;
        window.searchStudents = searchStudents;
        window.filterStudents = filterStudents;
        window.clearFilters = clearFilters;
        window.exportStudents = exportStudents;
        window.printStudents = printStudents;
        window.updateStreamOptions = updateStreamOptions;
        window.updateEditStreamOptions = updateEditStreamOptions;
        window.fixMalformedStudentIds = fixMalformedStudentIds;
        window.checkForDuplicateStudent = checkForDuplicateStudent;
        window.showDuplicateError = showDuplicateError;
        window.viewExistingStudent = viewExistingStudent;
        window.forceAddStudent = forceAddStudent;
        window.goToPage = goToPage;
        window.changeStudentsPerPage = changeStudentsPerPage;
        window.cleanupDuplicateStudents = cleanupDuplicateStudents;
        window.logout = logout;
    </script>
</body>
</html>
