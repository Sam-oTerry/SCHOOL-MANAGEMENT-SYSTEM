<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Term Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
    <style>
        .filter-status {
            transition: all 0.3s ease;
        }
        .filter-status.text-info {
            background-color: rgba(13, 202, 240, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #0dcaf0;
        }
        .search-input:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }
        .filter-select:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }
        .btn-clear-filters:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .stat-card {
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .term-row {
            transition: all 0.3s ease;
        }
        .term-row:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Term Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportTerms()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printTerms()">
                                <i class="fas fa-print"></i> Print
                            </button>
                    </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createTermModal">
                            <i class="fas fa-plus"></i> Add Term
                        </button>
                    </div>
                </div>
                
                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control search-input" id="searchInput" placeholder="Search terms..." onkeyup="searchTerms()">
                    </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select filter-select" id="statusFilter" onchange="filterTerms()">
                            <option value="all">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="completed">Completed</option>
                            <option value="upcoming">Upcoming</option>
                                </select>
                            </div>
                    <div class="col-md-2">
                        <select class="form-select filter-select" id="yearFilter" onchange="filterTerms()">
                            <option value="all">All Years</option>
                                </select>
                            </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100 btn-clear-filters" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>

                <!-- Current Term Status -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="current-term-card">
                            <div class="card bg-secondary text-white text-center">
                                <div class="card-body">
                                    <h3>No Active Term</h3>
                                    <p class="mb-0">No term is currently active</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-calendar-check text-primary mb-2"></i>
                                        <h4 class="number">0</h4>
                                        <p class="text-muted">Total Terms</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-play-circle text-success mb-2"></i>
                                        <h4 class="number">0</h4>
                                        <p class="text-muted">Active</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-check-circle text-info mb-2"></i>
                                        <h4 class="number">0</h4>
                                        <p class="text-muted">Completed</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock text-warning mb-2"></i>
                                        <h4 class="number">0</h4>
                                        <p class="text-muted">Upcoming</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <!-- Terms List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Academic Terms</h5>
                        <div class="filter-status">
                            <small class="text-muted" id="filterStatus">Showing all terms</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="termsTable">
                                <thead>
                                    <tr>
                                        <th>Term Name</th>
                                        <th>Academic Year</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="terms-tbody">
                                    <!-- Terms will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
            </main>
                    </div>
    </div>

    <!-- Create Term Modal -->
    <div class="modal fade" id="createTermModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Term</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTermForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Term Name</label>
                                    <input type="text" class="form-control" id="termName" placeholder="e.g., Term 1, First Term" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="academicYear" value="2024" required>
                            </div>
                        </div>
                    </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="startDate" required>
                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="endDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Registration Deadline</label>
                                    <input type="date" class="form-control" id="registrationDeadline">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Examination Period</label>
                                    <input type="text" class="form-control" id="examinationPeriod" placeholder="e.g., Week 8-9">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="termDescription" rows="3" placeholder="Enter term description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoActivate">
                                <label class="form-check-label" for="autoActivate">
                                    Auto-activate term when start date is reached
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createAcademicTerm()">Create Term</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Term Modal -->
    <div class="modal fade" id="editTermModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Term</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTermForm">
                        <input type="hidden" id="editTermId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Term Name</label>
                                    <input type="text" class="form-control" id="editTermName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="editAcademicYear" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="editStartDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="editEndDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Registration Deadline</label>
                                    <input type="date" class="form-control" id="editRegistrationDeadline">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Examination Period</label>
                                    <input type="text" class="form-control" id="editExaminationPeriod" placeholder="e.g., Week 8-9">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editTermDescription" rows="3" placeholder="Enter term description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editAutoActivate">
                                <label class="form-check-label" for="editAutoActivate">
                                    Auto-activate term when start date is reached
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateTerm()">Update Term</button>
                    <button type="button" class="btn btn-danger" onclick="deleteTerm()">Delete Term</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "ass-sms.firebaseapp.com",
            projectId: "ass-sms",
            storageBucket: "ass-sms.firebasestorage.app",
            messagingSenderId: "515388722489",
            appId: "1:515388722489:web:21169f130303f48aaa2ce8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let academicTerms = [];
        let filteredTerms = [];
        let academicYears = [];
        
        // Check authentication and role
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userRole = userData.role;
                        
                        if (userRole === 'system_admin') {
                            console.log('‚úÖ System Administrator authenticated:', user.email);
                            currentUser = user;
                            loadAcademicTerms();
                            loadAcademicYears();
                            setupRealTimeListeners();
                        } else {
                            console.log('‚ùå Access denied. Required role: system_admin');
                            alert('Access denied. You do not have system administrator privileges.');
                            auth.signOut().then(() => {
                                window.location.href = '../../index.html';
                            });
                        }
                    } else {
                        console.log('‚ùå User document not found');
                        auth.signOut().then(() => {
                            window.location.href = '../../index.html';
                        });
                    }
                });
            } else {
                console.log('‚ùå No authenticated user, redirecting to login');
                window.location.href = '../../index.html';
            }
        });
        
        // Load academic terms from Firebase
        async function loadAcademicTerms() {
            try {
                console.log('üîÑ Loading academic terms...');
                const termsSnapshot = await db.collection('academicTerms')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                academicTerms = [];
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    academicTerms.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                filteredTerms = [...academicTerms];
                displayAcademicTerms();
                updateTermStats();
                populateYearFilter();
                
                console.log(`‚úÖ Loaded ${academicTerms.length} academic terms`);
                
            } catch (error) {
                console.error('‚ùå Error loading academic terms:', error);
                showError('Failed to load academic terms. Please try again.');
            }
        }
        
        // Load academic years
        async function loadAcademicYears() {
            try {
                const yearsSnapshot = await db.collection('academicYears').get();
                academicYears = [];
                yearsSnapshot.forEach(doc => {
                    const yearData = doc.data();
                    academicYears.push({
                        id: doc.id,
                        ...yearData
                    });
                });
                
                console.log(`‚úÖ Loaded ${academicYears.length} academic years`);
                
            } catch (error) {
                console.error('Error loading academic years:', error);
                // Set default years
                academicYears = [
                    { id: '1', year: '2024' },
                    { id: '2', year: '2023' },
                    { id: '3', year: '2022' }
                ];
            }
        }
        
        // Display academic terms in the table
        function displayAcademicTerms() {
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredTerms.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="fas fa-calendar-check fa-2x mb-2"></i><br>
                            No terms found
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
            
            console.log(`üìä Displayed ${filteredTerms.length} terms`);
        }
        
        // Create term row
        function createTermRow(term) {
            const row = document.createElement('tr');
            const startDate = term.startDate ? new Date(term.startDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const endDate = term.endDate ? new Date(term.endDate.seconds * 1000).toLocaleDateString() : 'Not set';
            
            // Calculate weeks and progress
            const weeks = calculateWeeksInTerm(term.startDate, term.endDate);
            const progress = calculateTermProgress(term.startDate, term.endDate);
            const daysRemaining = calculateDaysRemaining(term.startDate, term.endDate);
            
            // Determine status based on dates
            let status = 'Inactive';
            let statusClass = 'bg-secondary';
            const now = new Date();
            
            if (term.startDate && term.endDate) {
                const start = new Date(term.startDate.seconds * 1000);
                const end = new Date(term.endDate.seconds * 1000);
                
                if (now < start) {
                    status = 'Upcoming';
                    statusClass = 'bg-warning';
                } else if (now >= start && now <= end) {
                    status = 'Active';
                    statusClass = 'bg-success';
                } else if (now > end) {
                    status = 'Completed';
                    statusClass = 'bg-info';
                }
            }
            
            // Calculate duration
            let duration = 'N/A';
            if (term.startDate && term.endDate) {
                const start = new Date(term.startDate.seconds * 1000);
                const end = new Date(term.endDate.seconds * 1000);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                duration = `${diffDays} days (${weeks} weeks)`;
            }
            
            row.innerHTML = `
                <td>
                    <strong>${term.termName || 'N/A'}</strong>
                    ${status === 'Active' ? '<br><small class="text-success"><i class="fas fa-circle"></i> Current Term</small>' : ''}
                </td>
                <td>${term.academicYear || 'N/A'}</td>
                <td>${startDate}</td>
                <td>${endDate}</td>
                <td>
                    ${duration}
                    ${daysRemaining > 0 && status === 'Active' ? `<br><small class="text-muted">${daysRemaining} days left</small>` : ''}
                </td>
                <td>
                    <span class="badge ${statusClass}">${status}</span>
                    ${status === 'Active' ? `<br><div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: ${progress}%"></div>
                    </div><small class="text-muted">${progress}% complete</small>` : ''}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editTerm('${term.id}')" title="Edit Term">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewTermDetails('${term.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="toggleTermStatus('${term.id}')" title="Toggle Status">
                            <i class="fas fa-toggle-${term.isActive ? 'on' : 'off'}"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTerm('${term.id}')" title="Delete Term">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Update term statistics
        function updateTermStats() {
            const totalTerms = academicTerms.length;
            const activeTerms = academicTerms.filter(term => term.isActive === true).length;
            const completedTerms = academicTerms.filter(term => {
                if (!term.endDate) return false;
                const endDate = new Date(term.endDate.seconds * 1000);
                return endDate < new Date();
            }).length;
            const upcomingTerms = academicTerms.filter(term => {
                if (!term.startDate) return false;
                const startDate = new Date(term.startDate.seconds * 1000);
                return startDate > new Date();
            }).length;
            
            // Update stats cards
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalTerms;
                statsCards[1].textContent = activeTerms;
                statsCards[2].textContent = completedTerms;
                statsCards[3].textContent = upcomingTerms;
            }
            
            // Update current term status
            updateCurrentTermStatus();
            
            console.log(`üìä Term Stats - Total: ${totalTerms}, Active: ${activeTerms}, Completed: ${completedTerms}, Upcoming: ${upcomingTerms}`);
        }
        
        // Update current term status based on dates
        function updateCurrentTermStatus() {
            const now = new Date();
            let currentTerm = null;
            
            // Find the current term based on dates
            academicTerms.forEach(term => {
                if (term.startDate && term.endDate) {
                    const startDate = new Date(term.startDate.seconds * 1000);
                    const endDate = new Date(term.endDate.seconds * 1000);
                    
                    if (now >= startDate && now <= endDate) {
                        currentTerm = term;
                    }
                }
            });
            
            // Update current term display
            const currentTermCard = document.querySelector('.current-term-card');
            if (currentTermCard) {
                if (currentTerm) {
                    currentTermCard.innerHTML = `
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <h3>${currentTerm.termName}</h3>
                                <p class="mb-0">Current Term</p>
                                <small>${currentTerm.academicYear}</small>
                            </div>
                        </div>
                    `;
                } else {
                    currentTermCard.innerHTML = `
                        <div class="card bg-secondary text-white text-center">
                            <div class="card-body">
                                <h3>No Active Term</h3>
                                <p class="mb-0">No term is currently active</p>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Calculate number of weeks in a term
        function calculateWeeksInTerm(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            
            const start = new Date(startDate.seconds * 1000);
            const end = new Date(endDate.seconds * 1000);
            
            // Calculate the difference in milliseconds
            const diffTime = Math.abs(end - start);
            
            // Calculate the difference in days
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // Calculate weeks (including partial weeks)
            const weeks = Math.ceil(diffDays / 7);
            
            return weeks;
        }
        
        // Calculate term progress percentage
        function calculateTermProgress(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            
            const start = new Date(startDate.seconds * 1000);
            const end = new Date(endDate.seconds * 1000);
            const now = new Date();
            
            // If term hasn't started yet
            if (now < start) return 0;
            
            // If term has ended
            if (now > end) return 100;
            
            // Calculate progress percentage
            const totalDuration = end - start;
            const elapsed = now - start;
            const progress = Math.round((elapsed / totalDuration) * 100);
            
            return Math.min(100, Math.max(0, progress));
        }
        
        // Calculate days remaining in term
        function calculateDaysRemaining(startDate, endDate) {
            if (!startDate || !endDate) return 0;
            
            const end = new Date(endDate.seconds * 1000);
            const now = new Date();
            
            // If term has ended
            if (now > end) return 0;
            
            // Calculate days remaining
            const diffTime = end - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.max(0, diffDays);
        }
        
        // Populate year filter dropdown
        function populateYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            if (yearFilter) {
                yearFilter.innerHTML = '<option value="all">All Years</option>';
                
                // Get unique years from terms
                const uniqueYears = [...new Set(academicTerms.map(term => term.academicYear).filter(Boolean))];
                uniqueYears.sort((a, b) => b - a).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilter.appendChild(option);
                });
            }
        }
        
        // Create new academic term
        async function createAcademicTerm() {
            const termName = document.getElementById('termName').value;
            const academicYear = document.getElementById('academicYear').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const registrationDeadline = document.getElementById('registrationDeadline').value;
            const examinationPeriod = document.getElementById('examinationPeriod').value;
            const description = document.getElementById('termDescription').value;
            const autoActivate = document.getElementById('autoActivate').checked;
            
            if (!termName || !academicYear || !startDate || !endDate) {
                showError('Please fill in all required fields.');
                return;
            }
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start >= end) {
                showError('End date must be after start date.');
                return;
            }
            
            try {
                // Calculate weeks in term
                const weeks = calculateWeeksInTerm(
                    firebase.firestore.Timestamp.fromDate(start),
                    firebase.firestore.Timestamp.fromDate(end)
                );
                
                // Calculate days in term
                const diffTime = Math.abs(end - start);
                const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                const termData = {
                    termName: termName,
                    academicYear: academicYear,
                    startDate: firebase.firestore.Timestamp.fromDate(start),
                    endDate: firebase.firestore.Timestamp.fromDate(end),
                    registrationDeadline: registrationDeadline ? firebase.firestore.Timestamp.fromDate(new Date(registrationDeadline)) : null,
                    examinationPeriod: examinationPeriod || '',
                    description: description || '',
                    isActive: false,
                    status: 'upcoming',
                    autoActivate: autoActivate,
                    weeks: weeks,
                    days: days,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('academicTerms').add(termData);
                
                showSuccess('Academic term created successfully!');
                document.getElementById('createTermForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('createTermModal')).hide();
                loadAcademicTerms();
                
            } catch (error) {
                console.error('Error creating academic term:', error);
                showError('Error creating academic term: ' + error.message);
            }
        }
        
        // Edit academic term
        function editTerm(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            // Populate edit form
            document.getElementById('editTermId').value = term.id;
            document.getElementById('editTermName').value = term.termName || '';
            document.getElementById('editAcademicYear').value = term.academicYear || '';
            document.getElementById('editStartDate').value = term.startDate ? 
                new Date(term.startDate.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editEndDate').value = term.endDate ? 
                new Date(term.endDate.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editRegistrationDeadline').value = term.registrationDeadline ? 
                new Date(term.registrationDeadline.seconds * 1000).toISOString().split('T')[0] : '';
            document.getElementById('editExaminationPeriod').value = term.examinationPeriod || '';
            document.getElementById('editTermDescription').value = term.description || '';
            document.getElementById('editAutoActivate').checked = term.autoActivate || false;
            
            new bootstrap.Modal(document.getElementById('editTermModal')).show();
        }
        
        // Update academic term
        async function updateTerm() {
            const termId = document.getElementById('editTermId').value;
            const termName = document.getElementById('editTermName').value;
            const academicYear = document.getElementById('editAcademicYear').value;
            const startDate = document.getElementById('editStartDate').value;
            const endDate = document.getElementById('editEndDate').value;
            const registrationDeadline = document.getElementById('editRegistrationDeadline').value;
            const examinationPeriod = document.getElementById('editExaminationPeriod').value;
            const description = document.getElementById('editTermDescription').value;
            const autoActivate = document.getElementById('editAutoActivate').checked;
            
            if (!termName || !academicYear || !startDate || !endDate) {
                showError('Please fill in all required fields.');
                return;
            }
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start >= end) {
                showError('End date must be after start date.');
                return;
            }
            
            try {
                const updateData = {
                    termName: termName,
                    academicYear: academicYear,
                    startDate: firebase.firestore.Timestamp.fromDate(start),
                    endDate: firebase.firestore.Timestamp.fromDate(end),
                    registrationDeadline: registrationDeadline ? firebase.firestore.Timestamp.fromDate(new Date(registrationDeadline)) : null,
                    examinationPeriod: examinationPeriod || '',
                    description: description || '',
                    autoActivate: autoActivate,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('academicTerms').doc(termId).update(updateData);
                
                showSuccess('Academic term updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editTermModal')).hide();
                loadAcademicTerms();
                
            } catch (error) {
                console.error('Error updating academic term:', error);
                showError('Error updating academic term: ' + error.message);
            }
        }
        
        // View term details
        function viewTermDetails(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            const startDate = term.startDate ? new Date(term.startDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const endDate = term.endDate ? new Date(term.endDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const registrationDeadline = term.registrationDeadline ? 
                new Date(term.registrationDeadline.seconds * 1000).toLocaleDateString() : 'Not set';
            const createdDate = term.createdAt ? new Date(term.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            
            // Calculate additional metrics
            const weeks = calculateWeeksInTerm(term.startDate, term.endDate);
            const progress = calculateTermProgress(term.startDate, term.endDate);
            const daysRemaining = calculateDaysRemaining(term.startDate, term.endDate);
            const totalDays = term.days || (term.startDate && term.endDate ? 
                Math.ceil((new Date(term.endDate.seconds * 1000) - new Date(term.startDate.seconds * 1000)) / (1000 * 60 * 60 * 24)) : 0);
            
            const details = `
                <div style="text-align: left; max-width: 600px;">
                    <h4>Term Details</h4>
                    <hr>
                    
                    <h5>Basic Information</h5>
                    <strong>Name:</strong> ${term.termName || 'N/A'}<br>
                    <strong>Academic Year:</strong> ${term.academicYear || 'N/A'}<br>
                    <strong>Status:</strong> ${term.isActive ? 'Active' : 'Inactive'}<br><br>
                    
                    <h5>Dates & Duration</h5>
                    <strong>Start Date:</strong> ${startDate}<br>
                    <strong>End Date:</strong> ${endDate}<br>
                    <strong>Registration Deadline:</strong> ${registrationDeadline}<br>
                    <strong>Duration:</strong> ${totalDays} days (${weeks} weeks)<br>
                    ${daysRemaining > 0 ? `<strong>Days Remaining:</strong> ${daysRemaining} days<br>` : ''}
                    <strong>Progress:</strong> ${progress}% complete<br><br>
                    
                    <h5>Additional Information</h5>
                    <strong>Examination Period:</strong> ${term.examinationPeriod || 'Not specified'}<br>
                    <strong>Description:</strong> ${term.description || 'No description'}<br>
                    <strong>Auto-activate:</strong> ${term.autoActivate ? 'Yes' : 'No'}<br><br>
                    
                    <strong>Created:</strong> ${createdDate}
                </div>
            `;
            
            // Create a modal for better display
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'termDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Term Details - ${term.termName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Toggle term status
        async function toggleTermStatus(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            const newStatus = !term.isActive;
            const action = newStatus ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} this term?`)) {
                try {
                    // If activating this term, deactivate all other terms first
                    if (newStatus) {
                        const batch = db.batch();
                        academicTerms.forEach(t => {
                            if (t.isActive) {
                                batch.update(db.collection('academicTerms').doc(t.id), {
                                    isActive: false,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedBy: currentUser.uid
                                });
                            }
                        });
                        await batch.commit();
                    }
                    
                    await db.collection('academicTerms').doc(termId).update({
                        isActive: newStatus,
                        status: newStatus ? 'active' : 'inactive',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.uid
                    });
                    
                    showSuccess(`Term ${action}d successfully!`);
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error toggling term status:', error);
                    showError('Error toggling term status. Please try again.');
                }
            }
        }
        
        // Delete academic term
        async function deleteTerm(termId) {
            if (confirm('Are you sure you want to delete this academic term? This action cannot be undone.')) {
                try {
                    await db.collection('academicTerms').doc(termId).delete();
                    showSuccess('Academic term deleted successfully!');
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error deleting academic term:', error);
                    showError('Error deleting academic term: ' + error.message);
                }
            }
        }
        
        // Search terms
        function searchTerms() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            console.log('üîç Searching terms with term:', searchTerm);
            
            filteredTerms = academicTerms.filter(term => 
                (term.termName || '').toLowerCase().includes(searchTerm) ||
                (term.academicYear || '').toLowerCase().includes(searchTerm) ||
                (term.description || '').toLowerCase().includes(searchTerm) ||
                (term.examinationPeriod || '').toLowerCase().includes(searchTerm)
            );
            
            displayAcademicTerms();
            updateFilterStatus(filteredTerms.length, academicTerms.length);
            
            console.log(`üìä Search found ${filteredTerms.length} terms`);
        }
        
        // Filter terms
        function filterTerms() {
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            
            console.log('üîç Filtering terms:', { statusFilter, yearFilter });
            
            let results = [...academicTerms];
            
            // Apply status filter
            if (statusFilter !== 'all') {
                if (statusFilter === 'active') {
                    results = results.filter(term => term.isActive === true);
                } else if (statusFilter === 'inactive') {
                    results = results.filter(term => term.isActive === false);
                } else if (statusFilter === 'completed') {
                    results = results.filter(term => {
                        if (!term.endDate) return false;
                        const endDate = new Date(term.endDate.seconds * 1000);
                        return endDate < new Date();
                    });
                } else if (statusFilter === 'upcoming') {
                    results = results.filter(term => {
                        if (!term.startDate) return false;
                        const startDate = new Date(term.startDate.seconds * 1000);
                        return startDate > new Date();
                    });
                }
            }
            
            // Apply year filter
            if (yearFilter !== 'all') {
                results = results.filter(term => term.academicYear === yearFilter);
            }
            
            filteredTerms = results;
            displayAcademicTerms();
            updateFilterStatus(filteredTerms.length, academicTerms.length);
            
            console.log(`üìä Filtered ${filteredTerms.length} terms from ${academicTerms.length} total`);
        }
        
        // Clear filters
        function clearFilters() {
            console.log('üßπ Clearing all filters');
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('yearFilter').value = 'all';
            filteredTerms = [...academicTerms];
            displayAcademicTerms();
            updateFilterStatus(academicTerms.length, academicTerms.length);
            console.log(`üìä Reset to show all ${academicTerms.length} terms`);
        }
        
        // Update filter status indicator
        function updateFilterStatus(filteredCount, totalCount) {
            const statusElement = document.getElementById('filterStatus');
            if (statusElement) {
                if (filteredCount === totalCount) {
                    statusElement.textContent = `Showing all ${totalCount} terms`;
                    statusElement.className = 'text-muted';
                } else {
                    statusElement.textContent = `Showing ${filteredCount} of ${totalCount} terms`;
                    statusElement.className = 'text-info fw-bold';
                }
            }
        }
        
        // Export terms
        function exportTerms() {
            const termsData = filteredTerms.map(term => ({
                termName: term.termName,
                academicYear: term.academicYear,
                startDate: term.startDate ? new Date(term.startDate.seconds * 1000).toLocaleDateString() : 'N/A',
                endDate: term.endDate ? new Date(term.endDate.seconds * 1000).toLocaleDateString() : 'N/A',
                isActive: term.isActive ? 'Active' : 'Inactive',
                description: term.description || '',
                examinationPeriod: term.examinationPeriod || ''
            }));
            
            const dataStr = JSON.stringify(termsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `academic-terms-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Terms exported successfully!');
        }
        
        // Print terms
        function printTerms() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for academic term changes
            db.collection('academicTerms').onSnapshot((snapshot) => {
                console.log('üìä Academic terms collection updated');
                loadAcademicTerms();
            });
            
            // Set up automatic term status updates every hour
            setInterval(updateTermStatusesAutomatically, 60 * 60 * 1000); // Every hour
        }
        
        // Automatically update term statuses based on current date
        async function updateTermStatusesAutomatically() {
            console.log('üîÑ Automatically updating term statuses...');
            
            const now = new Date();
            const batch = db.batch();
            let hasUpdates = false;
            
            academicTerms.forEach(term => {
                if (term.startDate && term.endDate) {
                    const startDate = new Date(term.startDate.seconds * 1000);
                    const endDate = new Date(term.endDate.seconds * 1000);
                    let newStatus = term.status;
                    let newIsActive = term.isActive;
                    
                    // Determine status based on current date
                    if (now < startDate) {
                        newStatus = 'upcoming';
                        newIsActive = false;
                    } else if (now >= startDate && now <= endDate) {
                        newStatus = 'active';
                        newIsActive = true;
                    } else if (now > endDate) {
                        newStatus = 'completed';
                        newIsActive = false;
                    }
                    
                    // Update if status changed
                    if (newStatus !== term.status || newIsActive !== term.isActive) {
                        const termRef = db.collection('academicTerms').doc(term.id);
                        batch.update(termRef, {
                            status: newStatus,
                            isActive: newIsActive,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: 'system'
                        });
                        hasUpdates = true;
                        
                        console.log(`üìÖ Term "${term.termName}" status updated: ${term.status} ‚Üí ${newStatus}`);
                    }
                }
            });
            
            if (hasUpdates) {
                try {
                    await batch.commit();
                    console.log('‚úÖ Term statuses updated automatically');
                    loadAcademicTerms(); // Refresh the display
                } catch (error) {
                    console.error('‚ùå Error updating term statuses:', error);
                }
            }
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Create sample academic terms for testing
        async function createSampleTerms() {
            if (!confirm('This will create sample academic terms. Continue?')) return;
            
            try {
                const currentYear = new Date().getFullYear();
                const nextYear = currentYear + 1;
                
                const sampleTerms = [
                    {
                        termName: 'Term 1',
                        academicYear: currentYear.toString(),
                        startDate: new Date(currentYear, 0, 15), // January 15
                        endDate: new Date(currentYear, 2, 31), // March 31
                        description: 'First term of the academic year',
                        examinationPeriod: 'March 20-31',
                        autoActivate: true
                    },
                    {
                        termName: 'Term 2',
                        academicYear: currentYear.toString(),
                        startDate: new Date(currentYear, 3, 15), // April 15
                        endDate: new Date(currentYear, 5, 30), // June 30
                        description: 'Second term of the academic year',
                        examinationPeriod: 'June 15-30',
                        autoActivate: true
                    },
                    {
                        termName: 'Term 3',
                        academicYear: currentYear.toString(),
                        startDate: new Date(currentYear, 8, 15), // September 15
                        endDate: new Date(currentYear, 10, 30), // November 30
                        description: 'Third term of the academic year',
                        examinationPeriod: 'November 15-30',
                        autoActivate: true
                    }
                ];
                
                const batch = db.batch();
                
                sampleTerms.forEach(term => {
                    const start = term.startDate;
                    const end = term.endDate;
                    const weeks = calculateWeeksInTerm(
                        firebase.firestore.Timestamp.fromDate(start),
                        firebase.firestore.Timestamp.fromDate(end)
                    );
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                    
                    const termRef = db.collection('academicTerms').doc();
                    batch.set(termRef, {
                        termName: term.termName,
                        academicYear: term.academicYear,
                        startDate: firebase.firestore.Timestamp.fromDate(start),
                        endDate: firebase.firestore.Timestamp.fromDate(end),
                        description: term.description,
                        examinationPeriod: term.examinationPeriod,
                        autoActivate: term.autoActivate,
                        isActive: false,
                        status: 'upcoming',
                        weeks: weeks,
                        days: days,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: currentUser.uid
                    });
                });
                
                await batch.commit();
                showSuccess('Sample academic terms created successfully!');
                loadAcademicTerms();
                
            } catch (error) {
                console.error('Error creating sample terms:', error);
                showError('Error creating sample terms: ' + error.message);
            }
        }
        
        // Make functions globally available
        window.createAcademicTerm = createAcademicTerm;
        window.editTerm = editTerm;
        window.updateTerm = updateTerm;
        window.deleteTerm = deleteTerm;
        window.viewTermDetails = viewTermDetails;
        window.toggleTermStatus = toggleTermStatus;
        window.searchTerms = searchTerms;
        window.filterTerms = filterTerms;
        window.clearFilters = clearFilters;
        window.exportTerms = exportTerms;
        window.printTerms = printTerms;
        window.createSampleTerms = createSampleTerms;
        window.logout = logout;
        
        // Delete academic term
        async function deleteTerm(termId) {
            if (confirm('Are you sure you want to delete this academic term? This action cannot be undone.')) {
                try {
                    await db.collection('academic_terms').doc(termId).delete();
                    showSuccess('Academic term deleted successfully!');
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error deleting academic term:', error);
                    showError('Error deleting academic term: ' + error.message);
                }
            }
        }
        
        // Search terms
        function searchTerms() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredTerms = academicTerms.filter(term => 
                term.termName.toLowerCase().includes(searchTerm) ||
                term.academicYear.toLowerCase().includes(searchTerm) ||
                (term.description || '').toLowerCase().includes(searchTerm)
            );
            
            // Update display with filtered results
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            filteredTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
        }
        
        // Filter terms by status
        function filterByStatus(status) {
            let filteredTerms = academicTerms;
            
            if (status === 'active') {
                filteredTerms = academicTerms.filter(term => term.isActive);
            } else if (status === 'inactive') {
                filteredTerms = academicTerms.filter(term => !term.isActive);
            } else if (status === 'completed') {
                filteredTerms = academicTerms.filter(term => term.status === 'completed');
            } else if (status === 'upcoming') {
                filteredTerms = academicTerms.filter(term => term.status === 'upcoming');
            }
            
            // Update display with filtered results
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            filteredTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for academic term changes
            db.collection('academicTerms').onSnapshot((snapshot) => {
                loadAcademicTerms();
                updateTermStats();
            });
        }
        
        // Enhanced academic term loading with real-time updates
        async function loadAcademicTerms() {
            try {
                const termsSnapshot = await db.collection('academicTerms')
                    .orderBy('startDate', 'desc')
                    .get();
                
                academicTerms = [];
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    academicTerms.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                displayAcademicTerms(academicTerms);
                updateTermStats();
                
            } catch (error) {
                console.error('Error loading academic terms:', error);
                showError('Failed to load academic terms. Please try again.');
            }
        }
        
        // Update term statistics
        function updateTermStats() {
            const totalTerms = academicTerms.length;
            const activeTerms = academicTerms.filter(term => term.isActive === true).length;
            const currentTerms = academicTerms.filter(term => {
                const now = new Date();
                const startDate = term.startDate?.toDate();
                const endDate = term.endDate?.toDate();
                return startDate && endDate && now >= startDate && now <= endDate;
            }).length;
            
            const upcomingTerms = academicTerms.filter(term => {
                const now = new Date();
                const startDate = term.startDate?.toDate();
                return startDate && startDate > now;
            }).length;
            
            // Update stats cards if they exist
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalTerms;
                statsCards[1].textContent = activeTerms;
                statsCards[2].textContent = currentTerms;
                statsCards[3].textContent = upcomingTerms;
            }
        }
        
        // Enhanced search with real-time filtering
        function searchTerms() {
            const searchTerm = document.getElementById('search-terms').value.toLowerCase();
            const filteredTerms = academicTerms.filter(term => 
                term.name?.toLowerCase().includes(searchTerm) ||
                term.year?.toString().includes(searchTerm) ||
                term.description?.toLowerCase().includes(searchTerm)
            );
            displayAcademicTerms(filteredTerms);
        }
        
        // Enhanced filter with real-time updates
        function filterByStatus() {
            const statusFilter = document.getElementById('status-filter').value;
            let filteredTerms = academicTerms;
            
            if (statusFilter === 'active') {
                filteredTerms = academicTerms.filter(term => term.isActive === true);
            } else if (statusFilter === 'inactive') {
                filteredTerms = academicTerms.filter(term => term.isActive === false);
            } else if (statusFilter === 'current') {
                const now = new Date();
                filteredTerms = academicTerms.filter(term => {
                    const startDate = term.startDate?.toDate();
                    const endDate = term.endDate?.toDate();
                    return startDate && endDate && now >= startDate && now <= endDate;
                });
            } else if (statusFilter === 'upcoming') {
                const now = new Date();
                filteredTerms = academicTerms.filter(term => {
                    const startDate = term.startDate?.toDate();
                    return startDate && startDate > now;
                });
            }
            
            displayAcademicTerms(filteredTerms);
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.createAcademicTerm = createAcademicTerm;
        window.editTerm = editTerm;
        window.viewTermDetails = viewTermDetails;
        window.toggleTermStatus = toggleTermStatus;
        window.deleteTerm = deleteTerm;
        window.searchTerms = searchTerms;
        window.filterByStatus = filterByStatus;
        window.logout = logout;
    </script>
</body>
</html>
