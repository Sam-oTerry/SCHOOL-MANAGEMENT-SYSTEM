<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Term Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🏫</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="staff-management.html">
                                <i class="fas fa-user-tie"></i> Staff Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>Term Management</h4>
                        <span class="role-badge">System Management</span>
                    </div>
                    <div>
                        <span id="current-user">John Doe</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Term Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Term Management Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Academic Year</label>
                                <select class="form-select" id="academic-year" onchange="updateTerms()">
                                    <option value="2023" selected>2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Current Term</label>
                                <select class="form-select" id="current-term" onchange="updateCurrentTerm()">
                                    <option value="term1">Term 1</option>
                                    <option value="term2" selected>Term 2</option>
                                    <option value="term3">Term 3</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTermModal">
                                        <i class="fas fa-plus"></i> Create Term
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="startNewTerm()">
                                        <i class="fas fa-play"></i> Start Term
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quick Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-info btn-sm" onclick="endCurrentTerm()">
                                        <i class="fas fa-stop"></i> End Term
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="archiveTerms()">
                                        <i class="fas fa-archive"></i> Archive
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Term Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Current Term Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center">
                                    <div class="card-body">
                                        <h3>Term 2</h3>
                                        <p class="mb-0">Current Term</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center">
                                    <div class="card-body">
                                        <h3>45</h3>
                                        <p class="mb-0">Days Remaining</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center">
                                    <div class="card-body">
                                        <h3>65%</h3>
                                        <p class="mb-0">Progress</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center">
                                    <div class="card-body">
                                        <h3>Active</h3>
                                        <p class="mb-0">Status</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Terms List -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Academic Terms</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Term</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="terms-tbody">
                                    <!-- Terms will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Term Deadlines -->
                <div class="card">
                    <div class="card-header">
                        <h5>Important Deadlines</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Upcoming Deadlines</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Mid-term Examinations
                                        <span class="badge bg-primary rounded-pill">5 days</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Report Cards Due
                                        <span class="badge bg-warning rounded-pill">12 days</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        End of Term
                                        <span class="badge bg-success rounded-pill">45 days</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Recent Activities</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Term 2 started successfully
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Student enrollment completed
                                    </li>
                                    <li class="list-group-item">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        Timetable published
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create Term Modal -->
    <div class="modal fade" id="createTermModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Term</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-term-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Term Name</label>
                                    <select class="form-select" id="term-name" required>
                                        <option value="">Select Term</option>
                                        <option value="term1">Term 1</option>
                                        <option value="term2">Term 2</option>
                                        <option value="term3">Term 3</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Academic Year</label>
                                    <input type="text" class="form-control" id="term-academic-year" value="2023" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="term-start-date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="term-end-date" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Registration Deadline</label>
                                    <input type="date" class="form-control" id="registration-deadline">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Examination Period</label>
                                    <input type="text" class="form-control" id="examination-period" placeholder="e.g., Week 8-9">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="term-description" rows="3" placeholder="Enter term description..."></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-activate">
                                <label class="form-check-label" for="auto-activate">
                                    Auto-activate term when start date is reached
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createTerm()">Create Term</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/system-admin.js"></script>
    <script>
        // Term Management Functionality
        let terms = [];
        
        // Sample terms data
        const sampleTerms = [
            {
                id: 1,
                name: 'Term 1',
                academicYear: '2023',
                startDate: '2023-09-04',
                endDate: '2023-12-15',
                duration: '102 days',
                status: 'Completed',
                progress: 100
            },
            {
                id: 2,
                name: 'Term 2',
                academicYear: '2023',
                startDate: '2024-01-08',
                endDate: '2024-04-05',
                duration: '87 days',
                status: 'Active',
                progress: 65
            },
            {
                id: 3,
                name: 'Term 3',
                academicYear: '2023',
                startDate: '2024-04-22',
                endDate: '2024-08-09',
                duration: '109 days',
                status: 'Scheduled',
                progress: 0
            }
        ];
        
        function initializeTermManagement() {
            terms = [...sampleTerms];
            displayTerms();
        }
        
        function displayTerms() {
            const tbody = document.getElementById('terms-tbody');
            tbody.innerHTML = '';
            
            terms.forEach(term => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${term.name}</strong></td>
                    <td>${formatDate(term.startDate)}</td>
                    <td>${formatDate(term.endDate)}</td>
                    <td>${term.duration}</td>
                    <td><span class="badge ${getStatusColor(term.status)}">${term.status}</span></td>
                    <td>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar ${getProgressColor(term.progress)}" role="progressbar" 
                                 style="width: ${term.progress}%" aria-valuenow="${term.progress}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                ${term.progress}%
                            </div>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewTerm(${term.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editTerm(${term.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTerm(${term.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'active': return 'bg-success';
                case 'completed': return 'bg-primary';
                case 'scheduled': return 'bg-warning';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function getProgressColor(progress) {
            if (progress >= 80) return 'bg-success';
            if (progress >= 50) return 'bg-warning';
            if (progress >= 20) return 'bg-info';
            return 'bg-danger';
        }
        
        function createTerm() {
            const name = document.getElementById('term-name').value;
            const academicYear = document.getElementById('term-academic-year').value;
            const startDate = document.getElementById('term-start-date').value;
            const endDate = document.getElementById('term-end-date').value;
            const registrationDeadline = document.getElementById('registration-deadline').value;
            const examinationPeriod = document.getElementById('examination-period').value;
            const description = document.getElementById('term-description').value;
            const autoActivate = document.getElementById('auto-activate').checked;
            
            if (!name || !academicYear || !startDate || !endDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (new Date(startDate) >= new Date(endDate)) {
                alert('End date must be after start date.');
                return;
            }
            
            // Calculate duration
            const start = new Date(startDate);
            const end = new Date(endDate);
            const duration = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            const newTerm = {
                id: terms.length + 1,
                name: name.charAt(0).toUpperCase() + name.slice(1),
                academicYear,
                startDate,
                endDate,
                duration: duration + ' days',
                status: 'Scheduled',
                progress: 0,
                registrationDeadline,
                examinationPeriod,
                description,
                autoActivate
            };
            
            terms.push(newTerm);
            displayTerms();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTermModal'));
            modal.hide();
            document.getElementById('create-term-form').reset();
            
            showNotification('Term created successfully!', 'success');
        }
        
        function viewTerm(termId) {
            const term = terms.find(t => t.id === termId);
            if (!term) return;
            
            alert(`Term Details:\n\nName: ${term.name}\nAcademic Year: ${term.academicYear}\nStart Date: ${formatDate(term.startDate)}\nEnd Date: ${formatDate(term.endDate)}\nDuration: ${term.duration}\nStatus: ${term.status}\nProgress: ${term.progress}%`);
        }
        
        function editTerm(termId) {
            const term = terms.find(t => t.id === termId);
            if (!term) return;
            
            alert(`Edit Term:\n\nTerm: ${term.name}\nAcademic Year: ${term.academicYear}\n\nThis feature will open the edit form for the term.`);
        }
        
        function deleteTerm(termId) {
            if (confirm('Are you sure you want to delete this term?')) {
                terms = terms.filter(t => t.id !== termId);
                displayTerms();
                showNotification('Term deleted successfully!', 'success');
            }
        }
        
        function updateTerms() {
            const academicYear = document.getElementById('academic-year').value;
            
            // Filter terms by academic year
            displayTerms();
        }
        
        function updateCurrentTerm() {
            const currentTerm = document.getElementById('current-term').value;
            
            // Update current term
            showNotification(`Current term updated to ${currentTerm}!`, 'success');
        }
        
        function startNewTerm() {
            if (confirm('Are you sure you want to start a new term? This will end the current term.')) {
                alert('Starting new term...\n\nThis feature will end the current term and start a new one.');
                showNotification('New term started successfully!', 'success');
            }
        }
        
        function endCurrentTerm() {
            if (confirm('Are you sure you want to end the current term?')) {
                alert('Ending current term...\n\nThis feature will end the current term and prepare for the next one.');
                showNotification('Current term ended successfully!', 'success');
            }
        }
        
        function archiveTerms() {
            if (confirm('Are you sure you want to archive completed terms?')) {
                alert('Archiving terms...\n\nThis feature will archive all completed terms.');
                showNotification('Terms archived successfully!', 'success');
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../index.html';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeTermManagement();
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "ass-sms.firebaseapp.com",
            projectId: "ass-sms",
            storageBucket: "ass-sms.firebasestorage.app",
            messagingSenderId: "515388722489",
            appId: "1:515388722489:web:21169f130303f48aaa2ce8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let academicTerms = [];
        let currentAcademicYear = '2024';
        
        // Check authentication and role
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userRole = userData.role;
                        
                        if (userRole === 'system_admin') {
                            console.log('✅ System Administrator authenticated:', user.email);
                            currentUser = user;
                            loadAcademicTerms();
                            setupRealTimeListeners();
                        } else {
                            console.log('❌ Access denied. Required role: system_admin');
                            alert('Access denied. You do not have system administrator privileges.');
                            auth.signOut().then(() => {
                                window.location.href = '../../index.html';
                            });
                        }
                    } else {
                        console.log('❌ User document not found');
                        auth.signOut().then(() => {
                            window.location.href = '../../index.html';
                        });
                    }
                });
            } else {
                console.log('❌ No authenticated user, redirecting to login');
                window.location.href = '../../index.html';
            }
        });
        
        // Load academic terms from Firebase
        async function loadAcademicTerms() {
            try {
                const termsSnapshot = await db.collection('academic_terms')
                    .where('academicYear', '==', currentAcademicYear)
                    .orderBy('termNumber', 'asc')
                    .get();
                
                academicTerms = [];
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    academicTerms.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                displayAcademicTerms();
                updateTermStats();
                
                console.log('✅ Academic terms loaded successfully');
            } catch (error) {
                console.error('❌ Error loading academic terms:', error);
                showError('Failed to load academic terms. Please try again.');
            }
        }
        
        // Display academic terms in the table
        function displayAcademicTerms() {
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            academicTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
        }
        
        // Create term row
        function createTermRow(term) {
            const row = document.createElement('tr');
            const startDate = term.startDate ? new Date(term.startDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const endDate = term.endDate ? new Date(term.endDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const isActive = term.isActive ? 'Active' : 'Inactive';
            const statusClass = term.isActive ? 'bg-success' : 'bg-secondary';
            
            row.innerHTML = `
                <td>${term.termName}</td>
                <td>${term.academicYear}</td>
                <td>${startDate}</td>
                <td>${endDate}</td>
                <td><span class="badge ${statusClass}">${isActive}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTerm('${term.id}')" title="Edit Term">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewTermDetails('${term.id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleTermStatus('${term.id}')" title="Toggle Status">
                        <i class="fas fa-toggle-${term.isActive ? 'on' : 'off'}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTerm('${term.id}')" title="Delete Term">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            return row;
        }
        
        // Update term statistics
        function updateTermStats() {
            const totalTerms = academicTerms.length;
            const activeTerms = academicTerms.filter(term => term.isActive).length;
            const completedTerms = academicTerms.filter(term => term.status === 'completed').length;
            const upcomingTerms = academicTerms.filter(term => term.status === 'upcoming').length;
            
            // Update stats cards
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalTerms;
                statsCards[1].textContent = activeTerms;
                statsCards[2].textContent = completedTerms;
                statsCards[3].textContent = upcomingTerms;
            }
        }
        
        // Create new academic term
        async function createAcademicTerm() {
            const termName = document.getElementById('termName').value;
            const academicYear = document.getElementById('academicYear').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const description = document.getElementById('termDescription').value;
            
            if (!termName || !academicYear || !startDate || !endDate) {
                showError('Please fill in all required fields.');
                return;
            }
            
            // Validate dates
            const start = new Date(startDate);
            const end = new Date(endDate);
            if (start >= end) {
                showError('End date must be after start date.');
                return;
            }
            
            try {
                const termData = {
                    termName: termName,
                    academicYear: academicYear,
                    startDate: firebase.firestore.Timestamp.fromDate(start),
                    endDate: firebase.firestore.Timestamp.fromDate(end),
                    description: description || '',
                    isActive: false,
                    status: 'upcoming',
                    termNumber: academicTerms.length + 1,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('academic_terms').add(termData);
                
                showSuccess('Academic term created successfully!');
                document.getElementById('createTermForm').reset();
                loadAcademicTerms();
                
            } catch (error) {
                console.error('Error creating academic term:', error);
                showError('Error creating academic term: ' + error.message);
            }
        }
        
        // Edit academic term
        async function editTerm(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            const newTermName = prompt('Enter new term name:', term.termName);
            const newStartDate = prompt('Enter new start date (YYYY-MM-DD):', 
                term.startDate ? new Date(term.startDate.seconds * 1000).toISOString().split('T')[0] : '');
            const newEndDate = prompt('Enter new end date (YYYY-MM-DD):', 
                term.endDate ? new Date(term.endDate.seconds * 1000).toISOString().split('T')[0] : '');
            const newDescription = prompt('Enter new description:', term.description || '');
            
            if (newTermName && newStartDate && newEndDate) {
                try {
                    const start = new Date(newStartDate);
                    const end = new Date(newEndDate);
                    
                    if (start >= end) {
                        showError('End date must be after start date.');
                        return;
                    }
                    
                    await db.collection('academic_terms').doc(termId).update({
                        termName: newTermName,
                        startDate: firebase.firestore.Timestamp.fromDate(start),
                        endDate: firebase.firestore.Timestamp.fromDate(end),
                        description: newDescription,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.uid
                    });
                    
                    showSuccess('Academic term updated successfully!');
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error updating academic term:', error);
                    showError('Error updating academic term: ' + error.message);
                }
            }
        }
        
        // View term details
        function viewTermDetails(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            const startDate = term.startDate ? new Date(term.startDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const endDate = term.endDate ? new Date(term.endDate.seconds * 1000).toLocaleDateString() : 'Not set';
            const createdDate = term.createdAt ? new Date(term.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            
            const details = `
                <strong>Term Details:</strong><br>
                <strong>Name:</strong> ${term.termName}<br>
                <strong>Academic Year:</strong> ${term.academicYear}<br>
                <strong>Start Date:</strong> ${startDate}<br>
                <strong>End Date:</strong> ${endDate}<br>
                <strong>Status:</strong> ${term.isActive ? 'Active' : 'Inactive'}<br>
                <strong>Description:</strong> ${term.description || 'No description'}<br>
                <strong>Created:</strong> ${createdDate}
            `;
            
            alert(details);
        }
        
        // Toggle term status
        async function toggleTermStatus(termId) {
            const term = academicTerms.find(t => t.id === termId);
            if (!term) return;
            
            const newStatus = !term.isActive;
            const action = newStatus ? 'activate' : 'deactivate';
            
            if (confirm(`Are you sure you want to ${action} this term?`)) {
                try {
                    // If activating this term, deactivate all other terms first
                    if (newStatus) {
                        const batch = db.batch();
                        academicTerms.forEach(t => {
                            if (t.isActive) {
                                batch.update(db.collection('academic_terms').doc(t.id), {
                                    isActive: false,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    updatedBy: currentUser.uid
                                });
                            }
                        });
                        await batch.commit();
                    }
                    
                    await db.collection('academic_terms').doc(termId).update({
                        isActive: newStatus,
                        status: newStatus ? 'active' : 'inactive',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedBy: currentUser.uid
                    });
                    
                    showSuccess(`Term ${action}d successfully!`);
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error toggling term status:', error);
                    showError('Error toggling term status. Please try again.');
                }
            }
        }
        
        // Delete academic term
        async function deleteTerm(termId) {
            if (confirm('Are you sure you want to delete this academic term? This action cannot be undone.')) {
                try {
                    await db.collection('academic_terms').doc(termId).delete();
                    showSuccess('Academic term deleted successfully!');
                    loadAcademicTerms();
                } catch (error) {
                    console.error('Error deleting academic term:', error);
                    showError('Error deleting academic term: ' + error.message);
                }
            }
        }
        
        // Search terms
        function searchTerms() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredTerms = academicTerms.filter(term => 
                term.termName.toLowerCase().includes(searchTerm) ||
                term.academicYear.toLowerCase().includes(searchTerm) ||
                (term.description || '').toLowerCase().includes(searchTerm)
            );
            
            // Update display with filtered results
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            filteredTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
        }
        
        // Filter terms by status
        function filterByStatus(status) {
            let filteredTerms = academicTerms;
            
            if (status === 'active') {
                filteredTerms = academicTerms.filter(term => term.isActive);
            } else if (status === 'inactive') {
                filteredTerms = academicTerms.filter(term => !term.isActive);
            } else if (status === 'completed') {
                filteredTerms = academicTerms.filter(term => term.status === 'completed');
            } else if (status === 'upcoming') {
                filteredTerms = academicTerms.filter(term => term.status === 'upcoming');
            }
            
            // Update display with filtered results
            const tbody = document.querySelector('#termsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            filteredTerms.forEach(term => {
                const row = createTermRow(term);
                tbody.appendChild(row);
            });
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for academic term changes
            db.collection('academicTerms').onSnapshot((snapshot) => {
                loadAcademicTerms();
                updateTermStats();
            });
        }
        
        // Enhanced academic term loading with real-time updates
        async function loadAcademicTerms() {
            try {
                const termsSnapshot = await db.collection('academicTerms')
                    .orderBy('startDate', 'desc')
                    .get();
                
                academicTerms = [];
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    academicTerms.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                displayAcademicTerms(academicTerms);
                updateTermStats();
                
            } catch (error) {
                console.error('Error loading academic terms:', error);
                showError('Failed to load academic terms. Please try again.');
            }
        }
        
        // Update term statistics
        function updateTermStats() {
            const totalTerms = academicTerms.length;
            const activeTerms = academicTerms.filter(term => term.isActive === true).length;
            const currentTerms = academicTerms.filter(term => {
                const now = new Date();
                const startDate = term.startDate?.toDate();
                const endDate = term.endDate?.toDate();
                return startDate && endDate && now >= startDate && now <= endDate;
            }).length;
            
            const upcomingTerms = academicTerms.filter(term => {
                const now = new Date();
                const startDate = term.startDate?.toDate();
                return startDate && startDate > now;
            }).length;
            
            // Update stats cards if they exist
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalTerms;
                statsCards[1].textContent = activeTerms;
                statsCards[2].textContent = currentTerms;
                statsCards[3].textContent = upcomingTerms;
            }
        }
        
        // Enhanced search with real-time filtering
        function searchTerms() {
            const searchTerm = document.getElementById('search-terms').value.toLowerCase();
            const filteredTerms = academicTerms.filter(term => 
                term.name?.toLowerCase().includes(searchTerm) ||
                term.year?.toString().includes(searchTerm) ||
                term.description?.toLowerCase().includes(searchTerm)
            );
            displayAcademicTerms(filteredTerms);
        }
        
        // Enhanced filter with real-time updates
        function filterByStatus() {
            const statusFilter = document.getElementById('status-filter').value;
            let filteredTerms = academicTerms;
            
            if (statusFilter === 'active') {
                filteredTerms = academicTerms.filter(term => term.isActive === true);
            } else if (statusFilter === 'inactive') {
                filteredTerms = academicTerms.filter(term => term.isActive === false);
            } else if (statusFilter === 'current') {
                const now = new Date();
                filteredTerms = academicTerms.filter(term => {
                    const startDate = term.startDate?.toDate();
                    const endDate = term.endDate?.toDate();
                    return startDate && endDate && now >= startDate && now <= endDate;
                });
            } else if (statusFilter === 'upcoming') {
                const now = new Date();
                filteredTerms = academicTerms.filter(term => {
                    const startDate = term.startDate?.toDate();
                    return startDate && startDate > now;
                });
            }
            
            displayAcademicTerms(filteredTerms);
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.createAcademicTerm = createAcademicTerm;
        window.editTerm = editTerm;
        window.viewTermDetails = viewTermDetails;
        window.toggleTermStatus = toggleTermStatus;
        window.deleteTerm = deleteTerm;
        window.searchTerms = searchTerms;
        window.filterByStatus = filterByStatus;
        window.logout = logout;
    </script>
</body>
</html>
