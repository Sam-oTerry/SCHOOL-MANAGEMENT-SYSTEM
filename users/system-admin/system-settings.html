<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
    <style>
        .settings-nav-btn {
            transition: all 0.3s ease;
            border-radius: 8px;
        }
        .settings-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .settings-section {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid #dee2e6;
        }
        .form-control:focus, .form-select:focus {
            border-color: #0dcaf0;
            box-shadow: 0 0 0 0.2rem rgba(13, 202, 240, 0.25);
        }
        .btn-group .btn {
            border-radius: 6px;
            margin-right: 0.5rem;
        }
        .settings-status {
            transition: all 0.3s ease;
        }
        .settings-status.text-success {
            background-color: rgba(25, 135, 84, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #198754;
        }
        .settings-status.text-danger {
            background-color: rgba(220, 53, 69, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 3px solid #dc3545;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="fas fa-cog me-2"></i>System Settings
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportSettings()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('settings-file').click()">
                                <i class="fas fa-upload"></i> Import
                            </button>
                            <input type="file" id="settings-file" accept=".json" style="display: none;" onchange="importSettings()">
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="resetToDefaults()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                    </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="saveAllSettings()">
                            <i class="fas fa-save"></i> Save All
                        </button>
                    </div>
                </div>
                
                <!-- Settings Navigation -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>Settings Categories
                        </h5>
                        <div class="settings-status">
                            <small class="text-muted" id="settingsStatus">Loading settings...</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100 mb-2 settings-nav-btn" onclick="showSettings('general')" id="nav-general">
                                    <i class="fas fa-cog"></i> General Settings
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100 mb-2 settings-nav-btn" onclick="showSettings('academic')" id="nav-academic">
                                    <i class="fas fa-graduation-cap"></i> Academic Settings
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100 mb-2 settings-nav-btn" onclick="showSettings('security')" id="nav-security">
                                    <i class="fas fa-shield-alt"></i> Security Settings
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100 mb-2 settings-nav-btn" onclick="showSettings('backup')" id="nav-backup">
                                    <i class="fas fa-database"></i> Backup Settings
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading system settings...</p>
                </div>
                
                <!-- General Settings -->
                <div id="general-settings" class="settings-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>General Settings
                            </h5>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveGeneralSettings()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="general-settings-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">School Name</label>
                                            <input type="text" class="form-control" id="school-name" value="St. Mary's Secondary School">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">School Code</label>
                                            <input type="text" class="form-control" id="school-code" value="SMS001">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">School Address</label>
                                            <textarea class="form-control" id="school-address" rows="3">P.O. Box 123, Kampala, Uganda</textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Contact Information</label>
                                            <input type="tel" class="form-control mb-2" id="school-phone" value="+256 700 123 456">
                                            <input type="email" class="form-control" id="school-email" value="info@stmarys.edu">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Currency</label>
                                            <select class="form-select" id="currency">
                                                <option value="UGX" selected>Ugandan Shilling (UGX)</option>
                                                <option value="USD">US Dollar (USD)</option>
                                                <option value="EUR">Euro (EUR)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Time Zone</label>
                                            <select class="form-select" id="timezone">
                                                <option value="Africa/Kampala" selected>Africa/Kampala</option>
                                                <option value="UTC">UTC</option>
                                                <option value="America/New_York">America/New_York</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Academic Settings -->
                <div id="academic-settings" class="settings-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-graduation-cap me-2"></i>Academic Settings
                            </h5>
                            <button type="button" class="btn btn-sm btn-success" onclick="saveAcademicSettings()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="academic-settings-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Academic Year</label>
                                            <input type="text" class="form-control" id="academic-year" value="2023">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Number of Terms</label>
                                            <select class="form-select" id="number-of-terms">
                                                <option value="3" selected>3 Terms</option>
                                                <option value="2">2 Terms</option>
                                                <option value="4">4 Terms</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Grading System</label>
                                            <select class="form-select" id="grading-system">
                                                <option value="A-F" selected>A-F (New Curriculum)</option>
                                                <option value="1-9">1-9 (Old System)</option>
                                                <option value="percentage">Percentage</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Pass Mark</label>
                                            <input type="number" class="form-control" id="pass-mark" value="50" min="0" max="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Mid-term Weight (%)</label>
                                            <input type="number" class="form-control" id="midterm-weight" value="20" min="0" max="100">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">End-term Weight (%)</label>
                                            <input type="number" class="form-control" id="endterm-weight" value="80" min="0" max="100">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div id="security-settings" class="settings-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>Security Settings
                            </h5>
                            <button type="button" class="btn btn-sm btn-info" onclick="saveSecuritySettings()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="security-settings-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Password Policy</label>
                                            <select class="form-select" id="password-policy">
                                                <option value="standard" selected>Standard (6+ characters)</option>
                                                <option value="strong">Strong (8+ characters, mixed case)</option>
                                                <option value="complex">Complex (8+ characters, numbers, symbols)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Session Timeout (minutes)</label>
                                            <input type="number" class="form-control" id="session-timeout" value="30" min="5" max="480">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Login Attempts</label>
                                            <input type="number" class="form-control" id="login-attempts" value="3" min="1" max="10">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Account Lockout Duration (minutes)</label>
                                            <input type="number" class="form-control" id="lockout-duration" value="15" min="5" max="1440">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="two-factor-auth">
                                        <label class="form-check-label" for="two-factor-auth">
                                            Enable Two-Factor Authentication
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="audit-logging">
                                        <label class="form-check-label" for="audit-logging">
                                            Enable Audit Logging
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Backup Settings -->
                <div id="backup-settings" class="settings-section" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-database me-2"></i>Backup Settings
                            </h5>
                            <div>
                                <button type="button" class="btn btn-sm btn-warning me-2" onclick="saveBackupSettings()">
                                    <i class="fas fa-save"></i> Save
                                </button>
                                <button type="button" class="btn btn-sm btn-success" onclick="createBackup()">
                                    <i class="fas fa-database"></i> Backup Now
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="backup-settings-form">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Backup Frequency</label>
                                            <select class="form-select" id="backup-frequency">
                                                <option value="daily" selected>Daily</option>
                                                <option value="weekly">Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Backup Time</label>
                                            <input type="time" class="form-control" id="backup-time" value="02:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Retention Period (days)</label>
                                            <input type="number" class="form-control" id="retention-period" value="30" min="7" max="365">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Backup Location</label>
                                            <input type="text" class="form-control" id="backup-location" value="/backups/">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto-backup">
                                        <label class="form-check-label" for="auto-backup">
                                            Enable Automatic Backup
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="email-notifications">
                                        <label class="form-check-label" for="email-notifications">
                                            Email Backup Notifications
                                        </label>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/system-admin.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let systemSettings = {};
        let settingsLoaded = false;
        
        // System Settings Functionality
        function showSettings(category) {
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            // Hide all settings sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected section
            const targetSection = document.getElementById(category + '-settings');
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // Update button states
            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-warning');
                if (btn.id === 'nav-general') {
                    btn.classList.add('btn-outline-primary');
                } else if (btn.id === 'nav-academic') {
                    btn.classList.add('btn-outline-success');
                } else if (btn.id === 'nav-security') {
                    btn.classList.add('btn-outline-info');
                } else if (btn.id === 'nav-backup') {
                    btn.classList.add('btn-outline-warning');
                }
            });
            
            // Highlight active button
            const activeButton = document.getElementById('nav-' + category);
            if (activeButton) {
            if (category === 'general') {
                activeButton.classList.remove('btn-outline-primary');
                activeButton.classList.add('btn-primary');
            } else if (category === 'academic') {
                activeButton.classList.remove('btn-outline-success');
                activeButton.classList.add('btn-success');
            } else if (category === 'security') {
                activeButton.classList.remove('btn-outline-info');
                activeButton.classList.add('btn-info');
            } else if (category === 'backup') {
                activeButton.classList.remove('btn-outline-warning');
                activeButton.classList.add('btn-warning');
            }
        }
        }
        
        // Save General Settings
        async function saveGeneralSettings() {
            try {
                const generalSettings = {
                    schoolName: document.getElementById('school-name').value,
                    schoolCode: document.getElementById('school-code').value,
                    schoolAddress: document.getElementById('school-address').value,
                    schoolPhone: document.getElementById('school-phone').value,
                    schoolEmail: document.getElementById('school-email').value,
                    currency: document.getElementById('currency').value,
                    timezone: document.getElementById('timezone').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('systemSettings').doc('general').set(generalSettings, { merge: true });
                showSuccess('General settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving general settings:', error);
                showError('Error saving general settings: ' + error.message);
            }
        }
        
        // Save Academic Settings
        async function saveAcademicSettings() {
            try {
                const academicSettings = {
                    academicYear: document.getElementById('academic-year').value,
                    numberOfTerms: document.getElementById('number-of-terms').value,
                    gradingSystem: document.getElementById('grading-system').value,
                    passMark: parseInt(document.getElementById('pass-mark').value),
                    midtermWeight: parseInt(document.getElementById('midterm-weight').value),
                    endtermWeight: parseInt(document.getElementById('endterm-weight').value),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                // Validate weights
                if (academicSettings.midtermWeight + academicSettings.endtermWeight !== 100) {
                    showError('Mid-term and End-term weights must add up to 100%.');
                return;
            }
            
                await db.collection('systemSettings').doc('academic').set(academicSettings, { merge: true });
                showSuccess('Academic settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving academic settings:', error);
                showError('Error saving academic settings: ' + error.message);
            }
        }
        
        // Save Security Settings
        async function saveSecuritySettings() {
            try {
                const securitySettings = {
                    passwordPolicy: document.getElementById('password-policy').value,
                    sessionTimeout: parseInt(document.getElementById('session-timeout').value),
                    loginAttempts: parseInt(document.getElementById('login-attempts').value),
                    lockoutDuration: parseInt(document.getElementById('lockout-duration').value),
                    twoFactorAuth: document.getElementById('two-factor-auth').checked,
                    auditLogging: document.getElementById('audit-logging').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('systemSettings').doc('security').set(securitySettings, { merge: true });
                showSuccess('Security settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving security settings:', error);
                showError('Error saving security settings: ' + error.message);
            }
        }
        
        // Save Backup Settings
        async function saveBackupSettings() {
            try {
                const backupSettings = {
                    backupFrequency: document.getElementById('backup-frequency').value,
                    backupTime: document.getElementById('backup-time').value,
                    retentionPeriod: parseInt(document.getElementById('retention-period').value),
                    backupLocation: document.getElementById('backup-location').value,
                    autoBackup: document.getElementById('auto-backup').checked,
                    emailNotifications: document.getElementById('email-notifications').checked,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('systemSettings').doc('backup').set(backupSettings, { merge: true });
                showSuccess('Backup settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving backup settings:', error);
                showError('Error saving backup settings: ' + error.message);
            }
        }
        
        // Save All Settings
        async function saveAllSettings() {
            try {
                await Promise.all([
                    saveGeneralSettings(),
                    saveAcademicSettings(),
                    saveSecuritySettings(),
                    saveBackupSettings()
                ]);
                showSuccess('All settings saved successfully!');
            } catch (error) {
                console.error('Error saving all settings:', error);
                showError('Error saving settings: ' + error.message);
            }
        }
        
        // Create Backup
        async function createBackup() {
            if (confirm('Are you sure you want to create a backup now? This may take a few minutes.')) {
                try {
                    showSuccess('Backup process initiated...');
                    // Simulate backup process
                    setTimeout(() => {
                        showSuccess('Backup completed successfully!');
                    }, 3000);
                } catch (error) {
                    console.error('Error creating backup:', error);
                    showError('Error creating backup: ' + error.message);
                }
            }
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show general settings by default
            showSettings('general');
        });
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/users/system-admin-utils.js"></script>
    
    <script>
        // System Admin System Settings Functionality
        let systemSettings = {};
        let currentUser = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystemSettings();
            setupMobileSidebar(); // From system-admin-utils.js
        });

        async function initializeSystemSettings() {
            try {
                // Wait for authentication
                await waitForAuth(); // From system-admin-utils.js
                
                // Load user data using utility function
                const userResult = await loadSystemAdminUserData(db, currentUser); // From system-admin-utils.js
                if (!userResult.success) {
                    showError(userResult.error); // From system-admin-utils.js
                    return;
                }
                
                // Update UI with user data
                updateUserDisplay(userResult);
                
                // Load system settings
                loadSystemSettings();
                setupRealTimeListeners();
                
            } catch (error) {
                console.error('Error initializing system settings:', error);
                showError('Failed to initialize system settings. Please refresh and try again.'); // From system-admin-utils.js
            }
        }

        function updateUserDisplay(userResult) {
            try {
                // Update current user display
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = userResult.userName;
                }
                
                // Update sidebar staff ID
                const staffIdEl = document.querySelector('.sidebar small');
                if (staffIdEl) {
                    staffIdEl.textContent = `Staff ID: ${userResult.staffId}`;
                }
                
                console.log('System Admin System Settings user loaded:', {
                    name: userResult.userName,
                    department: userResult.departmentId,
                    departmentName: userResult.departmentName,
                    staffId: userResult.staffId
                });
            } catch (error) {
                console.error('Error updating user display:', error);
            }
        }
        
        // Load system settings from Firebase
        async function loadSystemSettings() {
            try {
                console.log('üîÑ Loading system settings...');
                
                // Load all settings categories
                const [generalDoc, academicDoc, securityDoc, backupDoc] = await Promise.all([
                    db.collection('systemSettings').doc('general').get(),
                    db.collection('systemSettings').doc('academic').get(),
                    db.collection('systemSettings').doc('security').get(),
                    db.collection('systemSettings').doc('backup').get()
                ]);
                
                // Populate forms with loaded data
                if (generalDoc.exists) {
                    const data = generalDoc.data();
                    document.getElementById('school-name').value = data.schoolName || '';
                    document.getElementById('school-code').value = data.schoolCode || '';
                    document.getElementById('school-address').value = data.schoolAddress || '';
                    document.getElementById('school-phone').value = data.schoolPhone || '';
                    document.getElementById('school-email').value = data.schoolEmail || '';
                    document.getElementById('currency').value = data.currency || 'UGX';
                    document.getElementById('timezone').value = data.timezone || 'Africa/Kampala';
                }
                
                if (academicDoc.exists) {
                    const data = academicDoc.data();
                    document.getElementById('academic-year').value = data.academicYear || '';
                    document.getElementById('number-of-terms').value = data.numberOfTerms || '3';
                    document.getElementById('grading-system').value = data.gradingSystem || 'A-F';
                    document.getElementById('pass-mark').value = data.passMark || 50;
                    document.getElementById('midterm-weight').value = data.midtermWeight || 20;
                    document.getElementById('endterm-weight').value = data.endtermWeight || 80;
                }
                
                if (securityDoc.exists) {
                    const data = securityDoc.data();
                    document.getElementById('password-policy').value = data.passwordPolicy || 'standard';
                    document.getElementById('session-timeout').value = data.sessionTimeout || 30;
                    document.getElementById('login-attempts').value = data.loginAttempts || 3;
                    document.getElementById('lockout-duration').value = data.lockoutDuration || 15;
                    document.getElementById('two-factor-auth').checked = data.twoFactorAuth || false;
                    document.getElementById('audit-logging').checked = data.auditLogging || false;
                }
                
                if (backupDoc.exists) {
                    const data = backupDoc.data();
                    document.getElementById('backup-frequency').value = data.backupFrequency || 'daily';
                    document.getElementById('backup-time').value = data.backupTime || '02:00';
                    document.getElementById('retention-period').value = data.retentionPeriod || 30;
                    document.getElementById('backup-location').value = data.backupLocation || '/backups/';
                    document.getElementById('auto-backup').checked = data.autoBackup || false;
                    document.getElementById('email-notifications').checked = data.emailNotifications || false;
                }
                
                // Update status
                document.getElementById('settingsStatus').textContent = 'Settings loaded successfully';
                document.getElementById('settingsStatus').className = 'text-success fw-bold';
                
                // Show general settings by default
                showSettings('general');
                
                console.log('‚úÖ System settings loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading system settings:', error);
                document.getElementById('settingsStatus').textContent = 'Error loading settings';
                document.getElementById('settingsStatus').className = 'text-danger fw-bold';
                showError('Failed to load system settings. Please try again.');
            }
        }
        
        // Setup real-time listeners
        function setupRealTimeListeners() {
            // Listen for settings changes
            db.collection('systemSettings').onSnapshot((snapshot) => {
                console.log('üìä System settings updated');
                loadSystemSettings();
            });
        }
        
        // Export settings
        async function exportSettings() {
            try {
                const [generalDoc, academicDoc, securityDoc, backupDoc] = await Promise.all([
                    db.collection('systemSettings').doc('general').get(),
                    db.collection('systemSettings').doc('academic').get(),
                    db.collection('systemSettings').doc('security').get(),
                    db.collection('systemSettings').doc('backup').get()
                ]);
                
                const settingsData = {
                    general: generalDoc.exists ? generalDoc.data() : {},
                    academic: academicDoc.exists ? academicDoc.data() : {},
                    security: securityDoc.exists ? securityDoc.data() : {},
                    backup: backupDoc.exists ? backupDoc.data() : {},
                    exportedAt: new Date().toISOString(),
                    exportedBy: currentUser.email
                };
                
                const dataStr = JSON.stringify(settingsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `system-settings-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                showSuccess('Settings exported successfully!');
                
            } catch (error) {
                console.error('Error exporting settings:', error);
                showError('Error exporting settings: ' + error.message);
            }
        }
        
        // Import settings
        async function importSettings() {
            const fileInput = document.getElementById('settings-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a file to import.');
                return;
            }
            
            try {
                const text = await file.text();
                const settingsData = JSON.parse(text);
                
                // Remove export metadata
                delete settingsData.exportedAt;
                delete settingsData.exportedBy;
                
                // Save each category
                if (settingsData.general) {
                    await db.collection('systemSettings').doc('general').set(settingsData.general, { merge: true });
                }
                if (settingsData.academic) {
                    await db.collection('systemSettings').doc('academic').set(settingsData.academic, { merge: true });
                }
                if (settingsData.security) {
                    await db.collection('systemSettings').doc('security').set(settingsData.security, { merge: true });
                }
                if (settingsData.backup) {
                    await db.collection('systemSettings').doc('backup').set(settingsData.backup, { merge: true });
                }
                
                showSuccess('Settings imported successfully!');
                loadSystemSettings(); // Reload to show imported settings
                
            } catch (error) {
                console.error('Error importing settings:', error);
                showError('Error importing settings: ' + error.message);
            }
        }
        
        // Reset to defaults
        async function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to default values? This action cannot be undone.')) {
                try {
                    const defaultSettings = {
                        general: {
                            schoolName: 'Adilang Secondary School',
                            schoolCode: 'ASS001',
                            schoolAddress: 'Agago District, Uganda',
                            schoolPhone: '',
                            schoolEmail: '',
                            currency: 'UGX',
                            timezone: 'Africa/Kampala'
                        },
                        academic: {
                            academicYear: new Date().getFullYear().toString(),
                            numberOfTerms: '3',
                            gradingSystem: 'A-F',
                            passMark: 50,
                            midtermWeight: 20,
                            endtermWeight: 80
                        },
                        security: {
                            passwordPolicy: 'standard',
                            sessionTimeout: 30,
                            loginAttempts: 3,
                            lockoutDuration: 15,
                            twoFactorAuth: false,
                            auditLogging: false
                        },
                        backup: {
                            backupFrequency: 'daily',
                            backupTime: '02:00',
                            retentionPeriod: 30,
                            backupLocation: '/backups/',
                            autoBackup: false,
                            emailNotifications: false
                        }
                    };
                    
                    // Save default settings
                    await Promise.all([
                        db.collection('systemSettings').doc('general').set(defaultSettings.general),
                        db.collection('systemSettings').doc('academic').set(defaultSettings.academic),
                        db.collection('systemSettings').doc('security').set(defaultSettings.security),
                        db.collection('systemSettings').doc('backup').set(defaultSettings.backup)
                    ]);
                    
                    showSuccess('Settings reset to default values successfully!');
                    loadSystemSettings();
                    
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showError('Error resetting settings: ' + error.message);
                }
            }
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.showSettings = showSettings;
        window.saveGeneralSettings = saveGeneralSettings;
        window.saveAcademicSettings = saveAcademicSettings;
        window.saveSecuritySettings = saveSecuritySettings;
        window.saveBackupSettings = saveBackupSettings;
        window.saveAllSettings = saveAllSettings;
        window.createBackup = createBackup;
        window.exportSettings = exportSettings;
        window.importSettings = importSettings;
        window.resetToDefaults = resetToDefaults;
        window.logout = logout;
    </script>
</body>
</html>
