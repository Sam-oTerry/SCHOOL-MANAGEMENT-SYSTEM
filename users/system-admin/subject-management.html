<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Subject Management</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportSubjects()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printSubjects()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addSubjectModal">
                            <i class="fas fa-plus"></i> Add Subject
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search subjects..." onkeyup="searchSubjects()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="levelFilter" onchange="filterSubjects()">
                            <option value="all">All Levels</option>
                            <option value="s1-s2">Senior 1-2</option>
                            <option value="s3-s4">Senior 3-4</option>
                            <option value="s5-s6">Senior 5-6</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="typeFilter" onchange="filterSubjects()">
                            <option value="all">All Types</option>
                            <option value="compulsory">Compulsory</option>
                            <option value="elective">Elective</option>
                            <option value="principal">Principal</option>
                            <option value="subsidiary">Subsidiary</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Subject Statistics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-book text-primary mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Total Subjects</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle text-success mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Compulsory</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-star text-warning mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Elective</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-graduation-cap text-info mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">A-Level</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subjects by Level -->
                <div class="row">
                    <!-- Senior 1-2 Compulsory Subjects -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Senior 1-2 Compulsory Subjects</h5>
                            </div>
                            <div class="card-body">
                                <div id="s1s2-compulsory-subjects">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Senior 1-2 Elective Subjects -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">Senior 1-2 Elective Subjects</h5>
                            </div>
                            <div class="card-body">
                                <div id="s1s2-elective-subjects">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Senior 3-4 Subjects -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">Senior 3-4 Subjects</h5>
                            </div>
                            <div class="card-body">
                                <div id="s3s4-subjects">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Senior 5-6 Principal Subjects -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">Senior 5-6 Principal Subjects</h5>
                            </div>
                            <div class="card-body">
                                <div id="s5s6-principal-subjects">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Senior 5-6 Subsidiary Subjects -->
                    <div class="col-md-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0">Senior 5-6 Subsidiary Subjects</h5>
                            </div>
                            <div class="card-body">
                                <div id="s5s6-subsidiary-subjects">
                                    <!-- Subjects will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Subject Modal -->
    <div class="modal fade" id="addSubjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Subject</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addSubjectForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="subjectName" class="form-label">Subject Name</label>
                                    <input type="text" class="form-control" id="subjectName" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="subjectCode" class="form-label">Subject Code</label>
                                    <input type="text" class="form-control" id="subjectCode" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subjectLevel" class="form-label">Level</label>
                                    <select class="form-select" id="subjectLevel" required>
                                        <option value="">Select Level</option>
                                        <option value="s1-s2">Senior 1-2</option>
                                        <option value="s3-s4">Senior 3-4</option>
                                        <option value="s5-s6">Senior 5-6</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subjectType" class="form-label">Type</label>
                                    <select class="form-select" id="subjectType" required>
                                        <option value="">Select Type</option>
                                        <option value="compulsory">Compulsory</option>
                                        <option value="elective">Elective</option>
                                        <option value="principal">Principal</option>
                                        <option value="subsidiary">Subsidiary</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="subjectDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="subjectDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subjectCredits" class="form-label">Credits</label>
                                    <input type="number" class="form-control" id="subjectCredits" min="1" max="10">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subjectHours" class="form-label">Hours per Week</label>
                                    <input type="number" class="form-control" id="subjectHours" min="1" max="20">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSubject()">Add Subject</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/users/system-admin-utils.js"></script>
    
    <script>
        // System Admin Subject Management Functionality
        let subjects = [];
        let filteredSubjects = [];
        let currentUser = null;
        
        // Predefined subjects data
        const predefinedSubjects = {
            's1s2-compulsory': [
                { name: 'English Language', code: 'ENG', credits: 4, hours: 6 },
                { name: 'Mathematics', code: 'MATH', credits: 4, hours: 6 },
                { name: 'History & Political Education', code: 'HPE', credits: 3, hours: 4 },
                { name: 'Physics', code: 'PHY', credits: 3, hours: 4 },
                { name: 'Chemistry', code: 'CHEM', credits: 3, hours: 4 },
                { name: 'Biology', code: 'BIO', credits: 3, hours: 4 },
                { name: 'Geography', code: 'GEO', credits: 3, hours: 4 },
                { name: 'Kiswahili', code: 'KIS', credits: 2, hours: 3 },
                { name: 'Physical Education', code: 'PE', credits: 2, hours: 3 },
                { name: 'Religious Education', code: 'RE', credits: 2, hours: 3 },
                { name: 'General Science', code: 'GS', credits: 3, hours: 4 }
            ],
            's1s2-elective': [
                { name: 'Literature in English', code: 'LIT', credits: 2, hours: 3 },
                { name: 'Luganda', code: 'LUG', credits: 2, hours: 3 },
                { name: 'French', code: 'FRE', credits: 2, hours: 3 },
                { name: 'Fine Art', code: 'ART', credits: 2, hours: 3 },
                { name: 'Entrepreneurship Education', code: 'ENT', credits: 2, hours: 3 },
                { name: 'Performing Arts', code: 'PA', credits: 2, hours: 3 },
                { name: 'Agriculture', code: 'AGR', credits: 2, hours: 3 },
                { name: 'Information and Computer Technology', code: 'ICT', credits: 2, hours: 3 },
                { name: 'Business Studies', code: 'BS', credits: 2, hours: 3 },
                { name: 'Home Economics', code: 'HE', credits: 2, hours: 3 },
                { name: 'Woodwork', code: 'WW', credits: 2, hours: 3 },
                { name: 'Metal Fabrication', code: 'MF', credits: 2, hours: 3 }
            ],
            's5s6-principal': [
                { name: 'Biology (A-Level)', code: 'BIO-A', credits: 6, hours: 8 },
                { name: 'Chemistry (A-Level)', code: 'CHEM-A', credits: 6, hours: 8 },
                { name: 'Physics (A-Level)', code: 'PHY-A', credits: 6, hours: 8 },
                { name: 'Mathematics (A-Level)', code: 'MATH-A', credits: 6, hours: 8 },
                { name: 'Geography (A-Level)', code: 'GEO-A', credits: 6, hours: 8 },
                { name: 'Economics', code: 'ECON', credits: 6, hours: 8 },
                { name: 'History (A-Level)', code: 'HIST-A', credits: 6, hours: 8 },
                { name: 'Literature in English (A-Level)', code: 'LIT-A', credits: 6, hours: 8 },
                { name: 'Divinity', code: 'DIV', credits: 6, hours: 8 },
                { name: 'Fine Art (A-Level)', code: 'ART-A', credits: 6, hours: 8 },
                { name: 'Business Studies (A-Level)', code: 'BS-A', credits: 6, hours: 8 },
                { name: 'Entrepreneurship (A-Level)', code: 'ENT-A', credits: 6, hours: 8 },
                { name: 'Accountancy', code: 'ACC', credits: 6, hours: 8 }
            ],
            's5s6-subsidiary': [
                { name: 'General Paper', code: 'GP', credits: 3, hours: 4 },
                { name: 'Subsidiary Mathematics', code: 'SUB-MATH', credits: 3, hours: 4 },
                { name: 'Subsidiary ICT', code: 'SUB-ICT', credits: 3, hours: 4 }
            ]
        };
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSubjectManagement();
            setupMobileSidebar(); // From system-admin-utils.js
        });

        async function initializeSubjectManagement() {
            try {
                // Wait for authentication
                await waitForAuth(); // From system-admin-utils.js
                
                // Load user data using utility function
                const userResult = await loadSystemAdminUserData(db, currentUser); // From system-admin-utils.js
                if (!userResult.success) {
                    showError(userResult.error); // From system-admin-utils.js
                    return;
                }
                
                // Update UI with user data
                updateUserDisplay(userResult);
                
                // Initialize subjects
                initializeSubjects();
                setupRealTimeListeners();
                
            } catch (error) {
                console.error('Error initializing subject management:', error);
                showError('Failed to initialize subject management. Please refresh and try again.'); // From system-admin-utils.js
            }
        }

        function updateUserDisplay(userResult) {
            try {
                // Update current user display
                const currentUserEl = document.getElementById('current-user');
                if (currentUserEl) {
                    currentUserEl.textContent = userResult.userName;
                }
                
                // Update sidebar staff ID
                const staffIdEl = document.querySelector('.sidebar small');
                if (staffIdEl) {
                    staffIdEl.textContent = `Staff ID: ${userResult.staffId}`;
                }
                
                console.log('System Admin Subject Management user loaded:', {
                    name: userResult.userName,
                    department: userResult.departmentId,
                    departmentName: userResult.departmentName,
                    staffId: userResult.staffId
                });
            } catch (error) {
                console.error('Error updating user display:', error);
            }
        }
        
        // Initialize subjects
        async function initializeSubjects() {
            try {
                await loadSubjects();
                await createDefaultSubjects();
                displaySubjectsByLevel();
                updateSubjectStats();
            } catch (error) {
                console.error('Error initializing subjects:', error);
                showError('Failed to initialize subjects. Please try again.');
            }
        }
        
        // Load subjects from Firebase
        async function loadSubjects() {
            try {
                const subjectsSnapshot = await db.collection('subjects').get();
                subjects = [];
                subjectsSnapshot.forEach(doc => {
                    const subjectData = doc.data();
                    subjects.push({
                        id: doc.id,
                        ...subjectData
                    });
                });
                
                filteredSubjects = [...subjects];
                
            } catch (error) {
                console.error('Error loading subjects:', error);
                showError('Failed to load subjects. Please try again.');
            }
        }
        
        // Create default subjects if they don't exist
        async function createDefaultSubjects() {
            if (subjects.length > 0) return; // Subjects already exist
            
            try {
                const batch = db.batch();
                let subjectCount = 0;
                
                // Add all predefined subjects
                Object.keys(predefinedSubjects).forEach(category => {
                    const categorySubjects = predefinedSubjects[category];
                    categorySubjects.forEach(subject => {
                        const subjectRef = db.collection('subjects').doc();
                        const subjectData = {
                            name: subject.name,
                            code: subject.code,
                            level: category.split('-')[0] + '-' + category.split('-')[1],
                            type: category.includes('compulsory') ? 'compulsory' : 
                                  category.includes('elective') ? 'elective' :
                                  category.includes('principal') ? 'principal' : 'subsidiary',
                            credits: subject.credits,
                            hoursPerWeek: subject.hours,
                            description: `${subject.name} - ${subject.code}`,
                            isActive: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: currentUser.uid
                        };
                        
                        batch.set(subjectRef, subjectData);
                        subjectCount++;
                    });
                });
                
                await batch.commit();
                console.log(`‚úÖ Created ${subjectCount} default subjects`);
                await loadSubjects(); // Reload subjects
                
            } catch (error) {
                console.error('Error creating default subjects:', error);
                showError('Error creating default subjects. Please try again.');
            }
        }
        
        // Display subjects by level
        function displaySubjectsByLevel() {
            displaySubjectCategory('s1s2-compulsory-subjects', 's1s2-compulsory');
            displaySubjectCategory('s1s2-elective-subjects', 's1s2-elective');
            displaySubjectCategory('s3s4-subjects', 's3s4');
            displaySubjectCategory('s5s6-principal-subjects', 's5s6-principal');
            displaySubjectCategory('s5s6-subsidiary-subjects', 's5s6-subsidiary');
        }
        
        // Display subject category
        function displaySubjectCategory(containerId, category) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const categorySubjects = subjects.filter(subject => {
                if (category === 's1s2-compulsory') return subject.level === 's1-s2' && subject.type === 'compulsory';
                if (category === 's1s2-elective') return subject.level === 's1-s2' && subject.type === 'elective';
                if (category === 's3s4') return subject.level === 's3-s4';
                if (category === 's5s6-principal') return subject.level === 's5-s6' && subject.type === 'principal';
                if (category === 's5s6-subsidiary') return subject.level === 's5-s6' && subject.type === 'subsidiary';
                return false;
            });
            
            container.innerHTML = '';
            
            if (categorySubjects.length === 0) {
                container.innerHTML = '<p class="text-muted">No subjects found.</p>';
                return;
            }
            
            categorySubjects.forEach(subject => {
                const subjectCard = createSubjectCard(subject);
                container.appendChild(subjectCard);
            });
        }
        
        // Create subject card
        function createSubjectCard(subject) {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            
            const typeColors = {
                'compulsory': 'primary',
                'elective': 'success',
                'principal': 'info',
                'subsidiary': 'secondary'
            };
            
            const typeColor = typeColors[subject.type] || 'secondary';
            
            card.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">${subject.name}</h6>
                            <small class="text-muted">Code: ${subject.code} | Credits: ${subject.credits || 'N/A'} | Hours: ${subject.hoursPerWeek || 'N/A'}</small>
                        </div>
                        <div>
                            <span class="badge bg-${typeColor}">${subject.type.toUpperCase()}</span>
                            <div class="btn-group btn-group-sm ms-2">
                                <button class="btn btn-outline-primary" onclick="editSubject('${subject.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSubject('${subject.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Update subject statistics
        function updateSubjectStats() {
            const totalSubjects = subjects.length;
            const compulsorySubjects = subjects.filter(s => s.type === 'compulsory').length;
            const electiveSubjects = subjects.filter(s => s.type === 'elective').length;
            const aLevelSubjects = subjects.filter(s => s.level === 's5-s6').length;
            
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalSubjects;
                statsCards[1].textContent = compulsorySubjects;
                statsCards[2].textContent = electiveSubjects;
                statsCards[3].textContent = aLevelSubjects;
            }
        }
        
        // Add new subject
        async function addSubject() {
            const name = document.getElementById('subjectName').value;
            const code = document.getElementById('subjectCode').value;
            const level = document.getElementById('subjectLevel').value;
            const type = document.getElementById('subjectType').value;
            const description = document.getElementById('subjectDescription').value;
            const credits = document.getElementById('subjectCredits').value;
            const hours = document.getElementById('subjectHours').value;
            
            if (!name || !code || !level || !type) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                const subjectData = {
                    name: name,
                    code: code,
                    level: level,
                    type: type,
                    description: description || '',
                    credits: credits ? parseInt(credits) : null,
                    hoursPerWeek: hours ? parseInt(hours) : null,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('subjects').add(subjectData);
                
                showSuccess('Subject added successfully!');
                document.getElementById('addSubjectForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addSubjectModal')).hide();
                await loadSubjects();
                displaySubjectsByLevel();
                updateSubjectStats();
                
            } catch (error) {
                console.error('Error adding subject:', error);
                showError('Error adding subject: ' + error.message);
            }
        }
        
        // Edit subject
        function editSubject(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            alert(`Edit subject: ${subject.name} - This feature will be implemented in the next update.`);
        }
        
        // Delete subject
        async function deleteSubject(subjectId) {
            if (confirm('Are you sure you want to delete this subject?')) {
                try {
                    await db.collection('subjects').doc(subjectId).delete();
                    showSuccess('Subject deleted successfully!');
                    await loadSubjects();
                    displaySubjectsByLevel();
                    updateSubjectStats();
                } catch (error) {
                    console.error('Error deleting subject:', error);
                    showError('Error deleting subject: ' + error.message);
                }
            }
        }
        
        // Search subjects
        function searchSubjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredSubjects = subjects.filter(subject => 
                subject.name.toLowerCase().includes(searchTerm) ||
                subject.code.toLowerCase().includes(searchTerm) ||
                (subject.description || '').toLowerCase().includes(searchTerm)
            );
            displaySubjectsByLevel();
        }
        
        // Filter subjects
        function filterSubjects() {
            const levelFilter = document.getElementById('levelFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredSubjects = subjects.filter(subject => {
                const levelMatch = levelFilter === 'all' || subject.level === levelFilter;
                const typeMatch = typeFilter === 'all' || subject.type === typeFilter;
                return levelMatch && typeMatch;
            });
            
            displaySubjectsByLevel();
        }
        
        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('typeFilter').value = 'all';
            filteredSubjects = [...subjects];
            displaySubjectsByLevel();
        }
        
        // Export subjects
        function exportSubjects() {
            const subjectsData = subjects.map(subject => ({
                name: subject.name,
                code: subject.code,
                level: subject.level,
                type: subject.type,
                credits: subject.credits,
                hoursPerWeek: subject.hoursPerWeek,
                description: subject.description
            }));
            
            const dataStr = JSON.stringify(subjectsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `subjects-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Subjects exported successfully!');
        }
        
        // Print subjects
        function printSubjects() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for subject changes
            db.collection('subjects').onSnapshot((snapshot) => {
                loadSubjects();
                displaySubjectsByLevel();
                updateSubjectStats();
            });
        }
        
        // Enhanced subject loading with real-time updates
        async function loadSubjects() {
            try {
                const subjectsSnapshot = await db.collection('subjects').get();
                subjects = [];
                subjectsSnapshot.forEach(doc => {
                    const subjectData = doc.data();
                    subjects.push({
                        id: doc.id,
                        ...subjectData
                    });
                });
                
                filteredSubjects = [...subjects];
                
            } catch (error) {
                console.error('Error loading subjects:', error);
                showError('Failed to load subjects. Please try again.');
            }
        }
        
        // Enhanced search with real-time filtering
        function searchSubjects() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredSubjects = subjects.filter(subject => 
                subject.name.toLowerCase().includes(searchTerm) ||
                subject.code.toLowerCase().includes(searchTerm) ||
                (subject.description || '').toLowerCase().includes(searchTerm)
            );
            displaySubjectsByLevel();
        }
        
        // Enhanced filter with real-time updates
        function filterSubjects() {
            const levelFilter = document.getElementById('levelFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredSubjects = subjects.filter(subject => {
                const levelMatch = levelFilter === 'all' || subject.level === levelFilter;
                const typeMatch = typeFilter === 'all' || subject.type === typeFilter;
                return levelMatch && typeMatch;
            });
            
            displaySubjectsByLevel();
        }
        
        // Enhanced subject creation with real-time updates
        async function addSubject() {
            const name = document.getElementById('subjectName').value;
            const code = document.getElementById('subjectCode').value;
            const level = document.getElementById('subjectLevel').value;
            const type = document.getElementById('subjectType').value;
            const description = document.getElementById('subjectDescription').value;
            const credits = document.getElementById('subjectCredits').value;
            const hours = document.getElementById('subjectHours').value;
            
            if (!name || !code || !level || !type) {
                showError('Please fill in all required fields.');
                return;
            }
            
            // Check if subject code already exists
            const existingSubject = subjects.find(s => s.code.toLowerCase() === code.toLowerCase());
            if (existingSubject) {
                showError('Subject code already exists. Please use a different code.');
                return;
            }
            
            try {
                const subjectData = {
                    name: name,
                    code: code,
                    level: level,
                    type: type,
                    description: description || '',
                    credits: credits ? parseInt(credits) : null,
                    hoursPerWeek: hours ? parseInt(hours) : null,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('subjects').add(subjectData);
                
                showSuccess('Subject added successfully!');
                document.getElementById('addSubjectForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addSubjectModal')).hide();
                
            } catch (error) {
                console.error('Error adding subject:', error);
                showError('Error adding subject: ' + error.message);
            }
        }
        
        // Enhanced subject editing with real-time updates
        async function editSubject(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            // Create edit modal dynamically
            const editModal = document.createElement('div');
            editModal.className = 'modal fade';
            editModal.id = 'editSubjectModal';
            editModal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Subject</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editSubjectForm">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-3">
                                            <label for="editSubjectName" class="form-label">Subject Name</label>
                                            <input type="text" class="form-control" id="editSubjectName" value="${subject.name}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="editSubjectCode" class="form-label">Subject Code</label>
                                            <input type="text" class="form-control" id="editSubjectCode" value="${subject.code}" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editSubjectLevel" class="form-label">Level</label>
                                            <select class="form-select" id="editSubjectLevel" required>
                                                <option value="s1-s2" ${subject.level === 's1-s2' ? 'selected' : ''}>Senior 1-2</option>
                                                <option value="s3-s4" ${subject.level === 's3-s4' ? 'selected' : ''}>Senior 3-4</option>
                                                <option value="s5-s6" ${subject.level === 's5-s6' ? 'selected' : ''}>Senior 5-6</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editSubjectType" class="form-label">Type</label>
                                            <select class="form-select" id="editSubjectType" required>
                                                <option value="compulsory" ${subject.type === 'compulsory' ? 'selected' : ''}>Compulsory</option>
                                                <option value="elective" ${subject.type === 'elective' ? 'selected' : ''}>Elective</option>
                                                <option value="principal" ${subject.type === 'principal' ? 'selected' : ''}>Principal</option>
                                                <option value="subsidiary" ${subject.type === 'subsidiary' ? 'selected' : ''}>Subsidiary</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="editSubjectDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editSubjectDescription" rows="3">${subject.description || ''}</textarea>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editSubjectCredits" class="form-label">Credits</label>
                                            <input type="number" class="form-control" id="editSubjectCredits" value="${subject.credits || ''}" min="1" max="10">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editSubjectHours" class="form-label">Hours per Week</label>
                                            <input type="number" class="form-control" id="editSubjectHours" value="${subject.hoursPerWeek || ''}" min="1" max="20">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateSubject('${subjectId}')">Update Subject</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editModal);
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            // Remove modal when hidden
            editModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(editModal);
            });
        }
        
        // Update subject function
        async function updateSubject(subjectId) {
            const name = document.getElementById('editSubjectName').value;
            const code = document.getElementById('editSubjectCode').value;
            const level = document.getElementById('editSubjectLevel').value;
            const type = document.getElementById('editSubjectType').value;
            const description = document.getElementById('editSubjectDescription').value;
            const credits = document.getElementById('editSubjectCredits').value;
            const hours = document.getElementById('editSubjectHours').value;
            
            if (!name || !code || !level || !type) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                const subjectData = {
                    name: name,
                    code: code,
                    level: level,
                    type: type,
                    description: description || '',
                    credits: credits ? parseInt(credits) : null,
                    hoursPerWeek: hours ? parseInt(hours) : null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                };
                
                await db.collection('subjects').doc(subjectId).update(subjectData);
                
                showSuccess('Subject updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editSubjectModal')).hide();
                
            } catch (error) {
                console.error('Error updating subject:', error);
                showError('Error updating subject: ' + error.message);
            }
        }
        
        // Enhanced subject deletion with confirmation
        async function deleteSubject(subjectId) {
            const subject = subjects.find(s => s.id === subjectId);
            if (!subject) return;
            
            if (confirm(`Are you sure you want to delete "${subject.name}"? This action cannot be undone.`)) {
                try {
                    await db.collection('subjects').doc(subjectId).delete();
                    showSuccess('Subject deleted successfully!');
                } catch (error) {
                    console.error('Error deleting subject:', error);
                    showError('Error deleting subject: ' + error.message);
                }
            }
        }
        
        // Enhanced export with real-time data
        function exportSubjects() {
            const subjectsData = subjects.map(subject => ({
                name: subject.name,
                code: subject.code,
                level: subject.level,
                type: subject.type,
                credits: subject.credits,
                hoursPerWeek: subject.hoursPerWeek,
                description: subject.description,
                isActive: subject.isActive,
                createdAt: subject.createdAt?.toDate?.()?.toISOString() || 'N/A'
            }));
            
            const dataStr = JSON.stringify(subjectsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `subjects-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Subjects exported successfully!');
        }
        
        // Enhanced print functionality
        function printSubjects() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <html>
                    <head>
                        <title>Subject Management Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; }
                            .section { margin-bottom: 30px; }
                            .subject-card { border: 1px solid #ddd; padding: 10px; margin: 5px 0; }
                            .subject-title { font-weight: bold; }
                            .subject-details { color: #666; font-size: 0.9em; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Subject Management Report</h1>
                            <p>Generated on: ${new Date().toLocaleDateString()}</p>
                        </div>
                        ${generatePrintContent()}
                    </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Generate print content
        function generatePrintContent() {
            let content = '';
            
            // Group subjects by level and type
            const groupedSubjects = {
                's1s2-compulsory': subjects.filter(s => s.level === 's1-s2' && s.type === 'compulsory'),
                's1s2-elective': subjects.filter(s => s.level === 's1-s2' && s.type === 'elective'),
                's3s4': subjects.filter(s => s.level === 's3-s4'),
                's5s6-principal': subjects.filter(s => s.level === 's5-s6' && s.type === 'principal'),
                's5s6-subsidiary': subjects.filter(s => s.level === 's5-s6' && s.type === 'subsidiary')
            };
            
            Object.keys(groupedSubjects).forEach(category => {
                const categorySubjects = groupedSubjects[category];
                if (categorySubjects.length > 0) {
                    const categoryName = category.replace('-', ' ').replace(/([A-Z])/g, ' $1').trim();
                    content += `<div class="section">
                        <h2>${categoryName.toUpperCase()}</h2>
                        ${categorySubjects.map(subject => `
                            <div class="subject-card">
                                <div class="subject-title">${subject.name}</div>
                                <div class="subject-details">
                                    Code: ${subject.code} | 
                                    Credits: ${subject.credits || 'N/A'} | 
                                    Hours: ${subject.hoursPerWeek || 'N/A'}
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
                }
            });
            
            return content;
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.addSubject = addSubject;
        window.editSubject = editSubject;
        window.updateSubject = updateSubject;
        window.deleteSubject = deleteSubject;
        window.searchSubjects = searchSubjects;
        window.filterSubjects = filterSubjects;
        window.clearFilters = clearFilters;
        window.exportSubjects = exportSubjects;
        window.printSubjects = printSubjects;
        window.logout = logout;
    </script>
</body>
</html>
