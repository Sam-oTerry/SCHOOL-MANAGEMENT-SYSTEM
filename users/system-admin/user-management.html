<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>User Management</h4>
                        <span class="role-badge">System Management</span>
                    </div>
                    <div>
                        <span id="current-user">John Doe</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- User Management Controls -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>User Management Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">User Role</label>
                                <select class="form-select" id="role-filter" onchange="filterUsers()">
                                    <option value="">All Roles</option>
                                    <option value="head-teacher">Head Teacher</option>
                                    <option value="system-admin">System Administrator</option>
                                    <option value="dos">Director of Studies</option>
                                    <option value="bursar">Bursar</option>
                                    <option value="class-teacher">Class Teacher</option>
                                    <option value="subject-teacher">Subject Teacher</option>
                                    <option value="hod">Head of Department</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status-filter" onchange="filterUsers()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Search</label>
                                <input type="text" class="form-control" id="search-users" placeholder="Search users..." onkeyup="searchUsers()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Actions</label>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createUserModal">
                                        <i class="fas fa-plus"></i> Create User
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="exportUsers()">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>User Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-primary text-white text-center stat-card">
                                    <div class="card-body">
                                        <h3 class="number">0</h3>
                                        <p class="mb-0">Total Users</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white text-center stat-card">
                                    <div class="card-body">
                                        <h3 class="number">0</h3>
                                        <p class="mb-0">Active Users</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-white text-center stat-card">
                                    <div class="card-body">
                                        <h3 class="number">0</h3>
                                        <p class="mb-0">Staff Members</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white text-center stat-card">
                                    <div class="card-body">
                                        <h3 class="number">0</h3>
                                        <p class="mb-0">Administrators</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users List -->
                <div class="card">
                    <div class="card-header">
                        <h5>Users List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Staff ID</th>
                                        <th>Email</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Subjects</th>
                                        <th>Departments</th>
                                        <th>Class</th>
                                        <th>Last Login</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-user-form">
                        <!-- Personal Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">Personal Information</h6>
                            </div>
                            <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="first-name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="last-name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last-name" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" class="form-control" id="email" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="phone" class="form-label">Phone</label>
                                            <input type="tel" class="form-control" id="phone" placeholder="+256 700 123 456">
                                </div>
                            </div>
                        </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <textarea class="form-control" id="address" rows="2" placeholder="Enter address"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">Account Information</h6>
                            </div>
                            <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="confirm-password" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirm-password" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                            <label for="user-role" class="form-label">Role</label>
                                    <select class="form-select" id="user-role" required>
                                        <option value="">Select Role</option>
                                                <option value="system_admin">System Administrator</option>
                                                <option value="head_teacher">Head Teacher</option>
                                        <option value="bursar">Bursar</option>
                                                <option value="class_teacher">Class Teacher</option>
                                                <option value="subject_teacher">Subject Teacher</option>
                                        <option value="hod">Head of Department</option>
                                                <option value="dos">Director of Studies</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="department" class="form-label">Primary Department</label>
                                    <select class="form-select" id="department" onchange="handleDepartmentChange()">
                                        <option value="">Select Department</option>
                                        <!-- Departments will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subjects Selection -->
                        <div class="row" id="subjectsRow">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subject1" class="form-label">Primary Subject</label>
                                    <select class="form-select" id="subject1" onchange="handleSubjectChange()">
                                        <option value="">Select Primary Subject</option>
                                        <!-- Subjects will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="subject2" class="form-label">Secondary Subject (Optional)</label>
                                    <select class="form-select" id="subject2">
                                        <option value="">Select Secondary Subject</option>
                                        <!-- Subjects will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Class Selection for Class Teachers -->
                        <div class="row" id="classRow" style="display: none;">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assignedClass" class="form-label">Assigned Class</label>
                                    <select class="form-select" id="assignedClass">
                                        <option value="">Select Class</option>
                                        <!-- Classes will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="classStream" class="form-label">Class Stream (Optional)</label>
                                    <select class="form-select" id="classStream">
                                        <option value="">Select Stream</option>
                                        <option value="A">Stream A</option>
                                        <option value="B">Stream B</option>
                                        <option value="C">Stream C</option>
                                        <option value="D">Stream D</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Departments -->
                        <div class="row" id="additionalDepartmentsRow" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Additional Departments</label>
                                    <div id="additionalDepartmentsList">
                                        <!-- Additional departments will be shown here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
                </div>
            </div>
        </div>
    </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="send-email">
                                <label class="form-check-label" for="send-email">
                                    Send welcome email with login credentials
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">Create User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade" id="userDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>User ID:</strong> <span id="detail-user-id"></span></p>
                            <p><strong>Username:</strong> <span id="detail-username"></span></p>
                            <p><strong>Full Name:</strong> <span id="detail-full-name"></span></p>
                            <p><strong>Role:</strong> <span id="detail-role"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email:</strong> <span id="detail-email"></span></p>
                            <p><strong>Phone:</strong> <span id="detail-phone"></span></p>
                            <p><strong>Last Login:</strong> <span id="detail-last-login"></span></p>
                            <p><strong>Status:</strong> <span id="detail-status"></span></p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p><strong>Department:</strong> <span id="detail-department"></span></p>
                        <p><strong>Created:</strong> <span id="detail-created"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editUser()">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button type="button" class="btn btn-warning" onclick="resetPassword()">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteUser()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/system-admin.js"></script>
    <script>
        // User Management Functionality (Legacy - will be replaced)
        
        // Sample users data
        const sampleUsers = [
            {
                id: 'USR1001',
                username: 'john.smith',
                firstName: 'John',
                lastName: 'Smith',
                email: 'john.smith@school.edu',
                phone: '+256 700 123 456',
                role: 'Head Teacher',
                department: 'Administration',
                status: 'Active',
                lastLogin: '2023-10-15 14:30:00',
                created: '2023-01-15 09:00:00'
            },
            {
                id: 'USR1002',
                username: 'mary.johnson',
                firstName: 'Mary',
                lastName: 'Johnson',
                email: 'mary.johnson@school.edu',
                phone: '+256 700 123 457',
                role: 'Director of Studies',
                department: 'Administration',
                status: 'Active',
                lastLogin: '2023-10-15 13:45:00',
                created: '2023-02-01 10:30:00'
            },
            {
                id: 'USR1003',
                username: 'peter.brown',
                firstName: 'Peter',
                lastName: 'Brown',
                email: 'peter.brown@school.edu',
                phone: '+256 700 123 458',
                role: 'Bursar',
                department: 'Administration',
                status: 'Active',
                lastLogin: '2023-10-15 12:20:00',
                created: '2023-03-01 11:15:00'
            },
            {
                id: 'USR1004',
                username: 'sarah.wilson',
                firstName: 'Sarah',
                lastName: 'Wilson',
                email: 'sarah.wilson@school.edu',
                phone: '+256 700 123 459',
                role: 'Class Teacher',
                department: 'Teaching',
                status: 'Active',
                lastLogin: '2023-10-15 11:30:00',
                created: '2023-04-01 08:45:00'
            },
            {
                id: 'USR1005',
                username: 'david.davis',
                firstName: 'David',
                lastName: 'Davis',
                email: 'david.davis@school.edu',
                phone: '+256 700 123 460',
                role: 'Subject Teacher',
                department: 'Teaching',
                status: 'Suspended',
                lastLogin: '2023-10-10 16:20:00',
                created: '2023-05-01 14:00:00'
            }
        ];
        
        function initializeUserManagement() {
            users = [...sampleUsers];
            displayUsers();
        }
        
        function displayUsers() {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td><span class="badge ${getRoleColor(user.role)}">${user.role}</span></td>
                    <td>${user.email}</td>
                    <td>${formatDate(user.lastLogin)}</td>
                    <td><span class="badge ${getStatusColor(user.status)}">${user.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewUser('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getRoleColor(role) {
            switch(role.toLowerCase()) {
                case 'head teacher': return 'bg-primary';
                case 'system administrator': return 'bg-danger';
                case 'director of studies': return 'bg-info';
                case 'bursar': return 'bg-warning';
                case 'class teacher': return 'bg-success';
                case 'subject teacher': return 'bg-secondary';
                case 'head of department': return 'bg-dark';
                default: return 'bg-light text-dark';
            }
        }
        
        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'active': return 'bg-success';
                case 'inactive': return 'bg-secondary';
                case 'suspended': return 'bg-danger';
                default: return 'bg-warning';
            }
        }
        
        function createUser() {
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const role = document.getElementById('user-role').value;
            const phone = document.getElementById('phone').value;
            const department = document.getElementById('department').value;
            const sendEmail = document.getElementById('send-email').checked;
            
            if (!firstName || !lastName || !username || !email || !password || !confirmPassword || !role) {
                alert('Please fill in all required fields.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Passwords do not match.');
                return;
            }
            
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            const newUser = {
                id: 'USR' + String(currentUserId++).padStart(4, '0'),
                username,
                firstName,
                lastName,
                email,
                phone,
                role: role.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                department: department.charAt(0).toUpperCase() + department.slice(1),
                status: 'Active',
                lastLogin: 'Never',
                created: new Date().toISOString().replace('T', ' ').substring(0, 19)
            };
            
            users.push(newUser);
            displayUsers();
            
            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
            modal.hide();
            document.getElementById('create-user-form').reset();
            
            if (sendEmail) {
                showNotification('User created and welcome email sent!', 'success');
            } else {
                showNotification('User created successfully!', 'success');
            }
        }
        
        function viewUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            // Populate modal
            document.getElementById('detail-user-id').textContent = user.id;
            document.getElementById('detail-username').textContent = user.username;
            document.getElementById('detail-full-name').textContent = `${user.firstName} ${user.lastName}`;
            document.getElementById('detail-role').textContent = user.role;
            document.getElementById('detail-email').textContent = user.email;
            document.getElementById('detail-phone').textContent = user.phone || 'Not provided';
            document.getElementById('detail-last-login').textContent = user.lastLogin;
            document.getElementById('detail-status').textContent = user.status;
            document.getElementById('detail-department').textContent = user.department;
            document.getElementById('detail-created').textContent = formatDate(user.created);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('userDetailModal'));
            modal.show();
        }
        
        function editUser(userId) {
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    alert(`Edit User:\n\nName: ${user.firstName} ${user.lastName}\nRole: ${user.role}\n\nThis feature will open the edit form for the user.`);
                }
            } else {
                alert('Edit User feature:\n\nThis will open the edit form for the user.');
            }
        }
        
        function resetPassword(userId) {
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    if (confirm(`Reset password for ${user.firstName} ${user.lastName}?`)) {
                        showNotification('Password reset email sent to user!', 'success');
                    }
                }
            } else {
                if (confirm('Reset password for this user?')) {
                    showNotification('Password reset email sent to user!', 'success');
                }
            }
        }
        
        function deleteUser(userId) {
            if (userId) {
                if (confirm('Are you sure you want to delete this user?')) {
                    users = users.filter(u => u.id !== userId);
                    displayUsers();
                    showNotification('User deleted successfully!', 'success');
                }
            } else {
                if (confirm('Are you sure you want to delete this user?')) {
                    showNotification('User deleted successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('userDetailModal'));
                    modal.hide();
                }
            }
        }
        
        function filterUsers() {
            const roleFilter = document.getElementById('role-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            
            let filteredUsers = users;
            
            if (roleFilter) {
                filteredUsers = filteredUsers.filter(u => 
                    u.role.toLowerCase().replace(' ', '-') === roleFilter.toLowerCase()
                );
            }
            
            if (statusFilter) {
                filteredUsers = filteredUsers.filter(u => u.status.toLowerCase() === statusFilter.toLowerCase());
            }
            
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u => 
                    u.firstName.toLowerCase().includes(searchTerm) ||
                    u.lastName.toLowerCase().includes(searchTerm) ||
                    u.username.toLowerCase().includes(searchTerm) ||
                    u.email.toLowerCase().includes(searchTerm)
                );
            }
            
            displayFilteredUsers(filteredUsers);
        }
        
        function displayFilteredUsers(filteredUsers) {
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.firstName} ${user.lastName}</td>
                    <td><span class="badge ${getRoleColor(user.role)}">${user.role}</span></td>
                    <td>${user.email}</td>
                    <td>${formatDate(user.lastLogin)}</td>
                    <td><span class="badge ${getStatusColor(user.status)}">${user.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewUser('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function exportUsers() {
            alert('Export Users feature:\n\nThis will download the users list as an Excel file for backup or external use.');
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../index.html';
            }
        }
        
    </script>

    <script>
        // System Admin User Management Functionality
        let users = [];
        let currentUserId = 1001;
        
        // Global variables
        let currentUser = null;
        let allUsers = [];
        let filteredUsers = [];
        let departments = [];
        let subjects = [];
        let classes = [];
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserManagement();
        });

        async function initializeUserManagement() {
            try {
                // Wait for authentication and get the user
                currentUser = await waitForAuth();
                
                // Load user data and check role
                const userResult = await loadSystemAdminUserData(db, currentUser);
                if (!userResult.success) {
                    showError(userResult.error);
                    return;
                }
                
                // Update UI with user data
                updateUserDisplay(userResult);
                
                // Load all users
                await loadAllUsers();
                
                // Load dynamic data
                await loadDepartments();
                await loadSubjects();
                await loadClasses();
                
                setupRealTimeListeners();
                
            } catch (error) {
                console.error('Error initializing user management:', error);
                showError('Failed to initialize user management. Please refresh and try again.');
            }
        }

        // Wait for authentication
        function waitForAuth() {
            return new Promise((resolve, reject) => {
                if (!window.auth) {
                    reject(new Error('Firebase Auth not initialized.'));
                    return;
                }
                const unsubscribe = window.auth.onAuthStateChanged((user) => {
                    unsubscribe();
                    if (user) {
                        window.currentUser = user; // Set global currentUser
                        resolve(user);
                    } else {
                        window.location.href = '../../index.html'; // Redirect to login if not authenticated
                        reject(new Error('User not authenticated'));
                    }
                });
            });
        }

        // Load system admin user data
        async function loadSystemAdminUserData(db, currentUser) {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (!userDoc.exists) {
                    return { success: false, error: 'User profile not found. Please contact administrator.' };
                }
                const userData = userDoc.data();

                if (userData.role !== 'system_admin') {
                    return { success: false, error: 'Access denied. This page is only for System Administrator users.' };
                }

                return {
                    success: true,
                    userData,
                    userName: getUserName(userData),
                    staffId: getUserStaffId(userData)
                };
            } catch (error) {
                console.error('Error in loadSystemAdminUserData:', error);
                return { success: false, error: 'Failed to load user data. Please refresh and try again.' };
            }
        }

        // Utility function to get user name
        function getUserName(userData) {
            if (!userData) return 'Unknown User';
            return userData.personalInfo?.fullName || 
                   `${userData.personalInfo?.firstName || ''} ${userData.personalInfo?.lastName || ''}`.trim() ||
                   userData.fullName ||
                   `${userData.firstName || ''} ${userData.lastName || ''}`.trim() ||
                   'Unknown User';
        }

        // Utility function to get user staff ID
        function getUserStaffId(userData) {
            if (!userData) return 'N/A';
            return userData.staffId || userData.employmentInfo?.staffId || 'N/A';
        }

        function updateUserDisplay(userResult) {
            // Use the standardized updateUserDisplay function from system-admin-utils.js
            window.updateUserDisplay(userResult);
            
            console.log('System Admin user loaded:', {
                name: userResult.userName,
                staffId: userResult.staffId
            });
        }
        
        // Load departments from Firestore
        async function loadDepartments() {
            try {
                const departmentsSnapshot = await db.collection('departments').orderBy('name').get();
                departments = [];
                
                departmentsSnapshot.forEach(doc => {
                    const deptData = doc.data();
                    departments.push({
                        id: doc.id,
                        ...deptData
                    });
                });
                
                populateDepartmentDropdowns();
                console.log(`‚úÖ Loaded ${departments.length} departments from Firestore`);
                
            } catch (error) {
                console.error('Error loading departments:', error);
                showError('Failed to load departments. Please try again.');
            }
        }
        
        // Load subjects from Firestore
        async function loadSubjects() {
            try {
                const subjectsSnapshot = await db.collection('subjects').orderBy('name').get();
                subjects = [];
                
                subjectsSnapshot.forEach(doc => {
                    const subjectData = doc.data();
                    subjects.push({
                        id: doc.id,
                        ...subjectData
                    });
                });
                
                populateSubjectDropdowns();
                console.log(`‚úÖ Loaded ${subjects.length} subjects from Firestore`);
                
            } catch (error) {
                console.error('Error loading subjects:', error);
                showError('Failed to load subjects. Please try again.');
            }
        }
        
        // Load classes from Firestore
        async function loadClasses() {
            try {
                const classesSnapshot = await db.collection('classes').orderBy('name').get();
                classes = [];
                
                classesSnapshot.forEach(doc => {
                    const classData = doc.data();
                    classes.push({
                        id: doc.id,
                        ...classData
                    });
                });
                
                populateClassDropdown();
                console.log(`‚úÖ Loaded ${classes.length} classes from Firestore`);
                
            } catch (error) {
                console.error('Error loading classes:', error);
                showError('Failed to load classes. Please try again.');
            }
        }
        
        // Populate department dropdowns
        function populateDepartmentDropdowns() {
            const departmentSelect = document.getElementById('department');
            if (!departmentSelect) return;
            
            departmentSelect.innerHTML = '<option value="">Select Department</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                departmentSelect.appendChild(option);
            });
        }
        
        // Populate subject dropdowns
        function populateSubjectDropdowns() {
            const subject1Select = document.getElementById('subject1');
            const subject2Select = document.getElementById('subject2');
            
            if (!subject1Select || !subject2Select) return;
            
            // Clear existing options
            subject1Select.innerHTML = '<option value="">Select Primary Subject</option>';
            subject2Select.innerHTML = '<option value="">Select Secondary Subject</option>';
            
            subjects.forEach(subject => {
                const option1 = document.createElement('option');
                option1.value = subject.id;
                option1.textContent = `${subject.name} (${subject.code})`;
                subject1Select.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = subject.id;
                option2.textContent = `${subject.name} (${subject.code})`;
                subject2Select.appendChild(option2);
            });
        }
        
        // Populate class dropdown
        function populateClassDropdown() {
            const classSelect = document.getElementById('assignedClass');
            if (!classSelect) return;
            
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                classSelect.appendChild(option);
            });
        }
        
        // Handle department change
        function handleDepartmentChange() {
            const departmentId = document.getElementById('department').value;
            const role = document.getElementById('user-role').value;
            
            // Show/hide subjects based on role
            const subjectsRow = document.getElementById('subjectsRow');
            const classRow = document.getElementById('classRow');
            const additionalDepartmentsRow = document.getElementById('additionalDepartmentsRow');
            
            if (role === 'bursar' || role === 'system_admin') {
                subjectsRow.style.display = 'none';
                classRow.style.display = 'none';
                additionalDepartmentsRow.style.display = 'none';
            } else {
                subjectsRow.style.display = 'block';
                if (role === 'class_teacher') {
                    classRow.style.display = 'block';
                } else {
                    classRow.style.display = 'none';
                }
                additionalDepartmentsRow.style.display = 'none';
            }
            
            // Update additional departments if subjects are selected
            updateAdditionalDepartments();
        }
        
        // Handle subject change
        function handleSubjectChange() {
            updateAdditionalDepartments();
        }
        
        // Update additional departments based on selected subjects
        function updateAdditionalDepartments() {
            const subject1Id = document.getElementById('subject1').value;
            const subject2Id = document.getElementById('subject2').value;
            const additionalDepartmentsRow = document.getElementById('additionalDepartmentsRow');
            const additionalDepartmentsList = document.getElementById('additionalDepartmentsList');
            
            if (!subject1Id && !subject2Id) {
                additionalDepartmentsRow.style.display = 'none';
                return;
            }
            
            // Get departments for selected subjects
            const subjectDepartments = new Set();
            
            if (subject1Id) {
                const subject1 = subjects.find(s => s.id === subject1Id);
                if (subject1 && subject1.departmentId) {
                    subjectDepartments.add(subject1.departmentId);
                }
            }
            
            if (subject2Id) {
                const subject2 = subjects.find(s => s.id === subject2Id);
                if (subject2 && subject2.departmentId) {
                    subjectDepartments.add(subject2.departmentId);
                }
            }
            
            // Remove primary department from additional departments
            const primaryDepartmentId = document.getElementById('department').value;
            subjectDepartments.delete(primaryDepartmentId);
            
            if (subjectDepartments.size > 0) {
                additionalDepartmentsList.innerHTML = '';
                subjectDepartments.forEach(deptId => {
                    const dept = departments.find(d => d.id === deptId);
                    if (dept) {
                        const badge = document.createElement('span');
                        badge.className = 'badge bg-info me-2 mb-2';
                        badge.textContent = dept.name;
                        additionalDepartmentsList.appendChild(badge);
                    }
                });
                additionalDepartmentsRow.style.display = 'block';
            } else {
                additionalDepartmentsRow.style.display = 'none';
            }
        }
        
        // Handle role change
        function handleRoleChange() {
            const role = document.getElementById('user-role').value;
            const subjectsRow = document.getElementById('subjectsRow');
            const classRow = document.getElementById('classRow');
            
            if (role === 'bursar' || role === 'system_admin') {
                subjectsRow.style.display = 'none';
                classRow.style.display = 'none';
            } else {
                subjectsRow.style.display = 'block';
                if (role === 'class_teacher') {
                    classRow.style.display = 'block';
                } else {
                    classRow.style.display = 'none';
                }
            }
            
            handleDepartmentChange();
        }

        // Load all users from Firebase
        async function loadAllUsers() {
            try {
                const usersSnapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = [];
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    allUsers.push({
                        id: doc.id,
                        ...userData
                    });
                });
                
                filteredUsers = [...allUsers];
                displayUsers();
                updateUserStats();
                calculateUserStatistics();
                
                console.log(`‚úÖ Loaded ${allUsers.length} users from Firestore`);
                
            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users. Please try again.');
            }
        }
        
        // Display users in the table
        function displayUsers() {
            const tbody = document.getElementById('users-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredUsers.forEach(user => {
                const row = createUserRow(user);
                tbody.appendChild(row);
            });
            
            console.log(`üìä Displayed ${filteredUsers.length} users`);
        }
        
        // Create user row
        function createUserRow(user) {
            const row = document.createElement('tr');
            const fullName = getUserName(user);
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleString() : 'Never';
            const createdAt = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString() : 'Unknown';
            const status = user.status || user.accountStatus || 'active';
            const statusColor = status === 'active' ? 'success' : status === 'inactive' ? 'secondary' : 'danger';
            const staffId = getUserStaffId(user);
            const staffIdColor = user.staffId ? 'primary' : 'secondary';
            const department = user.academicInfo?.department || user.personalInfo?.department || 'Not specified';
            
            // Prepare subjects and departments display
            const subjectsDisplay = user.academicInfo?.subjects ? 
                user.academicInfo.subjects.map(s => `<span class="badge bg-info me-1">${s.name}</span>`).join('') : 
                '<span class="text-muted">No subjects</span>';
            
            const departmentsDisplay = user.academicInfo?.departmentNames ? 
                user.academicInfo.departmentNames.map(d => `<span class="badge bg-secondary me-1">${d}</span>`).join('') : 
                '<span class="text-muted">No departments</span>';
            
            const assignedClassDisplay = user.academicInfo?.assignedClass ? 
                `<span class="badge bg-success">${user.academicInfo.assignedClass}</span>` : 
                '<span class="text-muted">Not assigned</span>';

            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-avatar me-2">${initials}</div>
                        <div>
                            <strong>${user.email}</strong><br>
                            <small class="text-muted">ID: ${user.id.substring(0, 8)}...</small>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="badge bg-${staffIdColor}">${staffId}</span>
                </td>
                <td>${user.email}</td>
                <td>${fullName}</td>
                <td><span class="badge bg-primary">${user.role.replace('_', ' ').toUpperCase()}</span></td>
                <td>${subjectsDisplay}</td>
                <td>${departmentsDisplay}</td>
                <td>${assignedClassDisplay}</td>
                <td>${lastLogin}</td>
                <td><span class="badge bg-${statusColor}">${status.toUpperCase()}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editUser('${user.id}')" title="Edit User">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewUserDetails('${user.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="resetUserPassword('${user.id}')" title="Reset Password">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteUser('${user.id}')" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // Update user statistics
        function updateUserStats() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(user => (user.status || 'active') === 'active').length;
            const adminUsers = allUsers.filter(user => user.role === 'system_admin').length;
            const staffUsers = allUsers.filter(user => [
                'head_teacher', 'class_teacher', 'subject_teacher', 
                'bursar', 'dos', 'hod', 'teacher'
            ].includes(user.role)).length;
            
            // Update stats cards
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalUsers;
                statsCards[1].textContent = activeUsers;
                statsCards[2].textContent = staffUsers;
                statsCards[3].textContent = adminUsers;
            }
            
            // Update card colors based on values
            updateStatsCardColors(totalUsers, activeUsers, staffUsers, adminUsers);
            
            // Log statistics for debugging
            console.log('üìä User Statistics Updated:', {
                total: totalUsers,
                active: activeUsers,
                staff: staffUsers,
                admins: adminUsers
            });
        }
        
        // Update stats card colors based on values
        function updateStatsCardColors(total, active, staff, admins) {
            const cards = document.querySelectorAll('.stat-card');
            
            // Total Users card
            if (cards[0]) {
                cards[0].className = `card ${total > 0 ? 'bg-primary' : 'bg-secondary'} text-white text-center stat-card`;
            }
            
            // Active Users card
            if (cards[1]) {
                const activePercentage = total > 0 ? (active / total) * 100 : 0;
                let color = 'bg-secondary';
                if (activePercentage >= 90) color = 'bg-success';
                else if (activePercentage >= 70) color = 'bg-warning';
                else if (activePercentage >= 50) color = 'bg-danger';
                cards[1].className = `card ${color} text-white text-center stat-card`;
            }
            
            // Staff Members card
            if (cards[2]) {
                cards[2].className = `card ${staff > 0 ? 'bg-warning' : 'bg-secondary'} text-white text-center stat-card`;
            }
            
            // Administrators card
            if (cards[3]) {
                cards[3].className = `card ${admins > 0 ? 'bg-info' : 'bg-secondary'} text-white text-center stat-card`;
            }
        }
        
        // Generate unique staff ID (simple sequential numbering)
        async function generateStaffId() {
            try {
                console.log('üîç Querying for latest staff ID...');
                // Get the latest staff ID from all users
                const querySnapshot = await db.collection('users')
                    .where('staffId', '>=', 'STF0001')
                    .where('staffId', '<', 'STF9999')
                    .orderBy('staffId', 'desc')
                    .limit(1)
                    .get();
                
                console.log('üìä Query results:', querySnapshot.size, 'documents found');
                
                let nextNumber = 1;
                if (!querySnapshot.empty) {
                    const latestStaffId = querySnapshot.docs[0].data().staffId;
                    console.log('üî¢ Latest staff ID found:', latestStaffId);
                    const currentNumber = parseInt(latestStaffId.substring(3)); // Remove 'STF' prefix
                    nextNumber = currentNumber + 1;
                    console.log('üî¢ Next number will be:', nextNumber);
                } else {
                    console.log('üî¢ No existing staff IDs found, starting with 1');
                }
                
                const newStaffId = 'STF' + String(nextNumber).padStart(4, '0');
                console.log('üÜî Generated staff ID:', newStaffId);
                return newStaffId;
            } catch (error) {
                console.error('‚ùå Error generating staff ID:', error);
                // Fallback to timestamp-based ID
                const fallbackId = 'STF' + String(Date.now()).slice(-4);
                console.log('üîÑ Using fallback staff ID:', fallbackId);
                return fallbackId;
            }
        }
        
        // Create new user
        async function createUser() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            const fullName = `${firstName} ${lastName}`.trim();
            const role = document.getElementById('user-role').value;
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;
            const departmentId = document.getElementById('department').value;
            const subject1Id = document.getElementById('subject1').value;
            const subject2Id = document.getElementById('subject2').value;
            const assignedClassId = document.getElementById('assignedClass').value;
            const classStream = document.getElementById('classStream').value;
            
            if (!email || !password || !confirmPassword || !fullName || !role) {
                showError('Please fill in all required fields.');
                return;
            }
            
            // Validate subjects for teaching roles
            if (role !== 'bursar' && role !== 'system_admin') {
                if (!subject1Id) {
                    showError('Please select at least one subject for teaching roles.');
                    return;
                }
            }
            
            // Validate class assignment for class teachers
            if (role === 'class_teacher' && !assignedClassId) {
                showError('Please select a class for class teachers.');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match.');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters long.');
                return;
            }
            
            // Check if current user is authenticated
            if (!currentUser) {
                showError('You must be logged in to create users. Please refresh the page and try again.');
                return;
            }
            
            // Check if email already exists in current users list
            const existingUser = allUsers.find(user => user.email.toLowerCase() === email.toLowerCase());
            if (existingUser) {
                showError(`Email address ${email} is already in use by ${existingUser.personalInfo?.fullName || 'another user'}.`);
                return;
            }
            
            // Show loading state
            const createButton = document.querySelector('#createUserModal .btn-primary');
            const originalText = createButton.innerHTML;
            createButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating User...';
            createButton.disabled = true;
            
            try {
                console.log('üîÑ Starting user creation process...');
                console.log('üìß Email:', email);
                console.log('üë§ Full Name:', fullName);
                console.log('üé≠ Role:', role);
                
                // Generate staff ID
                console.log('üÜî Generating staff ID...');
                const staffId = await generateStaffId();
                console.log('‚úÖ Generated Staff ID:', staffId);
                
                // Create user in Firebase Auth with retry logic
                console.log('üî• Creating Firebase Auth user...');
                let userCredential;
                let retryCount = 0;
                const maxRetries = 3;
                
                // Set a flag to prevent auth state change from logging out user
                window.isCreatingUser = true;
                
                while (retryCount < maxRetries) {
                    try {
                        userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        console.log('‚úÖ Firebase Auth user created successfully');
                        break; // Success, exit retry loop
                    } catch (retryError) {
                        retryCount++;
                        console.error(`‚ùå Auth attempt ${retryCount} failed:`, retryError.code, retryError.message);
                        if (retryError.code === 'auth/network-request-failed' && retryCount < maxRetries) {
                            console.log(`üîÑ Network error, retrying... (${retryCount}/${maxRetries})`);
                            await new Promise(resolve => setTimeout(resolve, 2000 * retryCount)); // Exponential backoff
                            continue;
                        }
                        throw retryError; // Re-throw if not network error or max retries reached
                    }
                }
                
                const user = userCredential.user;
                console.log('üë§ New user created:', user.uid);
                
                // Update user profile (optional - continue even if this fails)
                console.log('üë§ Updating user profile...');
                try {
                    // Add a timeout for profile update
                    const profileUpdatePromise = user.updateProfile({
                        displayName: fullName
                    });
                    
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Profile update timeout')), 5000);
                    });
                    
                    await Promise.race([profileUpdatePromise, timeoutPromise]);
                    console.log('‚úÖ User profile updated');
                } catch (profileError) {
                    console.warn('‚ö†Ô∏è Profile update failed, continuing with user creation:', profileError.message);
                    // Continue with user creation even if profile update fails
                }
                
                // Prepare subjects and departments data
                const userSubjects = [];
                const userDepartments = new Set();
                
                if (subject1Id) {
                    const subject1 = subjects.find(s => s.id === subject1Id);
                    if (subject1) {
                        userSubjects.push({
                            id: subject1Id,
                            name: subject1.name,
                            code: subject1.code,
                            isPrimary: true
                        });
                        if (subject1.departmentId) {
                            userDepartments.add(subject1.departmentId);
                        }
                    }
                }
                
                if (subject2Id) {
                    const subject2 = subjects.find(s => s.id === subject2Id);
                    if (subject2) {
                        userSubjects.push({
                            id: subject2Id,
                            name: subject2.name,
                            code: subject2.code,
                            isPrimary: false
                        });
                        if (subject2.departmentId) {
                            userDepartments.add(subject2.departmentId);
                        }
                    }
                }
                
                // Add primary department if specified
                if (departmentId) {
                    userDepartments.add(departmentId);
                }
                
                // Get department names
                const departmentNames = Array.from(userDepartments).map(deptId => {
                    const dept = departments.find(d => d.id === deptId);
                    return dept ? dept.name : '';
                }).filter(name => name);
                
                // Create user document in Firestore with retry logic
                console.log('üìÑ Creating Firestore document...');
                const userDocData = {
                    uid: user.uid,
                    email: email,
                    role: role,
                    staffId: staffId,
                    personalInfo: {
                        fullName: fullName,
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: phone || '',
                        address: address || '',
                        department: departmentId || ''
                    },
                    academicInfo: {
                        department: departmentId || '',
                        departments: Array.from(userDepartments),
                        departmentNames: departmentNames,
                        subjects: userSubjects,
                        assignedClass: role === 'class_teacher' ? assignedClassId : null,
                        classStream: role === 'class_teacher' ? classStream : null
                    },
                    employmentInfo: {
                        staffId: staffId,
                        position: role,
                        department: departmentId || '',
                        startDate: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    status: 'active',
                    accountStatus: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                console.log('üìÑ Document data:', userDocData);
                
                // Try to create Firestore document with retry logic
                let firestoreRetryCount = 0;
                const maxFirestoreRetries = 3;
                let firestoreSuccess = false;
                
                while (firestoreRetryCount < maxFirestoreRetries && !firestoreSuccess) {
                    try {
                        await db.collection('users').doc(user.uid).set(userDocData);
                        console.log('‚úÖ Firestore document created successfully');
                        firestoreSuccess = true;
                    } catch (firestoreError) {
                        firestoreRetryCount++;
                        console.error(`‚ùå Firestore attempt ${firestoreRetryCount} failed:`, firestoreError.message);
                        if (firestoreRetryCount < maxFirestoreRetries) {
                            console.log(`üîÑ Retrying Firestore operation... (${firestoreRetryCount}/${maxFirestoreRetries})`);
                            await new Promise(resolve => setTimeout(resolve, 1000 * firestoreRetryCount));
                        } else {
                            throw firestoreError;
                        }
                    }
                }
                
                showSuccess(`User created successfully! Staff ID: ${staffId}`);
                document.getElementById('create-user-form').reset();
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                loadAllUsers();
                
                // Clear the flag after successful creation
                window.isCreatingUser = false;
                
            } catch (error) {
                console.error('Error creating user:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showError(`Email address ${email} is already in use. Please use a different email address.`);
                } else if (error.code === 'auth/weak-password') {
                    showError('Password is too weak.');
                } else if (error.code === 'auth/network-request-failed') {
                    showError('Network error. Please check your internet connection and try again.');
                } else if (error.code === 'auth/too-many-requests') {
                    showError('Too many requests. Please wait a moment and try again.');
                } else if (error.code === 'auth/invalid-email') {
                    showError('Invalid email address format.');
                } else if (error.code === 'auth/operation-not-allowed') {
                    showError('User creation is not enabled. Please contact administrator.');
                } else {
                    showError('Error creating user: ' + error.message);
                }
            } finally {
                // Restore button state
                createButton.innerHTML = originalText;
                createButton.disabled = false;
                
                // Clear the flag in case of error
                window.isCreatingUser = false;
            }
        }
        
        // Edit user - Enhanced with role change functionality
        async function editUser(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            // Show enhanced edit modal with role change options
            const newRole = prompt(`Change role for ${getUserName(user)}:\n\nCurrent role: ${user.role}\n\nEnter new role:\n- system_admin\n- head_teacher\n- bursar\n- class_teacher\n- subject_teacher\n- hod\n- dos`, user.role);
            
            if (newRole && newRole !== user.role) {
                if (confirm(`Are you sure you want to change ${getUserName(user)}'s role from ${user.role} to ${newRole}?`)) {
                    try {
                        const updateData = {
                            role: newRole,
                            employmentInfo: {
                                ...user.employmentInfo,
                                position: newRole
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedBy: currentUser.uid
                        };
                        
                        await db.collection('users').doc(userId).update(updateData);
                        
                        showSuccess(`User role changed from ${user.role} to ${newRole} successfully!`);
                        loadAllUsers();
                    } catch (error) {
                        console.error('Error updating user role:', error);
                        showError('Error updating user role: ' + error.message);
                    }
                }
            }
        }
        
        // View user details
        function viewUserDetails(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;
            
            const fullName = getUserName(user);
            const createdAt = user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleString() : 'Unknown';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin.seconds * 1000).toLocaleString() : 'Never';
            const updatedAt = user.updatedAt ? new Date(user.updatedAt.seconds * 1000).toLocaleString() : 'Unknown';
            const department = user.academicInfo?.department || user.personalInfo?.department || 'Not specified';
            const subjects = user.academicInfo?.subjects || [];
            const employmentStart = user.employmentInfo?.startDate ? new Date(user.employmentInfo.startDate.seconds * 1000).toLocaleDateString() : 'Not specified';
            
            const details = `
                <div style="text-align: left; max-width: 500px;">
                    <h4>User Details</h4>
                    <hr>
                    
                    <h5>Personal Information</h5>
                    <strong>Name:</strong> ${fullName}<br>
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>Phone:</strong> ${user.personalInfo?.phone || 'Not provided'}<br>
                    <strong>Address:</strong> ${user.personalInfo?.address || 'Not provided'}<br>
                    <strong>Department:</strong> ${department}<br><br>
                    
                    <h5>Academic Information</h5>
                    <strong>Academic Department:</strong> ${user.academicInfo?.department || 'Not specified'}<br>
                    <strong>Subjects:</strong> ${subjects.length > 0 ? subjects.join(', ') : 'None assigned'}<br>
                    <strong>Departments:</strong> ${user.academicInfo?.departments ? user.academicInfo.departments.join(', ') : 'Not specified'}<br><br>
                    
                    <h5>Employment Information</h5>
                    <strong>Staff ID:</strong> <span class="badge bg-primary">${getUserStaffId(user)}</span><br>
                    <strong>Position:</strong> ${user.employmentInfo?.position || user.role}<br>
                    <strong>Employment Department:</strong> ${user.employmentInfo?.department || department}<br>
                    <strong>Start Date:</strong> ${employmentStart}<br><br>
                    
                    <h5>Account Information</h5>
                    <strong>User ID:</strong> ${user.id}<br>
                    <strong>Role:</strong> ${user.role.replace('_', ' ').toUpperCase()}<br>
                    <strong>Status:</strong> ${user.status || user.accountStatus || 'active'}<br>
                    <strong>Created:</strong> ${createdAt}<br>
                    <strong>Last Updated:</strong> ${updatedAt}<br>
                    <strong>Last Login:</strong> ${lastLogin}<br><br>
                    
                    <h5>System Information</h5>
                    <strong>Created By:</strong> ${user.createdBy || 'System'}<br>
                    <strong>Updated By:</strong> ${user.updatedBy || 'N/A'}
                </div>
            `;
            
            // Create a modal for better display
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'userDetailsModal';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">User Details - ${fullName}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="editUser('${userId}')">
                                <i class="fas fa-edit"></i> Edit User
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Remove modal when hidden
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Reset user password
        async function resetUserPassword(userId) {
            if (confirm('Are you sure you want to reset this user\'s password? They will need to use the new password to login.')) {
                const newPassword = prompt('Enter new password (minimum 6 characters):');
                if (newPassword && newPassword.length >= 6) {
                    try {
                        // Note: In a real application, you would use Firebase Admin SDK
                        // to reset passwords server-side for security
                        showSuccess('Password reset initiated. User will receive an email with instructions.');
                    } catch (error) {
                        console.error('Error resetting password:', error);
                        showError('Error resetting password: ' + error.message);
                    }
                } else {
                    showError('Password must be at least 6 characters long.');
                }
            }
        }
        
        // Delete user
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                try {
                    await db.collection('users').doc(userId).delete();
                    showSuccess('User deleted successfully!');
                    loadAllUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showError('Error deleting user: ' + error.message);
                }
            }
        }
        
        // Search users
        function searchUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            filteredUsers = allUsers.filter(user => 
                user.email.toLowerCase().includes(searchTerm) ||
                getUserName(user).toLowerCase().includes(searchTerm) ||
                (user.personalInfo?.firstName || '').toLowerCase().includes(searchTerm) ||
                (user.personalInfo?.lastName || '').toLowerCase().includes(searchTerm) ||
                user.role.toLowerCase().includes(searchTerm) ||
                (user.personalInfo?.phone || '').includes(searchTerm) ||
                (user.academicInfo?.department || user.personalInfo?.department || '').toLowerCase().includes(searchTerm) ||
                getUserStaffId(user).toLowerCase().includes(searchTerm)
            );
            displayUsers();
        }
        
        // Filter users by role and status
        function filterUsers() {
            const roleFilter = document.getElementById('role-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            
            let filtered = allUsers;
            
            // Filter by role
            if (roleFilter) {
                filtered = filtered.filter(user => user.role === roleFilter);
            }
            
            // Filter by status
            if (statusFilter) {
                filtered = filtered.filter(user => (user.status || user.accountStatus || 'active') === statusFilter);
            }
            
            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(user => 
                    user.email.toLowerCase().includes(searchTerm) ||
                    getUserName(user).toLowerCase().includes(searchTerm) ||
                    (user.personalInfo?.firstName || '').toLowerCase().includes(searchTerm) ||
                    (user.personalInfo?.lastName || '').toLowerCase().includes(searchTerm) ||
                    user.role.toLowerCase().includes(searchTerm) ||
                    (user.personalInfo?.phone || '').includes(searchTerm) ||
                    (user.academicInfo?.department || user.personalInfo?.department || '').toLowerCase().includes(searchTerm) ||
                    getUserStaffId(user).toLowerCase().includes(searchTerm)
                );
            }
            
            filteredUsers = filtered;
            displayUsers();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for user changes
            db.collection('users').onSnapshot((snapshot) => {
                console.log('üë• Users collection updated');
                loadAllUsers();
            });
        }
        
        // Calculate and display comprehensive user statistics
        function calculateUserStatistics() {
            const totalUsers = allUsers.length;
            const activeUsers = allUsers.filter(user => (user.status || 'active') === 'active').length;
            const inactiveUsers = allUsers.filter(user => (user.status || 'active') === 'inactive').length;
            const suspendedUsers = allUsers.filter(user => user.status === 'suspended').length;
            
            // Role-based statistics
            const roleStats = {};
            allUsers.forEach(user => {
                roleStats[user.role] = (roleStats[user.role] || 0) + 1;
            });
            
            // Department statistics
            const departmentStats = {};
            allUsers.forEach(user => {
                const dept = user.academicInfo?.department || user.personalInfo?.department || 'Not Specified';
                departmentStats[dept] = (departmentStats[dept] || 0) + 1;
            });
            
            // Recent users (last 7 days)
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recentUsers = allUsers.filter(user => {
                if (!user.createdAt) return false;
                const userCreated = new Date(user.createdAt.seconds * 1000);
                return userCreated >= sevenDaysAgo;
            }).length;
            
            // Users with recent login (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const recentLoginUsers = allUsers.filter(user => {
                if (!user.lastLogin) return false;
                const lastLogin = new Date(user.lastLogin.seconds * 1000);
                return lastLogin >= thirtyDaysAgo;
            }).length;
            
            console.log('üìà Comprehensive User Statistics:', {
                total: totalUsers,
                active: activeUsers,
                inactive: inactiveUsers,
                suspended: suspendedUsers,
                recent: recentUsers,
                recentLogin: recentLoginUsers,
                roles: roleStats,
                departments: departmentStats
            });
            
            return {
                total: totalUsers,
                active: activeUsers,
                inactive: inactiveUsers,
                suspended: suspendedUsers,
                recent: recentUsers,
                recentLogin: recentLoginUsers,
                roles: roleStats,
                departments: departmentStats
            };
        }
        
        
        // Logout function
        function logout() {
            if (!window.auth) {
                console.error('Firebase Auth not initialized for logout.');
                window.location.href = '../../index.html';
                return;
            }
            if (confirm('Are you sure you want to logout?')) {
                window.auth.signOut().then(() => {
                    console.log('User signed out');
                    window.location.href = '../../index.html';
                }).catch((error) => {
                    console.error('Logout error:', error);
                    window.location.href = '../../index.html';
                });
            }
        }
        
        // Display detailed statistics in console and optionally in UI
        function displayDetailedStats() {
            const stats = calculateUserStatistics();
            
            // Create a detailed stats display
            const statsInfo = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-chart-bar"></i> Detailed User Statistics</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>User Status:</strong><br>
                            ‚Ä¢ Total Users: ${stats.total}<br>
                            ‚Ä¢ Active: ${stats.active}<br>
                            ‚Ä¢ Inactive: ${stats.inactive}<br>
                            ‚Ä¢ Suspended: ${stats.suspended}
                        </div>
                        <div class="col-md-6">
                            <strong>Activity:</strong><br>
                            ‚Ä¢ Recent Users (7 days): ${stats.recent}<br>
                            ‚Ä¢ Recent Login (30 days): ${stats.recentLogin}<br>
                            ‚Ä¢ Active Rate: ${stats.total > 0 ? ((stats.active / stats.total) * 100).toFixed(1) : 0}%
                        </div>
                    </div>
                </div>
            `;
            
            // You can uncomment this to display stats in the UI
            // const statsContainer = document.getElementById('stats-container');
            // if (statsContainer) {
            //     statsContainer.innerHTML = statsInfo;
            // }
            
            console.log('üìä Detailed Statistics Display:', stats);
        }
        
        // Clear form when modal is opened
        function clearCreateUserForm() {
            document.getElementById('create-user-form').reset();
            // Clear any existing error messages
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
        }
        
        // Add event listeners for modal show and role changes
        document.addEventListener('DOMContentLoaded', function() {
            const createUserModal = document.getElementById('createUserModal');
            if (createUserModal) {
                createUserModal.addEventListener('show.bs.modal', clearCreateUserForm);
            }
            
            // Add role change event listener
            const roleSelect = document.getElementById('user-role');
            if (roleSelect) {
                roleSelect.addEventListener('change', handleRoleChange);
            }
        });
        
        // Make functions globally available
        window.createUser = createUser;
        window.editUser = editUser;
        window.viewUserDetails = viewUserDetails;
        window.resetUserPassword = resetUserPassword;
        window.deleteUser = deleteUser;
        window.searchUsers = searchUsers;
        window.filterUsers = filterUsers;
        window.displayDetailedStats = displayDetailedStats;
        window.clearCreateUserForm = clearCreateUserForm;
        window.logout = logout;
        window.getUserName = getUserName;
        window.getUserStaffId = getUserStaffId;
        window.handleDepartmentChange = handleDepartmentChange;
        window.handleSubjectChange = handleSubjectChange;
        window.handleRoleChange = handleRoleChange;
    </script>
</body>
</html>
