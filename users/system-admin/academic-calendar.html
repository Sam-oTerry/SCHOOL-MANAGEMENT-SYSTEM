<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Calendar - System Administrator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè´</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/system-admin.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">System Administrator</h6>
                        <small class="text-muted">Staff ID: SYS1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-dashboard.html">
                                <i class="fas fa-chart-line"></i> System Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="user-management.html">
                                <i class="fas fa-users"></i> User Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="staff-management.html">
                                <i class="fas fa-user-tie"></i> Staff Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="academic-calendar.html">
                                <i class="fas fa-calendar-alt"></i> Academic Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-management.html">
                                <i class="fas fa-user-graduate"></i> Student Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="subject-management.html">
                                <i class="fas fa-book"></i> Subject Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="term-management.html">
                                <i class="fas fa-calendar-check"></i> Term Management
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="system-settings.html">
                                <i class="fas fa-cog"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    
                    <hr>
                    <div class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Academic Calendar</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportCalendar()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printCalendar()">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                            <i class="fas fa-plus"></i> Add Event
                        </button>
                    </div>
                </div>

                <!-- Calendar Controls -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Calendar View</h6>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('month')">Month</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('week')">Week</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('day')">Day</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Filter Events</h6>
                                <select class="form-select form-select-sm" id="eventFilter" onchange="filterEvents()">
                                    <option value="all">All Events</option>
                                    <option value="academic">Academic</option>
                                    <option value="holiday">Holiday</option>
                                    <option value="exam">Exam</option>
                                    <option value="meeting">Meeting</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar -->
                <div class="card">
                    <div class="card-body">
                        <div id="calendar"></div>
                    </div>
                </div>

                <!-- Event Statistics -->
                <div class="row mt-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-day text-primary mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Total Events</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-graduation-cap text-success mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Academic Events</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-times text-warning mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Holidays</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <i class="fas fa-clipboard-list text-info mb-2"></i>
                                <h4 class="number">0</h4>
                                <p class="text-muted">Exams</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEventForm">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventType" class="form-label">Event Type</label>
                            <select class="form-select" id="eventType" required>
                                <option value="academic">Academic</option>
                                <option value="holiday">Holiday</option>
                                <option value="exam">Exam</option>
                                <option value="meeting">Meeting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="eventStartDate" class="form-label">Start Date</label>
                            <input type="datetime-local" class="form-control" id="eventStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventEndDate" class="form-label">End Date</label>
                            <input type="datetime-local" class="form-control" id="eventEndDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="eventLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="eventLocation">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addEvent()">Add Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <input type="hidden" id="editEventId">
                        <div class="mb-3">
                            <label for="editEventTitle" class="form-label">Event Title</label>
                            <input type="text" class="form-control" id="editEventTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEventType" class="form-label">Event Type</label>
                            <select class="form-select" id="editEventType" required>
                                <option value="academic">Academic</option>
                                <option value="holiday">Holiday</option>
                                <option value="exam">Exam</option>
                                <option value="meeting">Meeting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editEventStartDate" class="form-label">Start Date</label>
                            <input type="datetime-local" class="form-control" id="editEventStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEventEndDate" class="form-label">End Date</label>
                            <input type="datetime-local" class="form-control" id="editEventEndDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editEventDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editEventLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="editEventLocation">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateEvent()">Update Event</button>
                    <button type="button" class="btn btn-danger" onclick="deleteEvent()">Delete Event</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "ass-sms.firebaseapp.com",
            projectId: "ass-sms",
            storageBucket: "ass-sms.firebasestorage.app",
            messagingSenderId: "515388722489",
            appId: "1:515388722489:web:21169f130303f48aaa2ce8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let calendar = null;
        let events = [];
        let currentView = 'month';
        
        // Check authentication and role
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const userRole = userData.role;
                        
                        if (userRole === 'system_admin') {
                            console.log('‚úÖ System Administrator authenticated:', user.email);
                            currentUser = user;
                            initializeCalendar();
                            setupRealTimeListeners();
                        } else {
                            console.log('‚ùå Access denied. Required role: system_admin');
                            alert('Access denied. You do not have system administrator privileges.');
                            auth.signOut().then(() => {
                                window.location.href = '../../index.html';
                            });
                        }
                    } else {
                        console.log('‚ùå User document not found');
                        auth.signOut().then(() => {
                            window.location.href = '../../index.html';
                        });
                    }
                });
            } else {
                console.log('‚ùå No authenticated user, redirecting to login');
                window.location.href = '../../index.html';
            }
        });
        
        // Initialize FullCalendar
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: loadEvents,
                eventClick: function(info) {
                    editEvent(info.event);
                },
                dateClick: function(info) {
                    addEventForDate(info.dateStr);
                },
                eventDrop: function(info) {
                    updateEventDate(info.event);
                },
                eventResize: function(info) {
                    updateEventDate(info.event);
                }
            });
            
            calendar.render();
            loadEventStatistics();
        }
        
        // Load events from Firebase
        async function loadEvents() {
            try {
                const eventsSnapshot = await db.collection('calendar_events')
                    .orderBy('startDate', 'asc')
                    .get();
                
                events = [];
                const calendarEvents = [];
                
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    const event = {
                        id: doc.id,
                        title: eventData.title,
                        start: eventData.startDate.toDate(),
                        end: eventData.endDate.toDate(),
                        backgroundColor: getEventColor(eventData.type),
                        borderColor: getEventColor(eventData.type),
                        extendedProps: {
                            type: eventData.type,
                            description: eventData.description,
                            location: eventData.location,
                            createdBy: eventData.createdBy
                        }
                    };
                    
                    events.push(eventData);
                    calendarEvents.push(event);
                });
                
                updateEventStatistics();
                return calendarEvents;
                
            } catch (error) {
                console.error('Error loading events:', error);
                showError('Failed to load calendar events. Please try again.');
                return [];
            }
        }
        
        // Get event color based on type
        function getEventColor(type) {
            const colors = {
                'academic': '#007bff',
                'holiday': '#28a745',
                'exam': '#dc3545',
                'meeting': '#ffc107',
                'other': '#6c757d'
            };
            return colors[type] || '#6c757d';
        }
        
        // Add new event
        async function addEvent() {
            const title = document.getElementById('eventTitle').value;
            const type = document.getElementById('eventType').value;
            const startDate = document.getElementById('eventStartDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const description = document.getElementById('eventDescription').value;
            const location = document.getElementById('eventLocation').value;
            
            if (!title || !startDate || !endDate) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                const eventData = {
                    title: title,
                    type: type,
                    startDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                    endDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                    description: description || '',
                    location: location || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('calendar_events').add(eventData);
                
                showSuccess('Event added successfully!');
                document.getElementById('addEventForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
                calendar.refetchEvents();
                
            } catch (error) {
                console.error('Error adding event:', error);
                showError('Error adding event: ' + error.message);
            }
        }
        
        // Edit event
        function editEvent(event) {
            const eventData = events.find(e => e.id === event.id);
            if (!eventData) return;
            
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editEventTitle').value = event.title;
            document.getElementById('editEventType').value = event.extendedProps.type;
            document.getElementById('editEventStartDate').value = event.start.toISOString().slice(0, 16);
            document.getElementById('editEventEndDate').value = event.end.toISOString().slice(0, 16);
            document.getElementById('editEventDescription').value = event.extendedProps.description || '';
            document.getElementById('editEventLocation').value = event.extendedProps.location || '';
            
            new bootstrap.Modal(document.getElementById('editEventModal')).show();
        }
        
        // Update event
        async function updateEvent() {
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('editEventTitle').value;
            const type = document.getElementById('editEventType').value;
            const startDate = document.getElementById('editEventStartDate').value;
            const endDate = document.getElementById('editEventEndDate').value;
            const description = document.getElementById('editEventDescription').value;
            const location = document.getElementById('editEventLocation').value;
            
            if (!title || !startDate || !endDate) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                await db.collection('calendar_events').doc(eventId).update({
                    title: title,
                    type: type,
                    startDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                    endDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                    description: description || '',
                    location: location || '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                });
                
                showSuccess('Event updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
                calendar.refetchEvents();
                
            } catch (error) {
                console.error('Error updating event:', error);
                showError('Error updating event: ' + error.message);
            }
        }
        
        // Delete event
        async function deleteEvent() {
            const eventId = document.getElementById('editEventId').value;
            
            if (confirm('Are you sure you want to delete this event?')) {
                try {
                    await db.collection('calendar_events').doc(eventId).delete();
                    
                    showSuccess('Event deleted successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
                    calendar.refetchEvents();
                    
                } catch (error) {
                    console.error('Error deleting event:', error);
                    showError('Error deleting event: ' + error.message);
                }
            }
        }
        
        // Update event date (drag and drop)
        async function updateEventDate(event) {
            try {
                const eventData = events.find(e => e.id === event.id);
                if (!eventData) return;
                
                await db.collection('calendar_events').doc(event.id).update({
                    startDate: firebase.firestore.Timestamp.fromDate(event.start),
                    endDate: firebase.firestore.Timestamp.fromDate(event.end),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser.uid
                });
                
                showSuccess('Event date updated successfully!');
                
            } catch (error) {
                console.error('Error updating event date:', error);
                showError('Error updating event date. Please try again.');
                calendar.refetchEvents(); // Revert changes
            }
        }
        
        // Add event for specific date
        function addEventForDate(dateStr) {
            document.getElementById('eventStartDate').value = dateStr + 'T09:00';
            document.getElementById('eventEndDate').value = dateStr + 'T17:00';
            new bootstrap.Modal(document.getElementById('addEventModal')).show();
        }
        
        // Change calendar view
        function changeView(view) {
            currentView = view;
            calendar.changeView(view);
        }
        
        // Filter events
        function filterEvents() {
            const filter = document.getElementById('eventFilter').value;
            calendar.removeAllEvents();
            
            if (filter === 'all') {
                calendar.addEventSource(loadEvents());
            } else {
                const filteredEvents = events.filter(event => event.type === filter);
                const calendarEvents = filteredEvents.map(event => ({
                    id: event.id,
                    title: event.title,
                    start: event.startDate.toDate(),
                    end: event.endDate.toDate(),
                    backgroundColor: getEventColor(event.type),
                    borderColor: getEventColor(event.type)
                }));
                calendar.addEventSource(calendarEvents);
            }
        }
        
        // Update event statistics
        function updateEventStatistics() {
            const totalEvents = events.length;
            const academicEvents = events.filter(event => event.type === 'academic').length;
            const holidays = events.filter(event => event.type === 'holiday').length;
            const exams = events.filter(event => event.type === 'exam').length;
            
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalEvents;
                statsCards[1].textContent = academicEvents;
                statsCards[2].textContent = holidays;
                statsCards[3].textContent = exams;
            }
        }
        
        // Load event statistics
        async function loadEventStatistics() {
            try {
                const eventsSnapshot = await db.collection('calendar_events').get();
                events = [];
                
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    events.push({
                        id: doc.id,
                        ...eventData
                    });
                });
                
                updateEventStatistics();
                
            } catch (error) {
                console.error('Error loading event statistics:', error);
            }
        }
        
        // Export calendar
        function exportCalendar() {
            const eventsData = events.map(event => ({
                title: event.title,
                type: event.type,
                start: event.startDate.toDate().toISOString(),
                end: event.endDate.toDate().toISOString(),
                description: event.description,
                location: event.location
            }));
            
            const dataStr = JSON.stringify(eventsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `academic-calendar-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Calendar exported successfully!');
        }
        
        // Print calendar
        function printCalendar() {
            window.print();
        }
        
        // Show success message
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Show error message
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alertDiv, document.body.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Setup real-time listeners for dynamic updates
        function setupRealTimeListeners() {
            // Listen for calendar event changes
            db.collection('calendarEvents').onSnapshot((snapshot) => {
                loadCalendarEvents();
                updateEventStats();
            });
            
            // Listen for academic term changes
            db.collection('academicTerms').onSnapshot((snapshot) => {
                loadAcademicTerms();
            });
        }
        
        // Enhanced calendar event loading with real-time updates
        async function loadCalendarEvents() {
            try {
                const eventsSnapshot = await db.collection('calendarEvents')
                    .orderBy('startDate', 'asc')
                    .get();
                
                calendarEvents = [];
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    calendarEvents.push({
                        id: doc.id,
                        ...eventData
                    });
                });
                
                updateCalendar();
                updateEventStats();
                
            } catch (error) {
                console.error('Error loading calendar events:', error);
                showError('Failed to load calendar events. Please try again.');
            }
        }
        
        // Load academic terms for calendar
        async function loadAcademicTerms() {
            try {
                const termsSnapshot = await db.collection('academicTerms')
                    .where('isActive', '==', true)
                    .get();
                
                academicTerms = [];
                termsSnapshot.forEach(doc => {
                    const termData = doc.data();
                    academicTerms.push({
                        id: doc.id,
                        ...termData
                    });
                });
                
                updateTermSelector();
                
            } catch (error) {
                console.error('Error loading academic terms:', error);
            }
        }
        
        // Update calendar with new events
        function updateCalendar() {
            if (window.calendar) {
                // Clear existing events
                window.calendar.removeAllEvents();
                
                // Add new events
                calendarEvents.forEach(event => {
                    window.calendar.addEvent({
                        id: event.id,
                        title: event.title,
                        start: event.startDate?.toDate(),
                        end: event.endDate?.toDate(),
                        color: getEventColor(event.type),
                        extendedProps: {
                            description: event.description,
                            type: event.type,
                            location: event.location
                        }
                    });
                });
            }
        }
        
        // Get event color based on type
        function getEventColor(eventType) {
            const colors = {
                'exam': '#dc3545',
                'holiday': '#28a745',
                'meeting': '#007bff',
                'event': '#ffc107',
                'deadline': '#6f42c1'
            };
            return colors[eventType] || '#6c757d';
        }
        
        // Update event statistics
        function updateEventStats() {
            const totalEvents = calendarEvents.length;
            const upcomingEvents = calendarEvents.filter(event => {
                const eventDate = event.startDate?.toDate();
                return eventDate && eventDate > new Date();
            }).length;
            
            const examEvents = calendarEvents.filter(event => event.type === 'exam').length;
            const holidayEvents = calendarEvents.filter(event => event.type === 'holiday').length;
            
            // Update stats cards if they exist
            const statsCards = document.querySelectorAll('.stat-card .number');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = totalEvents;
                statsCards[1].textContent = upcomingEvents;
                statsCards[2].textContent = examEvents;
                statsCards[3].textContent = holidayEvents;
            }
        }
        
        // Update term selector dropdown
        function updateTermSelector() {
            const termSelector = document.getElementById('term-selector');
            if (termSelector) {
                termSelector.innerHTML = '<option value="">Select Academic Term</option>';
                academicTerms.forEach(term => {
                    const option = document.createElement('option');
                    option.value = term.id;
                    option.textContent = `${term.name} (${term.year})`;
                    termSelector.appendChild(option);
                });
            }
        }
        
        // Enhanced event creation with real-time updates
        async function createEvent() {
            const title = document.getElementById('event-title').value;
            const description = document.getElementById('event-description').value;
            const startDate = document.getElementById('event-start-date').value;
            const endDate = document.getElementById('event-end-date').value;
            const eventType = document.getElementById('event-type').value;
            const location = document.getElementById('event-location').value;
            const termId = document.getElementById('term-selector').value;
            
            if (!title || !startDate || !endDate || !eventType) {
                showError('Please fill in all required fields.');
                return;
            }
            
            try {
                const eventData = {
                    title: title,
                    description: description,
                    startDate: firebase.firestore.Timestamp.fromDate(new Date(startDate)),
                    endDate: firebase.firestore.Timestamp.fromDate(new Date(endDate)),
                    type: eventType,
                    location: location,
                    termId: termId,
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                };
                
                await db.collection('calendarEvents').add(eventData);
                
                showSuccess('Event created successfully!');
                document.getElementById('create-event-form').reset();
                bootstrap.Modal.getInstance(document.getElementById('createEventModal')).hide();
                
            } catch (error) {
                console.error('Error creating event:', error);
                showError('Error creating event: ' + error.message);
            }
        }
        
        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Logout error:', error);
                window.location.href = '../../index.html';
            });
        }
        
        // Make functions globally available
        window.addEvent = addEvent;
        window.updateEvent = updateEvent;
        window.deleteEvent = deleteEvent;
        window.changeView = changeView;
        window.filterEvents = filterEvents;
        window.exportCalendar = exportCalendar;
        window.printCalendar = printCalendar;
        window.logout = logout;
    </script>
</body>
</html>
