<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Work - Subject Teacher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/subject-teacher.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">Subject Teacher</h6>
                        <small class="text-muted">Staff ID: <span id="sidebar-staff-id">â€”</span></small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grade-entry.html">
                                <i class="fas fa-edit"></i> Grade Entry
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-lists.html">
                                <i class="fas fa-users"></i> Student Lists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="project-work.html">
                                <i class="fas fa-tasks"></i> Project Work
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="results-analysis.html">
                                <i class="fas fa-chart-bar"></i> Results Analysis
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar"></i> Timetable
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>Project Work</h4>
                        <span class="role-badge">Subject Teacher</span>
                    </div>
                    <div>
                        <span id="current-user">John Doe</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Add Project Button -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5>Project Management</h5>
                    <button class="btn btn-primary" onclick="showAddProjectModal()">
                        <i class="fas fa-plus"></i> Add Project
                    </button>
                </div>
                
                <!-- Projects List -->
                <div class="card">
                    <div class="card-header">
                        <h5>Current Projects</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="projects-table">
                                <thead>
                                    <tr>
                                        <th>Project Title</th>
                                        <th>Subject</th>
                                        <th>Class</th>
                                        <th>Due Date</th>
                                        <th>Students</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projects-tbody">
                                    <!-- Projects will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Project Submissions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>Project Submissions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="submissions-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Project</th>
                                        <th>Subject</th>
                                        <th>Submission Date</th>
                                        <th>Status</th>
                                        <th>Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="submissions-tbody">
                                    <!-- Submissions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal fade" id="addProjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-project-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Title</label>
                                    <input type="text" class="form-control" id="project-title" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subject</label>
                                    <select class="form-select" id="project-subject" required>
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Class</label>
                                    <select class="form-select" id="project-class" required>
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Due Date</label>
                                    <input type="date" class="form-control" id="project-due-date" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Total Marks</label>
                                    <input type="number" class="form-control" id="project-marks" min="1" max="100" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Project Type</label>
                                    <select class="form-select" id="project-type" required>
                                        <option value="">Select Type</option>
                                        <option value="individual">Individual</option>
                                        <option value="group">Group</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Project Description</label>
                            <textarea class="form-control" id="project-description" rows="4" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Instructions</label>
                            <textarea class="form-control" id="project-instructions" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addProject()">Add Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Project Modal -->
    <div class="modal fade" id="gradeProjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Grade Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="grade-project-form">
                        <div class="mb-3">
                            <label class="form-label">Student</label>
                            <input type="text" class="form-control" id="grade-student" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Project</label>
                            <input type="text" class="form-control" id="grade-project" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Score (out of <span id="max-marks">100</span>)</label>
                            <input type="number" class="form-control" id="project-score" min="0" max="100" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comments</label>
                            <textarea class="form-control" id="project-comments" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitGrade()">Submit Grade</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="../../assets/js/firebase-init-compat.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/subject-teacher.js"></script>
    <script>
        // Project Work Functionality (Firebase)
        let projects = [];
        let submissions = [];
        let subjectsIndex = {};
        
        // Sample data
        const sampleProjects = [
            {
                id: 'P001',
                title: 'Quadratic Equations Project',
                subject: 'Mathematics',
                class: 'S.4 Science A',
                dueDate: '2023-11-15',
                totalMarks: 50,
                type: 'Individual',
                description: 'Solve and analyze quadratic equations',
                instructions: 'Submit written solutions and analysis',
                status: 'Active',
                students: 35
            },
            {
                id: 'P002',
                title: 'Physics Lab Report',
                subject: 'Physics',
                class: 'S.4 Science B',
                dueDate: '2023-11-20',
                totalMarks: 40,
                type: 'Individual',
                description: 'Write a comprehensive lab report',
                instructions: 'Include methodology, results, and conclusions',
                status: 'Active',
                students: 32
            },
            {
                id: 'P003',
                title: 'Chemical Reactions Project',
                subject: 'Chemistry',
                class: 'S.3 Science',
                dueDate: '2023-11-25',
                totalMarks: 60,
                type: 'Group',
                description: 'Research and present chemical reactions',
                instructions: 'Group presentation with visual aids',
                status: 'Active',
                students: 38
            }
        ];
        
        const sampleSubmissions = [
            {
                id: 'S001',
                studentId: 'S00123',
                studentName: 'Mukasa John',
                projectId: 'P001',
                projectTitle: 'Quadratic Equations Project',
                subject: 'Mathematics',
                submissionDate: '2023-11-14',
                status: 'Submitted',
                score: null,
                comments: null
            },
            {
                id: 'S002',
                studentId: 'S00124',
                studentName: 'Nakato Mary',
                projectId: 'P001',
                projectTitle: 'Quadratic Equations Project',
                subject: 'Mathematics',
                submissionDate: '2023-11-13',
                status: 'Graded',
                score: 45,
                comments: 'Excellent work with detailed analysis'
            },
            {
                id: 'S003',
                studentId: 'S00125',
                studentName: 'Okot David',
                projectId: 'P002',
                projectTitle: 'Physics Lab Report',
                subject: 'Physics',
                submissionDate: '2023-11-19',
                status: 'Submitted',
                score: null,
                comments: null
            }
        ];
        
        async function initializeProjects() {
            // Auth guard
            if (!window.auth || !window.db) return;
            const user = auth.currentUser;
            if (!user) return;
            try {
                const uDoc = await db.collection('users').doc(user.uid).get();
                const data = uDoc.exists ? uDoc.data() : {};
                const staffId = (data.staffId || (data.employmentInfo && data.employmentInfo.staffId)) || 'â€”';
                document.getElementById('sidebar-staff-id').textContent = staffId;
            } catch (e) {}

            // Load assigned subjects to populate selects
            const ids = await (async () => {
                const doc = await db.collection('users').doc(user.uid).get();
                const d = doc.exists ? doc.data() : {};
                const a = (d.employmentInfo && Array.isArray(d.employmentInfo.subjects)) ? d.employmentInfo.subjects : [];
                const b = (d.academicInfo && Array.isArray(d.academicInfo.subjects)) ? d.academicInfo.subjects : [];
                return Array.from(new Set([...(a||[]), ...(b||[])]));
            })();
            const subjSel = document.getElementById('project-subject');
            subjSel.innerHTML = '<option value="">Select Subject</option>';
            if (ids.length) {
                const chunks = [];
                for (let i = 0; i < ids.length; i += 10) chunks.push(ids.slice(i, i+10));
                const snaps = await Promise.all(chunks.map(ch => db.collection('subjects').where(firebase.firestore.FieldPath.documentId(), 'in', ch).get()));
                const list = [];
                snaps.forEach(snap => snap.forEach(doc => list.push({ id: doc.id, ...doc.data() })));
                subjectsIndex = {};
                list.forEach(s => { subjectsIndex[s.id] = { name: s.name || s.subjectName || 'Subject', classes: Array.isArray(s.classes) ? s.classes : [] }; });
                subjSel.innerHTML = '<option value="">Select Subject</option>' + list.map(s => `<option value="${s.id}">${subjectsIndex[s.id].name}</option>`).join('');
            }
            // Populate classes on subject change
            document.getElementById('project-subject').addEventListener('change', () => {
                const sid = document.getElementById('project-subject').value;
                const classes = (subjectsIndex[sid] && subjectsIndex[sid].classes) ? subjectsIndex[sid].classes : [];
                const clsSel = document.getElementById('project-class');
                clsSel.innerHTML = '<option value="">Select Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            });

            await loadProjects();
            await loadSubmissions();
            displayProjects();
            displaySubmissions();
        }
        
        function displayProjects() {
            const tbody = document.getElementById('projects-tbody');
            tbody.innerHTML = '';
            
            projects.forEach(project => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${project.title}</strong>
                        <br><small class="text-muted">${project.description}</small>
                    </td>
                    <td>${subjectsIndex[project.subjectId]?.name || project.subject || 'Subject'}</td>
                    <td>${project.class}</td>
                    <td>${project.dueDate}</td>
                    <td>${project.students || 0} students</td>
                    <td><span class="badge ${getProjectStatusColor(project.status)}">${project.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewProject('${project.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="editProject('${project.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProject('${project.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function displaySubmissions() {
            const tbody = document.getElementById('submissions-tbody');
            tbody.innerHTML = '';
            
            submissions.forEach(submission => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-2">${submission.studentName.split(' ').map(n => n[0]).join('')}</div>
                            <div>
                                <strong>${submission.studentName}</strong>
                                <br><small class="text-muted">${submission.studentId}</small>
                            </div>
                        </div>
                    </td>
                    <td>${submission.projectTitle}</td>
                    <td>${subjectsIndex[submission.subjectId]?.name || submission.subject || 'Subject'}</td>
                    <td>${submission.submissionDate}</td>
                    <td><span class="badge ${getSubmissionStatusColor(submission.status)}">${submission.status}</span></td>
                    <td>${typeof submission.score === 'number' ? `${submission.score}/100` : '-'}</td>
                    <td>
                        ${submission.status === 'Submitted' ? `
                            <button class="btn btn-sm btn-outline-success" onclick="gradeProject('${submission.id}')">
                                <i class="fas fa-check"></i> Grade
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-primary" onclick="viewGrade('${submission.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        `}
                        <button class="btn btn-sm btn-outline-info" onclick="viewSubmission('${submission.id}')">
                            <i class="fas fa-file"></i> File
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getProjectStatusColor(status) {
            const colors = {
                'Active': 'bg-success',
                'Completed': 'bg-primary',
                'Cancelled': 'bg-danger'
            };
            return colors[status] || 'bg-secondary';
        }
        
        function getSubmissionStatusColor(status) {
            const colors = {
                'Submitted': 'bg-warning',
                'Graded': 'bg-success',
                'Late': 'bg-danger'
            };
            return colors[status] || 'bg-secondary';
        }
        
        function showAddProjectModal() {
            const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
            modal.show();
        }
        
        async function addProject() {
            const title = document.getElementById('project-title').value;
            const subject = document.getElementById('project-subject').value;
            const classSelect = document.getElementById('project-class').value;
            const dueDate = document.getElementById('project-due-date').value;
            const marks = document.getElementById('project-marks').value;
            const type = document.getElementById('project-type').value;
            const description = document.getElementById('project-description').value;
            const instructions = document.getElementById('project-instructions').value;
            
            if (!title || !subject || !classSelect || !dueDate || !marks || !type || !description) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const ref = await db.collection('projects').add({
                    title,
                    subjectId: subject,
                    class: classSelect,
                    dueDate,
                    totalMarks: parseInt(marks),
                    type,
                    description,
                    instructions,
                    status: 'Active',
                    createdBy: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadProjects();
                displayProjects();
            } catch (e) {
                console.error('Add project error:', e);
                alert('Failed to add project');
                return;
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('add-project-form').reset();
            
            alert('Project added successfully!');
        }
        
        function viewProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (project) {
                alert(`Project Details:\n\nTitle: ${project.title}\nSubject: ${project.subject}\nClass: ${project.class}\nDue Date: ${project.dueDate}\nDescription: ${project.description}`);
            }
        }
        
        function editProject(projectId) {
            alert(`Edit project: ${projectId}`);
        }
        
        async function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await db.collection('projects').doc(projectId).delete();
                    await loadProjects();
                    displayProjects();
                } catch (e) {
                    console.error('Delete project error:', e);
                    alert('Failed to delete project');
                }
                alert('Project deleted successfully!');
            }
        }
        
        function gradeProject(submissionId) {
            const submission = submissions.find(s => s.id === submissionId);
            if (submission) {
                document.getElementById('grade-student').value = submission.studentName;
                document.getElementById('grade-project').value = submission.projectTitle;
                document.getElementById('max-marks').textContent = '100';
                document.getElementById('project-score').value = '';
                document.getElementById('project-comments').value = '';
                
                const modal = new bootstrap.Modal(document.getElementById('gradeProjectModal'));
                modal.show();
            }
        }
        
        async function submitGrade() {
            const score = document.getElementById('project-score').value;
            const comments = document.getElementById('project-comments').value;
            
            if (!score) {
                alert('Please enter a score');
                return;
            }
            
            try {
                // Update first submitted item for simplicity in this UI
                const firstSubmitted = submissions.find(s => s.status === 'Submitted');
                if (!firstSubmitted) { alert('No submitted item to grade'); return; }
                await db.collection('project_submissions').doc(firstSubmitted.id).update({
                    score: parseInt(score),
                    comments,
                    status: 'Graded',
                    gradedBy: auth.currentUser.uid,
                    gradedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadSubmissions();
                displaySubmissions();
            } catch (e) {
                console.error('Submit grade error:', e);
                alert('Failed to submit grade');
                return;
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('gradeProjectModal'));
            modal.hide();
            
            alert('Grade submitted successfully!');
        }
        
        function viewGrade(submissionId) {
            const submission = submissions.find(s => s.id === submissionId);
            if (submission) {
                alert(`Grade Details:\n\nStudent: ${submission.studentName}\nProject: ${submission.projectTitle}\nScore: ${submission.score}/100\nComments: ${submission.comments}`);
            }
        }
        
        function viewSubmission(submissionId) {
            alert(`Viewing submission file for: ${submissionId}`);
        }
        
        function logout() { if (!window.auth) { window.location.href='../../index.html'; return; } auth.signOut().then(() => window.location.href='../../index.html'); }
        
        async function loadProjects() {
            const snap = await db.collection('projects').where('createdBy', '==', auth.currentUser.uid).orderBy('createdAt', 'desc').limit(100).get();
            projects = [];
            snap.forEach(doc => projects.push({ id: doc.id, ...doc.data() }));
        }
        async function loadSubmissions() {
            const snap = await db.collection('project_submissions').where('teacherId', '==', auth.currentUser.uid).orderBy('submissionDate', 'desc').limit(200).get();
            submissions = [];
            snap.forEach(doc => submissions.push({ id: doc.id, ...doc.data() }));
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.auth || !window.db) return;
            auth.onAuthStateChanged(async (user) => {
                if (!user) { window.location.href='../../index.html'; return; }
                await initializeProjects();
            });
        });
    </script>
</body>
</html>
