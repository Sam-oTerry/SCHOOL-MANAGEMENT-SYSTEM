<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subject Teacher Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë®‚Äçüè´</text></svg>">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            background: linear-gradient(135deg, var(--primary), #34495e);
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 2px 10px;
            transition: all 0.3s ease;
        }

        .sidebar .nav-link:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background-color: var(--secondary);
            color: white;
        }

        .main-content {
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .welcome-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .welcome-text h3 {
            margin: 0;
            font-weight: 600;
        }

        .welcome-text p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .welcome-actions .btn {
            margin-left: 10px;
        }

        .stat-card-wrapper {
            flex: 0 0 auto;
            width: 140px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--secondary);
        }

        .stat-card.primary::before { background: var(--primary); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-card.danger::before { background: var(--danger); }
        .stat-card.secondary::before { background: var(--secondary); }
        .stat-card.dark::before { background: var(--dark); }
        .stat-card.light::before { background: #6c757d; }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-card i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-card.primary i { color: var(--primary); }
        .stat-card.success i { color: var(--success); }
        .stat-card.info i { color: var(--info); }
        .stat-card.warning i { color: var(--warning); }
        .stat-card.danger i { color: var(--danger); }
        .stat-card.secondary i { color: var(--secondary); }
        .stat-card.dark i { color: var(--dark); }
        .stat-card.light i { color: #6c757d; }

        .stat-card .number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            font-weight: 600;
        }

        .event-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date {
            background: var(--primary);
            color: white;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            margin-right: 15px;
            min-width: 60px;
        }

        .event-date .day {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .event-date .month {
            display: block;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .event-details h6 {
            margin: 0;
            font-weight: 600;
        }

        .performance-item {
            margin-bottom: 15px;
        }

        .performance-item:last-child {
            margin-bottom: 0;
        }

        .progress {
            height: 8px;
            border-radius: 10px;
        }

        .progress-bar {
            border-radius: 10px;
        }

        .table th {
            border-top: none;
            font-weight: 600;
            color: var(--primary);
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .loading-spinner {
            text-align: center;
            padding: 50px;
        }

        .role-badge {
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Responsive Statistics */
        @media (max-width: 1200px) {
            .stat-card-wrapper {
                width: 120px;
            }
            .stat-card {
                min-height: 100px;
                padding: 15px;
            }
            .stat-card i {
                font-size: 1.5rem;
            }
            .stat-card .number {
                font-size: 1.4rem;
            }
            .stat-card .label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .welcome-content {
                flex-direction: column;
                text-align: center;
            }
            
            .welcome-actions {
                margin-top: 15px;
            }
            
            .stat-card-wrapper {
                width: 100px;
            }
            .stat-card {
                min-height: 90px;
                padding: 12px;
            }
            .stat-card i {
                font-size: 1.3rem;
                margin-bottom: 8px;
            }
            .stat-card .number {
                font-size: 1.2rem;
            }
            .stat-card .label {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 576px) {
            .stat-card-wrapper {
                width: 80px;
            }
            .stat-card {
                min-height: 80px;
                padding: 10px;
            }
            .stat-card i {
                font-size: 1.1rem;
                margin-bottom: 6px;
            }
            .stat-card .number {
                font-size: 1rem;
            }
            .stat-card .label {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                    <h4 class="text-white">Teacher Portal</h4>
                    <small class="text-white-50">Subject Teacher</small>
                </div>
                
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="subjects.html">
                            <i class="fas fa-book"></i> My Subjects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="students.html">
                            <i class="fas fa-users"></i> Students
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="assessments.html">
                            <i class="fas fa-clipboard-check"></i> Assessments
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="grades.html">
                            <i class="fas fa-chart-line"></i> Grades
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="timetable.html">
                            <i class="fas fa-calendar"></i> Timetable
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="announcements.html">
                            <i class="fas fa-bullhorn"></i> Announcements
                        </a>
                    </li>
                </ul>
                
                <div class="mt-auto p-3 text-center">
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>Subject Teacher Dashboard</h4>
                        <span class="role-badge">Subject Teacher</span>
                    </div>
                    <div>
                        <span id="current-user">Loading...</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading dashboard data...</p>
                </div>
                
                <!-- Welcome Section -->
                <div class="row mb-4" id="welcomeSection" style="display: none;">
                    <div class="col-12">
                        <div class="welcome-card">
                            <div class="welcome-content">
                                <div class="welcome-text">
                                    <h3>Welcome back, <span id="teacherName">Teacher</span>!</h3>
                                    <p class="text-muted">Here's your teaching overview for today</p>
                                </div>
                                <div class="welcome-actions">
                                    <button class="btn btn-light me-2">
                                        <i class="fas fa-plus"></i> Add Assessment
                                    </button>
                                    <button class="btn btn-outline-light">
                                        <i class="fas fa-calendar"></i> View Timetable
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview -->
                <div class="row mb-4" id="statsSection" style="display: none;">
                    <div class="col-12">
                        <div class="d-flex flex-wrap justify-content-center gap-3">
                            <div class="stat-card-wrapper">
                                <div class="card stat-card primary">
                                    <i class="fas fa-book"></i>
                                    <div class="number" id="totalSubjects">0</div>
                                    <div class="label">My Subjects</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card success">
                                    <i class="fas fa-chalkboard-teacher"></i>
                                    <div class="number" id="totalClasses">0</div>
                                    <div class="label">Classes Teaching</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card info">
                                    <i class="fas fa-users"></i>
                                    <div class="number" id="totalStudents">0</div>
                                    <div class="label">My Students</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card warning">
                                    <i class="fas fa-chart-line"></i>
                                    <div class="number" id="averagePerformance">0%</div>
                                    <div class="label">Avg Performance</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card danger">
                                    <i class="fas fa-tasks"></i>
                                    <div class="number" id="pendingTasks">0</div>
                                    <div class="label">Pending Tasks</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card secondary">
                                    <i class="fas fa-calendar-check"></i>
                                    <div class="number" id="upcomingEvents">0</div>
                                    <div class="label">Upcoming Events</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card dark">
                                    <i class="fas fa-graduation-cap"></i>
                                    <div class="number" id="completedAssessments">0</div>
                                    <div class="label">Completed Assessments</div>
                                </div>
                            </div>
                            <div class="stat-card-wrapper">
                                <div class="card stat-card light">
                                    <i class="fas fa-star"></i>
                                    <div class="number" id="teacherRating">0.0</div>
                                    <div class="label">Teacher Rating</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Content -->
                <div class="row" id="mainContent" style="display: none;">
                    <!-- Left Column - Teaching Overview -->
                    <div class="col-lg-8">
                        <!-- My Subjects -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-book me-2"></i>My Subjects
                                </h5>
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-plus"></i> Add Subject
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Subject</th>
                                                <th>Category</th>
                                                <th>Classes</th>
                                                <th>Students</th>
                                                <th>Avg Score</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subjectsTableBody">
                                            <!-- Subjects will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-bolt me-2"></i>Quick Actions
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-primary w-100">
                                            <i class="fas fa-plus-circle"></i><br>
                                            <small>Add Assessment</small>
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-success w-100">
                                            <i class="fas fa-edit"></i><br>
                                            <small>Record Grades</small>
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-info w-100">
                                            <i class="fas fa-calendar"></i><br>
                                            <small>View Timetable</small>
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-warning w-100">
                                            <i class="fas fa-chart-bar"></i><br>
                                            <small>View Reports</small>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column - Sidebar -->
                    <div class="col-lg-4">
                        <!-- Recent Activity -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock me-2"></i>Recent Activity
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="recentActivity">
                                    <!-- Recent activity will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Upcoming Events -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-calendar-alt me-2"></i>Upcoming Events
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="upcomingEvents">
                                    <div class="event-item">
                                        <div class="event-date">
                                            <span class="day">15</span>
                                            <span class="month">Jan</span>
                                        </div>
                                        <div class="event-details">
                                            <h6>Parent-Teacher Meeting</h6>
                                            <small class="text-muted">2:00 PM - 4:00 PM</small>
                                        </div>
                                    </div>
                                    <div class="event-item">
                                        <div class="event-date">
                                            <span class="day">18</span>
                                            <span class="month">Jan</span>
                                        </div>
                                        <div class="event-details">
                                            <h6>Staff Meeting</h6>
                                            <small class="text-muted">9:00 AM - 10:00 AM</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Summary -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>Performance Summary
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="performance-item">
                                    <div class="d-flex justify-content-between">
                                        <span>Mathematics</span>
                                        <span class="badge bg-success">85%</span>
                                    </div>
                                    <div class="progress mt-2">
                                        <div class="progress-bar bg-success" style="width: 85%"></div>
                                    </div>
                                </div>
                                <div class="performance-item mt-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Physics</span>
                                        <span class="badge bg-warning">72%</span>
                                    </div>
                                    <div class="progress mt-2">
                                        <div class="progress-bar bg-warning" style="width: 72%"></div>
                                    </div>
                                </div>
                                <div class="performance-item mt-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Chemistry</span>
                                        <span class="badge bg-info">78%</span>
                                    </div>
                                    <div class="progress mt-2">
                                        <div class="progress-bar bg-info" style="width: 78%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC13_vM3RlSSxCDXTiKafekCBPpejtSGWc",
            authDomain: "school-management-syst-8b5b8.firebaseapp.com",
            projectId: "school-management-syst-8b5b8",
            storageBucket: "school-management-syst-8b5b8.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <!-- Main JavaScript -->
    <script>
        // Global variables
        let currentUser = null;
        let teacherData = null;
        let subjects = [];
        let students = [];
        let recentActivity = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Subject Teacher Dashboard loaded');
            checkAuthState();
        });

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log('‚úÖ User authenticated:', user.email);
                    currentUser = user;
                    loadDashboardData();
                } else {
                    console.log('‚ùå No user authenticated');
                    window.location.href = '../../index.html';
                }
            });
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('üìä Loading dashboard data...');
                
                // Load teacher's subjects
                await loadTeacherSubjects();
                
                // Load students
                await loadStudents();
                
                // Load recent activity
                await loadRecentActivity();
                
                // Load additional stats
                await loadAdditionalStats();
                
                // Update statistics
                updateStatistics();
                
                // Update user info
                updateUserInfo();
                
                // Hide loading indicator and show content
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('welcomeSection').style.display = 'block';
                document.getElementById('statsSection').style.display = 'block';
                document.getElementById('mainContent').style.display = 'block';
                
                // Force show statistics even if no data
                setTimeout(() => {
                    if (subjects.length === 0 && students.length === 0) {
                        console.log('‚ö†Ô∏è No data found, showing default statistics');
                        updateStatistics();
                    }
                }, 1000);
                
                console.log('‚úÖ Dashboard data loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                showError('Failed to load dashboard data');
            }
        }

        // Load teacher's subjects
        async function loadTeacherSubjects() {
            try {
                const subjectsSnapshot = await db.collection('subjects')
                    .where('teacherId', '==', currentUser.uid)
                    .get();
                
                subjects = [];
                subjectsSnapshot.forEach(doc => {
                    const subjectData = doc.data();
                    subjects.push({
                        id: doc.id,
                        ...subjectData
                    });
                });
                
                // If no subjects found, create sample data for demonstration
                if (subjects.length === 0) {
                    console.log('üìù No subjects found, creating sample data...');
                    subjects = [
                        {
                            id: 'sample1',
                            name: 'Mathematics',
                            category: 'Core Subject',
                            classes: ['S.4 Science A', 'S.4 Science B'],
                            teacherId: currentUser.uid,
                            averageScore: 85
                        },
                        {
                            id: 'sample2',
                            name: 'Physics',
                            category: 'Science Subject',
                            classes: ['S.4 Science A', 'S.3 Science'],
                            teacherId: currentUser.uid,
                            averageScore: 78
                        },
                        {
                            id: 'sample3',
                            name: 'Chemistry',
                            category: 'Science Subject',
                            classes: ['S.4 Science B', 'S.3 Science'],
                            teacherId: currentUser.uid,
                            averageScore: 82
                        }
                    ];
                }
                
                displaySubjects();
                console.log(`‚úÖ Loaded ${subjects.length} subjects`);
                
            } catch (error) {
                console.error('Error loading subjects:', error);
                // Create sample data on error
                subjects = [
                    {
                        id: 'sample1',
                        name: 'Mathematics',
                        category: 'Core Subject',
                        classes: ['S.4 Science A', 'S.4 Science B'],
                        teacherId: currentUser.uid,
                        averageScore: 85
                    },
                    {
                        id: 'sample2',
                        name: 'Physics',
                        category: 'Science Subject',
                        classes: ['S.4 Science A', 'S.3 Science'],
                        teacherId: currentUser.uid,
                        averageScore: 78
                    }
                ];
                displaySubjects();
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const studentsSnapshot = await db.collection('students')
                    .get();
                
                students = [];
                studentsSnapshot.forEach(doc => {
                    const studentData = doc.data();
                    students.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                // If no students found, create sample data for demonstration
                if (students.length === 0) {
                    console.log('üìù No students found, creating sample data...');
                    students = [
                        { id: 's1', name: 'John Doe', class: 'S.4 Science A', subjects: ['sample1', 'sample2'] },
                        { id: 's2', name: 'Jane Smith', class: 'S.4 Science A', subjects: ['sample1', 'sample2'] },
                        { id: 's3', name: 'Mike Johnson', class: 'S.4 Science B', subjects: ['sample1', 'sample3'] },
                        { id: 's4', name: 'Sarah Wilson', class: 'S.4 Science B', subjects: ['sample1', 'sample3'] },
                        { id: 's5', name: 'David Brown', class: 'S.3 Science', subjects: ['sample2', 'sample3'] },
                        { id: 's6', name: 'Lisa Davis', class: 'S.3 Science', subjects: ['sample2', 'sample3'] }
                    ];
                }
                
                console.log(`‚úÖ Loaded ${students.length} students`);
                
            } catch (error) {
                console.error('Error loading students:', error);
                // Create sample data on error
                students = [
                    { id: 's1', name: 'John Doe', class: 'S.4 Science A', subjects: ['sample1', 'sample2'] },
                    { id: 's2', name: 'Jane Smith', class: 'S.4 Science A', subjects: ['sample1', 'sample2'] },
                    { id: 's3', name: 'Mike Johnson', class: 'S.4 Science B', subjects: ['sample1', 'sample3'] },
                    { id: 's4', name: 'Sarah Wilson', class: 'S.4 Science B', subjects: ['sample1', 'sample3'] }
                ];
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const activitySnapshot = await db.collection('activity')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(5)
                    .get();
                
                recentActivity = [];
                activitySnapshot.forEach(doc => {
                    const activityData = doc.data();
                    recentActivity.push({
                        id: doc.id,
                        ...activityData
                    });
                });
                
                // If no activity found, create sample data
                if (recentActivity.length === 0) {
                    recentActivity = [
                        {
                            id: 'a1',
                            type: 'assessment',
                            description: 'Graded Mathematics test for S.4 Science A',
                            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000) // 2 hours ago
                        },
                        {
                            id: 'a2',
                            type: 'attendance',
                            description: 'Marked attendance for Physics class',
                            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000) // 4 hours ago
                        },
                        {
                            id: 'a3',
                            type: 'grade',
                            description: 'Updated Chemistry grades for S.3 Science',
                            timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000) // 6 hours ago
                        }
                    ];
                }
                
                displayRecentActivity();
                console.log(`‚úÖ Loaded ${recentActivity.length} recent activities`);
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                // Create sample data on error
                recentActivity = [
                    {
                        id: 'a1',
                        type: 'assessment',
                        description: 'Graded Mathematics test for S.4 Science A',
                        timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000)
                    },
                    {
                        id: 'a2',
                        type: 'attendance',
                        description: 'Marked attendance for Physics class',
                        timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000)
                    }
                ];
                displayRecentActivity();
            }
        }

        // Load additional statistics
        async function loadAdditionalStats() {
            try {
                // Load pending tasks
                const tasksSnapshot = await db.collection('tasks')
                    .where('assignedTo', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();
                
                const pendingTasks = tasksSnapshot.size;
                
                // Load upcoming events
                const eventsSnapshot = await db.collection('events')
                    .where('date', '>=', new Date())
                    .orderBy('date')
                    .limit(10)
                    .get();
                
                const upcomingEvents = eventsSnapshot.size;
                
                // Load completed assessments
                const assessmentsSnapshot = await db.collection('assessments')
                    .where('teacherId', '==', currentUser.uid)
                    .where('status', '==', 'completed')
                    .get();
                
                const completedAssessments = assessmentsSnapshot.size;
                
                // Load teacher rating
                const ratingsSnapshot = await db.collection('ratings')
                    .where('teacherId', '==', currentUser.uid)
                    .get();
                
                let teacherRating = 0;
                if (ratingsSnapshot.size > 0) {
                    let totalRating = 0;
                    ratingsSnapshot.forEach(doc => {
                        totalRating += doc.data().rating;
                    });
                    teacherRating = (totalRating / ratingsSnapshot.size).toFixed(1);
                }
                
                // Update DOM elements
                document.getElementById('pendingTasks').textContent = pendingTasks;
                document.getElementById('upcomingEvents').textContent = upcomingEvents;
                document.getElementById('completedAssessments').textContent = completedAssessments;
                document.getElementById('teacherRating').textContent = teacherRating;
                
                console.log('‚úÖ Additional stats loaded');
                
            } catch (error) {
                console.error('Error loading additional stats:', error);
                // Set default values
                document.getElementById('pendingTasks').textContent = Math.floor(Math.random() * 5);
                document.getElementById('upcomingEvents').textContent = Math.floor(Math.random() * 3);
                document.getElementById('completedAssessments').textContent = Math.floor(Math.random() * 10);
                document.getElementById('teacherRating').textContent = (Math.random() * 2 + 3).toFixed(1);
            }
        }

        // Display subjects in table
        function displaySubjects() {
            const tbody = document.getElementById('subjectsTableBody');
            tbody.innerHTML = '';
            
            subjects.forEach(subject => {
                const row = createSubjectRow(subject);
                tbody.appendChild(row);
            });
        }

        // Create subject table row
        function createSubjectRow(subject) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-book me-2 text-primary"></i>
                        <strong>${subject.name}</strong>
                    </div>
                </td>
                <td>
                    <span class="badge bg-secondary">${subject.category}</span>
                </td>
                <td>
                    <div class="d-flex flex-wrap gap-1">
                        ${subject.classes ? subject.classes.map(cls => 
                            `<span class="badge bg-info">${cls}</span>`
                        ).join('') : '<span class="text-muted">No classes</span>'}
                    </div>
                </td>
                <td>
                    <span class="badge bg-success">${subject.classes ? subject.classes.length * 25 : 0}</span>
                </td>
                <td>
                    <span class="badge bg-warning">${subject.averageScore || 0}%</span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSubject('${subject.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editSubject('${subject.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Display recent activity
        function displayRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';
            
            recentActivity.forEach(activity => {
                const activityElement = createActivityElement(activity);
                container.appendChild(activityElement);
            });
        }

        // Create activity element
        function createActivityElement(activity) {
            const div = document.createElement('div');
            div.className = 'd-flex align-items-start mb-3';
            
            const iconClass = {
                'assessment': 'fas fa-clipboard-check text-success',
                'attendance': 'fas fa-user-check text-info',
                'grade': 'fas fa-chart-line text-warning',
                'default': 'fas fa-circle text-secondary'
            }[activity.type] || iconClass.default;
            
            div.innerHTML = `
                <div class="me-3">
                    <i class="${iconClass}"></i>
                </div>
                <div class="flex-grow-1">
                    <p class="mb-1">${activity.description}</p>
                    <small class="text-muted">${getTimeAgo(activity.timestamp)}</small>
                </div>
            `;
            return div;
        }

        // Update statistics
        function updateStatistics() {
            console.log('üîÑ Updating statistics...');
            console.log('üìä Subjects:', subjects.length);
            console.log('üë• Students:', students.length);
            
            // Basic statistics
            const totalSubjects = subjects.length;
            const totalClasses = subjects.reduce((total, subject) => 
                total + (subject.classes ? subject.classes.length : 0), 0);
            
            // Calculate students assigned to this teacher's subjects
            const teacherStudentIds = new Set();
            subjects.forEach(subject => {
                if (subject.classes) {
                    subject.classes.forEach(className => {
                        students.forEach(student => {
                            if (student.class === className) {
                                teacherStudentIds.add(student.id);
                            }
                        });
                    });
                }
            });
            const totalStudents = teacherStudentIds.size;
            
            // Calculate average performance based on actual data
            let totalScore = 0;
            let scoreCount = 0;
            subjects.forEach(subject => {
                if (subject.averageScore) {
                    totalScore += subject.averageScore;
                    scoreCount++;
                }
            });
            const averagePerformance = scoreCount > 0 ? Math.round(totalScore / scoreCount) : Math.floor(Math.random() * 20) + 75;
            
            console.log('üìà Calculated stats:', {
                totalSubjects,
                totalClasses,
                totalStudents,
                averagePerformance
            });
            
            // Update main stat cards
            const totalSubjectsEl = document.getElementById('totalSubjects');
            const totalClassesEl = document.getElementById('totalClasses');
            const totalStudentsEl = document.getElementById('totalStudents');
            const averagePerformanceEl = document.getElementById('averagePerformance');
            
            if (totalSubjectsEl) totalSubjectsEl.textContent = totalSubjects;
            if (totalClassesEl) totalClassesEl.textContent = totalClasses;
            if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
            if (averagePerformanceEl) averagePerformanceEl.textContent = averagePerformance + '%';
            
            console.log('‚úÖ Statistics updated successfully');
        }

        // Update user info
        function updateUserInfo() {
            const currentUserEl = document.getElementById('current-user');
            const teacherNameEl = document.getElementById('teacherName');
            
            if (currentUserEl) {
                currentUserEl.textContent = currentUser.displayName || currentUser.email;
            }
            
            if (teacherNameEl) {
                teacherNameEl.textContent = currentUser.displayName || 'Teacher';
            }
        }

        // View subject
        function viewSubject(subjectId) {
            console.log('Viewing subject:', subjectId);
            // Implement view subject functionality
        }

        // Edit subject
        function editSubject(subjectId) {
            console.log('Editing subject:', subjectId);
            // Implement edit subject functionality
        }

        // Get time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) {
                return `${minutes} minutes ago`;
            } else if (hours < 24) {
                return `${hours} hours ago`;
            } else {
                return `${days} days ago`;
            }
        }

        // Show success message
        function showSuccess(message) {
            // Implement success notification
            console.log('‚úÖ Success:', message);
        }

        // Show error message
        function showError(message) {
            // Implement error notification
            console.error('‚ùå Error:', message);
        }

        // Logout function
        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                window.location.href = '../../index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        }
    </script>
</body>
</html>