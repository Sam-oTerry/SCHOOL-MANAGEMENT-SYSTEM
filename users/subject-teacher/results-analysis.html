<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Analysis - Subject Teacher</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../../assets/css/main.css" rel="stylesheet">
    <link href="../../assets/css/components/sidebar.css" rel="stylesheet">
    <link href="../../assets/css/users/subject-teacher.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="z-index: 1000;">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="../../assets/images/logo.png" alt="School Logo" class="img-fluid mb-2" style="max-height: 60px;">
                        <h6 class="text-muted">Subject Teacher</h6>
                        <small class="text-muted">Staff ID: ST1234</small>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="my-subjects.html">
                                <i class="fas fa-book"></i> My Subjects
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="grade-entry.html">
                                <i class="fas fa-edit"></i> Grade Entry
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="student-lists.html">
                                <i class="fas fa-users"></i> Student Lists
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="project-work.html">
                                <i class="fas fa-tasks"></i> Project Work
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="results-analysis.html">
                                <i class="fas fa-chart-bar"></i> Results Analysis
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="announcements.html">
                                <i class="fas fa-bullhorn"></i> Announcements
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="timetable.html">
                                <i class="fas fa-calendar"></i> Timetable
                            </a>
                        </li>
                    </ul>
                    
                    <div class="mt-auto p-3 text-center">
                        <button class="btn btn-sm btn-outline-light" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="header">
                    <div>
                        <h4>Results Analysis</h4>
                        <span class="role-badge">Subject Teacher</span>
                    </div>
                    <div>
                        <span id="current-user">John Doe</span>
                        <i class="fas fa-user-circle ms-2 text-primary"></i>
                    </div>
                </div>
                
                <!-- Analysis Filters -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Analysis Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Subject</label>
                                <select class="form-select" id="analysis-subject" onchange="updateAnalysis()">
                                    <option value="">All Subjects</option>
                                    <option value="mathematics">Mathematics</option>
                                    <option value="physics">Physics</option>
                                    <option value="chemistry">Chemistry</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="analysis-class" onchange="updateAnalysis()">
                                    <option value="">All Classes</option>
                                    <option value="s4-science-a">S.4 Science A</option>
                                    <option value="s4-science-b">S.4 Science B</option>
                                    <option value="s3-science">S.3 Science</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Term</label>
                                <select class="form-select" id="analysis-term" onchange="updateAnalysis()">
                                    <option value="">All Terms</option>
                                    <option value="first-term">First Term</option>
                                    <option value="second-term">Second Term</option>
                                    <option value="third-term">Third Term</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Analysis Type</label>
                                <select class="form-select" id="analysis-type" onchange="updateAnalysis()">
                                    <option value="overall">Overall Performance</option>
                                    <option value="trend">Performance Trend</option>
                                    <option value="comparison">Class Comparison</option>
                                    <option value="individual">Individual Analysis</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="total-students">0</h3>
                                <p class="mb-0">Total Students</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="average-score">0%</h3>
                                <p class="mb-0">Average Score</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" id="pass-rate">0%</h3>
                                <p class="mb-0">Pass Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="top-performer">-</h3>
                                <p class="mb-0">Top Performer</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Grade Distribution -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Grade Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <canvas id="gradeChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-4">
                                <div class="grade-stats">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>A (90-100%)</span>
                                        <span class="badge bg-success" id="grade-a-count">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>B (80-89%)</span>
                                        <span class="badge bg-primary" id="grade-b-count">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>C (70-79%)</span>
                                        <span class="badge bg-info" id="grade-c-count">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>D (60-69%)</span>
                                        <span class="badge bg-warning" id="grade-d-count">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>E (50-59%)</span>
                                        <span class="badge bg-secondary" id="grade-e-count">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>F (0-49%)</span>
                                        <span class="badge bg-danger" id="grade-f-count">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Trends -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Performance Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trendChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <!-- Class Comparison -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Class Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>Students</th>
                                        <th>Average Score</th>
                                        <th>Pass Rate</th>
                                        <th>Top Performer</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody id="class-comparison-tbody">
                                    <!-- Class comparison data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Individual Student Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h5>Individual Student Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Class</th>
                                        <th>Mid-term</th>
                                        <th>End-term</th>
                                        <th>Final Grade</th>
                                        <th>Grade</th>
                                        <th>Trend</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="individual-analysis-tbody">
                                    <!-- Individual analysis data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/users/subject-teacher.js"></script>
    <script>
        // Results Analysis Functionality
        let analysisData = [];
        let gradeChart = null;
        let trendChart = null;
        
        // Sample analysis data
        const sampleAnalysisData = [
            {
                studentId: 'S00123',
                studentName: 'Mukasa John',
                class: 'S.4 Science A',
                subject: 'Mathematics',
                midTerm: 85,
                endTerm: 90,
                finalGrade: 89,
                grade: 'B',
                term: 'First Term'
            },
            {
                studentId: 'S00124',
                studentName: 'Nakato Mary',
                class: 'S.4 Science A',
                subject: 'Mathematics',
                midTerm: 92,
                endTerm: 95,
                finalGrade: 94.4,
                grade: 'A',
                term: 'First Term'
            },
            {
                studentId: 'S00125',
                studentName: 'Okot David',
                class: 'S.4 Science B',
                subject: 'Physics',
                midTerm: 78,
                endTerm: 82,
                finalGrade: 81.2,
                grade: 'B',
                term: 'First Term'
            },
            {
                studentId: 'S00126',
                studentName: 'Namukasa Sarah',
                class: 'S.3 Science',
                subject: 'Chemistry',
                midTerm: 88,
                endTerm: 91,
                finalGrade: 90.4,
                grade: 'A',
                term: 'First Term'
            },
            {
                studentId: 'S00127',
                studentName: 'Kato Peter',
                class: 'S.4 Science A',
                subject: 'Mathematics',
                midTerm: 75,
                endTerm: 80,
                finalGrade: 79,
                grade: 'C',
                term: 'First Term'
            }
        ];
        
        function initializeAnalysis() {
            analysisData = [...sampleAnalysisData];
            updateAnalysis();
        }
        
        function updateAnalysis() {
            const subject = document.getElementById('analysis-subject').value;
            const classSelect = document.getElementById('analysis-class').value;
            const term = document.getElementById('analysis-term').value;
            const analysisType = document.getElementById('analysis-type').value;
            
            let filteredData = analysisData;
            
            if (subject) {
                filteredData = filteredData.filter(d => d.subject.toLowerCase() === subject);
            }
            if (classSelect) {
                filteredData = filteredData.filter(d => d.class.toLowerCase().replace(' ', '-') === classSelect);
            }
            if (term) {
                filteredData = filteredData.filter(d => d.term.toLowerCase().replace(' ', '-') === term);
            }
            
            updateOverview(filteredData);
            updateGradeDistribution(filteredData);
            updatePerformanceTrends(filteredData);
            updateClassComparison(filteredData);
            updateIndividualAnalysis(filteredData);
        }
        
        function updateOverview(data) {
            const totalStudents = data.length;
            const averageScore = totalStudents > 0 ? (data.reduce((sum, d) => sum + d.finalGrade, 0) / totalStudents).toFixed(1) : 0;
            const passRate = totalStudents > 0 ? ((data.filter(d => d.finalGrade >= 50).length / totalStudents) * 100).toFixed(1) : 0;
            const topPerformer = data.length > 0 ? data.reduce((max, d) => d.finalGrade > max.finalGrade ? d : max).studentName : '-';
            
            document.getElementById('total-students').textContent = totalStudents;
            document.getElementById('average-score').textContent = averageScore + '%';
            document.getElementById('pass-rate').textContent = passRate + '%';
            document.getElementById('top-performer').textContent = topPerformer;
        }
        
        function updateGradeDistribution(data) {
            const gradeCounts = {
                A: data.filter(d => d.grade === 'A').length,
                B: data.filter(d => d.grade === 'B').length,
                C: data.filter(d => d.grade === 'C').length,
                D: data.filter(d => d.grade === 'D').length,
                E: data.filter(d => d.grade === 'E').length,
                F: data.filter(d => d.grade === 'F').length
            };
            
            document.getElementById('grade-a-count').textContent = gradeCounts.A;
            document.getElementById('grade-b-count').textContent = gradeCounts.B;
            document.getElementById('grade-c-count').textContent = gradeCounts.C;
            document.getElementById('grade-d-count').textContent = gradeCounts.D;
            document.getElementById('grade-e-count').textContent = gradeCounts.E;
            document.getElementById('grade-f-count').textContent = gradeCounts.F;
            
            // Update chart
            if (gradeChart) {
                gradeChart.destroy();
            }
            
            const ctx = document.getElementById('gradeChart').getContext('2d');
            gradeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['A', 'B', 'C', 'D', 'E', 'F'],
                    datasets: [{
                        data: [gradeCounts.A, gradeCounts.B, gradeCounts.C, gradeCounts.D, gradeCounts.E, gradeCounts.F],
                        backgroundColor: [
                            '#28a745',
                            '#007bff',
                            '#17a2b8',
                            '#ffc107',
                            '#6c757d',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        function updatePerformanceTrends(data) {
            // Sample trend data
            const trendData = {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                datasets: [{
                    label: 'Average Score',
                    data: [75, 78, 82, 85, 88, 90],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                }]
            };
            
            if (trendChart) {
                trendChart.destroy();
            }
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: trendData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function updateClassComparison(data) {
            const tbody = document.getElementById('class-comparison-tbody');
            tbody.innerHTML = '';
            
            const classStats = {};
            data.forEach(d => {
                if (!classStats[d.class]) {
                    classStats[d.class] = {
                        students: [],
                        totalScore: 0,
                        count: 0
                    };
                }
                classStats[d.class].students.push(d);
                classStats[d.class].totalScore += d.finalGrade;
                classStats[d.class].count++;
            });
            
            Object.entries(classStats).forEach(([className, stats]) => {
                const averageScore = (stats.totalScore / stats.count).toFixed(1);
                const passRate = ((stats.students.filter(s => s.finalGrade >= 50).length / stats.count) * 100).toFixed(1);
                const topPerformer = stats.students.reduce((max, s) => s.finalGrade > max.finalGrade ? s : max);
                const performance = averageScore >= 80 ? 'Excellent' : averageScore >= 70 ? 'Good' : averageScore >= 60 ? 'Average' : 'Below Average';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${className}</td>
                    <td>${stats.count}</td>
                    <td>${averageScore}%</td>
                    <td>${passRate}%</td>
                    <td>${topPerformer.studentName}</td>
                    <td><span class="badge ${getPerformanceColor(performance)}">${performance}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateIndividualAnalysis(data) {
            const tbody = document.getElementById('individual-analysis-tbody');
            tbody.innerHTML = '';
            
            data.forEach(student => {
                const trend = student.endTerm > student.midTerm ? '↗️ Improving' : 
                            student.endTerm < student.midTerm ? '↘️ Declining' : '➡️ Stable';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="student-avatar me-2">${student.studentName.split(' ').map(n => n[0]).join('')}</div>
                            <div>
                                <strong>${student.studentName}</strong>
                                <br><small class="text-muted">${student.studentId}</small>
                            </div>
                        </div>
                    </td>
                    <td>${student.class}</td>
                    <td>${student.midTerm}%</td>
                    <td>${student.endTerm}%</td>
                    <td>${student.finalGrade}%</td>
                    <td><span class="badge ${getGradeColor(student.grade)}">${student.grade}</span></td>
                    <td>${trend}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStudentAnalysis('${student.studentId}')">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getPerformanceColor(performance) {
            const colors = {
                'Excellent': 'bg-success',
                'Good': 'bg-primary',
                'Average': 'bg-warning',
                'Below Average': 'bg-danger'
            };
            return colors[performance] || 'bg-secondary';
        }
        
        function getGradeColor(grade) {
            const colors = {
                'A': 'bg-success',
                'B': 'bg-primary',
                'C': 'bg-info',
                'D': 'bg-warning',
                'E': 'bg-secondary',
                'F': 'bg-danger'
            };
            return colors[grade] || 'bg-secondary';
        }
        
        function viewStudentAnalysis(studentId) {
            alert(`Viewing detailed analysis for student: ${studentId}`);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = '../../index.html';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeAnalysis();
        });
    </script>
</body>
</html>
